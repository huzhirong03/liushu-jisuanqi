<!DOCTYPE html>
<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      å…­å”ç«ç®­è®¡ç®—å™¨ - ç‰ˆæœ¬ä¿¡æ¯                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ç‰ˆæœ¬å·: v2.5.0                                                            â•‘
â•‘  æ›´æ–°æ—¥æœŸ: 2025-12-25                                                      â•‘
â•‘  æç¤ºè¯ç‰ˆæœ¬: v2.1                                                          â•‘
â•‘  æµ‹è¯•ç”¨ä¾‹ç‰ˆæœ¬: v1.1 (35ä¸ªç”¨ä¾‹)                                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  æ›´æ–°æ—¥å¿—:                                                                 â•‘
â•‘  v1.9.0 - æç¤ºè¯ä¼˜åŒ–v2                                                     â•‘
â•‘    - æ”¯æŒç”Ÿè‚–+xæ ¼å¼ï¼ˆé¾™x10ã€ç‹—X80ã€çŒ´é¸¡x50ï¼‰                                â•‘
â•‘    - æ”¯æŒå°æ•°/å¤§æ•°/å•æ•°/åŒæ•°èŒƒå›´                                           â•‘
â•‘    - æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼ˆç©ºæ ¼/ç‚¹/é€—å·/é¡¿å·/æ–œæ /æ¨ªæ ï¼‰                          â•‘
â•‘    - æ”¯æŒä¸­æ–‡é‡‘é¢ï¼ˆå„äºŒåã€å„ä¸€ç™¾ï¼‰                                        â•‘
â•‘    - æ–°å¢R29/R30ç†ç”±ä»£ç                                                    â•‘
â•‘    - æ–°å¢æ‰¹é‡è¾¹ç¼˜æµ‹è¯•åŠŸèƒ½ï¼ˆ32ä¸ªç”¨ä¾‹ï¼‰                                       â•‘
â•‘    - æµ‹è¯•å®Œæˆè‡ªåŠ¨å¯¼å‡ºJSON+CSV                                              â•‘
â•‘  v1.8.0 - æ¨¡å‹æ¯”æ‹¼ç³»ç»Ÿ                                                     â•‘
â•‘    - 5è½®æµ‹è¯•ã€æ ‡å‡†ç­”æ¡ˆå¯¹æ¯”ã€CSVå¯¼å‡ºã€è¯„åˆ†ç»Ÿè®¡                              â•‘
â•‘  v1.7.0 - å…”å­APIå¤šç«™ç‚¹æ™ºèƒ½åˆ‡æ¢                                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  âš ï¸ æ–°å¯¹è¯å¿…è¯»: PROJECT_INFO.md (åŒ…å«é¡¹ç›®ç»“æ„ã€æ¨¡å‹é…ç½®ã€æµ‹è¯•å†å²)          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      å…­å”ç«ç®­è®¡ç®—å™¨ - ä»£ç ç´¢å¼•                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  ã€æŸ¥æ‰¾æ–¹æ³•ã€‘æŒ‰ Ctrl+F æœç´¢å…³é”®è¯                                          â•‘
â•‘                                                                           â•‘
â•‘  1. é»˜è®¤å¼€å¥–å·ç ï¼ˆæµ‹è¯•ç”¨ï¼‰                                                  â•‘
â•‘     æœç´¢: ã€æµ‹è¯•ç”¨ã€‘é»˜è®¤å¼€å¥–å·ç                                             â•‘
â•‘                                                                           â•‘
â•‘  2. æ ¼å¼è§£ææ¨¡å—ï¼ˆè§£æä¸‹æ³¨æ–‡æœ¬ï¼‰                                            â•‘
â•‘     æœç´¢: ã€æ¨¡å—1ã€‘æ ¼å¼è§£ææ¨¡å—                                             â•‘
â•‘                                                                           â•‘
â•‘  3. è®¡ç®—é€»è¾‘æ¨¡å—ï¼ˆè®¡ç®—ä¸­å¥–ç»“æœï¼‰                                            â•‘
â•‘     æœç´¢: ã€æ¨¡å—2ã€‘è®¡ç®—é€»è¾‘æ¨¡å—                                             â•‘
â•‘                                                                           â•‘
â•‘  4. èµ”ç‡è®¾ç½®æ¨¡å—ï¼ˆèµ”ç‡è¯»å†™å¯¼å…¥å¯¼å‡ºï¼‰                                        â•‘
â•‘     æœç´¢: ã€æ¨¡å—3ã€‘èµ”ç‡è®¾ç½®æ¨¡å—                                             â•‘
â•‘                                                                           â•‘
â•‘  5. å¯¼å‡º/å¯¼å…¥èµ”ç‡æŒ‰é’®                                                      â•‘
â•‘     ä½ç½®: æ¿€æ´»ä¼šå‘˜é¡µé¢ â†’ èµ”ç‡é…ç½®å¤‡ä»½                                       â•‘
â•‘                                                                           â•‘
â•‘  â˜…â˜…â˜… 6. ã€AIæç¤ºè¯ã€‘å¤§æ¨¡å‹è¾“å…¥æç¤ºè¯ â˜…â˜…â˜…                                  â•‘
â•‘     æœç´¢: ã€AIæç¤ºè¯å¼€å§‹ã€‘                                                  â•‘
â•‘     è¯´æ˜: å‘é€ç»™DeepSeekå¤§æ¨¡å‹çš„æç¤ºè¯ï¼Œæ§åˆ¶AIå¦‚ä½•è§£æç”¨æˆ·è¾“å…¥              â•‘
â•‘                                                                           â•‘
â•‘  â˜…â˜…â˜… 7. ã€AIè°ƒè¯•æ˜¾ç¤ºã€‘æµ‹è¯•å®Œæˆååˆ é™¤ â˜…â˜…â˜…                                  â•‘
â•‘     æœç´¢: ã€AIè°ƒè¯•æ˜¾ç¤ºã€‘                                                    â•‘
â•‘     è¯´æ˜: å‘Šè¯‰AI"åˆ é™¤AIè°ƒè¯•æ˜¾ç¤ºä»£ç "å³å¯ç§»é™¤                               â•‘
â•‘                                                                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ã€æ”¯æŒçš„ç©æ³•ç±»å‹ã€‘å…±24ç§                                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ç‰¹ç ç±»:     ç‰¹ç ã€ç”Ÿè‚–ç‰¹ç ï¼ˆä¹°Xå„Yï¼‰ã€å¤§å°å•åŒ                             â•‘
â•‘  å¹³ç‰¹ç±»:     å¹³ç‰¹ä¸€è‚–(ä¸€å‹)ã€å¹³ç‰¹äºŒè¿è‚–(äºŒå‹)ã€å¹³ç‰¹ä¸‰è¿è‚–(ä¸‰å‹)ã€           â•‘
â•‘             å¹³ç‰¹å››è¿è‚–ã€å¹³ç‰¹äº”è¿è‚–ã€å¹³ç‰¹å°¾æ•°                               â•‘
â•‘  ç”Ÿè‚–ç±»:     ç”Ÿè‚–ã€å…­è‚–ã€ç‰¹è‚–ã€åˆè‚–ã€æ­£è‚–                                    â•‘
â•‘  æ³¢è‰²ç±»:     æ³¢è‰²ã€åŠæ³¢(çº¢å•/çº¢åŒ/è“å•/è“åŒ/ç»¿å¤§/ç»¿å°ç­‰)                    â•‘
â•‘  å¹³ç ç±»:     å•å¹³/å¹³ç                                                      â•‘
â•‘  è¿ç ç±»:     äºŒä¸­äºŒã€ä¸‰ä¸­ä¸‰ã€äºŒå…¨ä¸­ã€ä¸‰å…¨ä¸­ã€äºŒä¸­ç‰¹ã€ä¸‰ä¸­ç‰¹ã€ç‰¹ä¸²           â•‘
â•‘  ä¸ä¸­ç±»:     äº”ä¸ä¸­~åäºŒä¸ä¸­                                               â•‘
â•‘  å…¶ä»–:       æ€»å’Œå¤§å°å•åŒã€äº”è¡Œã€å®¶ç¦½é‡å…½ã€å¤´å°¾æ•°                           â•‘
â•‘                                                                           â•‘
â•‘  ã€é‡è¦åŒºåˆ†ã€‘"ä¹°çŒªå„10" vs "çŒªx10"                                          â•‘
â•‘  ä¹°çŒªå„10 â†’ ç”Ÿè‚–ç‰¹ç ï¼šä¹°çŒªçš„å·ç (7,19,31,43)å„10å…ƒ=40å…ƒï¼Œèµ”ç‡43            â•‘
â•‘  çŒªx10   â†’ ç”Ÿè‚–ç‰¹ç ï¼šçŒªçš„å·ç å„10å…ƒï¼ˆåŒä¸Šï¼‰                                â•‘
â•‘  çŒª10    â†’ ç”Ÿè‚–ï¼šä¹°çŒªç”Ÿè‚–10å…ƒï¼Œèµ”ç‡12                                      â•‘
â•‘                                                                           â•‘
â•‘  ã€åˆ«åæ˜ å°„ã€‘                                                              â•‘
â•‘  ä¸€å‹=å¹³ç‰¹ä¸€è‚–  äºŒå‹=å¹³ç‰¹äºŒè¿è‚–  ä¸‰å‹=å¹³ç‰¹ä¸‰è¿è‚–  å¹³ç =å•å¹³  +=å(å·ç )     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  â˜…â˜…â˜… 8. ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘å¤§æ¨¡å‹æµ‹è¯•ç³»ç»Ÿï¼ˆåæœŸåˆ é™¤ï¼‰ â˜…â˜…â˜…                   â•‘
â•‘     æœç´¢: ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘                                                â•‘
â•‘     è¯´æ˜: ç”¨äºæ¯”æ‹¼å„å¤§æ¨¡å‹æ€§èƒ½ï¼Œæ‰¾åˆ°æœ€é€‚åˆçš„æ¨¡å‹ç»„åˆ                        â•‘
â•‘     åˆ é™¤: å‘Šè¯‰AI"åˆ é™¤ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼åŠŸèƒ½"å³å¯ç§»é™¤                            â•‘
â•‘     åŒ…å«: 5è½®æµ‹è¯•ã€è¾¹ç¼˜æµ‹è¯•ã€æ ‡å‡†ç­”æ¡ˆå¯¹æ¯”ã€CSV+JSONå¯¼å‡º                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å…­å”ç«ç®­è®¡ç®—å™¨">
    <meta name="theme-color" content="#1a1a2e">
    
    <title>å…­å”ç«ç®­è®¡ç®—å™¨</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- ğŸ†• v3.11.67 DNSé¢„è§£æï¼šåŠ å¿«APIé¦–æ¬¡è¯·æ±‚é€Ÿåº¦ -->
    <link rel="dns-prefetch" href="https://rocket-calc.site">
    <link rel="preconnect" href="https://rocket-calc.site" crossorigin>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ğŸ†• v3.11.67 ç§»åŠ¨ç«¯ç‚¹å‡»ä¼˜åŒ–ï¼šç¦ç”¨åŒå‡»ç¼©æ”¾ï¼Œæ¶ˆé™¤300msç‚¹å‡»å»¶è¿Ÿ */
        button, input, textarea, select, .btn, .toolbar-btn, [role="button"] {
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* é¡¶éƒ¨æ ‡é¢˜ */
        .header {
            text-align: center;
            padding: 15px 0;
        }
        
        .header h1 {
            font-size: 24px;
            color: #e94560;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .header h1::before {
            content: '';
            width: 20px;
            height: 20px;
            background: #e94560;
            border-radius: 4px;
        }
        
        /* ä¿¡æ¯å¡ç‰‡ */
        .info-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .info-card {
            flex: 1;
            /* ğŸ†• v3.11.67 ç§»é™¤ backdrop-filterï¼Œæ”¹ç”¨æ·±è‰²èƒŒæ™¯ï¼ˆGPUä¼˜åŒ–ï¼‰ */
            background: rgba(20, 20, 40, 0.85);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .info-card.large {
            flex: 2;
        }
        
        .info-card-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }
        
        .info-card-value {
            font-size: 13px;
            color: #fff;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        
        .info-card-value.highlight {
            color: #fbbf24;
            font-weight: bold;
        }
        
        /* åŠŸèƒ½æŒ‰é’®åŒº */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 10px 8px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            max-width: 100px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-icon {
            font-size: 16px;
        }
        
        .btn-row {
            justify-content: center;
        }
        
        /* å¼€å¥–æ˜¾ç¤ºåŒº */
        .lottery-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .lottery-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .lottery-balls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap;
            gap: 6px;
            overflow-x: auto;
        }
        
        .ball-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            flex-shrink: 0;
        }
        
        .ball {
            width: 34px;
            height: 34px;
            min-width: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -3px 6px rgba(0,0,0,0.2), inset 0 3px 6px rgba(255,255,255,0.3);
            /* åŠ¨ç”»æ•ˆæœ */
            opacity: 0;
            transform: scale(0.5);
            animation: ballAppear 0.4s ease-out forwards;
            animation-delay: var(--delay, 0s);
        }
        
        @keyframes ballAppear {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* ç¦ç”¨åŠ¨ç”»æ—¶ç«‹å³æ˜¾ç¤º */
        .ball.no-anim {
            opacity: 1;
            transform: scale(1);
            animation: none;
        }
        
        .ball.red { background: linear-gradient(145deg, #ff6b6b, #c0392b); }
        .ball.blue { background: linear-gradient(145deg, #4dabf7, #2980b9); }
        .ball.green { background: linear-gradient(145deg, #51cf66, #27ae60); }
        
        .ball-info {
            font-size: 10px;
            color: #aaa;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .ball-plus {
            font-size: 14px;
            color: #666;
            margin: 0 1px;
            flex-shrink: 0;
        }
        
        .lottery-empty {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }
        
        /* è¾“å…¥æ¡†åŒº */
        .input-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-section-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .input-textarea {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: none;
            outline: none;
        }
        
        .input-textarea::placeholder {
            color: #666;
        }
        
        .input-textarea:focus {
            border-color: #e94560;
        }
        
        /* æ“ä½œæŒ‰é’® */
        .action-row {
            display: flex;
            gap: 10px;
        }
        
        .btn-calculate {
            flex: 2;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-clear {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-check {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* æ ¸å¯¹è¯¦æƒ…é¡µæ ·å¼ */
        .check-summary {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .check-summary-item {
            text-align: center;
        }
        
        .check-summary-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        
        .check-summary-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .check-summary-value.win {
            color: #e74c3c;
        }
        
        .check-summary-value.lose {
            color: #2ecc71;
        }
        
        .check-detail-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .check-detail-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 12px;
            border-left: 3px solid #666;
        }
        
        .check-detail-item.win {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
        
        .check-detail-item.lose {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }
        
        .check-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .check-detail-type {
            font-size: 13px;
            color: #fff;
            font-weight: bold;
        }
        
        .check-detail-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: #e74c3c;
            color: white;
        }
        
        .check-detail-badge.miss {
            background: #666;
        }
        
        .check-detail-info {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        
        .check-detail-calc {
            font-size: 12px;
            color: #aaa;
            font-family: 'Courier New', monospace;
        }
        
        .check-detail-result {
            font-size: 16px;
            font-weight: bold;
            text-align: right;
            margin-top: 8px;
        }
        
        .check-detail-result.win {
            color: #e74c3c;
        }
        
        .check-detail-result.lose {
            color: #2ecc71;
        }
        
        /* é¡µé¢åˆ‡æ¢ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* å­é¡µé¢å¤´éƒ¨ */
        .page-header {
            display: flex;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 15px;
        }
        
        .btn-back {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 15px 5px 0;
        }
        
        .page-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        /* è®¾ç½®é¡¹ */
        .setting-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .setting-group-title {
            font-size: 14px;
            color: #e94560;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-size: 14px;
        }
        
        .setting-input {
            width: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fbbf24;
            font-size: 14px;
            text-align: right;
            outline: none;
        }
        
        .setting-input:focus {
            border-color: #e94560;
        }
        
        /* å‚ç…§è¡¨ */
        .ref-table-wrap {
            overflow-x: auto;
            margin-top: 5px;
        }
        
        .ref-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .ref-table th {
            background: rgba(233, 69, 96, 0.3);
            padding: 10px 8px;
            text-align: left;
            color: #fff;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .ref-table td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ddd;
        }
        
        .ref-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .ref-table .num-red { color: #e74c3c; font-weight: bold; }
        .ref-table .num-blue { color: #3498db; font-weight: bold; }
        .ref-table .num-green { color: #2ecc71; font-weight: bold; }
        
        /* æ¿€æ´»é¡µé¢ */
        .machine-code-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .machine-code-value {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            color: #fbbf24;
            letter-spacing: 2px;
        }
        
        .license-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            text-align: center;
            outline: none;
            margin-bottom: 15px;
        }
        
        .btn-activate {
            width: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* AIæ¨¡å‹åˆ‡æ¢æŒ‰é’® */
        .ai-model-btn {
            flex: 1;
            min-width: 60px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ccc;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .ai-model-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .ai-model-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .ai-model-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ğŸ†• v3.11.48 ç»Ÿä¸€å·¥å…·æ æŒ‰é’®æ ·å¼ - 50pxé«˜åº¦ï¼Œå†…å®¹å±…ä¸­ä¸æº¢å‡º */
        .toolbar-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 2px;
            flex: 1;
            min-width: 0;
            height: 50px;
            padding: 0 4px;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            box-sizing: border-box;
        }
        .toolbar-btn:hover {
            filter: brightness(1.15);
        }
        .toolbar-btn:active {
            filter: brightness(0.95);
            transform: scale(0.98);
        }
        .toolbar-btn .btn-text {
            font-size: 13px;
            line-height: 1;
            flex-shrink: 0;
        }
        /* è®¡ç®—æŒ‰é’®æ–‡å­—å¾€å·¦ç§»åŠ¨3px */
        .toolbar-btn-primary .btn-text {
            margin-left: -3px;
        }
        .toolbar-btn-secondary {
            background: linear-gradient(135deg,#4a5568,#2d3748) !important;
        }
        .toolbar-btn-primary {
            background: linear-gradient(135deg,#e94560,#c23a51) !important;
            font-weight: bold;
        }
        
        /* è°ƒè¯•é¢æ¿Tabæ ·å¼ */
        .debug-tab {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
        }
        .debug-tab:hover {
            color: #aaa;
            background: rgba(255,255,255,0.05);
        }
        .debug-tab.active {
            color: #9b59b6;
            border-bottom-color: #9b59b6;
            background: rgba(155,89,182,0.1);
        }
        
        /* å¤šæ¨¡å‹å¯¹æ¯”æ ‡ç­¾ */
        .model-tab {
            flex: 1;
            padding: 10px 8px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .model-tab:hover {
            background: rgba(255,255,255,0.05);
        }
        .model-tab.active {
            color: #fff;
            border-bottom-color: #667eea;
            background: rgba(102,126,234,0.1);
        }
        .model-tab.success {
            color: #81c784;
        }
        .model-tab.error {
            color: #ef5350;
        }
        .model-tab.warning {
            color: #ffa726;
        }
        .model-tab-name {
            font-size: 12px;
            font-weight: 600;
        }
        .model-tab-time {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.8;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .status-label {
            font-size: 12px;
            color: #888;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .status-value.active { color: #2ecc71; }
        .status-value.trial { color: #f39c12; }
        .status-value.expired { color: #e74c3c; }
        
        /* ç»“æœæ˜¾ç¤º */
        .result-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .result-section.show {
            display: block;
        }
        
        .result-title {
            font-size: 14px;
            color: #e94560;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .result-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            scroll-behavior: smooth;
            /* ğŸ†• v3.11.67 é•¿åˆ—è¡¨æ¸²æŸ“ä¼˜åŒ–ï¼šè·³è¿‡å±å¹•å¤–å†…å®¹æ¸²æŸ“ï¼Œæå‡7å€æ€§èƒ½ */
            content-visibility: auto;
            contain-intrinsic-size: auto 500px;
        }
        
        /* ğŸ†• v3.11.64 æ‰“å­—æœºæ•ˆæœæ ·å¼ */
        .typewriter-cursor {
            display: inline-block;
            color: #4ecdc4;
            font-weight: bold;
            animation: cursorBlink 0.8s ease-in-out infinite;
            text-shadow: 0 0 8px rgba(78, 205, 196, 0.6);
        }
        @keyframes cursorBlink {
            0%, 45% { opacity: 1; }
            50%, 95% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* æ‰“å­—æœºè®¡ç®—ä¸­æç¤º */
        .typewriter-loading {
            color: #f39c12;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .result-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-copy-result {
            flex: 1;
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-feedback {
            flex: 1;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }

        /* å¼€å¥–è¾“å…¥ */
        .lottery-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .lottery-num-input {
            width: 45px;
            height: 45px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            outline: none;
        }
        
        .lottery-num-input:focus {
            border-color: #e94560;
        }
        
        .lottery-num-input.special {
            border-color: #fbbf24;
            color: #fbbf24;
        }
        
        .plus-sign {
            display: flex;
            align-items: center;
            font-size: 20px;
            color: #666;
        }
        
        .num-input-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .num-label {
            font-size: 10px;
            color: #888;
        }
        
        .lottery-num-input {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            outline: none;
        }
        
        .lottery-num-input:focus {
            border-color: #e94560;
        }
        
        .lottery-num-input.special {
            border-color: #fbbf24;
            color: #fbbf24;
        }
        
        .lottery-num-input.special:focus {
            border-color: #fbbf24;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }
        
        .lottery-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        /* å¯¼å…¥å¯¼å‡ºæŒ‰é’® */
        .config-btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .btn-config {
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .btn-config:active {
            transform: scale(0.95);
        }
        
        .btn-export {
            border-color: #3498db;
            color: #3498db;
        }
        
        .btn-import {
            border-color: #2ecc71;
            color: #2ecc71;
        }
        
        /* å¯¼å…¥å¼¹çª— */
        .import-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .import-modal.show {
            display: flex;
        }
        
        .import-modal-content {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .import-modal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2ecc71;
        }
        
        .import-textarea {
            width: 100%;
            height: 150px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            padding: 10px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            resize: none;
            margin-bottom: 15px;
        }
        
        .import-modal-btns {
            display: flex;
            gap: 10px;
        }
        
        .import-modal-btns button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-import-confirm {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .btn-import-cancel {
            background: rgba(255,255,255,0.1);
            color: #888;
        }
        
        /* èµ”ç‡è®¾ç½®æ–°å¸ƒå±€ */
        .odds-layout {
            display: flex;
            height: calc(100vh - 120px);
            gap: 0;
        }
        
        .odds-menu {
            width: 90px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px 0 0 10px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .odds-menu-item {
            padding: 15px 10px;
            text-align: center;
            font-size: 13px;
            color: #888;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s;
        }
        
        .odds-menu-item:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .odds-menu-item.active {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            border-left: 3px solid #e94560;
        }
        
        .odds-content {
            flex: 1;
            background: rgba(0,0,0,0.2);
            border-radius: 0 10px 10px 0;
            padding: 15px;
            overflow-y: auto;
        }
        
        .odds-panel {
            display: none;
        }
        
        .odds-panel.active {
            display: block;
        }
        
        .odds-panel-title {
            font-size: 14px;
            color: #e94560;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .odds-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .odds-item-label {
            font-size: 13px;
            color: #ccc;
        }
        
        .odds-item-input {
            width: 80px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            padding: 8px;
            font-size: 14px;
            text-align: center;
        }
        
        .odds-note {
            font-size: 12px;
            color: #888;
            padding: 8px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #e94560;
        }
        
        .odds-save-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #e94560, #c23a51);
            color: white;
            padding: 12px 40px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»é¡µé¢ -->
        <div class="page active" id="page-main">
            <div class="header">
                <h1 style="color:#e94560;">ğŸš€å…­å”ç«ç®­è®¡ç®—å™¨</h1>
            </div>
            
            <!-- åŠŸèƒ½æŒ‰é’® - 4ä¸ª -->
            <div class="btn-row">
                <button class="btn btn-primary" onclick="showPage('page-lottery')">
                    <span class="btn-icon">ğŸ¯</span>
                    <span>å¼€å¥–è®¾ç½®</span>
                </button>
                <button class="btn btn-success" onclick="showPage('page-odds')">
                    <span class="btn-icon">âš™ï¸</span>
                    <span>èµ”ç‡è®¾ç½®</span>
                </button>
                <button class="btn" onclick="showPage('page-format')" style="background:linear-gradient(135deg,#e91e63,#9c27b0);">
                    <span class="btn-icon">âœï¸</span>
                    <span>è‡ªå®šä¹‰æ ¼å¼</span>
                </button>
                <button class="btn btn-warning" onclick="showPage('page-params')">
                    <span class="btn-icon">ğŸ”§</span>
                    <span>å‚æ•°è®¾ç½®</span>
                </button>
            </div>
            
            <!-- å¼€å¥–æ˜¾ç¤º - ä¸Šä¸‹å¸ƒå±€ -->
            <div class="lottery-display" style="padding:10px;">
                <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ + åˆ‡æ¢æŒ‰é’® -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span id="lottery-type-name" style="color:#e94560;font-weight:bold;font-size:15px;">æ–°æ¾³</span>
                        <span id="lottery-issue" style="color:#888;font-size:12px;">ç¬¬xxxæœŸ</span>
                        <span style="color:#888;font-size:12px;">å¼€å¥–ç»“æœ</span>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button id="btn-hk" onclick="switchLotteryType('hk')" class="lottery-switch-btn" style="padding:5px 12px;border-radius:5px;font-size:12px;font-weight:bold;cursor:pointer;border:2px solid #4CAF50;background:transparent;color:#4CAF50;">é¦™æ¸¯</button>
                        <button id="btn-xam" onclick="switchLotteryType('xam')" class="lottery-switch-btn active" style="padding:5px 12px;border-radius:5px;font-size:12px;font-weight:bold;cursor:pointer;border:2px solid #e94560;background:transparent;color:#e94560;">æ–°æ¾³</button>
                    </div>
                </div>
                <!-- ä¸‹æ–¹ï¼šå¼€å¥–å·ç ï¼ˆç´§å‡‘å¸ƒå±€ï¼‰+ å¤åˆ¶æŒ‰é’® -->
                <div style="display:flex;align-items:center;gap:8px;">
                    <div class="lottery-balls" id="lottery-balls" style="gap:4px;justify-content:flex-start;flex:1;">
                        <div class="lottery-empty">è¯·å…ˆè®¾ç½®å¼€å¥–å·ç </div>
                    </div>
                    <button onclick="copyLotteryResult()" style="padding:6px 12px;background:rgba(255,255,255,0.1);color:#ccc;border:1px solid rgba(255,255,255,0.2);border-radius:6px;font-size:12px;cursor:pointer;white-space:nowrap;flex-shrink:0;">å¤åˆ¶</button>
                </div>
            </div>
            
            <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
            <div class="input-section" style="flex:1;display:flex;flex-direction:column;">
                <!-- ğŸ†• v3.11.45 æŒ‰é’®æ ï¼šå æ»¡æ•´è¡Œã€ç´§å‡‘é—´è·ã€å‡åŒ€åˆ†å¸ƒ -->
                <div style="display:flex;gap:4px;margin-bottom:8px;width:100%;">
                    <!-- è¯¦æƒ…æŒ‰é’®ï¼ˆåˆå¹¶AI+ç¨‹åºï¼Œå†…éƒ¨Tabåˆ‡æ¢ï¼‰ -->
                    <button onclick="showDebugPanel()" class="toolbar-btn" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);" title="æŸ¥çœ‹è¯†åˆ«è¯¦æƒ…">ğŸ¤–<span class="btn-text">è¯¦æƒ…</span></button>
                    <!-- æ‰¹é‡æµ‹è¯• -->
                    <button onclick="openBatchTestModal()" class="toolbar-btn" style="background:linear-gradient(135deg,#e74c3c,#c0392b);" title="æ‰¹é‡è¾¹ç¼˜æµ‹è¯•">ğŸ§ª<span class="btn-text">æµ‹è¯•</span></button>
                    <!-- åˆ†ç»„ç¼–è¾‘ -->
                    <button onclick="showGroupEditor()" class="toolbar-btn" style="background:linear-gradient(135deg,#667eea,#764ba2);" title="æ‰‹åŠ¨ç¼–è¾‘åˆ†ç»„">ğŸ“¦<span class="btn-text">åˆ†ç»„</span></button>
                    <!-- æ ¸å¯¹ -->
                    <button onclick="showCheckDetail()" class="toolbar-btn" style="background:linear-gradient(135deg,#3498db,#2980b9);" title="æ ¸å¯¹ä¸‹æ³¨">ğŸ”<span class="btn-text">æ ¸å¯¹</span></button>
                    <!-- æ¸…ç©º -->
                    <button onclick="clearInput()" class="toolbar-btn toolbar-btn-secondary" title="æ¸…ç©ºè¾“å…¥">ğŸ—‘ï¸<span class="btn-text">æ¸…ç©º</span></button>
                    <!-- è®¡ç®— -->
                    <button onclick="calculateBets()" class="toolbar-btn toolbar-btn-primary" title="å¼€å§‹è®¡ç®—">ğŸ’°<span class="btn-text">è®¡ç®—</span></button>
                </div>
                <textarea class="input-textarea" id="bet-input" style="flex:1;min-height:280px;" placeholder="ç²˜è´´ä¸‹æ³¨ä¿¡æ¯ï¼Œæ”¯æŒæ–°æ¾³/é¦™æ¸¯åŒå½©ç§

ğŸ“Œ å½©ç§åˆ‡æ¢ï¼šé¦™/æ¸¯=é¦™æ¸¯ï¼Œæ¾³/å¥¥=æ–°æ¾³
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ¾³é—¨03-24-07å„15
é¾™è™é©¬å„20
é¦™æ¸¯          â† å•ç‹¬ä¸€è¡Œåˆ‡æ¢å½©ç§
ç‰›é¸¡å„15
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ æ”¯æŒæ ¼å¼ï¼š
â€¢ ç”Ÿè‚–ç‰¹ç ï¼šä¹°çŒªå„10ã€é¾™x10ã€çŒ´é¸¡x50
â€¢ ç‰¹ç å·ç ï¼šç‰¹43 20å…ƒã€31.34å„äºŒå
â€¢ å¹³ç‰¹ï¼šä¸€å‹ç‹—800ã€äºŒå‹çŒ´é¸¡200ã€å¹³ç‰¹çŒ´é¸¡å„200
â€¢ å…­è‚–ï¼šå…­è‚–é¼ çŒ´ç¾Šé¸¡ç‰›é©¬200
â€¢ è¿è‚–ï¼šä¸‰å‹ç¾Šé¸¡çŒ´100

ğŸ’¡ ç©ºä¸€è¡Œ=åˆ†éš”ä¸åŒç»„"></textarea>
            </div>
            
            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="result-section" id="result-section">
                <div class="result-title">è®¡ç®—ç»“æœ</div>
                <div class="result-content" id="result-content"></div>
                <div class="result-buttons">
                    <button class="btn-copy-result" onclick="copyResult()">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
                    <button class="btn-feedback" onclick="showFeedbackModal()">âŒ ç»“æœæœ‰è¯¯ï¼Ÿæäº¤åé¦ˆ</button>
                </div>
            </div>
        </div>
        
        <!-- å¼€å¥–è®¾ç½®é¡µé¢ -->
        <div class="page" id="page-lottery">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('page-main')">â†</button>
                <div class="page-title">å¼€å¥–è®¾ç½®</div>
            </div>
            
            <!-- å¿«é€Ÿç²˜è´´è§£æ -->
            <div class="setting-group" style="padding:12px;">
                <!-- æ ‡é¢˜è¡Œï¼šæ ‡é¢˜ + æŒ‰é’® -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <div class="setting-group-title" style="margin-bottom:0;">å¿«é€Ÿç²˜è´´å¼€å¥–å·ç </div>
                    <button onclick="parseLotteryInput()" style="padding:6px 15px;background:linear-gradient(90deg,#e94560,#c23a51);color:white;border:none;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                        ğŸ” è§£æå¹¶å¡«å…¥
                    </button>
                </div>
                <!-- å¤§è¾“å…¥æ¡† -->
                <textarea id="paste-lottery-input" placeholder="ç¤ºèŒƒè¾“å…¥æ ¼å¼ï¼š&#10;01 08 09 15 24 26 ç‰¹27&#10;01.08.09.15.24.26.27&#10;01,08,09,15,24,26 ç‰¹27" style="width:100%;height:100px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;padding:12px;font-size:15px;resize:none;line-height:1.6;"></textarea>
                <!-- è§£æé¢„è§ˆ -->
                <div id="parse-preview" style="display:none;margin-top:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:8px;text-align:center;">
                    <div id="parse-preview-balls" style="display:flex;justify-content:center;align-items:center;gap:5px;flex-wrap:nowrap;"></div>
                </div>
            </div>
            
            <div class="setting-group" style="padding:12px;">
                <!-- æ ‡é¢˜è¡Œï¼šæ ‡é¢˜ + æŒ‰é’® -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div class="setting-group-title" style="margin-bottom:0;">å¼€å¥–å·ç </div>
                    <button onclick="saveLotteryNumbers()" style="padding:6px 15px;background:linear-gradient(90deg,#e94560,#c23a51);color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer;">ä¿å­˜å¼€å¥–å·ç </button>
                </div>
                <!-- å•è¡Œæ˜¾ç¤º7ä¸ªè¾“å…¥æ¡† -->
                <div style="display:flex;align-items:center;justify-content:center;gap:4px;flex-wrap:nowrap;">
                    <input type="text" class="lottery-num-input" id="num1" maxlength="2" oninput="formatNumInput(this)" onblur="padNumInput(this)" style="width:36px;height:36px;border-radius:50%;text-align:center;font-size:14px;font-weight:bold;background:#333;border:2px solid #555;color:#fff;">
                    <input type="text" class="lottery-num-input" id="num2" maxlength="2" oninput="formatNumInput(this)" onblur="padNumInput(this)" style="width:36px;height:36px;border-radius:50%;text-align:center;font-size:14px;font-weight:bold;background:#333;border:2px solid #555;color:#fff;">
                    <input type="text" class="lottery-num-input" id="num3" maxlength="2" oninput="formatNumInput(this)" onblur="padNumInput(this)" style="width:36px;height:36px;border-radius:50%;text-align:center;font-size:14px;font-weight:bold;background:#333;border:2px solid #555;color:#fff;">
                    <input type="text" class="lottery-num-input" id="num4" maxlength="2" oninput="formatNumInput(this)" onblur="padNumInput(this)" style="width:36px;height:36px;border-radius:50%;text-align:center;font-size:14px;font-weight:bold;background:#333;border:2px solid #555;color:#fff;">
                    <input type="text" class="lottery-num-input" id="num5" maxlength="2" oninput="formatNumInput(this)" onblur="padNumInput(this)" style="width:36px;height:36px;border-radius:50%;text-align:center;font-size:14px;font-weight:bold;background:#333;border:2px solid #555;color:#fff;">
                    <input type="text" class="lottery-num-input" id="num6" maxlength="2" oninput="formatNumInput(this)" onblur="padNumInput(this)" style="width:36px;height:36px;border-radius:50%;text-align:center;font-size:14px;font-weight:bold;background:#333;border:2px solid #555;color:#fff;">
                    <span style="color:#e94560;font-weight:bold;font-size:16px;margin:0 2px;">+</span>
                    <input type="text" class="lottery-num-input special" id="num-special" maxlength="2" oninput="formatNumInput(this)" onblur="padNumInput(this)" style="width:36px;height:36px;border-radius:50%;text-align:center;font-size:14px;font-weight:bold;background:#333;border:2px solid #f5a623;color:#f5a623;">
                </div>
                <div style="display:flex;justify-content:center;gap:4px;margin-top:4px;font-size:10px;color:#666;">
                    <span style="width:36px;text-align:center;">å¹³ç </span>
                    <span style="width:36px;text-align:center;">å¹³ç </span>
                    <span style="width:36px;text-align:center;">å¹³ç </span>
                    <span style="width:36px;text-align:center;">å¹³ç </span>
                    <span style="width:36px;text-align:center;">å¹³ç </span>
                    <span style="width:36px;text-align:center;">å¹³ç </span>
                    <span style="width:20px;"></span>
                    <span style="width:36px;text-align:center;color:#f5a623;">ç‰¹</span>
                </div>
            </div>
            
            <!-- å†å²è®°å½•é€‰æ‹© -->
            <div class="setting-group" style="padding:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div class="setting-group-title" style="margin-bottom:0;">ğŸ“œ å†å²å¼€å¥–è®°å½•ï¼ˆæœ€è¿‘10æœŸï¼‰</div>
                    <button onclick="fetchHistoryData()" style="padding:5px 10px;background:linear-gradient(90deg,#9b59b6,#8e44ad);color:white;border:none;border-radius:5px;font-size:11px;cursor:pointer;">ğŸ”„ æ‰‹åŠ¨è·å–</button>
                </div>
                
                <!-- å½©ç§é€‰æ‹©æ ‡ç­¾ -->
                <div style="display:flex;gap:6px;margin-bottom:10px;">
                    <button id="history-btn-xam" onclick="switchHistoryType('xam')" class="history-type-btn active" style="flex:1;padding:8px;border-radius:6px;font-size:12px;font-weight:bold;cursor:pointer;border:2px solid #e94560;background:rgba(233,69,96,0.2);color:#e94560;">æ–°æ¾³é—¨</button>
                    <button id="history-btn-hk" onclick="switchHistoryType('hk')" class="history-type-btn" style="flex:1;padding:8px;border-radius:6px;font-size:12px;font-weight:bold;cursor:pointer;border:2px solid #4CAF50;background:transparent;color:#4CAF50;">é¦™æ¸¯</button>
                </div>
                
                <!-- å†å²è®°å½•åˆ—è¡¨ï¼ˆå¯æ»‘åŠ¨ï¼‰ -->
                <div id="history-list" style="max-height:220px;overflow-y:auto;background:rgba(0,0,0,0.2);border-radius:8px;padding:6px;-webkit-overflow-scrolling:touch;">
                    <div style="text-align:center;color:#666;font-size:12px;padding:20px;">ğŸ”„ æ­£åœ¨è‡ªåŠ¨åŠ è½½å†å²è®°å½•...</div>
                </div>
                
                <!-- å¼€å¥–æ—¶é—´æç¤º -->
                <div style="font-size:10px;color:#666;text-align:center;margin-top:8px;">
                    â° å¼€å¥–æ—¶é—´ï¼šæ–°æ¾³é—¨ 21:30 | é¦™æ¸¯ 21:30ï¼ˆå‘¨äºŒå››å…­ï¼‰| æ¾³é—¨ 22:30
                </div>
            </div>
            
            <!-- è‡ªåŠ¨è·å–å¼€å¥– -->
            <div class="setting-group" style="padding:12px;">
                <div class="setting-group-title" style="margin-bottom:10px;">ğŸ“¡ è‡ªåŠ¨è·å–å¼€å¥–æ•°æ®</div>
                
                <!-- å½©ç§é€‰æ‹© -->
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <select id="lottery-type-select" style="flex:1;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:14px;">
                        <option value="xam" selected>ğŸ‡²ğŸ‡´ æ–°æ¾³é—¨å…­åˆå½©</option>
                        <option value="hk">ğŸ‡­ğŸ‡° é¦™æ¸¯å…­åˆå½©</option>
                        <option value="am">ğŸ‡²ğŸ‡´ ãŠ£æ¾³é—¨å…­åˆå½©</option>
                    </select>
                    <button onclick="fetchLotteryData()" style="padding:10px 20px;background:linear-gradient(90deg,#4CAF50,#45a049);color:white;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;white-space:nowrap;">
                        ğŸ“¡ è·å–æœ€æ–°
                    </button>
                </div>
                
                <!-- è·å–çŠ¶æ€æ˜¾ç¤º -->
                <div id="fetch-status" style="display:none;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;font-size:13px;text-align:center;"></div>
                
                <!-- APIæ¥æºæç¤º -->
                <div style="font-size:11px;color:#666;text-align:center;margin-top:8px;">
                    æ•°æ®æ¥æºï¼šMarksix6ï¼ˆè‡ªåŠ¨è·å–ï¼‰
                </div>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">å±æ€§å‚ç…§è¡¨</div>
                <button class="btn btn-primary" onclick="showPage('page-reference')" style="width:100%;max-width:none;">
                    <span>ğŸ“– æŸ¥çœ‹ç”Ÿè‚–/æ³¢è‰²/äº”è¡Œå¯¹ç…§è¡¨</span>
                </button>
            </div>
        </div>
        
        <!-- èµ”ç‡è®¾ç½®é¡µé¢ -->
        <div class="page" id="page-odds">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('page-main')">â†</button>
                <div class="page-title">èµ”ç‡è®¾ç½®</div>
            </div>
            
            <div class="odds-layout">
                <!-- å·¦ä¾§èœå•ï¼ˆæŒ‰ç”¨æˆ·æä¾›çš„ç©æ³•ç±»å‹ï¼‰ -->
                <div class="odds-menu">
                    <div class="odds-menu-item active" onclick="showOddsPanel('tema')">ç‰¹ç </div>
                    <div class="odds-menu-item" onclick="showOddsPanel('daxiao')">å¤§å°å•åŒ</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('pingte')">å¹³ç‰¹ä¸€è‚–</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('pingte2')">å¹³ç‰¹è¿è‚–</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('pingtew')">å¹³ç‰¹å°¾æ•°</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('liuxiao')">å…­è‚–</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('texiao')">ç‰¹è‚–</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('danping')">å•å¹³(å¹³ç )</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('bose')">æ³¢è‰²</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('banbo')">åŠæ³¢</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('lianma')">è¿ç </div>
                    <div class="odds-menu-item" onclick="showOddsPanel('buzhong')">ä¸ä¸­</div>
                    <div class="odds-menu-item" onclick="showOddsPanel('qita')">å…¶ä»–</div>
                </div>
                
                <!-- å³ä¾§å†…å®¹ï¼ˆæŒ‰æ–°ç©æ³•ç±»å‹ï¼‰ -->
                <div class="odds-content">
                    <!-- ç‰¹ç  -->
                    <div class="odds-panel active" id="panel-tema">
                        <div class="odds-panel-title">ç‰¹ç èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç‰¹ç </span>
                            <input type="number" class="odds-item-input" id="odds-tema" value="43">
                        </div>
                    </div>
                    
                    <!-- å¤§å°å•åŒ -->
                    <div class="odds-panel" id="panel-daxiao">
                        <div class="odds-panel-title">å¤§å°å•åŒèµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¤§</span>
                            <input type="number" class="odds-item-input" id="odds-da" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å°</span>
                            <input type="number" class="odds-item-input" id="odds-xiao" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å•</span>
                            <input type="number" class="odds-item-input" id="odds-dan" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åŒ</span>
                            <input type="number" class="odds-item-input" id="odds-shuang" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åˆå¤§</span>
                            <input type="number" class="odds-item-input" id="odds-heda" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åˆå°</span>
                            <input type="number" class="odds-item-input" id="odds-hexiao" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åˆå•</span>
                            <input type="number" class="odds-item-input" id="odds-hedan" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åˆåŒ</span>
                            <input type="number" class="odds-item-input" id="odds-heshuang" value="1.98" step="0.01">
                        </div>
                    </div>
                    
                    <!-- å¹³ç‰¹ä¸€è‚– -->
                    <div class="odds-panel" id="panel-pingte">
                        <div class="odds-panel-title">å¹³ç‰¹ä¸€è‚–èµ”ç‡ï¼ˆåˆ«åï¼šä¸€å‹ï¼‰</div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¹³ç‰¹ä¸€è‚–</span>
                            <input type="number" class="odds-item-input" id="odds-pingte1" value="11" step="0.1">
                        </div>
                    </div>
                    
                    <!-- å¹³ç‰¹è¿è‚– -->
                    <div class="odds-panel" id="panel-pingte2">
                        <div class="odds-panel-title">å¹³ç‰¹è¿è‚–èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¹³ç‰¹äºŒè¿è‚–ï¼ˆäºŒå‹ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-pingte2x" value="26" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¹³ç‰¹ä¸‰è¿è‚–ï¼ˆä¸‰å‹ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-pingte3x" value="66" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¹³ç‰¹å››è¿è‚–</span>
                            <input type="number" class="odds-item-input" id="odds-pingte4x" value="180" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¹³ç‰¹äº”è¿è‚–</span>
                            <input type="number" class="odds-item-input" id="odds-pingte5x" value="500" step="0.1">
                        </div>
                    </div>
                    
                    <!-- å¹³ç‰¹å°¾æ•° -->
                    <div class="odds-panel" id="panel-pingtew">
                        <div class="odds-panel-title">å¹³ç‰¹å°¾æ•°èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¹³ç‰¹å°¾æ•°</span>
                            <input type="number" class="odds-item-input" id="odds-pingtew" value="2.8" step="0.1">
                        </div>
                    </div>
                    
                    <!-- å…­è‚– -->
                    <div class="odds-panel" id="panel-liuxiao">
                        <div class="odds-panel-title">å…­è‚–èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">å…­è‚–</span>
                            <input type="number" class="odds-item-input" id="odds-liuxiao" value="4.2" step="0.1">
                        </div>
                    </div>
                    
                    <!-- ç‰¹è‚– -->
                    <div class="odds-panel" id="panel-texiao">
                        <div class="odds-panel-title">ç‰¹è‚–èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç‰¹è‚–</span>
                            <input type="number" class="odds-item-input" id="odds-texiao" value="12" step="0.1">
                        </div>
                    </div>
                    
                    <!-- å•å¹³ï¼ˆå¹³ç ï¼‰ -->
                    <div class="odds-panel" id="panel-danping">
                        <div class="odds-panel-title">å•å¹³ï¼ˆå¹³ç ï¼‰èµ”ç‡</div>
                        <div class="odds-note">è¯´æ˜ï¼šæŒ‡é™¤ç‰¹ç å¤–çš„6ä¸ªæ­£ç </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å•å¹³/å¹³ç </span>
                            <input type="number" class="odds-item-input" id="odds-danping" value="8" step="0.1">
                        </div>
                    </div>
                    
                    <!-- æ³¢è‰² -->
                    <div class="odds-panel" id="panel-bose">
                        <div class="odds-panel-title">æ³¢è‰²èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">çº¢æ³¢</span>
                            <input type="number" class="odds-item-input" id="odds-red" value="2.8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">è“æ³¢</span>
                            <input type="number" class="odds-item-input" id="odds-blue" value="2.8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç»¿æ³¢</span>
                            <input type="number" class="odds-item-input" id="odds-green" value="2.8" step="0.1">
                        </div>
                    </div>
                    
                    <!-- åŠæ³¢ -->
                    <div class="odds-panel" id="panel-banbo">
                        <div class="odds-panel-title">åŠæ³¢èµ”ç‡</div>
                        <div class="odds-note">æ ¼å¼ï¼šæ³¢è‰²+å¤§å°/å•åŒï¼Œå¦‚ï¼šçº¢å•ã€è“åŒã€ç»¿å¤§</div>
                        <div class="odds-item">
                            <span class="odds-item-label">çº¢å¤§</span>
                            <input type="number" class="odds-item-input" id="odds-red-da" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">çº¢å°</span>
                            <input type="number" class="odds-item-input" id="odds-red-xiao" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">çº¢å•</span>
                            <input type="number" class="odds-item-input" id="odds-red-dan" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">çº¢åŒ</span>
                            <input type="number" class="odds-item-input" id="odds-red-shuang" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">è“å¤§</span>
                            <input type="number" class="odds-item-input" id="odds-blue-da" value="5" step="0.1">
                    </div>
                        <div class="odds-item">
                            <span class="odds-item-label">è“å°</span>
                            <input type="number" class="odds-item-input" id="odds-blue-xiao" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">è“å•</span>
                            <input type="number" class="odds-item-input" id="odds-blue-dan" value="5" step="0.1">
                    </div>
                        <div class="odds-item">
                            <span class="odds-item-label">è“åŒ</span>
                            <input type="number" class="odds-item-input" id="odds-blue-shuang" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç»¿å¤§</span>
                            <input type="number" class="odds-item-input" id="odds-green-da" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç»¿å°</span>
                            <input type="number" class="odds-item-input" id="odds-green-xiao" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç»¿å•</span>
                            <input type="number" class="odds-item-input" id="odds-green-dan" value="5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç»¿åŒ</span>
                            <input type="number" class="odds-item-input" id="odds-green-shuang" value="5" step="0.1">
                        </div>
                    </div>
                    
                    <!-- è¿ç  -->
                    <div class="odds-panel" id="panel-lianma">
                        <div class="odds-panel-title">è¿ç èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">äºŒä¸­äºŒ</span>
                            <input type="number" class="odds-item-input" id="odds-2z2" value="42" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ä¸‰ä¸­ä¸‰</span>
                            <input type="number" class="odds-item-input" id="odds-3z3" value="200" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">äºŒå…¨ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-2qz" value="21" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ä¸‰å…¨ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-3qz" value="75" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">äºŒä¸­ç‰¹</span>
                            <input type="number" class="odds-item-input" id="odds-2zt" value="8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ä¸‰ä¸­ç‰¹</span>
                            <input type="number" class="odds-item-input" id="odds-3zt" value="25" step="0.1">
                    </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ç‰¹ä¸²</span>
                            <input type="number" class="odds-item-input" id="odds-techuan" value="4.5" step="0.1">
                        </div>
                    </div>
                    
                    <!-- ä¸ä¸­ -->
                    <div class="odds-panel" id="panel-buzhong">
                        <div class="odds-panel-title">ä¸ä¸­èµ”ç‡ï¼ˆè‡ªé€‰ä¸ä¸­ï¼‰</div>
                        <div class="odds-item">
                            <span class="odds-item-label">äº”ä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-5bz" value="2.2" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å…­ä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-6bz" value="2.8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ä¸ƒä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-7bz" value="3.6" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å…«ä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-8bz" value="4.8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">ä¹ä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-9bz" value="6.5" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-10bz" value="9" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åä¸€ä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-11bz" value="12" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åäºŒä¸ä¸­</span>
                            <input type="number" class="odds-item-input" id="odds-12bz" value="16" step="0.1">
                        </div>
                    </div>
                    
                    <!-- å…¶ä»–ç©æ³• -->
                    <div class="odds-panel" id="panel-qita">
                        <div class="odds-panel-title">å…¶ä»–ç©æ³•èµ”ç‡</div>
                        <div class="odds-item">
                            <span class="odds-item-label">æ­£è‚–</span>
                            <input type="number" class="odds-item-input" id="odds-zhengxiao" value="2" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åˆè‚–ï¼ˆ2è‚–ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-hexiao2" value="6" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åˆè‚–ï¼ˆ3è‚–ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-hexiao3" value="4" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">åˆè‚–ï¼ˆ4è‚–ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-hexiao4" value="3" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">æ€»å’Œå¤§</span>
                            <input type="number" class="odds-item-input" id="odds-zongda" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">æ€»å’Œå°</span>
                            <input type="number" class="odds-item-input" id="odds-zongxiao" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">æ€»å’Œå•</span>
                            <input type="number" class="odds-item-input" id="odds-zongdan" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">æ€»å’ŒåŒ</span>
                            <input type="number" class="odds-item-input" id="odds-zongshuang" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å®¶ç¦½</span>
                            <input type="number" class="odds-item-input" id="odds-jiaqin" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">é‡å…½</span>
                            <input type="number" class="odds-item-input" id="odds-yeshou" value="1.98" step="0.01">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å¤´æ•°ï¼ˆ0-4å¤´ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-toushu" value="4" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">å°¾æ•°ï¼ˆ0-9å°¾ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-weishu" value="9" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">äº”è¡Œï¼ˆé‡‘ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-wuxing-jin" value="4.8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">äº”è¡Œï¼ˆæœ¨ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-wuxing-mu" value="4.8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">äº”è¡Œï¼ˆæ°´ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-wuxing-shui" value="5.8" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">äº”è¡Œï¼ˆç«ï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-wuxing-huo" value="4" step="0.1">
                        </div>
                        <div class="odds-item">
                            <span class="odds-item-label">äº”è¡Œï¼ˆåœŸï¼‰</span>
                            <input type="number" class="odds-item-input" id="odds-wuxing-tu" value="5.4" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="odds-save-btn" onclick="saveOdds()">ğŸ’¾ ä¿å­˜èµ”ç‡</button>
        </div>
        
        <!-- è‡ªå®šä¹‰æ ¼å¼é¡µé¢ -->
        <div class="page" id="page-format">
            <div class="page-header" style="margin-bottom:8px;">
                <button class="btn-back" onclick="showPage('page-main')">â†</button>
                <div class="page-title">è‡ªå®šä¹‰æ ¼å¼</div>
            </div>
            
            <!-- ğŸ†• v3.6 è‡ªå®šä¹‰è¯†åˆ«è§„åˆ™ -->
            <div class="setting-group" style="background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(245,158,11,0.1));border:1px solid rgba(251,191,36,0.3);margin-top:0;">
                <div class="setting-group-title" style="color:#fbbf24;">ğŸ¯ è‡ªå®šä¹‰è¯†åˆ«è§„åˆ™</div>
                <div style="font-size:12px;color:#888;margin-bottom:10px;">
                    è®¾ç½®å…³é”®è¯è®©ç³»ç»Ÿ<b style="color:#f59e0b;">è‡ªåŠ¨è¯†åˆ«</b>å¯¹åº”çš„ç©æ³•ç±»å‹
                </div>
                
                <!-- è§„åˆ™åˆ—è¡¨ -->
                <div id="custom-rules-list" style="max-height:300px;overflow-y:auto;margin-bottom:12px;">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- æ·»åŠ æ–°è§„åˆ™ï¼ˆç®€æ´ä¸»ç•Œé¢ï¼‰ -->
                <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;margin-bottom:12px;">
                    <div style="font-size:11px;color:#888;margin-bottom:8px;">â• æ·»åŠ æ–°è§„åˆ™</div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <input type="text" id="new-rule-keyword" placeholder="å…³é”®è¯ï¼ˆå¦‚ï¼šå°ç ï¼‰" style="flex:1;min-width:100px;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:13px;">
                        <select id="new-rule-type" onchange="onRuleTypeChange()" style="flex:1;min-width:120px;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:13px;">
                            <option value="">é€‰æ‹©ç±»å‹</option>
                            <optgroup label="â”€â”€â”€ ç‰¹ç ç›¸å…³ â”€â”€â”€">
                                <option value="T01">ç‰¹ç ï¼ˆå•å·ï¼‰</option>
                                <option value="T01_EXPAND">ç‰¹ç ï¼ˆå±•å¼€å¤šå·ï¼‰</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ å¤§å°å•åŒ â”€â”€â”€">
                                <option value="XS">å°æ•° (1-24)</option>
                                <option value="DS">å¤§æ•° (25-48)</option>
                                <option value="ODD">å•æ•°</option>
                                <option value="EVEN">åŒæ•°</option>
                                <option value="HXS">åˆå° (0-6)</option>
                                <option value="HDS">åˆå¤§ (7-13)</option>
                                <option value="HODD">åˆå•</option>
                                <option value="HEVEN">åˆåŒ</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ æ³¢è‰² â”€â”€â”€">
                                <option value="C1">çº¢æ³¢</option>
                                <option value="C2">è“æ³¢</option>
                                <option value="C3">ç»¿æ³¢</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ ç”Ÿè‚–ç±» â”€â”€â”€">
                                <option value="PT1">å¹³ç‰¹ä¸€è‚–</option>
                                <option value="TX">ç‰¹è‚–</option>
                                <option value="ZX">æ­£è‚–</option>
                                <option value="SX">ç”Ÿè‚–</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ å¹³ç‰¹ â”€â”€â”€">
                                <option value="PT2">å¹³ç‰¹äºŒè¿è‚–</option>
                                <option value="PT3">å¹³ç‰¹ä¸‰è¿è‚–</option>
                                <option value="PTW">å¹³ç‰¹å°¾æ•°</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ è¿ç  â”€â”€â”€">
                                <option value="E2">äºŒä¸­äºŒ</option>
                                <option value="S3">ä¸‰ä¸­ä¸‰</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ ä¸ä¸­ â”€â”€â”€">
                                <option value="BZ5">äº”ä¸ä¸­</option>
                                <option value="BZ6">å…­ä¸ä¸­</option>
                                <option value="BZ7">ä¸ƒä¸ä¸­</option>
                                <option value="BZ8">å…«ä¸ä¸­</option>
                                <option value="BZ9">ä¹ä¸ä¸­</option>
                                <option value="BZ10">åä¸ä¸­</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ å…¶ä»– â”€â”€â”€">
                                <option value="DP">å•å¹³/å¹³ç </option>
                                <option value="TS">å¤´æ•°</option>
                                <option value="WS">å°¾æ•°</option>
                                <option value="WX">äº”è¡Œ</option>
                                <option value="JY">å®¶ç¦½é‡å…½</option>
                                <option value="ZH">æ€»å’Œå¤§å°å•åŒ</option>
                                <option value="BB">åŠæ³¢</option>
                                <option value="SX6">å…­è‚–</option>
                                <option value="HX">åˆè‚–</option>
                            </optgroup>
                        </select>
                    </div>
                    <button onclick="addCustomRule()" style="width:100%;margin-top:10px;padding:10px;background:linear-gradient(90deg,#f59e0b,#d97706);color:white;border:none;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">
                        â• æ·»åŠ è§„åˆ™
                    </button>
                </div>
                
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="flex:1;font-size:10px;color:#666;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;">
                        âš ï¸ å…³é”®è¯åªå¡«åç§°ï¼Œä¸å¸¦é‡‘é¢<br>
                        ğŸ’¡ è¯†åˆ«é¡ºåºï¼šè‡ªå®šä¹‰è§„åˆ™ â†’ ç³»ç»Ÿè§„åˆ™ â†’ AIæ™ºèƒ½è¯†åˆ«
                    </div>
                    <button onclick="showCustomRuleHelp()" style="padding:8px 12px;background:rgba(102,126,234,0.3);border:1px solid rgba(102,126,234,0.5);border-radius:6px;color:#a78bfa;font-size:11px;cursor:pointer;white-space:nowrap;">
                        â“å¸®åŠ©
                    </button>
                </div>
            </div>
            
            <!-- ğŸ†• v3.7 è‡ªå®šä¹‰è§„åˆ™å¸®åŠ©å¼¹çª— -->
            <div id="custom-rule-help-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;overflow-y:auto;">
                <div style="max-width:400px;margin:30px auto;background:#1a1a2e;border-radius:12px;overflow:hidden;">
                    <div style="background:linear-gradient(90deg,#667eea,#764ba2);padding:15px;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-weight:bold;color:#fff;font-size:16px;">â“ è‡ªå®šä¹‰è§„åˆ™ä½¿ç”¨è¯´æ˜</span>
                        <button onclick="closeCustomRuleHelp()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">Ã—</button>
                    </div>
                    <div style="padding:16px;font-size:13px;color:#ccc;line-height:1.6;">
                        <div style="margin-bottom:16px;">
                            <div style="color:#fbbf24;font-weight:bold;margin-bottom:8px;">ğŸ“Œ åŠŸèƒ½è¯´æ˜</div>
                            <div style="color:#999;">å½“ç³»ç»Ÿæ— æ³•è¯†åˆ«æ‚¨è¾“å…¥çš„è¯è¯­æ—¶ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è§„åˆ™ï¼Œå‘Šè¯‰ç³»ç»Ÿè¿™ä¸ªè¯è¯­ä»£è¡¨ä»€ä¹ˆç©æ³•ç±»å‹ã€‚</div>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <div style="color:#4ade80;font-weight:bold;margin-bottom:8px;">âœ… æ­£ç¡®ç¤ºä¾‹</div>
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;font-size:12px;">
                                â€¢ å…³é”®è¯å¡«ï¼š<b style="color:#fff;">å°çƒ</b>ï¼Œç±»å‹é€‰ï¼š<b style="color:#fff;">ç‰¹ç (å±•å¼€å¤šå·)</b><br>
                                â€¢ å…³é”®è¯å¡«ï¼š<b style="color:#fff;">çº¢</b>ï¼Œç±»å‹é€‰ï¼š<b style="color:#fff;">çº¢æ³¢</b><br>
                                â€¢ å…³é”®è¯å¡«ï¼š<b style="color:#fff;">çŒªçŒª</b>ï¼Œç±»å‹é€‰ï¼š<b style="color:#fff;">ç”Ÿè‚–</b>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <div style="color:#f87171;font-weight:bold;margin-bottom:8px;">âŒ é”™è¯¯ç¤ºä¾‹</div>
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;font-size:12px;">
                                â€¢ <s style="color:#888;">å°çƒ 100</s> â† ä¸è¦å¸¦é‡‘é¢<br>
                                â€¢ <s style="color:#888;">å°çƒå„20</s> â† ä¸è¦å¸¦"å„"å­—
                            </div>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <div style="color:#60a5fa;font-weight:bold;margin-bottom:8px;">ğŸ’¡ ä½¿ç”¨æµç¨‹</div>
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;font-size:12px;">
                                1. åœ¨å·¦è¾¹è¾“å…¥æ¡†å¡«å†™<b style="color:#fff;">å…³é”®è¯</b><br>
                                2. åœ¨å³è¾¹ä¸‹æ‹‰æ¡†é€‰æ‹©<b style="color:#fff;">å¯¹åº”ç±»å‹</b><br>
                                3. ç‚¹å‡»<b style="color:#f59e0b;">æ·»åŠ è§„åˆ™</b>æŒ‰é’®<br>
                                4. ç‚¹å‡»<b style="color:#e94560;">ä¿å­˜è®¾ç½®</b>å³å¯ç”Ÿæ•ˆ
                            </div>
                        </div>
                        
                        <div style="margin-bottom:12px;">
                            <div style="color:#c084fc;font-weight:bold;margin-bottom:8px;">ğŸ”„ è¯†åˆ«é¡ºåº</div>
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;font-size:12px;">
                                ç³»ç»Ÿä¼šæŒ‰ä»¥ä¸‹é¡ºåºè¯†åˆ«æ‚¨çš„è¾“å…¥ï¼š<br>
                                <b style="color:#fbbf24;">â‘  æ‚¨è®¾ç½®çš„è§„åˆ™</b> â†’ <b style="color:#60a5fa;">â‘¡ ç³»ç»Ÿå†…ç½®è§„åˆ™</b> â†’ <b style="color:#4ade80;">â‘¢ AIæ™ºèƒ½è¯†åˆ«</b>
                            </div>
                        </div>
                        
                        <button onclick="closeCustomRuleHelp()" style="width:100%;padding:12px;background:linear-gradient(90deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;margin-top:8px;">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ†• v3.6 ç‰¹ç å±•å¼€è®¾ç½®å¼¹çª— -->
            <div id="expand-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;overflow-y:auto;">
                <div style="max-width:400px;margin:40px auto;background:#1a1a2e;border-radius:12px;overflow:hidden;">
                    <div style="background:linear-gradient(90deg,#f59e0b,#d97706);padding:15px;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-weight:bold;color:#fff;font-size:16px;">ğŸ“Š ç‰¹ç å±•å¼€è®¾ç½®</span>
                        <button onclick="closeExpandModal()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">Ã—</button>
                    </div>
                    <div style="padding:20px;">
                        <div style="margin-bottom:20px;">
                            <div style="font-size:12px;color:#888;margin-bottom:8px;">å…³é”®è¯ï¼š<b id="expand-modal-keyword" style="color:#fbbf24;"></b></div>
                        </div>
                        
                        <!-- å¿«æ·é¢„è®¾æŒ‰é’® -->
                        <div style="margin-bottom:20px;">
                            <div style="font-size:13px;color:#fff;margin-bottom:10px;font-weight:bold;">ğŸš€ å¿«æ·é¢„è®¾ï¼ˆç‚¹å‡»è‡ªåŠ¨å¡«å……ï¼‰</div>
                            
                            <div style="margin-bottom:12px;">
                                <div style="font-size:11px;color:#888;margin-bottom:6px;">å¤§å°èŒƒå›´ï¼š</div>
                                <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                    <button onclick="fillPreset('small')" class="preset-btn" style="padding:8px 12px;background:rgba(76,175,80,0.2);border:1px solid #4caf50;border-radius:6px;color:#81c784;font-size:11px;cursor:pointer;">å°æ•° 1-24</button>
                                    <button onclick="fillPreset('big')" class="preset-btn" style="padding:8px 12px;background:rgba(244,67,54,0.2);border:1px solid #f44336;border-radius:6px;color:#ef9a9a;font-size:11px;cursor:pointer;">å¤§æ•° 25-49</button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:12px;">
                                <div style="font-size:11px;color:#888;margin-bottom:6px;">å°¾æ•°ï¼š</div>
                                <div style="display:flex;flex-wrap:wrap;gap:4px;">
                                    <button onclick="fillPreset('tail0')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾0</button>
                                    <button onclick="fillPreset('tail1')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾1</button>
                                    <button onclick="fillPreset('tail2')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾2</button>
                                    <button onclick="fillPreset('tail3')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾3</button>
                                    <button onclick="fillPreset('tail4')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾4</button>
                                    <button onclick="fillPreset('tail5')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾5</button>
                                    <button onclick="fillPreset('tail6')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾6</button>
                                    <button onclick="fillPreset('tail7')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾7</button>
                                    <button onclick="fillPreset('tail8')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾8</button>
                                    <button onclick="fillPreset('tail9')" class="preset-btn" style="padding:6px 10px;background:rgba(156,39,176,0.2);border:1px solid #9c27b0;border-radius:4px;color:#ce93d8;font-size:10px;cursor:pointer;">å°¾9</button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:12px;">
                                <div style="font-size:11px;color:#888;margin-bottom:6px;">æ³¢è‰²ï¼š</div>
                                <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                    <button onclick="fillPreset('red')" class="preset-btn" style="padding:8px 12px;background:rgba(244,67,54,0.2);border:1px solid #f44336;border-radius:6px;color:#ef9a9a;font-size:11px;cursor:pointer;">ğŸ”´ çº¢æ³¢ 17ä¸ª</button>
                                    <button onclick="fillPreset('blue')" class="preset-btn" style="padding:8px 12px;background:rgba(33,150,243,0.2);border:1px solid #2196f3;border-radius:6px;color:#90caf9;font-size:11px;cursor:pointer;">ğŸ”µ è“æ³¢ 16ä¸ª</button>
                                    <button onclick="fillPreset('green')" class="preset-btn" style="padding:8px 12px;background:rgba(76,175,80,0.2);border:1px solid #4caf50;border-radius:6px;color:#81c784;font-size:11px;cursor:pointer;">ğŸŸ¢ ç»¿æ³¢ 16ä¸ª</button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:12px;">
                                <div style="font-size:11px;color:#888;margin-bottom:6px;">ç”Ÿè‚–ï¼ˆ2025è›‡å¹´ï¼‰ï¼š</div>
                                <div style="display:flex;flex-wrap:wrap;gap:4px;">
                                    <button onclick="fillPreset('Z1')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ­é¼ 4ä¸ª</button>
                                    <button onclick="fillPreset('Z2')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ‚ç‰›4ä¸ª</button>
                                    <button onclick="fillPreset('Z3')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ¯è™4ä¸ª</button>
                                    <button onclick="fillPreset('Z4')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ°å…”4ä¸ª</button>
                                    <button onclick="fillPreset('Z5')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ²é¾™4ä¸ª</button>
                                    <button onclick="fillPreset('Z6')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸè›‡5ä¸ª</button>
                                    <button onclick="fillPreset('Z7')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ´é©¬4ä¸ª</button>
                                    <button onclick="fillPreset('Z8')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ‘ç¾Š4ä¸ª</button>
                                    <button onclick="fillPreset('Z9')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸµçŒ´4ä¸ª</button>
                                    <button onclick="fillPreset('Z10')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ”é¸¡4ä¸ª</button>
                                    <button onclick="fillPreset('Z11')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ¶ç‹—4ä¸ª</button>
                                    <button onclick="fillPreset('Z12')" class="preset-btn" style="padding:6px 10px;background:rgba(255,152,0,0.2);border:1px solid #ff9800;border-radius:4px;color:#ffcc80;font-size:10px;cursor:pointer;">ğŸ·çŒª4ä¸ª</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å·²é€‰å·ç  -->
                        <div style="margin-bottom:20px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                                <div style="font-size:13px;color:#fff;font-weight:bold;">ğŸ“ å·²é€‰å·ç </div>
                                <div style="display:flex;gap:6px;">
                                    <button id="filter-odd-btn" onclick="toggleOddEvenFilter('odd')" class="filter-toggle-btn" style="padding:4px 10px;background:transparent;border:2px solid #ff9800;border-radius:4px;color:#ff9800;font-size:10px;cursor:pointer;transition:all 0.2s;">å•æ•°</button>
                                    <button id="filter-even-btn" onclick="toggleOddEvenFilter('even')" class="filter-toggle-btn" style="padding:4px 10px;background:transparent;border:2px solid #ff9800;border-radius:4px;color:#ff9800;font-size:10px;cursor:pointer;transition:all 0.2s;">åŒæ•°</button>
                                </div>
                            </div>
                            <textarea id="expand-numbers-input" placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è‡ªåŠ¨å¡«å……ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥ï¼ˆå¦‚ï¼š1,2,3,4,5ï¼‰" style="width:100%;height:60px;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:12px;resize:none;box-sizing:border-box;"></textarea>
                            <div id="expand-numbers-count" style="font-size:10px;color:#888;margin-top:4px;text-align:right;">å·²é€‰ 0 ä¸ªå·ç </div>
                        </div>
                        
                        <!-- é‡‘é¢æ¨¡å¼ -->
                        <div style="margin-bottom:20px;">
                            <div style="font-size:13px;color:#fff;margin-bottom:8px;font-weight:bold;">ğŸ’° é‡‘é¢æ¨¡å¼</div>
                            <div style="display:flex;gap:10px;">
                                <label style="flex:1;display:flex;align-items:center;gap:6px;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="amount-mode" value="each" checked style="width:16px;height:16px;">
                                    <span style="font-size:11px;color:#ccc;">æ¯ä¸ªå·ç è¯¥é‡‘é¢</span>
                                </label>
                                <label style="flex:1;display:flex;align-items:center;gap:6px;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="amount-mode" value="total" style="width:16px;height:16px;">
                                    <span style="font-size:11px;color:#ccc;">æ€»é‡‘é¢å¹³å‡åˆ†</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeExpandModal()" style="flex:1;padding:12px;background:rgba(255,255,255,0.1);color:#ccc;border:1px solid rgba(255,255,255,0.2);border-radius:6px;font-size:13px;cursor:pointer;">å–æ¶ˆ</button>
                            <button onclick="confirmExpandRule()" style="flex:1;padding:12px;background:linear-gradient(90deg,#f59e0b,#d97706);color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">âœ“ ç¡®å®šæ·»åŠ </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="saveFormatSettings()" style="width:100%;padding:12px;background:linear-gradient(90deg,#e94560,#c23a51);color:white;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;margin-top:15px;">
                ğŸ’¾ ä¿å­˜è®¾ç½®
            </button>
            
            <button onclick="resetFormatSettings()" style="width:100%;padding:10px;background:transparent;color:#888;border:1px solid rgba(255,255,255,0.2);border-radius:8px;font-size:13px;cursor:pointer;margin-top:10px;">
                ğŸ”„ æ¢å¤é»˜è®¤è®¾ç½®
            </button>
        </div>
        
        <!-- å‚æ•°è®¾ç½®é¡µé¢ -->
        <div class="page" id="page-params">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('page-main')">â†</button>
                <div class="page-title">å‚æ•°è®¾ç½®</div>
            </div>
            
            <!-- AIæ™ºèƒ½è§£æè®¾ç½®ï¼ˆä»è‡ªå®šä¹‰æ ¼å¼é¡µé¢ç§»å…¥ï¼‰ -->
            <div class="setting-group" style="background:linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2));border:1px solid rgba(102,126,234,0.3);">
                <div class="setting-group-title" style="color:#a78bfa;">ğŸ¤– AIæ™ºèƒ½è§£æ</div>
                <div style="font-size:12px;color:#888;margin-bottom:12px;">
                    å¼€å¯åå¯è‡ªåŠ¨è¯†åˆ«å„ç§å¤æ‚æ ¼å¼ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
                </div>
                
                <div class="setting-item">
                    <span class="setting-item-label">å¯ç”¨AIæ™ºèƒ½è§£æ</span>
                    <input type="checkbox" id="ai-parse-enabled" checked style="width:20px;height:20px;">
                </div>
                
                <!-- AIæ¨¡å‹åˆ‡æ¢æŒ‰é’® -->
                    <div style="margin-top:12px;">
                    <div style="font-size:12px;color:#888;margin-bottom:8px;">é€‰æ‹©AIæ¨¡å‹ï¼š</div>
                    <div id="ai-model-buttons" style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button type="button" class="ai-model-btn active" data-provider="tuzi" onclick="switchAIModel('tuzi')">
                            ğŸŒ è°·æ­Œ
                        </button>
                        <button type="button" class="ai-model-btn" data-provider="deepseek" onclick="switchAIModel('deepseek')">
                            ğŸš€ DS
                        </button>
                        <button type="button" class="ai-model-btn" data-provider="zhipu" onclick="switchAIModel('zhipu')">
                            ğŸ§  æ™ºè°±
                        </button>
                        <button type="button" class="ai-model-btn" data-provider="qwen" onclick="switchAIModel('qwen')">
                            â˜ï¸ åƒé—®
                        </button>
                        <button type="button" class="ai-model-btn" data-provider="claude" onclick="switchAIModel('claude')">
                            ğŸ¤– Claude
                        </button>
                        <button type="button" class="ai-model-btn" data-provider="gpt" onclick="switchAIModel('gpt')">
                            ğŸ’¡ GPT
                        </button>
                    </div>
                    <div id="ai-model-status" style="margin-top:8px;padding:8px;background:rgba(139,92,246,0.1);border-radius:6px;font-size:11px;color:#a78bfa;">
                        âœ… å½“å‰ï¼šGeminiï¼ˆå…”å­API Â· é¦™æ¸¯æœåŠ¡å™¨ï¼‰
                    </div>
                </div>
                
                <!-- éšè—çš„é…ç½® -->
                <div style="display:none;">
                    <select id="ai-provider">
                        <option value="tuzi" selected>Geminiï¼ˆå…”å­APIï¼‰</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="zhipu">æ™ºè°±GLM</option>
                        <option value="qwen">é€šä¹‰åƒé—®</option>
                        <option value="claude">Claude Opus</option>
                        <option value="gpt">GPT 5.1</option>
                        <option value="tuzi">Gemini 3 Pro</option>
                    </select>
                    <input type="hidden" id="ai-api-key" value="">
                </div>
            </div>
            
            <!-- å¯¼å…¥å¯¼å‡ºé…ç½®ï¼ˆä»è‡ªå®šä¹‰æ ¼å¼é¡µé¢ç§»å…¥ï¼‰ -->
            <div class="setting-group">
                <div class="setting-group-title">ğŸ“¦ å¯¼å…¥/å¯¼å‡ºé…ç½®</div>
                <div style="font-size:12px;color:#888;margin-bottom:12px;">
                    å¯¼å‡ºé…ç½®å¯åœ¨å…¶ä»–è®¾å¤‡å¯¼å…¥ä½¿ç”¨
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="exportAllSettings()" style="flex:1;padding:10px;background:rgba(102,126,234,0.2);color:#a78bfa;border:1px solid rgba(102,126,234,0.3);border-radius:6px;font-size:12px;cursor:pointer;">
                        ğŸ“¤ å¯¼å‡ºé…ç½®
                    </button>
                    <button onclick="document.getElementById('import-file-params').click()" style="flex:1;padding:10px;background:rgba(76,175,80,0.2);color:#81c784;border:1px solid rgba(76,175,80,0.3);border-radius:6px;font-size:12px;cursor:pointer;">
                        ğŸ“¥ å¯¼å…¥é…ç½®
                    </button>
                    <input type="file" id="import-file-params" accept=".json" style="display:none;" onchange="importAllSettings(event)">
                </div>
                <div style="font-size:10px;color:#666;margin-top:8px;">
                    åŒ…å«ï¼šè‡ªå®šä¹‰è§„åˆ™ + å€ç‡è®¾ç½®
                </div>
            </div>
            
            <button onclick="saveParamSettings()" style="width:100%;padding:12px;background:linear-gradient(90deg,#e94560,#c23a51);color:white;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;margin-top:15px;">
                ğŸ’¾ ä¿å­˜è®¾ç½®
            </button>
        </div>
        
        <!-- æ¿€æ´»é¡µé¢ -->
        <div class="page" id="page-activate">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('page-main')">â†</button>
                <div class="page-title">æ¿€æ´»ä¼šå‘˜</div>
            </div>
            
            <div class="status-card">
                <div class="status-label">æˆæƒçŠ¶æ€</div>
                <div class="status-value trial" id="license-status">è¯•ç”¨æœŸå‰©ä½™ 7 å¤©</div>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">è®¾å¤‡æœºå™¨ç </div>
                <div class="machine-code-display">
                    <div class="machine-code-value" id="machine-code">ç”Ÿæˆä¸­...</div>
                </div>
                <button class="btn btn-primary" onclick="copyMachineCode()" style="width:100%;">
                    <span>ğŸ“‹ å¤åˆ¶æœºå™¨ç </span>
                </button>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">è¾“å…¥æ¿€æ´»ç </div>
                <input type="text" class="license-input" id="license-input" placeholder="XXXX-XXXX-XXXX-XXXX">
                <button class="btn-activate" onclick="activateLicense()">ğŸ”“ æ¿€æ´»</button>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">èµ”ç‡é…ç½®å¤‡ä»½</div>
                <div class="config-btn-row">
                <button class="btn-config btn-export" onclick="showExportOptions()">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
                <button class="btn-config btn-import" onclick="showImportModal()">ğŸ“¥ å¯¼å…¥é…ç½®</button>
                </div>
            </div>
            
        </div>
        
        <!-- æ ¸å¯¹è¯¦æƒ…é¡µé¢ -->
        <div class="page" id="page-check">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('page-main')">â†</button>
                <div class="page-title">æ ¸å¯¹è¯¦æƒ…</div>
            </div>
            
            <!-- æ±‡æ€»ä¿¡æ¯ -->
            <div class="check-summary">
                <div class="check-summary-item">
                    <div class="check-summary-label">æ€»ä¸‹æ³¨</div>
                    <div class="check-summary-value" id="check-total-bet">0</div>
                </div>
                <div class="check-summary-item">
                    <div class="check-summary-label">ä¸­å¥–æ³¨æ•°</div>
                    <div class="check-summary-value" id="check-win-count">0</div>
                </div>
                <div class="check-summary-item">
                    <div class="check-summary-label">ç»“ç®—ç»“æœ</div>
                    <div class="check-summary-value" id="check-result">0</div>
                </div>
            </div>
            
            <!-- è¯¦ç»†åˆ—è¡¨ -->
            <div class="setting-group">
                <div class="setting-group-title">ä¸‹æ³¨æ˜ç»†</div>
                <div class="check-detail-list" id="check-detail-list">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- å‚ç…§è¡¨é¡µé¢ -->
        <div class="page" id="page-reference">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('page-lottery')">â†</button>
                <div class="page-title">å±æ€§å‚ç…§</div>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">ç”Ÿè‚–å‚ç…§è¡¨</div>
                <div class="ref-table-wrap">
                    <table class="ref-table" id="ref-shengxiao"></table>
                </div>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">äº”è¡Œå‚ç…§è¡¨</div>
                <div class="ref-table-wrap">
                    <table class="ref-table" id="ref-wuxing"></table>
                </div>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">æ³¢è‰²å‚ç…§è¡¨</div>
                <div class="ref-table-wrap">
                    <table class="ref-table" id="ref-bose"></table>
                </div>
            </div>
            
            <div class="setting-group">
                <div class="setting-group-title">å®¶ç¦½é‡å…½å‚ç…§è¡¨</div>
                <div class="ref-table-wrap">
                    <table class="ref-table" id="ref-jiaqin"></table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ğŸ†• åˆ†ç»„ç¼–è¾‘å™¨å¼¹çª— v2.4 -->
    <div class="import-modal" id="group-editor-modal" style="display:none;">
        <div class="import-modal-content" style="max-width:95%;width:450px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
            <div class="import-modal-title" style="display:flex;justify-content:space-between;align-items:center;">
                <span>ğŸ“¦ æ‰‹åŠ¨åˆ†ç»„ç¼–è¾‘</span>
                <button onclick="closeGroupEditor()" style="background:none;border:none;color:#888;font-size:20px;cursor:pointer;">Ã—</button>
            </div>
            
            <div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:12px;color:#888;">
                ğŸ’¡ æç¤ºï¼šç‚¹å‡»è¡Œä¹‹é—´çš„ <span style="color:#667eea;">ã€Œ+åˆ†ç»„çº¿ã€</span> æŒ‰é’®æ¥åˆ†éš”ä¸åŒç»„
            </div>
            
            <!-- è¡Œåˆ—è¡¨åŒºåŸŸ -->
            <div id="group-editor-lines" style="flex:1;overflow-y:auto;padding:12px 0;">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- åº•éƒ¨æŒ‰é’® -->
            <div style="display:flex;gap:8px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
                <button onclick="resetGroupEditor()" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);color:#ccc;border:1px solid rgba(255,255,255,0.2);border-radius:6px;font-size:13px;cursor:pointer;">ğŸ”„ é‡ç½®</button>
                <button onclick="applyGroupEdits()" style="flex:2;padding:10px;background:linear-gradient(90deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;">âœ… åº”ç”¨åˆ†ç»„</button>
            </div>
        </div>
    </div>
    
    <!-- æ‰¹é‡è¾¹ç¼˜æµ‹è¯•å¼¹çª— v2.0 -->
    <div class="import-modal" id="batch-test-modal" style="display:none;">
        <div class="import-modal-content" style="max-width:95%;width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
            <div class="import-modal-title" style="display:flex;justify-content:space-between;align-items:center;">
                <span>ğŸ§ª æ‰¹é‡ç²¾å‡†æµ‹è¯• v2.0</span>
                <span id="batch-test-status" style="font-size:11px;color:#4ade80;background:rgba(74,222,128,0.1);padding:2px 8px;border-radius:4px;">å°±ç»ª</span>
                <button onclick="closeBatchTestModal()" style="background:none;border:none;color:#888;font-size:20px;cursor:pointer;">Ã—</button>
            </div>
            
            <!-- ğŸ†• v2.0 Tabåˆ‡æ¢æ  -->
            <div style="display:flex;border-bottom:2px solid rgba(255,255,255,0.1);margin-bottom:8px;">
                <button id="tab-test-cases" onclick="switchBatchTab('cases')" style="flex:1;padding:10px;background:linear-gradient(90deg,#667eea,#764ba2);color:white;border:none;font-size:13px;font-weight:bold;cursor:pointer;border-radius:6px 6px 0 0;">
                    ğŸ“ æµ‹è¯•æ¡ˆä¾‹
                </button>
                <button id="tab-standard-answers" onclick="switchBatchTab('answers')" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);color:#888;border:none;font-size:13px;cursor:pointer;border-radius:6px 6px 0 0;">
                    âœ… æ ‡å‡†ç­”æ¡ˆ
                </button>
            </div>
            
            <!-- æµ‹è¯•è¾“å…¥åŒº -->
            <div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
                <!-- ğŸ†• æµ‹è¯•æ¡ˆä¾‹Tabå†…å®¹ -->
                <div id="batch-tab-cases" style="margin-bottom:8px;">
                    <label style="font-size:11px;color:#888;display:block;margin-bottom:4px;">ğŸ“ ç²˜è´´æµ‹è¯•æ¡ˆä¾‹ï¼ˆç”¨æˆ·è¾“å…¥å†…å®¹ï¼‰ï¼š</label>
                    <textarea id="batch-test-input" oninput="updateQueueCount()" placeholder="æ ¼å¼ï¼š#ç»„N&#10;ç”¨æˆ·è¾“å…¥å†…å®¹ï¼ˆå¯å¤šè¡Œï¼‰&#10;&#10;ç¤ºä¾‹ï¼š&#10;#ç»„1&#10;å…­è‚–é¼ çŒ´ç¾Šé¸¡ç‰›é©¬200ï¼Œé¸¡é¼ çŒ´x10ï¼Œå¹³ç‰¹çŒ´é¸¡å„200&#10;&#10;#ç»„2&#10;ç‰¹ç‰›ã€ç‹—ã€é¸¡å„æ•°30ç‰¹ç¾Šå„æ•°160&#10;ç‰¹05ã€17ã€45ã€11ã€23ã€35å„æ•°50æ–°æ¾³" 
                        style="width:100%;height:140px;padding:8px;border-radius:6px;border:1px solid rgba(102,126,234,0.5);background:rgba(0,0,0,0.3);color:#fff;font-size:12px;font-family:monospace;resize:vertical;box-sizing:border-box;"></textarea>
                </div>
                
                <!-- ğŸ†• æ ‡å‡†ç­”æ¡ˆTabå†…å®¹ -->
                <div id="batch-tab-answers" style="display:none;margin-bottom:8px;">
                    <label style="font-size:11px;color:#888;display:block;margin-bottom:4px;">âœ… ç²˜è´´æ ‡å‡†ç­”æ¡ˆï¼ˆAIç”Ÿæˆæˆ–æ‰‹åŠ¨æ•´ç†ï¼‰ï¼š</label>
                    <textarea id="batch-standard-answers" oninput="updateAnswerCount()" placeholder="æ ¼å¼ï¼š#ç»„N&#10;æ€»æ³¨:X|æ€»æŠ•:X|ä¸­å¥–:X|æ´¾å½©:X|ç›ˆäº:X&#10;---&#10;åºå·|ç±»å‹|åŸæ–‡|å·ç |é‡‘é¢|æ³¨æ•°|å°è®¡|ä¸­å¥–&#10;===&#10;&#10;ç¤ºä¾‹ï¼š&#10;#ç»„1&#10;æ€»æ³¨:54|æ€»æŠ•:3280|ä¸­å¥–:3|æ´¾å½©:12030|ç›ˆäº:+8750&#10;---&#10;1|å…­è‚–|å…­è‚–é¼ çŒ´ç¾Šé¸¡ç‰›é©¬ 200|é¼ ,çŒ´,ç¾Š,é¸¡,ç‰›,é©¬|200|1|200|âœ“&#10;2|ç‰¹ç |é¸¡é¼ çŒ´x10|é¸¡09,21,33,45,é¼ 06,18,30,42,çŒ´10,22,34,46|10|12|120|âœ—&#10;===" 
                        style="width:100%;height:140px;padding:8px;border-radius:6px;border:1px solid rgba(74,222,128,0.5);background:rgba(0,0,0,0.3);color:#fff;font-size:12px;font-family:monospace;resize:vertical;box-sizing:border-box;"></textarea>
                    <div style="font-size:10px;color:#888;margin-top:4px;">
                        ğŸ’¡ æ ‡å‡†ç­”æ¡ˆæ ¼å¼å‚è€ƒï¼š<a href="#" onclick="showAnswerFormatHelp();return false;" style="color:#60a5fa;">æŸ¥çœ‹æ ¼å¼è§„èŒƒ</a>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    <button id="run-batch-test-btn" onclick="runBatchTestV2()" style="padding:8px 20px;background:linear-gradient(90deg,#27ae60,#2ecc71);color:white;border:none;border-radius:6px;font-size:12px;font-weight:bold;cursor:pointer;">
                        â–¶ï¸ å¼€å§‹æµ‹è¯•
                    </button>
                    <button id="stop-batch-test-btn" onclick="stopBatchTest()" style="padding:8px 20px;background:linear-gradient(90deg,#e74c3c,#c0392b);color:white;border:none;border-radius:6px;font-size:12px;font-weight:bold;cursor:pointer;display:none;">
                        â¹ï¸ åœæ­¢
                    </button>
                    <button onclick="clearBatchTest()" style="padding:8px 12px;background:rgba(255,255,255,0.1);color:#ccc;border:1px solid rgba(255,255,255,0.2);border-radius:6px;font-size:11px;cursor:pointer;">
                        ğŸ—‘ï¸ æ¸…ç©º
                    </button>
                    <span style="font-size:11px;color:#888;margin-left:auto;">
                        æ¡ˆä¾‹: <span id="test-queue-count" style="color:#60a5fa;">0</span> | 
                        ç­”æ¡ˆ: <span id="answer-queue-count" style="color:#4ade80;">0</span>
                    </span>
                </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div id="batch-progress-bar" style="display:none;padding:8px 0;">
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span id="batch-progress-text" style="font-size:11px;color:#888;">è¿›åº¦ï¼š0/0</span>
                    <span id="batch-progress-time" style="font-size:11px;color:#888;">é¢„è®¡å‰©ä½™ï¼š--</span>
                </div>
                <div style="height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
                    <div id="batch-progress-fill" style="height:100%;width:0%;background:linear-gradient(90deg,#27ae60,#2ecc71);transition:width 0.3s;"></div>
                </div>
            </div>
            
            <!-- ç»“æœåŒºåŸŸ -->
            <div style="flex:1;overflow-y:auto;padding:8px 0;">
                <!-- ç»Ÿè®¡æ‘˜è¦ -->
                <div id="batch-summary" style="display:none;margin-bottom:12px;padding:10px;background:rgba(0,0,0,0.3);border-radius:6px;">
                    <div style="display:flex;justify-content:space-around;text-align:center;">
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#4ade80;" id="batch-pass-count">0</div>
                            <div style="font-size:10px;color:#888;">âœ… é€šè¿‡</div>
                        </div>
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#ef5350;" id="batch-fail-count">0</div>
                            <div style="font-size:10px;color:#888;">âŒ å¤±è´¥</div>
                        </div>
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#ffa726;" id="batch-warn-count">0</div>
                            <div style="font-size:10px;color:#888;">âš ï¸ å¾…éªŒè¯</div>
                        </div>
                        <div>
                            <div style="font-size:20px;font-weight:bold;color:#60a5fa;" id="batch-avg-time">0</div>
                            <div style="font-size:10px;color:#888;">âš¡ å¹³å‡è€—æ—¶(ms)</div>
                        </div>
                    </div>
                </div>
                
                <!-- è¯¦ç»†ç»“æœåˆ—è¡¨ -->
                <div id="batch-result-list" style="font-size:11px;"></div>
            </div>
            
            <!-- åº•éƒ¨æ“ä½œ -->
            <div style="padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;">
                <button onclick="exportBatchReport('json')" style="flex:1;padding:10px;background:linear-gradient(90deg,#3498db,#2980b9);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                    ğŸ“¤ å¯¼å‡ºJSONæŠ¥å‘Š
                </button>
                <button onclick="exportBatchReport('csv')" style="flex:1;padding:10px;background:linear-gradient(90deg,#27ae60,#2ecc71);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                    ğŸ“Š å¯¼å‡ºCSVæŠ¥å‘Š
                </button>
                <button onclick="exportBatchReport('log')" style="flex:1;padding:10px;background:linear-gradient(90deg,#9b59b6,#8e44ad);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                    ğŸ“‹ å¯¼å‡ºå¤„ç†æ—¥å¿—
                </button>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å‡ºé€‰é¡¹å¼¹çª— -->
    <div class="import-modal" id="export-modal">
        <div class="import-modal-content">
            <div class="import-modal-title">ğŸ“¤ å¯¼å‡ºé…ç½®</div>
            <div style="display:flex;flex-direction:column;gap:12px;">
                <button onclick="exportCopy()" style="width:100%;padding:15px;background:linear-gradient(90deg,#2ecc71,#27ae60);color:white;border:none;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">
                    ğŸ“‹ å¤åˆ¶é…ç½®æ–‡æœ¬ï¼ˆæ¨èï¼‰
                </button>
                <div style="color:#888;font-size:12px;text-align:center;">
                    å¤åˆ¶åå¯ç›´æ¥ç²˜è´´åˆ°å¾®ä¿¡å‘é€
                </div>
                <button onclick="exportDownload()" style="width:100%;padding:15px;background:rgba(255,255,255,0.1);color:#ccc;border:1px solid rgba(255,255,255,0.2);border-radius:10px;font-size:14px;cursor:pointer;">
                    ğŸ’¾ ä¸‹è½½ä¸ºæ–‡ä»¶
                </button>
            </div>
            <button onclick="hideExportModal()" style="width:100%;padding:12px;background:transparent;color:#666;border:none;font-size:14px;cursor:pointer;margin-top:15px;">
                å–æ¶ˆ
            </button>
        </div>
    </div>
    
    <!-- å¯¼å…¥é…ç½®å¼¹çª— -->
    <div class="import-modal" id="import-modal">
        <div class="import-modal-content">
            <div class="import-modal-title">ğŸ“¥ å¯¼å…¥é…ç½®</div>
            
            <div style="background:rgba(46,204,113,0.1);border:1px solid rgba(46,204,113,0.3);border-radius:8px;padding:12px;margin-bottom:15px;">
                <div style="color:#2ecc71;font-size:13px;font-weight:bold;margin-bottom:8px;">ğŸ’¡ æ¨èæ–¹å¼ï¼šç²˜è´´å¯¼å…¥</div>
                <div style="color:#888;font-size:12px;">
                    1. åœ¨å¾®ä¿¡æ‰“å¼€æ”¶åˆ°çš„é…ç½®æ–‡ä»¶<br>
                    2. é•¿æŒ‰å†…å®¹ â†’ å…¨é€‰ â†’ å¤åˆ¶<br>
                    3. å›åˆ°è¿™é‡Œç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†
                </div>
            </div>
            
            <textarea class="import-textarea" id="import-textarea" placeholder="é•¿æŒ‰æ­¤å¤„ç²˜è´´é…ç½®å†…å®¹...&#10;&#10;ï¼ˆä»å¾®ä¿¡å¤åˆ¶çš„é…ç½®æ–‡æœ¬ï¼‰" style="height:120px;"></textarea>
            
            <button onclick="importConfig()" style="width:100%;padding:14px;background:linear-gradient(90deg,#2ecc71,#27ae60);color:white;border:none;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;margin:10px 0;">
                âœ… ç¡®è®¤å¯¼å…¥
            </button>
            
            <div style="text-align:center;color:#666;font-size:12px;margin:15px 0;">â€” æˆ–è€…é€‰æ‹©æ–‡ä»¶ â€”</div>
            
            <!-- æ–‡ä»¶é€‰æ‹© - åªæ¥å—æ–‡æœ¬æ–‡ä»¶ï¼Œé¿å…æ˜¾ç¤ºæ‹ç…§é€‰é¡¹ -->
            <input type="file" id="import-file" accept=".txt,.json,text/plain,application/json" style="display:none;" onchange="handleFileSelect(event)">
            <button onclick="document.getElementById('import-file').click()" style="width:100%;padding:12px;background:rgba(255,255,255,0.1);color:#aaa;border:1px solid rgba(255,255,255,0.2);border-radius:8px;font-size:13px;cursor:pointer;">
                ğŸ“ ä»æ–‡ä»¶Appé€‰æ‹©
            </button>
            
            <button onclick="hideImportModal()" style="width:100%;padding:12px;background:transparent;color:#666;border:none;font-size:13px;cursor:pointer;margin-top:10px;">
                å–æ¶ˆ
            </button>
        </div>
    </div>
    
    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— -->
    <!-- â•‘          ç²¾å‡†çº é”™ç‰ˆ - åé¦ˆé¡µé¢ï¼ˆç´§å‡‘åˆ—è¡¨è®¾è®¡ï¼‰                   â•‘ -->
    <!-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-feedback">
        <!-- é¡¶éƒ¨å›ºå®šæ  -->
        <div id="feedback-fixed-header" style="position:sticky;top:0;z-index:100;background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.1);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <button class="btn-back" onclick="showPage('page-main')" style="padding:5px 10px;background:rgba(255,255,255,0.1);border:none;border-radius:5px;color:#fff;font-size:14px;cursor:pointer;">â† è¿”å›</button>
            </div>
            
            <!-- ğŸ†• v3.11.24 å¼€å¥–å·ç åŒºåŸŸï¼ˆæœŸå·åœ¨å·¦ï¼Œå·ç çƒåœ¨å³ï¼‰æ”¯æŒåŒå¼€å¥– -->
            <div id="fb-lottery-section" style="margin-bottom:8px;">
                <!-- åŠ¨æ€æ¸²æŸ“ -->
            </div>
            
            <div style="display:flex;justify-content:space-between;font-size:12px;color:#aaa;flex-wrap:wrap;gap:4px;">
                <span>æ€»æŠ•: <span id="fb-total-bet" style="color:#fff;">0</span>å…ƒ</span>
                <span>ä¸­<span id="fb-win-count" style="color:#4caf50;">0</span>æ³¨</span>
                <span>æ´¾å½©: <span id="fb-win-amount" style="color:#fbbf24;">0</span>å…ƒ</span>
                <span>ç›ˆäº: <span id="fb-total-result" style="font-weight:bold;">+0</span></span>
            </div>
        </div>
        
        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div id="feedback-list" style="padding:10px;"></div>
        
        <!-- åº•éƒ¨æäº¤æŒ‰é’®ï¼ˆå›ºå®šï¼‰ -->
        <div style="position:sticky;bottom:0;padding:10px 12px;background:linear-gradient(0deg, #1a1a2e 80%, transparent);border-top:1px solid rgba(255,255,255,0.05);">
            <button id="fb-submit-btn" onclick="submitFeedbackNew()" style="width:100%;padding:14px;background:linear-gradient(90deg,#e94560,#c23a51);color:white;border:none;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;">
                ğŸ“¤ æäº¤é”™è¯¯æŠ¥å‘Š (å·²é€‰ <span id="fb-error-count">0</span> é¡¹)
                </button>
            <div style="text-align:center;color:#555;font-size:10px;margin-top:6px;">
                ä»…æäº¤æ ‡è®°ä¸ºé”™è¯¯çš„æ¡ç›®
            </div>
        </div>
    </div>
    
    <script>
    // ==================== å…­åˆå½©æ•°æ® ====================
    const LHC_DATA = {
        // ç”Ÿè‚–å¯¹åº”å·ç ï¼ˆ2024å¹´ä¸ºåŸºå‡†ï¼‰
        shengxiao: {
            'é¼ ': [6, 18, 30, 42],
            'ç‰›': [5, 17, 29, 41],
            'è™': [4, 16, 28, 40],
            'å…”': [3, 15, 27, 39],
            'é¾™': [2, 14, 26, 38],
            'è›‡': [1, 13, 25, 37, 49],
            'é©¬': [12, 24, 36, 48],
            'ç¾Š': [11, 23, 35, 47],
            'çŒ´': [10, 22, 34, 46],
            'é¸¡': [9, 21, 33, 45],
            'ç‹—': [8, 20, 32, 44],
            'çŒª': [7, 19, 31, 43]
        },
        
        // äº”è¡Œå¯¹åº”å·ç 
        wuxing: {
            'é‡‘': [3, 4, 11, 12, 25, 26, 33, 34, 41, 42],
            'æœ¨': [7, 8, 15, 16, 23, 24, 37, 38, 45, 46],
            'æ°´': [13, 14, 21, 22, 29, 30, 43, 44],
            'ç«': [1, 2, 9, 10, 17, 18, 31, 32, 39, 40, 47, 48],
            'åœŸ': [5, 6, 19, 20, 27, 28, 35, 36, 49]
        },
        
        // æ³¢è‰²å¯¹åº”å·ç 
        bose: {
            'çº¢æ³¢': [1, 2, 7, 8, 12, 13, 18, 19, 23, 24, 29, 30, 34, 35, 40, 45, 46],
            'è“æ³¢': [3, 4, 9, 10, 14, 15, 20, 25, 26, 31, 36, 37, 41, 42, 47, 48],
            'ç»¿æ³¢': [5, 6, 11, 16, 17, 21, 22, 27, 28, 32, 33, 38, 39, 43, 44, 49]
        },
        
        // å®¶ç¦½é‡å…½
        jiaqin: {
            'å®¶ç¦½': ['ç‰›', 'é©¬', 'ç¾Š', 'é¸¡', 'ç‹—', 'çŒª'],
            'é‡å…½': ['é¼ ', 'è™', 'å…”', 'é¾™', 'è›‡', 'çŒ´']
        }
    };
    
    // ==================== çŠ¶æ€ç®¡ç† ====================
    let appState = {
        lotteryNumbers: [],  // å½“å‰æ˜¾ç¤ºçš„å¼€å¥–å·ç  [1,2,3,4,5,6,ç‰¹ç ]
        currentLotteryType: 'xam',  // å½“å‰é€‰ä¸­çš„å½©ç§ï¼šxam=æ–°æ¾³é—¨, hk=é¦™æ¸¯
        lotteryData: {
            xam: { numbers: [], issue: '', time: '', source: '' },  // æ–°æ¾³é—¨æ•°æ®
            hk: { numbers: [], issue: '', time: '', source: '' }    // é¦™æ¸¯æ•°æ®
        },
        lotteryHistory: {
            xam: [],  // æ–°æ¾³é—¨å†å²è®°å½•ï¼Œæœ€å¤š10æœŸ [{numbers, issue, time, source}, ...]
            hk: []    // é¦™æ¸¯å†å²è®°å½•ï¼Œæœ€å¤š10æœŸ
        },
        odds: {
            tema: 43,
            shengxiao: 12,
            red: 2.8,
            blue: 2.8,
            green: 2.8,
            daxiao: 2,
            danshuang: 2
        },
        machineCode: '',
        isActivated: false,
        trialDaysLeft: 7
    };
    
    // ==================== ğŸ†• v3.11.67 è°ƒè¯•å¼€å…³ ====================
    // ç”Ÿäº§ç¯å¢ƒè®¾ä¸º falseï¼Œå¯æå‡JSæ‰§è¡Œé€Ÿåº¦ 10 å€
    // è°ƒè¯•æ—¶è®¾ä¸º trueï¼Œå¯æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
    const IS_DEBUG = false;
    
    // ==================== è°ƒè¯•ä¿¡æ¯å­˜å‚¨ï¼ˆå®Œæ•´æ•°æ®é“¾æ¡ v3.2ï¼‰ ====================
    let debugInfo = {
        // ğŸ“Œ ç¬¬1-2æ­¥ï¼šè¾“å…¥é˜¶æ®µ
        originalInput: '',     // ç”¨æˆ·åŸå§‹è¾“å…¥
        sanitizedInput: '',    // ä»£å·è½¬æ¢åçš„è¾“å…¥ï¼ˆZä»£å·æ ¼å¼ï¼‰
        normalizeInfo: '',     // è§„èŒƒåŒ–ä¿¡æ¯
        
        // ğŸ“Œ ç¬¬3æ­¥ï¼šAI/æ­£åˆ™é˜¶æ®µ
        aiInput: '',           // å‘é€ç»™AIçš„å†…å®¹
        aiOutput: '',          // AIåŸå§‹è¾“å‡º
        aiParsed: null,        // AIè§£æåçš„JSON
        modelUsed: '',         // ä½¿ç”¨çš„æ¨¡å‹: regex / deepseek / zhipu...
        latencyMs: 0,          // AIå“åº”è€—æ—¶(æ¯«ç§’)
        
        // ğŸ“Œ ç¬¬4æ­¥ï¼šåç«¯è¯†åˆ«ç»“æœï¼ˆğŸ†• v3.1 æ–°å¢ï¼‰
        extractItems: [],      // æ­£åˆ™/AI è¯†åˆ«çš„æ¯æ¡è¯¦æƒ… [{code,zodiac,nums,amt,raw}]
        
        // ğŸ“Œ ç¬¬5æ­¥ï¼šåç«¯è®¡ç®—ç»“æœï¼ˆğŸ†• v3.1 æ–°å¢ï¼‰
        calcInputCount: 0,     // è¯†åˆ«æ¡æ•°ï¼ˆè¾“å…¥ï¼‰
        calcOutputCount: 0,    // å±•å¼€åæ¡æ•°ï¼ˆè¾“å‡ºï¼‰â­å…³é”®ï¼SXTMåº”å±•å¼€ä¸º4æ¡
        calcItems: [],         // è®¡ç®—åæ¯æ¡è¯¦æƒ… [{code,n,a,z,w,v,r,idx}]
        calcS1: 0,             // æ€»æŠ•å…¥
        calcS2: 0,             // å‘½ä¸­æ•°
        calcS3: 0,             // å‘½ä¸­é‡‘é¢
        calcS4: 0,             // ç»“ç®—
        backendVersion: '',    // ğŸ†• v3.2.1 åç«¯ç‰ˆæœ¬
        
        // ğŸ“Œ ç½‘ç»œè¯Šæ–­
        requestMode: '',       // è¯·æ±‚æ¨¡å¼
        targetUrl: '',         // ç›®æ ‡åœ°å€
        networkError: '',      // ç½‘ç»œé”™è¯¯
        rawResponse: '',       // åŸå§‹å“åº”
        
        // ğŸ“Œ è§£æç»“æœ
        aiBets: [],            // AIè¯†åˆ«çš„ä¸‹æ³¨åˆ—è¡¨
        localBets: [],         // æœ¬åœ°è§£æçš„ä¸‹æ³¨åˆ—è¡¨
        
        // ğŸ“Œ é”™è¯¯ä¿¡æ¯
        lastError: ''          // æœ€åä¸€æ¬¡é”™è¯¯
    };
    
    // æ˜¾ç¤ºAIè¯†åˆ«è¯¦æƒ…
    function showAIDebug() {
        let content = `<div style="max-height:70vh;overflow:auto;font-size:13px;line-height:1.6;">`;
        content += `<h3 style="color:#9b59b6;margin:0 0 10px;">ğŸ¤– AIè¯†åˆ«è¯¦æƒ…</h3>`;
        
        if (debugInfo.lastError) {
            content += `<div style="background:#c0392b;padding:10px;border-radius:6px;margin-bottom:10px;">
                <strong>âŒ é”™è¯¯ï¼š</strong>${debugInfo.lastError}
            </div>`;
        }
        
        // æ˜¾ç¤ºç½‘ç»œè¯Šæ–­ä¿¡æ¯
        if (debugInfo.requestMode || debugInfo.networkError) {
            content += `<div style="background:rgba(52,152,219,0.3);padding:10px;border-radius:6px;margin-bottom:10px;">
                <strong>ğŸŒ ç½‘ç»œè¯Šæ–­ï¼š</strong><br>
                <small>è¯·æ±‚æ¨¡å¼: ${debugInfo.requestMode || 'æœªçŸ¥'}</small><br>
                <small>ç›®æ ‡åœ°å€: ${(debugInfo.targetUrl || '').substring(0, 50)}...</small>`;
            if (debugInfo.networkError) {
                content += `<br><span style="color:#e74c3c;"><strong>âš ï¸ ${debugInfo.networkError}</strong></span>`;
            }
            if (debugInfo.rawResponse && !debugInfo.aiOutput) {
                content += `<br><small style="color:#95a5a6;">åŸå§‹å“åº”: ${(debugInfo.rawResponse || '').substring(0, 100)}...</small>`;
            }
            content += `</div>`;
        }
        
        // æ˜¾ç¤ºå­—ç¬¦è§„èŒƒåŒ–ä¿¡æ¯ï¼ˆè¯Šæ–­æ‰‹æœºè¾“å…¥é—®é¢˜ï¼‰
        if (debugInfo.normalizeInfo) {
            content += `<div style="background:rgba(241,196,15,0.3);padding:10px;border-radius:6px;margin-bottom:10px;">
                <strong>ğŸ“± å­—ç¬¦è§„èŒƒåŒ–ï¼š</strong>${debugInfo.normalizeInfo}
                <br><small style="color:#f1c40f;">ï¼ˆæ£€æµ‹åˆ°ç‰¹æ®Šå­—ç¬¦ï¼Œå·²è‡ªåŠ¨è½¬æ¢ï¼‰</small>
            </div>`;
        }
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ“¤ AIè¾“å…¥ï¼ˆç”¨æˆ·åŸæ–‡ï¼‰ï¼š</strong><br>
            <pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;">${debugInfo.aiInput || 'æ— '}</pre>
        </div>`;
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ“¥ AIåŸå§‹è¾“å‡ºï¼š</strong><br>
            <pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:200px;overflow:auto;">${debugInfo.aiOutput || 'æ— '}</pre>
        </div>`;
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ” AIè¯†åˆ«ç»“æœï¼š</strong><br>`;
        if (debugInfo.aiParsed && debugInfo.aiParsed.items) {
            content += `<table style="width:100%;border-collapse:collapse;margin-top:8px;">
                <tr style="background:rgba(0,0,0,0.3);"><th style="padding:6px;border:1px solid #555;">åŸæ–‡</th><th style="padding:6px;border:1px solid #555;">AIè¯†åˆ«ç±»å‹</th></tr>`;
            for (const item of debugInfo.aiParsed.items) {
                content += `<tr><td style="padding:6px;border:1px solid #555;">${item.raw || ''}</td><td style="padding:6px;border:1px solid #555;color:#9b59b6;font-weight:bold;">${item.type || ''}</td></tr>`;
            }
            content += `</table>`;
        } else {
            content += `<span style="color:#888;">æ— è¯†åˆ«ç»“æœ</span>`;
        }
        content += `</div>`;
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;">
            <strong>ğŸ“Š æœ€ç»ˆæå–çš„ä¸‹æ³¨ï¼ˆ${debugInfo.aiBets.length}æ¡ï¼‰ï¼š</strong><br>`;
        if (debugInfo.aiBets.length > 0) {
            content += `<pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:200px;overflow:auto;">${JSON.stringify(debugInfo.aiBets, null, 2)}</pre>`;
        } else {
            content += `<span style="color:#888;">æ— </span>`;
        }
        content += `</div></div>`;
        
        showDebugModal('ğŸ¤– AIè¯†åˆ«è¯¦æƒ…', content);
    }
    
    // æ˜¾ç¤ºç¨‹åºè¯†åˆ«è¯¦æƒ…
    function showLocalDebug() {
        const input = document.getElementById('bet-input').value.trim();
        
        // é‡æ–°æ‰§è¡Œæœ¬åœ°è§£æ
        const localBets = parseBetInput(input);
        debugInfo.localBets = localBets;
        
        let content = `<div style="max-height:70vh;overflow:auto;font-size:13px;line-height:1.6;">`;
        content += `<h3 style="color:#27ae60;margin:0 0 10px;">ğŸ“‹ ç¨‹åºæœ¬åœ°è¯†åˆ«è¯¦æƒ…</h3>`;
        
        content += `<div style="background:rgba(39,174,96,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ“¤ è¾“å…¥ï¼ˆç”¨æˆ·åŸæ–‡ï¼‰ï¼š</strong><br>
            <pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;">${input || 'æ— '}</pre>
        </div>`;
        
        content += `<div style="background:rgba(39,174,96,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ” é€è¡Œè¯†åˆ«ç»“æœï¼š</strong><br>`;
        const lines = input.split('\n').filter(l => l.trim());
        if (lines.length > 0) {
            content += `<table style="width:100%;border-collapse:collapse;margin-top:8px;">
                <tr style="background:rgba(0,0,0,0.3);"><th style="padding:6px;border:1px solid #555;">åŸæ–‡</th><th style="padding:6px;border:1px solid #555;">ç¨‹åºè¯†åˆ«ç±»å‹</th></tr>`;
            for (const line of lines) {
                const lineBets = parseBetLine(line.trim());
                const types = lineBets.map(b => b.type).join(', ') || 'æœªè¯†åˆ«';
                content += `<tr><td style="padding:6px;border:1px solid #555;">${line}</td><td style="padding:6px;border:1px solid #555;color:#27ae60;font-weight:bold;">${types}</td></tr>`;
            }
            content += `</table>`;
        } else {
            content += `<span style="color:#888;">æ— è¾“å…¥</span>`;
        }
        content += `</div>`;
        
        content += `<div style="background:rgba(39,174,96,0.2);padding:10px;border-radius:6px;">
            <strong>ğŸ“Š æœ€ç»ˆæå–çš„ä¸‹æ³¨ï¼ˆ${localBets.length}æ¡ï¼‰ï¼š</strong><br>`;
        if (localBets.length > 0) {
            content += `<pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:200px;overflow:auto;">${JSON.stringify(localBets, null, 2)}</pre>`;
        } else {
            content += `<span style="color:#888;">æ— </span>`;
        }
        content += `</div></div>`;
        
        showDebugModal('ğŸ“‹ ç¨‹åºè¯†åˆ«è¯¦æƒ…', content);
    }
    
    // ğŸ†• v3.11.44 æ˜¾ç¤ºè°ƒè¯•é¢æ¿ï¼ˆåˆå¹¶AI+ç¨‹åºï¼Œæ”¯æŒTabåˆ‡æ¢ï¼‰
    function showDebugPanel() {
        // ç§»é™¤å·²æœ‰å¼¹çª—
        const existing = document.getElementById('debug-modal');
        if (existing) existing.remove();
        
        const input = document.getElementById('bet-input').value.trim();
        
        // é‡æ–°æ‰§è¡Œæœ¬åœ°è§£æ
        const localBets = parseBetInput(input);
        debugInfo.localBets = localBets;
        
        const modal = document.createElement('div');
        modal.id = 'debug-modal';
        modal.innerHTML = `
            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;justify-content:center;align-items:center;padding:15px;">
                <div style="background:#1a1a2e;border-radius:12px;max-width:600px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:flex;flex-direction:column;">
                    <!-- æ ‡é¢˜æ  -->
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="font-weight:bold;font-size:15px;">ğŸ” è¯†åˆ«è¯¦æƒ…</span>
                        <button onclick="document.getElementById('debug-modal').remove()" style="background:none;border:none;color:white;font-size:22px;cursor:pointer;padding:0 5px;line-height:1;">Ã—</button>
                    </div>
                    
                    <!-- Tabåˆ‡æ¢ -->
                    <div style="display:flex;border-bottom:1px solid rgba(255,255,255,0.1);">
                        <button class="debug-tab active" onclick="switchDebugTab('ai', this)" id="debug-tab-ai">ğŸ¤– AIè¯†åˆ«</button>
                        <button class="debug-tab" onclick="switchDebugTab('local', this)" id="debug-tab-local">ğŸ“‹ ç¨‹åºè¯†åˆ«</button>
                    </div>
                    
                    <!-- å†…å®¹åŒºåŸŸ -->
                    <div style="flex:1;overflow:auto;max-height:calc(90vh - 110px);">
                        <!-- AIè¯†åˆ«å†…å®¹ -->
                        <div id="debug-content-ai" style="padding:16px;font-size:13px;line-height:1.6;">
                            ${generateAIDebugContent()}
                        </div>
                        <!-- ç¨‹åºè¯†åˆ«å†…å®¹ -->
                        <div id="debug-content-local" style="padding:16px;font-size:13px;line-height:1.6;display:none;">
                            ${generateLocalDebugContent(input, localBets)}
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Tabåˆ‡æ¢å‡½æ•°
    function switchDebugTab(tab, btn) {
        // æ›´æ–°Tabæ ·å¼
        document.querySelectorAll('.debug-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        
        // åˆ‡æ¢å†…å®¹
        document.getElementById('debug-content-ai').style.display = tab === 'ai' ? 'block' : 'none';
        document.getElementById('debug-content-local').style.display = tab === 'local' ? 'block' : 'none';
    }
    
    // ç”ŸæˆAIè°ƒè¯•å†…å®¹
    function generateAIDebugContent() {
        let content = '';
        
        if (debugInfo.lastError) {
            content += `<div style="background:#c0392b;padding:10px;border-radius:6px;margin-bottom:10px;">
                <strong>âŒ é”™è¯¯ä¿¡æ¯ï¼š</strong><br>${debugInfo.lastError}
            </div>`;
        }
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ“¤ è¾“å…¥ï¼ˆç”¨æˆ·åŸæ–‡ï¼‰ï¼š</strong><br>
            <pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:120px;overflow:auto;">${debugInfo.sanitizedInput || 'æ— '}</pre>
        </div>`;
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ“¥ AIåŸå§‹è¾“å‡ºï¼š</strong><br>
            <pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:120px;overflow:auto;">${debugInfo.aiRaw || 'æ— '}</pre>
        </div>`;
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ” AIè¯†åˆ«ç»“æœï¼š</strong><br>`;
        if (debugInfo.aiParsed && debugInfo.aiParsed.items) {
            content += `<table style="width:100%;border-collapse:collapse;margin-top:8px;">
                <tr style="background:rgba(0,0,0,0.3);"><th style="padding:6px;border:1px solid #555;text-align:left;">åŸæ–‡</th><th style="padding:6px;border:1px solid #555;">ç±»å‹</th></tr>`;
            for (const item of debugInfo.aiParsed.items) {
                content += `<tr><td style="padding:6px;border:1px solid #555;font-size:12px;">${item.raw || ''}</td><td style="padding:6px;border:1px solid #555;color:#9b59b6;font-weight:bold;">${item.type || ''}</td></tr>`;
            }
            content += `</table>`;
        } else {
            content += `<span style="color:#888;">æ— è¯†åˆ«ç»“æœ</span>`;
        }
        content += `</div>`;
        
        content += `<div style="background:rgba(155,89,182,0.2);padding:10px;border-radius:6px;">
            <strong>ğŸ“Š æœ€ç»ˆä¸‹æ³¨ï¼ˆ${debugInfo.aiBets?.length || 0}æ¡ï¼‰ï¼š</strong><br>`;
        if (debugInfo.aiBets && debugInfo.aiBets.length > 0) {
            content += `<pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:150px;overflow:auto;font-size:11px;">${JSON.stringify(debugInfo.aiBets, null, 2)}</pre>`;
        } else {
            content += `<span style="color:#888;">æ— </span>`;
        }
        content += `</div>`;
        
        return content;
    }
    
    // ç”Ÿæˆç¨‹åºè°ƒè¯•å†…å®¹
    function generateLocalDebugContent(input, localBets) {
        let content = '';
        
        content += `<div style="background:rgba(39,174,96,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ“¤ è¾“å…¥ï¼ˆç”¨æˆ·åŸæ–‡ï¼‰ï¼š</strong><br>
            <pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:120px;overflow:auto;">${input || 'æ— '}</pre>
        </div>`;
        
        content += `<div style="background:rgba(39,174,96,0.2);padding:10px;border-radius:6px;margin-bottom:10px;">
            <strong>ğŸ” é€è¡Œè¯†åˆ«ç»“æœï¼š</strong><br>`;
        const lines = input.split('\n').filter(l => l.trim());
        if (lines.length > 0) {
            content += `<table style="width:100%;border-collapse:collapse;margin-top:8px;">
                <tr style="background:rgba(0,0,0,0.3);"><th style="padding:6px;border:1px solid #555;text-align:left;">åŸæ–‡</th><th style="padding:6px;border:1px solid #555;">ç±»å‹</th></tr>`;
            for (const line of lines) {
                const lineBets = parseBetLine(line.trim());
                const types = lineBets.map(b => b.type).join(', ') || 'æœªè¯†åˆ«';
                content += `<tr><td style="padding:6px;border:1px solid #555;font-size:12px;">${line}</td><td style="padding:6px;border:1px solid #555;color:#27ae60;font-weight:bold;">${types}</td></tr>`;
            }
            content += `</table>`;
        } else {
            content += `<span style="color:#888;">æ— è¾“å…¥</span>`;
        }
        content += `</div>`;
        
        content += `<div style="background:rgba(39,174,96,0.2);padding:10px;border-radius:6px;">
            <strong>ğŸ“Š æœ€ç»ˆä¸‹æ³¨ï¼ˆ${localBets.length}æ¡ï¼‰ï¼š</strong><br>`;
        if (localBets.length > 0) {
            content += `<pre style="white-space:pre-wrap;margin:5px 0;background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;max-height:150px;overflow:auto;font-size:11px;">${JSON.stringify(localBets, null, 2)}</pre>`;
        } else {
            content += `<span style="color:#888;">æ— </span>`;
        }
        content += `</div>`;
        
        return content;
    }
    
    // æ˜¾ç¤ºè°ƒè¯•å¼¹çª—ï¼ˆä¿ç•™åŸå‡½æ•°ç”¨äºå…¼å®¹ï¼‰
    function showDebugModal(title, content) {
        // ç§»é™¤å·²æœ‰å¼¹çª—
        const existing = document.getElementById('debug-modal');
        if (existing) existing.remove();
        
        const modal = document.createElement('div');
        modal.id = 'debug-modal';
        modal.innerHTML = `
            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:99999;display:flex;justify-content:center;align-items:center;padding:20px;">
                <div style="background:#1a1a2e;border-radius:12px;max-width:600px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="font-weight:bold;font-size:16px;">${title}</span>
                        <button onclick="document.getElementById('debug-modal').remove()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:0 5px;">Ã—</button>
                    </div>
                    <div style="padding:20px;overflow:auto;max-height:calc(90vh - 60px);">
                        ${content}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // ==================== åˆå§‹åŒ– ====================
    async function init() {
        console.log('ğŸš€ [init] åº”ç”¨åˆå§‹åŒ–å¼€å§‹...');
        console.log('ğŸ“ [init] å½“å‰URL:', window.location.href);
        console.log('â° [init] åˆå§‹åŒ–æ—¶é—´:', new Date().toLocaleString('zh-CN'));
        
        try {
            // ç”Ÿæˆæœºå™¨ç 
            console.log('ğŸ”‘ [init] ç”Ÿæˆæœºå™¨ç ...');
            appState.machineCode = await generateMachineCode();
            document.getElementById('machine-code').textContent = appState.machineCode;
            console.log('âœ… [init] æœºå™¨ç ç”Ÿæˆå®Œæˆ:', appState.machineCode);
            
            // åŠ è½½ä¿å­˜çš„é…ç½®
            console.log('ğŸ“‚ [init] åŠ è½½æœ¬åœ°é…ç½®...');
            loadConfig();
            console.log('âœ… [init] é…ç½®åŠ è½½å®Œæˆ');
            
            // æ¢å¤AIæ¨¡å‹é€‰æ‹©ï¼ˆğŸ†• v3.11.69 é»˜è®¤æ”¹ä¸ºtuziï¼Œå…”å­APIæ›´å¿«ï¼‰
            const savedAIProvider = localStorage.getItem('ai_provider') || 'tuzi';
            switchAIModel(savedAIProvider);
            console.log('ğŸ¤– [init] AIæ¨¡å‹:', savedAIProvider);
            
            // ç¡®ä¿é»˜è®¤å½©ç§ä¸ºæ–°æ¾³é—¨
            if (!appState.currentLotteryType) {
                appState.currentLotteryType = 'xam';
            }
            console.log('ğŸ¯ [init] å½“å‰å½©ç§:', appState.currentLotteryType);
            
            // åŠ è½½èµ”ç‡è®¾ç½®
            console.log('ğŸ’° [init] åŠ è½½èµ”ç‡è®¾ç½®...');
            loadOddsFromStorage();
            
            // æ£€æŸ¥æ¿€æ´»çŠ¶æ€
            console.log('ğŸ” [init] æ£€æŸ¥æ¿€æ´»çŠ¶æ€...');
            checkLicense();
            console.log('âœ… [init] æ¿€æ´»çŠ¶æ€:', appState.isActivated ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»');
            
            // æ¸²æŸ“å‚ç…§è¡¨
            renderReferenceTables();
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            
            // æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            updateSwitchButtons();
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå°è¯•è‡ªåŠ¨è·å–ï¼ˆä¸é˜»å¡ï¼‰
            console.log('ğŸ”„ [init] å¼€å§‹è‡ªåŠ¨è·å–æ•°æ®...');
            tryAutoFetchOnce();
            
            // è‡ªåŠ¨è·å–å†å²è®°å½•ï¼ˆæ–°æ¾³é—¨å’Œé¦™æ¸¯åŒæ­¥æ›´æ–°10æ¡ï¼‰
            console.log('ğŸ“œ [init] è‡ªåŠ¨è·å–å†å²å¼€å¥–è®°å½•...');
            fetchHistoryData().then(() => {
                console.log('âœ… [init] å†å²è®°å½•è·å–å®Œæˆ');
            }).catch(err => {
                console.warn('âš ï¸ [init] å†å²è®°å½•è·å–å¤±è´¥:', err);
            });
            
            // å¯åŠ¨å¼€å¥–æ—¶æ®µè‡ªåŠ¨åˆ·æ–°
            startLiveRefresh();
            
            console.log('âœ… [init] åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼');
        } catch (error) {
            console.error('âŒ [init] åˆå§‹åŒ–å‡ºé”™:', error);
        }
    }
    
    // ==================== å¼€å¥–æ—¶æ®µè‡ªåŠ¨åˆ·æ–°ï¼ˆç›´æ’­æ•ˆæœï¼‰ ====================
    let liveRefreshInterval = null;
    let checkLiveInterval = null;
    // ğŸ†• v3.11.22 è®°å½•ä¸Šæ¬¡å¼€å¥–å·ç ï¼Œç”¨äºåˆ¤æ–­å·ç æ˜¯å¦å˜åŒ–
    let lastLotteryNumbersStr = '';
    let liveAnimationStopped = false;  // æ ‡è®°åŠ¨ç”»æ˜¯å¦å·²åœæ­¢ï¼ˆå·ç å®Œæ•´åï¼‰
    
    // æ£€æŸ¥æ˜¯å¦åœ¨å¼€å¥–æ—¶æ®µï¼ˆ21:29 - 21:40ï¼‰
    function isLiveTime() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        // 21:29 åˆ° 21:40
        if (hours === 21 && minutes >= 29 && minutes <= 40) {
            return true;
        }
        return false;
    }
    
    // ğŸ†• v3.11.22 æ£€æŸ¥å·ç æ˜¯å¦å®Œæ•´ï¼ˆ7ä¸ªæœ‰æ•ˆå·ç ï¼‰
    function isLotteryNumbersComplete(numbers) {
        if (!numbers || numbers.length !== 7) return false;
        // æ£€æŸ¥æ‰€æœ‰å·ç éƒ½æ˜¯æœ‰æ•ˆçš„ï¼ˆ1-49ï¼‰
        return numbers.every(n => n >= 1 && n <= 49);
    }
    
    // ğŸ†• v3.11.22 æ£€æŸ¥å·ç æ˜¯å¦æœ‰å˜åŒ–
    function hasLotteryNumbersChanged(numbers) {
        const currentStr = numbers ? numbers.join(',') : '';
        const changed = currentStr !== lastLotteryNumbersStr;
        lastLotteryNumbersStr = currentStr;
        return changed;
    }
    
    // å¯åŠ¨å¼€å¥–æ—¶æ®µè‡ªåŠ¨åˆ·æ–°ï¼ˆå‚è€ƒ index2.htmlï¼šå¼€å¥–æ—¶æ®µæ¯5ç§’åˆ·æ–°ï¼‰
    function startLiveRefresh() {
        // æ¯åˆ†é’Ÿæ£€æŸ¥æ˜¯å¦è¿›å…¥å¼€å¥–æ—¶æ®µ
        checkLiveInterval = setInterval(() => {
            if (isLiveTime()) {
                // è¿›å…¥å¼€å¥–æ—¶æ®µï¼Œå¼€å§‹é«˜é¢‘åˆ·æ–°
                if (!liveRefreshInterval) {
                    console.log('ğŸ“¡ è¿›å…¥å¼€å¥–æ—¶æ®µï¼Œå¼€å§‹æ¯5ç§’è‡ªåŠ¨åˆ·æ–°...');
                    showLiveToast('ğŸ“¡ å¼€å¥–ç›´æ’­æ¨¡å¼å·²å¼€å¯');
                    // ğŸ†• é‡ç½®çŠ¶æ€
                    lastLotteryNumbersStr = '';
                    liveAnimationStopped = false;
                    liveRefreshInterval = setInterval(async () => {
                        await doLiveRefresh();
                    }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆä¸index2.htmlä¸€è‡´ï¼‰
                }
            } else {
                // é€€å‡ºå¼€å¥–æ—¶æ®µï¼Œåœæ­¢é«˜é¢‘åˆ·æ–°
                if (liveRefreshInterval) {
                    console.log('â¹ï¸ å¼€å¥–æ—¶æ®µç»“æŸï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°');
                    clearInterval(liveRefreshInterval);
                    liveRefreshInterval = null;
                    // ğŸ†• é‡ç½®çŠ¶æ€
                    lastLotteryNumbersStr = '';
                    liveAnimationStopped = false;
                }
            }
        }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        
        // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
        if (isLiveTime() && !liveRefreshInterval) {
            console.log('ğŸ“¡ å½“å‰åœ¨å¼€å¥–æ—¶æ®µï¼Œå¼€å§‹è‡ªåŠ¨åˆ·æ–°...');
            showLiveToast('ğŸ“¡ å¼€å¥–ç›´æ’­æ¨¡å¼å·²å¼€å¯');
            // ğŸ†• é‡ç½®çŠ¶æ€
            lastLotteryNumbersStr = '';
            liveAnimationStopped = false;
            liveRefreshInterval = setInterval(async () => {
                await doLiveRefresh();
            }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        }
    }
    
    // ğŸ†• v3.11.22 ç›´æ’­åˆ·æ–°æ ¸å¿ƒé€»è¾‘
    async function doLiveRefresh() {
        try {
            // å…ˆè®°å½•å½“å‰å·ç å­—ç¬¦ä¸²ï¼ˆç”¨äºæ¯”è¾ƒï¼‰
            const oldNumbersStr = (appState.lotteryNumbers || []).join(',');
            
            // è·å–å‰å…ˆç¦ç”¨åŠ¨ç”»ï¼Œè®© fetchAllLotteryData å†…éƒ¨çš„æ¸²æŸ“ä¸å¸¦åŠ¨ç”»
            window.isLiveAnimationEnabled = false;
            
            // è·å–æœ€æ–°æ•°æ®ï¼ˆå†…éƒ¨ä¼šæ¸²æŸ“ä¸€æ¬¡ï¼Œä½†ä¸å¸¦åŠ¨ç”»ï¼‰
            await fetchAllLotteryData();
            
            const newNumbers = appState.lotteryNumbers;
            const newNumbersStr = (newNumbers || []).join(',');
            const isComplete = isLotteryNumbersComplete(newNumbers);
            const hasChanged = newNumbersStr !== oldNumbersStr;
            
            // æ›´æ–°è®°å½•
            lastLotteryNumbersStr = newNumbersStr;
            
            // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ’­æ”¾åŠ¨ç”»
            if (isComplete && !hasChanged && lastLotteryNumbersStr === newNumbersStr) {
                // å·ç å®Œæ•´ä¸”æœªå˜åŒ– â†’ å·²ç»å¼€å®Œï¼Œåœæ­¢åŠ¨ç”»
                if (!liveAnimationStopped) {
                    console.log('âœ… å¼€å¥–å·ç å·²å…¨éƒ¨å¼€å‡ºï¼Œåœæ­¢åŠ¨ç”»æ•ˆæœ');
                    showLiveToast('âœ… å¼€å¥–å®Œæˆ');
                    liveAnimationStopped = true;
                }
                // ä¸éœ€è¦é‡æ–°æ¸²æŸ“ï¼Œå·²ç»åœ¨ fetchAllLotteryData ä¸­æ¸²æŸ“è¿‡äº†
            } else if (hasChanged) {
                // å·ç æœ‰å˜åŒ– â†’ æ’­æ”¾åŠ¨ç”»
                console.log('ğŸ”„ å·ç æœ‰æ›´æ–°ï¼Œæ’­æ”¾åŠ¨ç”»', oldNumbersStr, 'â†’', newNumbersStr);
                window.isLiveAnimationEnabled = true;
                liveAnimationStopped = false;
                // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºåŠ¨ç”»
                renderLotteryBalls();
                // æ¸²æŸ“å®Œåé‡ç½®æ ‡å¿—
                window.isLiveAnimationEnabled = false;
            }
            // else: å·ç æœªå˜åŒ–ä½†ä¸å®Œæ•´ï¼ˆç­‰å¾…ä¸­ï¼‰â†’ å·²ç»æ¸²æŸ“è¿‡äº†ï¼Œä¸éœ€è¦é¢å¤–æ“ä½œ
        } catch (e) {
            console.log('ç›´æ’­åˆ·æ–°å¤±è´¥', e);
        }
    }
    
    // æ˜¾ç¤ºç›´æ’­æç¤º
    function showLiveToast(msg) {
        const toast = document.createElement('div');
        toast.innerHTML = msg;
        toast.style.cssText = 'position:fixed;top:20%;left:50%;transform:translateX(-50%);background:linear-gradient(90deg,#e94560,#c23a51);color:white;padding:12px 20px;border-radius:8px;font-size:13px;z-index:9999;box-shadow:0 4px 15px rgba(233,69,96,0.4);';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    
    // ä» data.json åŠ è½½é¢„è·å–çš„æ•°æ®ï¼ˆGitHub Actions æ–¹æ¡ˆï¼‰
    async function loadDataFromJSON() {
        console.log('ğŸ”„ [loadDataFromJSON] å¼€å§‹ä» data.json åŠ è½½æ•°æ®...');
        try {
            const url = './data.json?t=' + Date.now();
            console.log('ğŸ“¡ [loadDataFromJSON] è¯·æ±‚URL:', url);
            
            const response = await fetch(url);
            console.log('ğŸ“¥ [loadDataFromJSON] å“åº”çŠ¶æ€:', response.status, response.statusText);
            
            if (!response.ok) {
                console.warn('âš ï¸ [loadDataFromJSON] å“åº”ä¸OKï¼Œè¿”å›false');
                return false;
            }
            
            const data = await response.json();
            console.log('ğŸ“Š [loadDataFromJSON] è·å–åˆ°çš„æ•°æ®:', JSON.stringify(data, null, 2));
            
            if (!data) {
                console.warn('âš ï¸ [loadDataFromJSON] æ•°æ®ä¸ºç©ºï¼Œè¿”å›false');
                return false;
            }
            
            let loaded = false;
            
            // åŠ è½½æ–°æ¾³é—¨æ•°æ®
            if (data.xam && data.xam.numbers && data.xam.numbers.length === 7) {
                console.log('ğŸ° [loadDataFromJSON] æ–°æ¾³é—¨æ•°æ®æœ‰æ•ˆ:', data.xam.numbers.join(','));
                appState.lotteryData['xam'] = {
                    numbers: data.xam.numbers,
                    issue: data.xam.issue,
                    time: data.xam.time,
                    source: 'data.json'
                };
                addToHistory('xam', data.xam);
                loaded = true;
            } else {
                console.warn('âš ï¸ [loadDataFromJSON] æ–°æ¾³é—¨æ•°æ®æ— æ•ˆæˆ–ä¸å®Œæ•´');
            }
            
            // åŠ è½½é¦™æ¸¯æ•°æ®
            if (data.hk && data.hk.numbers && data.hk.numbers.length === 7) {
                console.log('ğŸ° [loadDataFromJSON] é¦™æ¸¯æ•°æ®æœ‰æ•ˆ:', data.hk.numbers.join(','));
                appState.lotteryData['hk'] = {
                    numbers: data.hk.numbers,
                    issue: data.hk.issue,
                    time: data.hk.time,
                    source: 'data.json'
                };
                addToHistory('hk', data.hk);
                loaded = true;
            } else {
                console.warn('âš ï¸ [loadDataFromJSON] é¦™æ¸¯æ•°æ®æ— æ•ˆæˆ–ä¸å®Œæ•´');
            }
            
            if (loaded) {
                // åŠ è½½å½“å‰å½©ç§æ•°æ®
                const currentData = appState.lotteryData[appState.currentLotteryType];
                console.log('ğŸ“Œ [loadDataFromJSON] å½“å‰å½©ç§:', appState.currentLotteryType);
                
                if (currentData && currentData.numbers && currentData.numbers.length === 7) {
                    appState.lotteryNumbers = currentData.numbers;
                    console.log('âœ… [loadDataFromJSON] è®¾ç½®å½“å‰å·ç :', appState.lotteryNumbers.join(','));
                }
                
                saveConfig();
                renderLotteryBalls();
                renderHistoryList();
                
                console.log('âœ… [loadDataFromJSON] æ•°æ®åŠ è½½æˆåŠŸï¼Œæ›´æ–°æ—¶é—´:', data.updateTime);
            } else {
                console.warn('âš ï¸ [loadDataFromJSON] æ²¡æœ‰æœ‰æ•ˆæ•°æ®è¢«åŠ è½½');
            }
            
            return loaded;
        } catch (e) {
            console.error('âŒ [loadDataFromJSON] åŠ è½½å¤±è´¥:', e.message, e);
            return false;
        }
    }
    
    // ğŸ†• v3.11.23 æ¯æ¬¡æ‰“å¼€é¡µé¢éƒ½è‡ªåŠ¨è·å–æœ€æ–°å¼€å¥–æ•°æ®
    async function tryAutoFetchOnce() {
        console.log('ğŸ”„ [tryAutoFetchOnce] è‡ªåŠ¨è·å–æœ€æ–°å¼€å¥–æ•°æ®...');
        showAutoFetchStatus('ğŸ”„ æ­£åœ¨åŠ è½½æœ€æ–°å¼€å¥–æ•°æ®...');
        
        // æ–¹æ¡ˆ1ï¼šä¼˜å…ˆä» data.json è¯»å–ï¼ˆGitHub Actions é¢„è·å–çš„æ•°æ®ï¼Œæ›´æ–°é¢‘ç‡é«˜ï¼‰
        try {
            const jsonLoaded = await loadDataFromJSON();
            if (jsonLoaded) {
                console.log('âœ… [tryAutoFetchOnce] ä» data.json åŠ è½½æˆåŠŸ');
                showAutoFetchStatus('âœ… å¼€å¥–æ•°æ®å·²æ›´æ–°', 'success');
                setTimeout(hideAutoFetchStatus, 2000);
                return;
            }
        } catch (e) {
            console.log('âš ï¸ [tryAutoFetchOnce] data.json åŠ è½½å¤±è´¥:', e.message);
        }
        
        // æ–¹æ¡ˆ2ï¼šdata.json å¤±è´¥ï¼Œå°è¯•ç›´æ¥è°ƒç”¨ APIï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
        console.log('ğŸ”„ [tryAutoFetchOnce] data.json å¤±è´¥ï¼Œå°è¯•è°ƒç”¨ API...');
        showAutoFetchStatus('ğŸ”„ æ­£åœ¨è·å–æœ€æ–°æ•°æ®...');
        
        let success = false;
        for (let retry = 0; retry < 2 && !success; retry++) {
            try {
                if (retry > 0) {
                    showAutoFetchStatus(`ğŸ”„ é‡è¯•è·å–ä¸­...(${retry}/2)`);
                    await new Promise(r => setTimeout(r, 1000));
                }
                await fetchAllLotteryData();
                
                const newXamData = appState.lotteryData['xam'];
                const newHkData = appState.lotteryData['hk'];
                if ((newXamData && newXamData.numbers && newXamData.numbers.length === 7) ||
                    (newHkData && newHkData.numbers && newHkData.numbers.length === 7)) {
                    success = true;
                    console.log('âœ… [tryAutoFetchOnce] API è·å–æˆåŠŸ');
                    showAutoFetchStatus('âœ… å¼€å¥–æ•°æ®å·²æ›´æ–°', 'success');
                }
            } catch (e) {
                console.log(`âš ï¸ [tryAutoFetchOnce] APIè·å–å¤±è´¥(å°è¯•${retry + 1}):`, e.message);
            }
        }
        
        if (!success) {
            // æ–¹æ¡ˆ3ï¼šAPIä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚æœæœ‰ï¼‰
            const xamData = appState.lotteryData['xam'];
            const hkData = appState.lotteryData['hk'];
            if ((xamData && xamData.numbers && xamData.numbers.length === 7) ||
                (hkData && hkData.numbers && hkData.numbers.length === 7)) {
                console.log('âš ï¸ [tryAutoFetchOnce] ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®');
                showAutoFetchStatus('âš ï¸ ç½‘ç»œå¼‚å¸¸ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®', 'warning');
            } else {
                showAutoFetchStatus('âš ï¸ è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è·å–', 'warning');
            }
        }
        
        setTimeout(hideAutoFetchStatus, 3000);
    }
    
    // æ˜¾ç¤ºè‡ªåŠ¨è·å–çŠ¶æ€
    function showAutoFetchStatus(msg, type = 'loading') {
        let statusDiv = document.getElementById('auto-fetch-status');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'auto-fetch-status';
            statusDiv.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;font-size:13px;z-index:9999;transition:opacity 0.3s;';
            document.body.appendChild(statusDiv);
        }
        
        statusDiv.innerHTML = msg;
        statusDiv.style.opacity = '1';
        
        if (type === 'success') {
            statusDiv.style.background = 'linear-gradient(90deg,#2ecc71,#27ae60)';
            statusDiv.style.color = 'white';
        } else if (type === 'warning') {
            statusDiv.style.background = 'linear-gradient(90deg,#f39c12,#e67e22)';
            statusDiv.style.color = 'white';
        } else {
            statusDiv.style.background = 'linear-gradient(90deg,#667eea,#764ba2)';
            statusDiv.style.color = 'white';
        }
    }
    
    // éšè—è‡ªåŠ¨è·å–çŠ¶æ€
    function hideAutoFetchStatus() {
        const statusDiv = document.getElementById('auto-fetch-status');
        if (statusDiv) {
            statusDiv.style.opacity = '0';
            setTimeout(() => statusDiv.remove(), 300);
        }
    }
    
    // è·å–æ‰€æœ‰å½©ç§æ•°æ®
    async function fetchAllLotteryData() {
        const api = LOTTERY_APIS.marksix6;
        
        // è·å–æ•°æ®ï¼ˆå¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼‰
        const data = await fetchWithProxy(api.url);
        
        let hasValidData = false;
        
        // è§£ææ–°æ¾³é—¨æ•°æ®
        const xamResult = api.parse(data, 'xam');
        if (xamResult && xamResult.numbers && xamResult.numbers.length === 7) {
            appState.lotteryData['xam'] = {
                numbers: xamResult.numbers,
                issue: xamResult.issue,
                time: xamResult.time,
                source: xamResult.source
            };
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory('xam', xamResult);
            hasValidData = true;
        }
        
        // è§£æé¦™æ¸¯æ•°æ®
        const hkResult = api.parse(data, 'hk');
        if (hkResult && hkResult.numbers && hkResult.numbers.length === 7) {
            appState.lotteryData['hk'] = {
                numbers: hkResult.numbers,
                issue: hkResult.issue,
                time: hkResult.time,
                source: hkResult.source
            };
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory('hk', hkResult);
            hasValidData = true;
        }
        
        // å¦‚æœæ²¡æœ‰è·å–åˆ°ä»»ä½•æœ‰æ•ˆæ•°æ®ï¼ŒæŠ›å‡ºé”™è¯¯
        if (!hasValidData) {
            throw new Error('æ•°æ®è§£æå¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆå¼€å¥–å·ç ');
        }
        
        // åŠ è½½å½“å‰å½©ç§çš„æ•°æ®
        const currentData = appState.lotteryData[appState.currentLotteryType];
        if (currentData && currentData.numbers && currentData.numbers.length === 7) {
            appState.lotteryNumbers = currentData.numbers;
        }
        
        // ä¿å­˜å¹¶åˆ·æ–°æ˜¾ç¤º
        saveConfig();
        renderLotteryBalls();
        renderHistoryList();  // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨
        
        return true; // è¿”å›æˆåŠŸæ ‡å¿—
    }
    
    // ==================== æœºå™¨ç ç”Ÿæˆ ====================
    async function generateMachineCode() {
        const components = [];
        
        // CanvasæŒ‡çº¹
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('LHC', 2, 2);
            components.push(canvas.toDataURL().slice(-50));
        } catch (e) {
            components.push('no-canvas');
        }
        
        // å±å¹•ä¿¡æ¯
        components.push(`${screen.width}x${screen.height}x${screen.colorDepth}`);
        components.push(Intl.DateTimeFormat().resolvedOptions().timeZone);
        components.push(navigator.language);
        components.push(navigator.platform);
        components.push(navigator.hardwareConcurrency || 'unknown');
        
        const raw = components.join('|');
        const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(raw));
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
        
        return `${hashHex.slice(0, 4)}-${hashHex.slice(4, 8)}-${hashHex.slice(8, 12)}-${hashHex.slice(12, 16)}`;
    }
    
    // ==================== é¡µé¢åˆ‡æ¢ ====================
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        // æ‰“å¼€å¼€å¥–è®¾ç½®é¡µé¢æ—¶ï¼Œæ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤ºå’Œå†å²è®°å½•
        if (pageId === 'page-lottery') {
            updateLotteryInputsDisplay();
            renderHistoryList();
        }
        
        // æ‰“å¼€å‚ç…§è¡¨é¡µé¢æ—¶ï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼
        if (pageId === 'page-reference') {
            renderReferenceTables();
        }
        
        // æ‰“å¼€è‡ªå®šä¹‰æ ¼å¼é¡µé¢æ—¶ï¼ŒåŠ è½½è®¾ç½®
        if (pageId === 'page-format') {
            loadFormatSettings();
        }
        
        // æ‰“å¼€å‚æ•°è®¾ç½®é¡µé¢æ—¶ï¼ŒåŠ è½½è®¾ç½®
        if (pageId === 'page-params') {
            loadParamSettings();
        }
    }
    
    // æ›´æ–°å¼€å¥–è®¾ç½®é¡µé¢çš„è¾“å…¥æ¡†æ˜¾ç¤º
    function updateLotteryInputsDisplay() {
        if (appState.lotteryNumbers && appState.lotteryNumbers.length >= 7) {
            for (let i = 0; i < 6; i++) {
                const num = appState.lotteryNumbers[i];
                const input = document.getElementById('num' + (i + 1));
                if (num > 0) {
                    input.value = String(num).padStart(2, '0');
                    updateInputColor(input, num, false);
                }
            }
            const specialNum = appState.lotteryNumbers[6];
            const specialInput = document.getElementById('num-special');
            if (specialNum > 0) {
                specialInput.value = String(specialNum).padStart(2, '0');
                updateInputColor(specialInput, specialNum, true);
            }
        }
        // éšè—é¢„è§ˆ
        hideParsePreview();
    }
    
    // ==================== é…ç½®ä¿å­˜/åŠ è½½ ====================
    function saveConfig() {
        localStorage.setItem('lhc_config', JSON.stringify(appState));
    }
    
    function loadConfig() {
        const saved = localStorage.getItem('lhc_config');
        if (saved) {
            const config = JSON.parse(saved);
            appState = { ...appState, ...config };
            
            // æ¢å¤èµ”ç‡è¾“å…¥æ¡†ï¼ˆå®‰å…¨æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼‰
            const setInputValue = (id, value) => {
                const el = document.getElementById(id);
                if (el && value !== undefined) el.value = value;
            };
            if (appState.odds) {
                setInputValue('odds-tema', appState.odds.tema);
                setInputValue('odds-shengxiao', appState.odds.shengxiao);
                setInputValue('odds-red', appState.odds.red);
                setInputValue('odds-blue', appState.odds.blue);
                setInputValue('odds-green', appState.odds.green);
                setInputValue('odds-daxiao', appState.odds.daxiao);
                setInputValue('odds-danshuang', appState.odds.danshuang);
            }
        }
        
        // ç¡®ä¿lotteryDataç»“æ„å­˜åœ¨
        if (!appState.lotteryData) {
            appState.lotteryData = {
                xam: { numbers: [], issue: '', time: '', source: '' },
                hk: { numbers: [], issue: '', time: '', source: '' }
            };
        }
        
        // ç¡®ä¿å†å²è®°å½•ç»“æ„å­˜åœ¨
        if (!appState.lotteryHistory) {
            appState.lotteryHistory = {
                xam: [],
                hk: []
            };
        }
        
        // é»˜è®¤å½©ç§ä¸ºæ–°æ¾³é—¨
        if (!appState.currentLotteryType) {
            appState.currentLotteryType = 'xam';
        }
        
        // å¦‚æœå½“å‰å½©ç§æœ‰æ•°æ®ï¼ŒåŠ è½½åˆ°lotteryNumbers
        const currentData = appState.lotteryData[appState.currentLotteryType];
        if (currentData && currentData.numbers && currentData.numbers.length === 7) {
            appState.lotteryNumbers = currentData.numbers;
        }
    }
    
    // ==================== å¼€å¥–å·ç  ====================
    
    // è§£æç²˜è´´çš„å¼€å¥–å·ç 
    function parseLotteryInput() {
        let input = document.getElementById('paste-lottery-input').value.trim();
        
        if (!input) {
            alert('è¯·å…ˆç²˜è´´å¼€å¥–å·ç ï¼');
            return;
        }
        
        // å®¹é”™å¤„ç†ï¼šåˆå¹¶å¤šä¸ªè¿ç»­ç©ºæ ¼ä¸ºå•ä¸ªç©ºæ ¼
        input = input.replace(/\s+/g, ' ');
        
        // æå–ç‰¹ç ï¼ˆå¦‚æœæœ‰"ç‰¹"å­—æ ‡è¯†ï¼‰
        let specialNum = null;
        let cleanInput = input;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰"ç‰¹"å­—æ ‡è¯†ç‰¹ç 
        const teMatch = input.match(/ç‰¹\s*(\d+)/);
        if (teMatch) {
            specialNum = parseInt(teMatch[1]);
            cleanInput = input.replace(/ç‰¹\s*\d+/, '').trim();
        }
        
        // ç”¨å„ç§åˆ†éš”ç¬¦åˆ†å‰²ï¼šç©ºæ ¼ã€ç‚¹ã€é€—å·ã€ä¸­æ–‡é€—å·ã€é¡¿å·
        const parts = cleanInput.split(/[\s.,ï¼Œã€ã€‚]+/).filter(p => p);
        
        // è§£ææ•°å­—
        const nums = [];
        const invalidParts = [];
        for (const part of parts) {
            const num = parseInt(part);
            if (!isNaN(num) && num >= 1 && num <= 49) {
                nums.push(num);
            } else if (part && !/^\s*$/.test(part)) {
                invalidParts.push(part);
            }
        }
        
        // å¦‚æœæ²¡æœ‰"ç‰¹"æ ‡è¯†ï¼Œæœ€åä¸€ä¸ªå°±æ˜¯ç‰¹ç 
        if (specialNum === null && nums.length >= 7) {
            specialNum = nums.pop();
        }
        
        // éªŒè¯æ•°é‡
        if (nums.length !== 6 || !specialNum) {
            showFormatErrorModal(nums, specialNum, invalidParts, input);
            hideParsePreview();
            return;
        }
        
        if (specialNum < 1 || specialNum > 49) {
            showFormatErrorModal(nums, specialNum, ['ç‰¹ç è¶…å‡ºèŒƒå›´'], input);
            hideParsePreview();
            return;
        }
        
        // åˆå¹¶æ‰€æœ‰å·ç æ£€æŸ¥é‡å¤
        const allNums = [...nums, specialNum];
        const uniqueNums = new Set(allNums);
        if (uniqueNums.size !== allNums.length) {
            const seen = {};
            const duplicates = [];
            for (const n of allNums) {
                if (seen[n]) duplicates.push(n);
                seen[n] = true;
            }
            showDuplicateErrorModal([...new Set(duplicates)]);
            hideParsePreview();
            return;
        }
        
        // å¡«å…¥è¾“å…¥æ¡†å¹¶æ›´æ–°è¾“å…¥æ¡†èƒŒæ™¯è‰²
        for (let i = 0; i < 6; i++) {
            const numInput = document.getElementById('num' + (i + 1));
            numInput.value = String(nums[i]).padStart(2, '0');
            updateInputColor(numInput, nums[i]);
        }
        const specialInput = document.getElementById('num-special');
        specialInput.value = String(specialNum).padStart(2, '0');
        updateInputColor(specialInput, specialNum, true);
        
        // æ˜¾ç¤ºå¸¦æ³¢è‰²çš„é¢„è§ˆ
        showParsePreview(nums, specialNum);
        
        // æ¸…ç©ºç²˜è´´æ¡†
        document.getElementById('paste-lottery-input').value = '';
        
        // æç¤ºç”¨æˆ·ç‚¹å‡»ä¿å­˜æŒ‰é’®
        const toast = document.createElement('div');
        toast.innerHTML = 'âœ… è§£ææˆåŠŸï¼è¯·ç‚¹å‡»<b>ã€Œä¿å­˜å¼€å¥–å·ç ã€</b>æŒ‰é’®åº”ç”¨';
        toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:#4CAF50;padding:15px 20px;border-radius:10px;font-size:13px;z-index:9999;text-align:center;max-width:280px;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
    }
    
    // æ˜¾ç¤ºæ ¼å¼é”™è¯¯å¼¹çª—
    function showFormatErrorModal(nums, specialNum, invalidParts, originalInput) {
        const correctFormat = '01 08 09 15 24 26 ç‰¹27';
        
        // åˆ›å»ºå¼¹çª—HTML
        let html = `
        <div id="format-error-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;">
            <div style="background:#fff;border-radius:12px;padding:20px;max-width:320px;width:100%;color:#333;">
                <div style="font-size:18px;font-weight:bold;margin-bottom:15px;">âŒ æ ¼å¼é”™è¯¯ï¼</div>
                
                <div style="margin-bottom:12px;">
                    <div style="color:#666;font-size:13px;">æ‚¨è¾“å…¥çš„ï¼š</div>
                    <div style="font-size:14px;word-break:break-all;">${originalInput}</div>
                </div>
                
                <div style="margin-bottom:12px;">
                    <div style="color:#666;font-size:13px;">è¯†åˆ«åˆ°ï¼š</div>
                    <div style="font-size:14px;">${nums.length}ä¸ªå¹³ç ${specialNum ? ' + 1ä¸ªç‰¹ç ' : ''}</div>
                </div>
                
                ${invalidParts.length > 0 ? `
                <div style="margin-bottom:12px;">
                    <div style="color:#666;font-size:13px;">æ— æ³•è¯†åˆ«çš„å†…å®¹ï¼š</div>
                    <div style="font-size:14px;color:#e74c3c;">${invalidParts.join(', ')}</div>
                </div>
                ` : ''}
                
                <div style="border-top:1px solid #eee;margin:15px 0;"></div>
                
                <div style="color:#e94560;font-size:13px;margin-bottom:8px;">ç‚¹å‡»å³ä¸‹è§’å¤åˆ¶æŒ‰é’®å¤åˆ¶æ­£ç¡®æ ¼å¼</div>
                <div style="display:flex;align-items:center;gap:8px;background:#f5f5f5;padding:10px;border-radius:8px;">
                    <span style="color:#2ecc71;font-size:16px;">âœ…</span>
                    <div>
                        <div style="font-size:12px;color:#888;">æ­£ç¡®æ ¼å¼ç¤ºä¾‹ï¼š</div>
                        <div style="font-size:15px;font-weight:bold;">${correctFormat}</div>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button onclick="closeFormatErrorModal()" style="flex:1;padding:12px;background:#f0f0f0;border:none;border-radius:8px;font-size:14px;cursor:pointer;color:#666;">å–æ¶ˆ</button>
                    <button onclick="copyFormatAndClose('${correctFormat}')" style="flex:1;padding:12px;background:#e94560;border:none;border-radius:8px;font-size:14px;cursor:pointer;color:#fff;font-weight:bold;">å¤åˆ¶</button>
                </div>
            </div>
        </div>`;
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function closeFormatErrorModal() {
        const modal = document.getElementById('format-error-modal');
        if (modal) modal.remove();
    }
    
    function copyFormatAndClose(text) {
        copyToClipboard(text);
        closeFormatErrorModal();
        alert('âœ… å·²å¤åˆ¶æ­£ç¡®æ ¼å¼ï¼');
    }
    
    // æ˜¾ç¤ºé‡å¤å·ç é”™è¯¯å¼¹çª—
    function showDuplicateErrorModal(duplicates) {
        const dupStr = duplicates.map(n => String(n).padStart(2,'0')).join(', ');
        alert('âŒ å·ç é‡å¤ï¼\n\né‡å¤çš„å·ç ï¼š' + dupStr + '\n\nå¼€å¥–å·ç ä¸èƒ½æœ‰é‡å¤ï¼Œè¯·æ£€æŸ¥åé‡æ–°è¾“å…¥ã€‚');
    }
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
        } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    }
    
    // æ ¹æ®å·ç æ›´æ–°è¾“å…¥æ¡†èƒŒæ™¯è‰²
    function updateInputColor(input, num, isSpecial = false) {
        const color = getNumberColor(num);
        const colorMap = {
            'red': '#c23a51',
            'blue': '#3a5fc2',
            'green': '#3a8c4a'
        };
        input.style.background = colorMap[color] || '#333';
        input.style.borderColor = isSpecial ? '#f5a623' : colorMap[color] || '#555';
    }
    
    // æ˜¾ç¤ºè§£æé¢„è§ˆ
    function showParsePreview(nums, specialNum) {
        const preview = document.getElementById('parse-preview');
        const balls = document.getElementById('parse-preview-balls');
        
        let html = '';
        // 6ä¸ªå¹³ç 
        for (let i = 0; i < 6; i++) {
            const num = nums[i];
            const color = getNumberColor(num);
            const colorMap = { 'red': '#c23a51', 'blue': '#3a5fc2', 'green': '#3a8c4a' };
            html += `<div style="width:32px;height:32px;border-radius:50%;background:${colorMap[color]};display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:bold;">${String(num).padStart(2,'0')}</div>`;
        }
        // + å·
        html += `<span style="color:#e94560;font-weight:bold;font-size:14px;margin:0 2px;">+</span>`;
        // ç‰¹ç 
        const specialColor = getNumberColor(specialNum);
        const colorMap = { 'red': '#c23a51', 'blue': '#3a5fc2', 'green': '#3a8c4a' };
        html += `<div style="width:32px;height:32px;border-radius:50%;background:${colorMap[specialColor]};border:2px solid #f5a623;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:bold;">${String(specialNum).padStart(2,'0')}</div>`;
        
        balls.innerHTML = html;
        preview.style.display = 'block';
    }
    
    // éšè—è§£æé¢„è§ˆ
    function hideParsePreview() {
        document.getElementById('parse-preview').style.display = 'none';
    }
    
    // æ ¼å¼åŒ–æ•°å­—è¾“å…¥ï¼ˆåªå…è®¸æ•°å­—ï¼‰
    function formatNumInput(input) {
        // åªä¿ç•™æ•°å­—
        let value = input.value.replace(/[^0-9]/g, '');
        
        // å¦‚æœè¾“å…¥äº†éæ•°å­—ï¼Œæç¤ºé”™è¯¯
        if (input.value !== value && input.value !== '') {
            input.style.borderColor = '#e74c3c';
            setTimeout(() => {
                input.style.borderColor = input.classList.contains('special') ? '#fbbf24' : 'rgba(255, 255, 255, 0.2)';
            }, 500);
        }
        
        // é™åˆ¶æœ€å¤§å€¼49
        if (parseInt(value) > 49) {
            value = '49';
        }
        
        input.value = value;
    }
    
    // å¤±ç„¦æ—¶è¡¥0
    function padNumInput(input) {
        let value = input.value.trim();
        if (value === '') {
            // æ¸…ç©ºæ—¶é‡ç½®é¢œè‰²
            input.style.background = '#333';
            input.style.borderColor = input.id === 'num-special' ? '#f5a623' : '#555';
            return;
        }
        
        let num = parseInt(value);
        if (isNaN(num) || num < 1) {
            input.value = '';
            input.style.background = '#333';
            input.style.borderColor = input.id === 'num-special' ? '#f5a623' : '#555';
            return;
        }
        
        if (num > 49) num = 49;
        
        // è¡¥0ï¼š1-9 â†’ 01-09
        input.value = num.toString().padStart(2, '0');
        
        // æ›´æ–°èƒŒæ™¯è‰²ä¸ºæ³¢è‰²
        const isSpecial = input.id === 'num-special';
        updateInputColor(input, num, isSpecial);
    }
    
    function saveLotteryNumbers() {
        const nums = [];
        let hasError = false;
        
        for (let i = 1; i <= 6; i++) {
            const input = document.getElementById('num' + i);
            const val = parseInt(input.value) || 0;
            if (val < 1 || val > 49) {
                hasError = true;
                input.style.borderColor = '#e74c3c';
            } else {
                input.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            }
            nums.push(val);
        }
        
        const specialInput = document.getElementById('num-special');
        const special = parseInt(specialInput.value) || 0;
        if (special < 1 || special > 49) {
            hasError = true;
            specialInput.style.borderColor = '#e74c3c';
        } else {
            specialInput.style.borderColor = '#fbbf24';
        }
        nums.push(special);
        
        if (hasError || nums.some(n => n < 1 || n > 49)) {
            alert('è¯·è¾“å…¥æ­£ç¡®çš„å·ç ï¼ˆ1-49ï¼‰ï¼');
            return;
        }
        
        // æ£€æŸ¥é‡å¤å·ç 
        const uniqueNums = new Set(nums);
        if (uniqueNums.size !== nums.length) {
            // æ‰¾å‡ºé‡å¤çš„å·ç 
            const seen = {};
            const duplicates = [];
            for (const n of nums) {
                if (seen[n]) {
                    duplicates.push(n);
                }
                seen[n] = true;
            }
            alert('âš ï¸ å¼€å¥–å·ç ä¸èƒ½é‡å¤ï¼\n\né‡å¤çš„å·ç ï¼š' + [...new Set(duplicates)].map(n => String(n).padStart(2,'0')).join(', '));
            return;
        }
        
        appState.lotteryNumbers = nums;
        
        // åŒæ­¥ä¿å­˜åˆ°å½“å‰å½©ç§çš„æ•°æ®
        const currentType = appState.currentLotteryType || 'xam';
        if (appState.lotteryData[currentType]) {
            appState.lotteryData[currentType].numbers = nums;
            // å¦‚æœæ²¡æœ‰æœŸå·ï¼Œä¿æŒåŸæœ‰æœŸå·
        }
        
        saveConfig();
        updateDisplay();
        showPage('page-main');
        
        // æ˜¾ç¤ºç®€çŸ­æç¤ºï¼ˆä¸é˜»å¡ï¼‰
        const toast = document.createElement('div');
        toast.innerHTML = 'âœ… å¼€å¥–å·ç å·²ä¿å­˜';
        toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#4CAF50;padding:15px 25px;border-radius:10px;font-size:14px;z-index:9999;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 1500);
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘              ã€æ¨¡å—4ã€‘è‡ªåŠ¨è·å–å¼€å¥–æ•°æ® - APIè°ƒç”¨               â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // APIé…ç½®ï¼ˆä¸‰ä¸ªAPIæºï¼Œè‡ªåŠ¨åˆ‡æ¢ï¼‰
    const LOTTERY_APIS = {
        // API 1: Marksix6ï¼ˆæ¨èï¼Œæ•°æ®æœ€å®Œæ•´ï¼‰
        marksix6: {
            name: 'Marksix6',
            url: 'https://marksix6.net/index.php?api=1',
            // å½©ç§æ˜ å°„
            lotteryMap: {
                'hk': 'é¦™æ¸¯å½©',
                'xam': 'æ–°æ¾³é—¨å½©',
                'am': 'æ¾³é—¨å½©'
            },
            parse: function(data, lotteryType) {
                const targetName = this.lotteryMap[lotteryType];
                if (!data.lottery_data) return null;
                
                const lottery = data.lottery_data.find(l => l.name === targetName);
                if (!lottery) return null;
                
                // è§£æå¼€å¥–å·ç 
                const numbers = lottery.openCode.split(',').map(n => parseInt(n.trim()));
                if (numbers.length !== 7) return null;
                
                return {
                    numbers: numbers,
                    issue: lottery.expect,
                    time: lottery.openTime,
                    zodiac: lottery.zodiac,
                    wave: lottery.wave,
                    source: 'Marksix6'
                };
            }
        },
        
        // ï¼ˆå·²åˆ é™¤ä¸å¯ç”¨çš„ 1234å¼€å¥–ç½‘ å’Œ 168å¼€å¥–ç½‘ï¼‰
    };
    
    // æ˜¾ç¤ºè·å–çŠ¶æ€
    function showFetchStatus(message, type) {
        const statusEl = document.getElementById('fetch-status');
        statusEl.style.display = 'block';
        
        let color = '#fff';
        let bgColor = 'rgba(0,0,0,0.3)';
        
        if (type === 'success') {
            color = '#4CAF50';
            bgColor = 'rgba(76, 175, 80, 0.2)';
        } else if (type === 'error') {
            color = '#e74c3c';
            bgColor = 'rgba(231, 76, 60, 0.2)';
        } else if (type === 'loading') {
            color = '#f5a623';
            bgColor = 'rgba(245, 166, 35, 0.2)';
        }
        
        statusEl.style.color = color;
        statusEl.style.background = bgColor;
        statusEl.innerHTML = message;
    }
    
    // éšè—çŠ¶æ€
    function hideFetchStatus() {
        document.getElementById('fetch-status').style.display = 'none';
    }
    
    // é€šè¿‡CORSä»£ç†è·å–æ•°æ®ï¼ˆè§£å†³è·¨åŸŸé—®é¢˜ï¼‰
    async function fetchWithProxy(url, timeout = 8000) {
        // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
        const createTimeoutController = (ms) => {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), ms);
            return controller;
        };
        
        // æ–¹æ³•1: ç›´æ¥å°è¯•è¯·æ±‚ï¼ˆå¦‚æœæœåŠ¡å™¨æ”¯æŒCORSï¼‰
        try {
            const controller = createTimeoutController(timeout);
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                signal: controller.signal
            });
            if (response.ok) {
                return await response.json();
            }
        } catch (e) {
            console.log('ç›´æ¥è¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä»£ç†...', e.message);
        }
        
        // æ–¹æ³•2: å°è¯•ä½¿ç”¨å¤šä¸ªå…¬å…±CORSä»£ç†ï¼ˆå¢åŠ æ›´å¤šç¨³å®šä»£ç†ï¼‰
        const corsProxies = [
            // ä»£ç†1: corsproxy.ioï¼ˆç¨³å®šæ€§è¾ƒå¥½ï¼‰
            `https://corsproxy.io/?${encodeURIComponent(url)}`,
            // ä»£ç†2: alloriginsï¼ˆå¤‡ç”¨ï¼‰
            `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            // ä»£ç†3: cors-anywhere é•œåƒ
            `https://proxy.cors.sh/${url}`,
            // ä»£ç†4: thingproxy
            `https://thingproxy.freeboard.io/fetch/${url}`
        ];
        
        for (const proxyUrl of corsProxies) {
            try {
                const controller = createTimeoutController(timeout);
                const response = await fetch(proxyUrl, {
                    signal: controller.signal,
                    headers: {
                        'x-cors-api-key': 'temp_key', // æŸäº›ä»£ç†éœ€è¦
                    }
                });
                if (response.ok) {
                    const text = await response.text();
                    try {
                        return JSON.parse(text);
                    } catch (parseErr) {
                        console.log('JSONè§£æå¤±è´¥:', proxyUrl);
                        continue;
                    }
                }
            } catch (e) {
                console.log('ä»£ç†è¯·æ±‚å¤±è´¥:', proxyUrl.split('?')[0], e.message);
            }
        }
        
        throw new Error('æ‰€æœ‰è¯·æ±‚æ–¹å¼éƒ½å¤±è´¥äº†ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
    
    // ä¸»å‡½æ•°ï¼šè·å–å¼€å¥–æ•°æ®
    async function fetchLotteryData() {
        const lotteryType = document.getElementById('lottery-type-select').value;
        const lotteryNames = {
            'hk': 'é¦™æ¸¯å…­åˆå½©',
            'xam': 'æ–°æ¾³é—¨å…­åˆå½©',
            'am': 'ãŠ£æ¾³é—¨å…­åˆå½©'
        };
        
        showFetchStatus('ğŸ”„ æ­£åœ¨è·å– ' + lotteryNames[lotteryType] + ' æœ€æ–°å¼€å¥–æ•°æ®...', 'loading');
        
        // ä½¿ç”¨ Marksix6 APIï¼ˆå”¯ä¸€å¯ç”¨çš„APIï¼‰
        const api = LOTTERY_APIS.marksix6;
        
        showFetchStatus(`ğŸ”„ æ­£åœ¨è·å– ${api.name} æ•°æ®...`, 'loading');
        
        try {
            // è·å–æ•°æ®
            const data = await fetchWithProxy(api.url);
            console.log(`${api.name} è¿”å›:`, data);
            
            // è§£ææ•°æ®
            const result = api.parse(data, lotteryType);
            
            if (result && result.numbers && result.numbers.length === 7) {
                // æˆåŠŸè·å–æ•°æ®
                applyLotteryResult(result, lotteryNames[lotteryType], lotteryType);
                return;
            }
            
            showFetchStatus('âŒ æ•°æ®è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        } catch (error) {
            console.error(`${api.name} å¤±è´¥:`, error);
            showFetchStatus('âŒ è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•', 'error');
        }
    }
    
    // åº”ç”¨è·å–åˆ°çš„å¼€å¥–ç»“æœ
    function applyLotteryResult(result, lotteryName, lotteryType) {
        // ä¿å­˜åˆ°å¯¹åº”å½©ç§çš„æ•°æ®
        if (lotteryType && appState.lotteryData[lotteryType]) {
            appState.lotteryData[lotteryType] = {
                numbers: result.numbers,
                issue: result.issue,
                time: result.time,
                source: result.source
            };
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory(lotteryType, result);
            renderHistoryList();  // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨
        }
        
        // å¡«å…¥è¾“å…¥æ¡†
        for (let i = 0; i < 6; i++) {
            const input = document.getElementById('num' + (i + 1));
            input.value = String(result.numbers[i]).padStart(2, '0');
            updateInputColor(input, result.numbers[i], false);
        }
        
        const specialInput = document.getElementById('num-special');
        specialInput.value = String(result.numbers[6]).padStart(2, '0');
        updateInputColor(specialInput, result.numbers[6], true);
        
        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        let statusMsg = `âœ… è·å–æˆåŠŸï¼<br>`;
        statusMsg += `<b>${lotteryName}</b> ç¬¬ <b>${result.issue}</b> æœŸ<br>`;
        statusMsg += `å¼€å¥–å·ç ï¼š<b>${result.numbers.slice(0, 6).map(n => String(n).padStart(2, '0')).join(' ')} + ${String(result.numbers[6]).padStart(2, '0')}</b><br>`;
        if (result.time) {
            statusMsg += `å¼€å¥–æ—¶é—´ï¼š${result.time}<br>`;
        }
        statusMsg += `<span style="font-size:11px;color:#888;">æ•°æ®æ¥æºï¼š${result.source}</span>`;
        
        showFetchStatus(statusMsg, 'success');
        
        // æ˜¾ç¤ºé¢„è§ˆ
        showParsePreview(result.numbers.slice(0, 6), result.numbers[6]);
        
        // ä¿å­˜é…ç½®
        saveConfig();
    }
    
    // åˆ‡æ¢èµ”ç‡é¢æ¿
    function showOddsPanel(panelId) {
        // åˆ‡æ¢èœå•é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.odds-menu-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // åˆ‡æ¢å†…å®¹é¢æ¿
        document.querySelectorAll('.odds-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById('panel-' + panelId).classList.add('active');
    }
    
    function updateDisplay() {
        // æ›´æ–°å¼€å¥–å·ç æ˜¾ç¤º
        renderLotteryBalls();
    }
    
    function renderLotteryBalls() {
        const container = document.getElementById('lottery-balls');
        const typeNameEl = document.getElementById('lottery-type-name');
        const issueEl = document.getElementById('lottery-issue');
        
        // æ›´æ–°å½©ç§åç§°å’ŒæœŸå·
        const typeNames = { xam: 'æ–°æ¾³', hk: 'é¦™æ¸¯' };
        if (typeNameEl) typeNameEl.textContent = typeNames[appState.currentLotteryType] || 'æ–°æ¾³';
        
        const currentData = appState.lotteryData[appState.currentLotteryType];
        if (issueEl) {
            if (currentData && currentData.issue) {
                issueEl.textContent = 'ç¬¬' + currentData.issue + 'æœŸ';
            } else {
                issueEl.textContent = 'ç¬¬xxxæœŸ';
            }
        }
        
        // æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        updateSwitchButtons();
        
        if (!appState.lotteryNumbers || appState.lotteryNumbers.length < 7 || appState.lotteryNumbers[0] === 0) {
            container.innerHTML = '<div class="lottery-empty">è¯·å…ˆè®¾ç½®å¼€å¥–å·ç </div>';
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ’­æ¨¡å¼ï¼ˆåªæœ‰ç›´æ’­åˆ·æ–°æ—¶æ‰æœ‰åŠ¨ç”»ï¼‰
        const isLive = window.isLiveAnimationEnabled || false;
        
        let html = '';
        for (let i = 0; i < 6; i++) {
            const num = appState.lotteryNumbers[i];
            const color = getNumberColor(num);
            const shengxiao = getNumberShengxiao(num);
            const wuxing = getNumberWuxing(num);
            
            if (isLive) {
                const delay = i * 0.15;
                html += `
                    <div class="ball-wrapper">
                        <div class="ball ${color}" style="--delay:${delay}s">${String(num).padStart(2, '0')}</div>
                        <div class="ball-info">${shengxiao}/${wuxing}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="ball-wrapper">
                        <div class="ball ${color} no-anim">${String(num).padStart(2, '0')}</div>
                        <div class="ball-info">${shengxiao}/${wuxing}</div>
                    </div>
                `;
            }
        }
        
        html += '<span class="ball-plus">+</span>';
        
        // ç‰¹ç 
        const special = appState.lotteryNumbers[6];
        const specialColor = getNumberColor(special);
        const specialShengxiao = getNumberShengxiao(special);
        const specialWuxing = getNumberWuxing(special);
        
        if (isLive) {
            const specialDelay = 6 * 0.15 + 0.2;
            html += `
                <div class="ball-wrapper">
                    <div class="ball ${specialColor}" style="--delay:${specialDelay}s">${String(special).padStart(2, '0')}</div>
                    <div class="ball-info">${specialShengxiao}/${specialWuxing}</div>
                </div>
            `;
        } else {
            html += `
                <div class="ball-wrapper">
                    <div class="ball ${specialColor} no-anim">${String(special).padStart(2, '0')}</div>
                    <div class="ball-info">${specialShengxiao}/${specialWuxing}</div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        
        // é‡ç½®ç›´æ’­åŠ¨ç”»æ ‡å¿—
        window.isLiveAnimationEnabled = false;
    }
    
    // åˆ‡æ¢å½©ç§
    function switchLotteryType(type) {
        appState.currentLotteryType = type;
        
        // åŠ è½½å¯¹åº”å½©ç§çš„æ•°æ®
        const data = appState.lotteryData[type];
        if (data && data.numbers && data.numbers.length === 7) {
            appState.lotteryNumbers = data.numbers;
        } else {
            appState.lotteryNumbers = [];
        }
        
        // ä¿å­˜å¹¶åˆ·æ–°æ˜¾ç¤º
        saveConfig();
        renderLotteryBalls();
    }
    
    // ==================== å†å²è®°å½•åŠŸèƒ½ ====================
    
    let currentHistoryType = 'xam';  // å½“å‰å†å²è®°å½•æ˜¾ç¤ºçš„å½©ç§
    
    // åˆ‡æ¢å†å²è®°å½•å½©ç§
    function switchHistoryType(type) {
        currentHistoryType = type;
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        const btnXam = document.getElementById('history-btn-xam');
        const btnHk = document.getElementById('history-btn-hk');
        
        if (btnXam && btnHk) {
            if (type === 'xam') {
                btnXam.style.background = 'rgba(233,69,96,0.2)';
                btnHk.style.background = 'transparent';
            } else {
                btnHk.style.background = 'rgba(76,175,80,0.2)';
                btnXam.style.background = 'transparent';
            }
        }
        
        renderHistoryList();
    }
    
    // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
    function renderHistoryList() {
        const container = document.getElementById('history-list');
        if (!container) return;
        
        // ç¡®ä¿å†å²è®°å½•ç»“æ„å­˜åœ¨
        if (!appState.lotteryHistory) {
            appState.lotteryHistory = { xam: [], hk: [] };
        }
        
        const history = appState.lotteryHistory[currentHistoryType] || [];
        
        if (history.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#666;font-size:12px;padding:20px;">æš‚æ— å†å²è®°å½•ï¼Œè¯·ç‚¹å‡»"æ‰‹åŠ¨è·å–"æŒ‰é’®</div>';
            return;
        }
        
        let html = '';
        history.forEach((item, index) => {
            const numbersStr = item.numbers.slice(0, 6).map(n => String(n).padStart(2, '0')).join(' ') + 
                            ' + ' + String(item.numbers[6]).padStart(2, '0');
            const isFirst = index === 0;
            
            // è®¡ç®—æ—¥æœŸï¼šä»æœŸå·æ¨ç®—ï¼ˆå‡è®¾æ¯å¤©ä¸€æœŸï¼Œä»æœ€æ–°ä¸€æœŸçš„æ—¥æœŸå¾€å‰æ¨ï¼‰
            let dateStr = '';
            if (item.time) {
                // å¦‚æœæœ‰æ—¶é—´ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
                const match = item.time.match(/(\d{4}-\d{2}-\d{2})/);
                if (match) {
                    dateStr = match[1].substring(5); // å– MM-DD
                }
            } else if (isFirst && appState.lotteryData[currentHistoryType]?.time) {
                // æœ€æ–°ä¸€æœŸä½¿ç”¨å½“å‰æ•°æ®çš„æ—¶é—´
                const match = appState.lotteryData[currentHistoryType].time.match(/(\d{4}-\d{2}-\d{2})/);
                if (match) {
                    dateStr = match[1].substring(5);
                }
            }
            
            html += `
                <div onclick="selectHistoryItem('${currentHistoryType}', ${index})" 
                    style="display:flex;justify-content:space-between;align-items:center;padding:8px;margin-bottom:4px;background:${isFirst ? 'rgba(233,69,96,0.15)' : 'rgba(255,255,255,0.05)'};border-radius:6px;cursor:pointer;border:1px solid ${isFirst ? 'rgba(233,69,96,0.3)' : 'transparent'};">
                    <div style="flex:1;">
                        <div style="font-size:11px;color:#888;margin-bottom:2px;">
                            ç¬¬${item.issue}æœŸ
                            ${dateStr ? '<span style="color:#4CAF50;margin-left:6px;">' + dateStr + '</span>' : ''}
                            ${isFirst ? '<span style="color:#e94560;font-weight:bold;margin-left:6px;">æœ€æ–°</span>' : ''}
                        </div>
                        <div style="font-size:13px;color:#fff;font-family:monospace;">${numbersStr}</div>
                    </div>
                    <button onclick="event.stopPropagation();selectHistoryItem('${currentHistoryType}', ${index})" 
                            style="padding:4px 10px;background:linear-gradient(90deg,#3498db,#2980b9);color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer;">é€‰ç”¨</button>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // é€‰æ‹©å†å²è®°å½•
    function selectHistoryItem(type, index) {
        if (!appState.lotteryHistory || !appState.lotteryHistory[type]) return;
        
        const item = appState.lotteryHistory[type][index];
        if (!item || !item.numbers) return;
        
        // è®¾ç½®ä¸ºå½“å‰æ•°æ®
        appState.lotteryNumbers = item.numbers.slice();
        appState.currentLotteryType = type;
        appState.lotteryData[type] = {
            numbers: item.numbers.slice(),
            issue: item.issue,
            time: item.time,
            source: item.source
        };
        
        // å¡«å…¥è¾“å…¥æ¡†
        for (let i = 0; i < 6; i++) {
            const input = document.getElementById('num' + (i + 1));
            if (input) {
                input.value = String(item.numbers[i]).padStart(2, '0');
                updateInputColor(input, item.numbers[i], false);
            }
        }
        const specialInput = document.getElementById('num-special');
        if (specialInput) {
            specialInput.value = String(item.numbers[6]).padStart(2, '0');
            updateInputColor(specialInput, item.numbers[6], true);
        }
        
        // æ˜¾ç¤ºé¢„è§ˆ
        showParsePreview(item.numbers.slice(0, 6), item.numbers[6]);
        
        saveConfig();
        renderLotteryBalls();
        
        // è‡ªåŠ¨è¿”å›ä¸»é¡µï¼Œæ˜¾ç¤ºç®€çŸ­æç¤º
        showPage('page-main');
        
        // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä¸é˜»å¡ï¼‰
        const toast = document.createElement('div');
        toast.innerHTML = `âœ… å·²åº”ç”¨ç¬¬${item.issue}æœŸ`;
        toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#4CAF50;padding:15px 25px;border-radius:10px;font-size:14px;z-index:9999;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 1500);
    }
    
    // æ·»åŠ å†å²è®°å½•ï¼ˆè·å–æ–°æ•°æ®æ—¶è°ƒç”¨ï¼‰
    function addToHistory(type, data) {
        if (!data || !data.numbers || data.numbers.length < 7) return;
        
        // ç¡®ä¿å†å²è®°å½•ç»“æ„å­˜åœ¨
        if (!appState.lotteryHistory) {
            appState.lotteryHistory = { xam: [], hk: [] };
        }
        if (!appState.lotteryHistory[type]) {
            appState.lotteryHistory[type] = [];
        }
        
        const history = appState.lotteryHistory[type];
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæœŸå·
        const existingIndex = history.findIndex(h => h.issue === data.issue);
        if (existingIndex !== -1) {
            // å·²å­˜åœ¨ï¼Œæ›´æ–°æ•°æ®
            history[existingIndex] = {
                numbers: data.numbers.slice(),
                issue: data.issue,
                time: data.time,
                source: data.source
            };
        } else {
            // ä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ°æœ€å‰é¢
            history.unshift({
                numbers: data.numbers.slice(),
                issue: data.issue,
                time: data.time,
                source: data.source
            });
            
            // ä¿æŒæœ€å¤š10æœŸ
            if (history.length > 10) {
                history.pop();
            }
        }
        
        saveConfig();
    }
    
    // æ‰¹é‡æ·»åŠ å†å²è®°å½•ï¼ˆä»APIçš„historyå­—æ®µè§£æï¼‰
    function addHistoryFromAPI(type, historyArray, latestOpenTime) {
        if (!historyArray || !Array.isArray(historyArray)) return;
        
        // ç¡®ä¿å†å²è®°å½•ç»“æ„å­˜åœ¨
        if (!appState.lotteryHistory) {
            appState.lotteryHistory = { xam: [], hk: [] };
        }
        if (!appState.lotteryHistory[type]) {
            appState.lotteryHistory[type] = [];
        }
        
        // è§£ææœ€æ–°çš„å¼€å¥–æ—¥æœŸ
        let latestDate = null;
        if (latestOpenTime) {
            const match = latestOpenTime.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                latestDate = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
            }
        }
        
        // è§£æå†å²è®°å½•æ ¼å¼: "2025129 æœŸï¼š49,19,28,10,17,45,01"
        const parsedHistory = [];
        for (let i = 0; i < Math.min(historyArray.length, 10); i++) {
            const item = historyArray[i];
            // åŒ¹é…æ ¼å¼: "æœŸå· æœŸï¼šå·ç "
            const match = item.match(/(\d+)\s*æœŸ[ï¼š:]\s*([\d,]+)/);
            if (match) {
                const issue = match[1];
                const numbers = match[2].split(',').map(n => parseInt(n.trim()));
                if (numbers.length === 7) {
                    let dateStr = '';
                    
                    if (type === 'xam') {
                        // æ–°æ¾³é—¨ï¼šæ¯å¤©ä¸€æœŸï¼Œå¯ä»¥æ¨ç®—æ—¥æœŸ
                        if (latestDate) {
                            const date = new Date(latestDate);
                            date.setDate(date.getDate() - i);
                            dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        }
                    } else if (type === 'hk' && i === 0 && latestOpenTime) {
                        // é¦™æ¸¯ï¼šæ¯å‘¨äºŒã€å››ã€å…­å¼€å¥–ï¼Œåªæœ‰æœ€æ–°ä¸€æœŸæ˜¾ç¤ºæ—¥æœŸ
                        dateStr = latestOpenTime;
                    }
                    // é¦™æ¸¯å†å²è®°å½•ä¸æ˜¾ç¤ºæ—¥æœŸï¼ˆå› ä¸ºæ¯å‘¨3æœŸï¼Œæ— æ³•ç®€å•æ¨ç®—ï¼‰
                    
                    parsedHistory.push({
                        numbers: numbers,
                        issue: issue,
                        time: dateStr,
                        source: 'Marksix6å†å²'
                    });
                }
            }
        }
        
        // æ›¿æ¢å†å²è®°å½•
        appState.lotteryHistory[type] = parsedHistory;
        saveConfig();
    }
    
    // è·å–å†å²å¼€å¥–è®°å½•
    async function fetchHistoryData() {
        const api = LOTTERY_APIS.marksix6;
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const historyList = document.getElementById('history-list');
        if (historyList) {
            historyList.innerHTML = '<div style="text-align:center;color:#9b59b6;font-size:12px;padding:20px;">ğŸ”„ æ­£åœ¨è·å–å†å²è®°å½•...</div>';
        }
        
        try {
            // ä½¿ç”¨ fetchWithProxy è§£å†³CORSé—®é¢˜
            const data = await fetchWithProxy(api.url);
            
            if (!data.lottery_data) {
                throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
            }
            
            // è§£ææ–°æ¾³é—¨å†å²
            const xamLottery = data.lottery_data.find(l => l.name === 'æ–°æ¾³é—¨å½©');
            if (xamLottery && xamLottery.history) {
                addHistoryFromAPI('xam', xamLottery.history, xamLottery.openTime);
            }
            
            // è§£æé¦™æ¸¯å†å²
            const hkLottery = data.lottery_data.find(l => l.name === 'é¦™æ¸¯å½©');
            if (hkLottery && hkLottery.history) {
                addHistoryFromAPI('hk', hkLottery.history, hkLottery.openTime);
            }
            
            // åˆ·æ–°æ˜¾ç¤º
            renderHistoryList();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const toast = document.createElement('div');
            toast.innerHTML = 'âœ… å†å²è®°å½•è·å–æˆåŠŸ';
            toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#4CAF50;padding:15px 25px;border-radius:10px;font-size:14px;z-index:9999;';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1500);
            
        } catch (e) {
            console.error('è·å–å†å²è®°å½•å¤±è´¥:', e);
            if (historyList) {
                historyList.innerHTML = '<div style="text-align:center;color:#e94560;font-size:12px;padding:20px;">âŒ è·å–å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
    }
    
    // å¤åˆ¶å¼€å¥–ç»“æœ
    function copyLotteryResult() {
        const currentData = appState.lotteryData[appState.currentLotteryType];
        if (!currentData || !currentData.numbers || currentData.numbers.length < 7) {
            alert('æš‚æ— å¼€å¥–ç»“æœå¯å¤åˆ¶');
            return;
        }
        
        // ç®€åŒ–åç§°ï¼šæ–°å¥¥ã€é¦™å…­
        const typeNames = { xam: 'æ–°å¥¥', hk: 'é¦™å…­', am: 'æ¾³é—¨' };
        const typeName = typeNames[appState.currentLotteryType] || 'å…­åˆ';
        const numbers = currentData.numbers;
        
        // å·ç æ ¼å¼ï¼šä¸¤ä¸¤åˆ†ç»„ï¼Œç‰¹ç å‰ç”¨"ç‰¹"
        // æ ¼å¼ï¼š31 26  44 21  22 34 ç‰¹ 16
        const n = numbers.map(num => String(num).padStart(2, '0'));
        const numbersStr = `${n[0]} ${n[1]}  ${n[2]} ${n[3]}  ${n[4]} ${n[5]} ç‰¹ ${n[6]}`;
        
        // ç”Ÿè‚–æ ¼å¼ï¼šä¸å·ç å¯¹é½
        // æ ¼å¼ï¼šçŒª  é¾™  ç‹—  é¸¡  çŒ´  çŒ´      è™
        const sx = numbers.map(num => getNumberShengxiao(num));
        const shengxiaoStr = `${sx[0]}  ${sx[1]}  ${sx[2]}  ${sx[3]}  ${sx[4]}  ${sx[5]}      ${sx[6]}`;
        
        // é¢œè‰²æ ¼å¼ï¼šä¸å·ç å¯¹é½
        // æ ¼å¼ï¼šè“  è“  ç»¿  ç»¿  ç»¿  çº¢      ç»¿
        const colorMap = { red: 'çº¢', blue: 'è“', green: 'ç»¿' };
        const colors = numbers.map(num => colorMap[getNumberColor(num)] || '?');
        const colorStr = `${colors[0]}  ${colors[1]}  ${colors[2]}  ${colors[3]}  ${colors[4]}  ${colors[5]}      ${colors[6]}`;
        
        // æ—¶é—´æ ¼å¼ï¼ˆåªä¿ç•™æ—¥æœŸéƒ¨åˆ†ï¼‰
        let dateStr = 'æœªçŸ¥';
        if (currentData.time) {
            const match = currentData.time.match(/(\d{4}-\d{2}-\d{2})/);
            if (match) {
                dateStr = match[1];
            }
        }
        
        const text = `ã€${typeName}ã€‘ç¬¬${currentData.issue}æœŸ\nå·ç ï¼š${numbersStr}\nç”Ÿè‚–ï¼š${shengxiaoStr}\né¢œè‰²ï¼š${colorStr}\næ—¶é—´ï¼š${dateStr}`;
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess();
            }).catch(() => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }
    
    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showCopySuccess();
        } catch (e) {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
        document.body.removeChild(textarea);
    }
    
    function showCopySuccess() {
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤ºï¼ˆ2ç§’åè‡ªåŠ¨å…³é—­ï¼‰
        const toast = document.createElement('div');
        toast.innerHTML = 'âœ… å·²å¤åˆ¶å¼€å¥–ç»“æœ';
        toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#4CAF50;padding:15px 25px;border-radius:10px;font-size:14px;z-index:9999;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);  // 2ç§’åè‡ªåŠ¨å…³é—­
    }
    
    // æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€
    function updateSwitchButtons() {
        const btnXam = document.getElementById('btn-xam');
        const btnHk = document.getElementById('btn-hk');
        
        if (btnXam && btnHk) {
            if (appState.currentLotteryType === 'xam') {
                btnXam.style.background = '#e94560';
                btnXam.style.color = '#fff';
                btnHk.style.background = 'transparent';
                btnHk.style.color = '#4CAF50';
            } else {
                btnHk.style.background = '#4CAF50';
                btnHk.style.color = '#fff';
                btnXam.style.background = 'transparent';
                btnXam.style.color = '#e94560';
            }
        }
    }
    
    function getNumberColor(num) {
        if (LHC_DATA.bose['çº¢æ³¢'].includes(num)) return 'red';
        if (LHC_DATA.bose['è“æ³¢'].includes(num)) return 'blue';
        if (LHC_DATA.bose['ç»¿æ³¢'].includes(num)) return 'green';
        return 'blue';
    }
    
    function getNumberShengxiao(num) {
        for (let [sx, nums] of Object.entries(LHC_DATA.shengxiao)) {
            if (nums.includes(num)) return sx;
        }
        return '';
    }
    
    function getNumberWuxing(num) {
        for (let [wx, nums] of Object.entries(LHC_DATA.wuxing)) {
            if (nums.includes(num)) return wx;
        }
        return '';
    }
    
    // ==================== èµ”ç‡è®¾ç½® ====================
    function saveOdds() {
        // ä¿å­˜æ‰€æœ‰èµ”ç‡è¾“å…¥æ¡†çš„å€¼
        saveOddsToStorage();
        
        showPage('page-main');
        alert('èµ”ç‡è®¾ç½®å·²ä¿å­˜ï¼');
    }
    
    // ==================== æ¿€æ´»åŠŸèƒ½ ====================
    function checkLicense() {
        const statusEl = document.getElementById('license-status');
        
        // æ£€æŸ¥è¯•ç”¨æœŸ
        let installTime = localStorage.getItem('lhc_install_time');
        if (!installTime) {
            installTime = Date.now().toString();
            localStorage.setItem('lhc_install_time', installTime);
        }
        
        const elapsed = Date.now() - parseInt(installTime);
        const daysLeft = Math.max(0, 7 - Math.floor(elapsed / (24 * 60 * 60 * 1000)));
        appState.trialDaysLeft = daysLeft;
        
        // æ£€æŸ¥æ¿€æ´»çŠ¶æ€
        const licenseData = localStorage.getItem('lhc_license');
        if (licenseData) {
            const data = JSON.parse(licenseData);
            if (data.activated) {
                appState.isActivated = true;
                statusEl.textContent = 'å·²æ¿€æ´» âœ“';
                statusEl.className = 'status-value active';
                return;
            }
        }
        
        if (daysLeft > 0) {
            statusEl.textContent = `è¯•ç”¨æœŸå‰©ä½™ ${daysLeft} å¤©`;
            statusEl.className = 'status-value trial';
        } else {
            statusEl.textContent = 'è¯•ç”¨æœŸå·²è¿‡ï¼Œè¯·æ¿€æ´»';
            statusEl.className = 'status-value expired';
        }
    }
    
    function copyMachineCode() {
        navigator.clipboard.writeText(appState.machineCode).then(() => {
            alert('æœºå™¨ç å·²å¤åˆ¶ï¼');
        }).catch(() => {
            const input = document.createElement('input');
            input.value = appState.machineCode;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            alert('æœºå™¨ç å·²å¤åˆ¶ï¼');
        });
    }
    
    function activateLicense() {
        const code = document.getElementById('license-input').value.trim().toUpperCase();
        if (!code) {
            alert('è¯·è¾“å…¥æ¿€æ´»ç ');
            return;
        }
        
        // è¿™é‡Œå®ç°æ¿€æ´»éªŒè¯é€»è¾‘
        // ç®€å•ç¤ºä¾‹ï¼šéªŒè¯æ¿€æ´»ç æ ¼å¼
        if (code.length >= 16) {
            localStorage.setItem('lhc_license', JSON.stringify({
                activated: true,
                code: code,
                time: Date.now()
            }));
            appState.isActivated = true;
            checkLicense();
            alert('æ¿€æ´»æˆåŠŸï¼');
        } else {
            alert('æ¿€æ´»ç æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•');
        }
    }
    
    // ==================== å‚ç…§è¡¨æ¸²æŸ“ ====================
    function renderReferenceTables() {
        // ç”Ÿè‚–è¡¨
        let sxHtml = '<tr><th>ç”Ÿè‚–</th><th>å¯¹åº”å·ç </th></tr>';
        for (let [sx, nums] of Object.entries(LHC_DATA.shengxiao)) {
            const numsStr = nums.map(n => {
                const color = getNumberColor(n);
                return `<span class="num-${color}">${String(n).padStart(2, '0')}</span>`;
            }).join(' ');
            sxHtml += `<tr><td>${sx}</td><td>${numsStr}</td></tr>`;
        }
        document.getElementById('ref-shengxiao').innerHTML = sxHtml;
        
        // äº”è¡Œè¡¨
        let wxHtml = '<tr><th>äº”è¡Œ</th><th>å¯¹åº”å·ç </th></tr>';
        for (let [wx, nums] of Object.entries(LHC_DATA.wuxing)) {
            const numsStr = nums.map(n => {
                const color = getNumberColor(n);
                return `<span class="num-${color}">${String(n).padStart(2, '0')}</span>`;
            }).join(' ');
            wxHtml += `<tr><td>${wx}</td><td>${numsStr}</td></tr>`;
        }
        document.getElementById('ref-wuxing').innerHTML = wxHtml;
        
        // æ³¢è‰²è¡¨
        let bsHtml = '<tr><th>æ³¢è‰²</th><th>å¯¹åº”å·ç </th></tr>';
        for (let [bs, nums] of Object.entries(LHC_DATA.bose)) {
            const colorClass = bs === 'çº¢æ³¢' ? 'red' : bs === 'è“æ³¢' ? 'blue' : 'green';
            const numsStr = nums.map(n => `<span class="num-${colorClass}">${String(n).padStart(2, '0')}</span>`).join(' ');
            bsHtml += `<tr><td>${bs}</td><td>${numsStr}</td></tr>`;
        }
        document.getElementById('ref-bose').innerHTML = bsHtml;
        
        // å®¶ç¦½é‡å…½è¡¨
        let jqHtml = '<tr><th>ç±»å‹</th><th>ç”Ÿè‚–</th></tr>';
        for (let [type, sxList] of Object.entries(LHC_DATA.jiaqin)) {
            jqHtml += `<tr><td>${type}</td><td>${sxList.join(' ')}</td></tr>`;
        }
        document.getElementById('ref-jiaqin').innerHTML = jqHtml;
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                    ã€æ¨¡å—1ã€‘æ ¼å¼è§£ææ¨¡å—                        â•‘
    // â•‘  æ–‡ä»¶åˆ†ç¦»æ—¶æå–åˆ°: js/parser.js                                 â•‘
    // â•‘  åŠŸèƒ½: è§£æç”¨æˆ·è¾“å…¥çš„ä¸‹æ³¨æ–‡æœ¬ï¼Œè¯†åˆ«ç©æ³•å’Œé‡‘é¢                    â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // å­˜å‚¨è§£æåçš„ä¸‹æ³¨æ•°æ®
    let parsedBets = [];
    let calcResults = [];
    let parsedGroups = [];  // å­˜å‚¨åˆ†ç»„ä¿¡æ¯
    let parsedLines = [];   // ğŸ†• å­˜å‚¨è¡Œçº§æ•°æ®ï¼ˆç”¨äºå°ç¥¨å¼æ¸²æŸ“ï¼‰
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ã€åˆ†ç»„è§£æç³»ç»Ÿ v3.0ã€‘ä¸¥æ ¼ç©ºè¡Œåˆ†ç»„ + è¡Œçº§è¿½è¸ª + åŸæ–‡ç»‘å®š
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /**
     * è§£æä¸‹æ³¨ä¿¡æ¯ï¼ˆå…¥å£å‡½æ•°ï¼‰- ä¸¥æ ¼åˆ†ç»„ + è¡Œçº§è¿½è¸ª
     * @param {string} input - ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ–‡æœ¬
     * @param {boolean} returnGroups - æ˜¯å¦è¿”å›åˆ†ç»„ä¿¡æ¯
     * @returns {Array} - è§£æåçš„ä¸‹æ³¨åˆ—è¡¨ï¼ˆå¸¦ groupId, lineId, originalLineï¼‰
     */
    function parseBetInput(input, returnGroups = false) {
        const bets = [];
        parsedGroups = [];
        parsedLines = [];
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ã€é¢„å¤„ç†ã€‘ç»Ÿä¸€æ¢è¡Œç¬¦æ ¼å¼ï¼Œè§£å†³å¾®ä¿¡/è·¨å¹³å°å¤åˆ¶ç²˜è´´é—®é¢˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let normalizedInput = input
            .replace(/\r\n/g, '\n')     // Windowsæ¢è¡Œ â†’ Unix
            .replace(/\r/g, '\n')       // è€Macæ¢è¡Œ â†’ Unix
            .trim();                     // ç§»é™¤é¦–å°¾ç©ºç™½
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ã€ç¬¬ä¸€å±‚åˆ‡å‰²ã€‘ä¸¥æ ¼æŒ‰ç©ºè¡Œåˆ†ç»„ v2.4.6
        // ğŸ†• æ”¹è¿›ï¼šé€è¡Œæ£€æµ‹ç©ºè¡Œï¼ˆåªåŒ…å«ç©ºç™½å­—ç¬¦çš„è¡Œï¼‰ï¼Œé¿å…è¡Œé¦–ç©ºæ ¼å¹²æ‰°åˆ†ç»„
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const allLines = normalizedInput.split('\n');
        const groupTexts = [];
        let currentGroup = [];
        
        for (const line of allLines) {
            const trimmedLine = line.trim();
            if (trimmedLine === '') {
                // ç©ºè¡Œï¼šå¦‚æœå½“å‰ç»„æœ‰å†…å®¹ï¼Œåˆ™ç»“æŸå½“å‰ç»„
                if (currentGroup.length > 0) {
                    groupTexts.push(currentGroup.join('\n'));
                    currentGroup = [];
                }
            } else {
                // éç©ºè¡Œï¼šæ·»åŠ åˆ°å½“å‰ç»„ï¼ˆå·²trimè¿‡ï¼‰
                currentGroup.push(trimmedLine);
            }
        }
        // æ·»åŠ æœ€åä¸€ç»„
        if (currentGroup.length > 0) {
            groupTexts.push(currentGroup.join('\n'));
        }
        
        console.log(`ğŸ“¦ åˆ†ç»„åˆ‡å‰² v2.4.6: æ£€æµ‹åˆ° ${allLines.length} è¡Œï¼Œåˆ†æˆ ${groupTexts.length} ç»„`);
        
        console.log(`ğŸ“¦ åˆ†ç»„åˆ‡å‰²: å…± ${groupTexts.length} ä¸ªç»„`);
        
        let globalLineIndex = 0;  // å…¨å±€è¡Œå·ï¼ˆç”¨äºåé¦ˆé¡µå®šä½ï¼‰
        
        groupTexts.forEach((groupText, groupIndex) => {
            const groupId = groupIndex + 1;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ã€ç¬¬äºŒå±‚åˆ‡å‰²ã€‘ç»„å†…æŒ‰å•æ¢è¡Œåˆ†è¡Œ
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const lines = groupText.split('\n').map(l => l.trim()).filter(l => l);
            const groupBets = [];
            const groupLineData = [];
            
            console.log(`  ğŸ“‹ ç»„${groupId}: ${lines.length}è¡Œ`);
            
            lines.forEach((originalLine, lineIndexInGroup) => {
                const lineId = `${groupId}-${lineIndexInGroup}`;  // å”¯ä¸€è¡Œæ ‡è¯†
                
                // å°è¯•è§£æè¯¥è¡Œ
                let parsed = null;
                let isError = false;
                
                try {
                    parsed = parseBetLine(originalLine);
                } catch (e) {
                    console.warn(`    âš ï¸ è¡Œ${lineId}è§£æå¼‚å¸¸:`, e.message);
                    isError = true;
                }
                
                // æ„å»ºè¡Œçº§æ•°æ®
                const lineData = {
                    lineId: lineId,
                    groupId: groupId,
                    lineIndexInGroup: lineIndexInGroup,
                    globalLineIndex: globalLineIndex,
                    originalLine: originalLine,  // ğŸ”‘ å…³é”®ï¼šä¿ç•™å®Œæ•´åŸæ–‡
                    bets: [],
                    betCount: 0,
                    isError: isError,
                    parseError: isError ? 'è§£æå¤±è´¥' : null
                };
                
                if (parsed && parsed.length > 0) {
                    // è§£ææˆåŠŸï¼šä¸ºæ¯ä¸ªbetç»‘å®šè¡Œçº§ä¿¡æ¯
                    parsed.forEach((bet, betIndex) => {
                        bet.groupId = groupId;
                        bet.lineId = lineId;
                        bet.originalLine = originalLine;  // ğŸ”‘ æ¯ä¸ªbetéƒ½ç»‘å®šåŸæ–‡
                        bet.globalLineIndex = globalLineIndex;
                        bet.betIndexInLine = betIndex;
                        
                        lineData.bets.push(bet);
                        groupBets.push(bet);
                        bets.push(bet);
                    });
                    lineData.betCount = parsed.length;
                    console.log(`    âœ… è¡Œ${lineId}: "${originalLine.substring(0,20)}..." â†’ ${parsed.length}æ³¨`);
                } else {
                    // è§£æå¤±è´¥æˆ–æ— ç»“æœï¼šç”Ÿæˆå ä½å¯¹è±¡
                    const placeholderBet = {
                        type: 'æœªè¯†åˆ«',
                        value: '',
                        amount: 0,
                        groupId: groupId,
                        lineId: lineId,
                        originalLine: originalLine,  // ğŸ”‘ ä¿ç•™åŸæ–‡ï¼
                        globalLineIndex: globalLineIndex,
                        betIndexInLine: 0,
                        isError: true,
                        parseError: 'æœªèƒ½è§£æå‡ºæœ‰æ•ˆä¸‹æ³¨'
                    };
                    lineData.bets.push(placeholderBet);
                    lineData.betCount = 0;
                    lineData.isError = true;
                    groupBets.push(placeholderBet);
                    bets.push(placeholderBet);
                    console.log(`    âŒ è¡Œ${lineId}: "${originalLine.substring(0,20)}..." â†’ æœªè¯†åˆ«`);
                }
                
                parsedLines.push(lineData);
                groupLineData.push(lineData);
                globalLineIndex++;
            });
            
            // ä¿å­˜åˆ†ç»„ä¿¡æ¯
            parsedGroups.push({
                id: groupId,
                rawText: groupText,
                lines: groupLineData,
                bets: groupBets,
                betCount: groupBets.filter(b => !b.isError).length,
                lineCount: lines.length
            });
        });
        
        console.log(`ğŸ“Š è§£æå®Œæˆ: ${parsedGroups.length}ç»„, ${parsedLines.length}è¡Œ, ${bets.length}æ³¨`);
        
        if (returnGroups) {
            return { bets, groups: parsedGroups, lines: parsedLines };
        }
        return bets;
    }
    
    /**
     * ğŸ†• å­¤å„¿è¡Œæ£€æµ‹ - è¯†åˆ«å¯èƒ½æ˜¯æ‰‹è¯¯æ¢è¡Œçš„è¡Œ
     * è§„åˆ™ï¼šå…¨æ˜¯æ•°å­—/åˆ†éš”ç¬¦ï¼Œä¸”æ²¡æœ‰é‡‘é¢å…³é”®è¯ï¼ˆå„/å…ƒ/x/Xï¼‰
     * @param {string} input - ç”¨æˆ·è¾“å…¥
     * @returns {Array} - æ£€æµ‹åˆ°çš„å­¤å„¿è¡Œä¿¡æ¯
     */
    function detectOrphanLines(input) {
        const orphans = [];
        const lines = input.split('\n');
        
        // é‡‘é¢å…³é”®è¯æ­£åˆ™
        const amountKeywords = /[å„å…ƒxXÃ—å—é’±]/;
        // çº¯æ•°å­—/åˆ†éš”ç¬¦è¡Œæ­£åˆ™ï¼ˆå…è®¸ç©ºæ ¼ã€é€—å·ã€ç‚¹ã€æ–œæ ï¼‰
        const pureNumberLine = /^[\d\s,ï¼Œ.ã€‚\/\-]+$/;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯æ•°å­—è¡Œï¼ˆæ²¡æœ‰é‡‘é¢å…³é”®è¯ï¼‰
            if (pureNumberLine.test(line) && !amountKeywords.test(line)) {
                // æ£€æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦å­˜åœ¨ä¸”æœ‰é‡‘é¢
                const nextLine = lines[i + 1]?.trim() || '';
                
                // åªæœ‰å½“ä¸‹ä¸€è¡Œæœ‰å†…å®¹æ—¶æ‰æ ‡è®°ä¸ºå­¤å„¿è¡Œ
                if (nextLine && amountKeywords.test(nextLine)) {
                    orphans.push({
                        lineIndex: i,
                        lineNumber: i + 1,  // äººç±»å¯è¯»çš„è¡Œå·
                        content: line,
                        nextLineContent: nextLine,
                        suggestMerge: true
                    });
                }
            }
        }
        
        return orphans;
    }
    
    /**
     * ğŸ†• æ˜¾ç¤ºå­¤å„¿è¡Œç¡®è®¤å¼¹çª—
     * @param {Array} orphans - æ£€æµ‹åˆ°çš„å­¤å„¿è¡Œ
     * @param {string} input - åŸå§‹è¾“å…¥
     * @returns {Promise<string>} - å¤„ç†åçš„è¾“å…¥
     */
    function showOrphanConfirmDialog(orphans, input) {
        return new Promise((resolve) => {
            if (orphans.length === 0) {
                resolve(input);
                return;
            }
            
            const orphan = orphans[0];  // ä¸€æ¬¡å¤„ç†ä¸€ä¸ª
            
            const dialogHtml = `
                <div style="text-align:left;">
                    <div style="background:rgba(255,193,7,0.2);padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #ffc107;">
                        <div style="color:#ffc107;font-weight:bold;margin-bottom:8px;">âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„æ–­è¡Œ</div>
                        <div style="font-size:12px;color:#aaa;margin-bottom:4px;">ç¬¬ ${orphan.lineNumber} è¡Œä¼¼ä¹åªæœ‰å·ç ï¼Œæ²¡æœ‰é‡‘é¢ï¼š</div>
                    </div>
                    
                    <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;margin-bottom:10px;font-family:monospace;">
                        <div style="color:#888;font-size:10px;margin-bottom:2px;">ç¬¬${orphan.lineNumber}è¡Œ:</div>
                        <div style="color:#fbbf24;font-size:14px;font-weight:bold;">${orphan.content}</div>
                        <div style="color:#444;margin:4px 0;">â†“ (æ¢è¡Œ)</div>
                        <div style="color:#888;font-size:10px;margin-bottom:2px;">ç¬¬${orphan.lineNumber + 1}è¡Œ:</div>
                        <div style="color:#fff;font-size:14px;">${orphan.nextLineContent}</div>
                    </div>
                    
                    <div style="font-size:12px;color:#888;margin-bottom:12px;">
                        ğŸ’¡ <strong>å»ºè®®</strong>ï¼šå¦‚æœæ˜¯æ‰‹è¯¯æ¢è¡Œï¼Œå¯ä»¥åˆå¹¶è¿™ä¸¤è¡Œ
                    </div>
                    
                    <div style="display:flex;gap:10px;">
                        <button onclick="window._orphanResolve('merge')" style="flex:1;padding:10px;background:linear-gradient(135deg,#4caf50,#45a049);color:white;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">
                            âœ… åˆå¹¶è¿™ä¸¤è¡Œ
                        </button>
                        <button onclick="window._orphanResolve('keep')" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);color:#aaa;border:1px solid #444;border-radius:6px;cursor:pointer;">
                            ä¿æŒåŸæ ·
                        </button>
                    </div>
                </div>
            `;
            
            showCustomModal('ğŸ” æ–­è¡Œæ£€æµ‹', dialogHtml);
            
            window._orphanResolve = (action) => {
                closeCustomModal();
                
                if (action === 'merge') {
                    // åˆå¹¶ï¼šåˆ é™¤è¯¥è¡Œçš„æ¢è¡Œç¬¦
                    const lines = input.split('\n');
                    lines[orphan.lineIndex] = lines[orphan.lineIndex] + ' ' + lines[orphan.lineIndex + 1];
                    lines.splice(orphan.lineIndex + 1, 1);
                    const newInput = lines.join('\n');
                    
                    // æ›´æ–°è¾“å…¥æ¡†
                    document.getElementById('bet-input').value = newInput;
                    showAutoCloseToast('âœ… å·²åˆå¹¶ç¬¬' + orphan.lineNumber + 'è¡Œ', 2000);
                    
                    // é€’å½’æ£€æµ‹å‰©ä½™å­¤å„¿è¡Œ
                    const remainingOrphans = detectOrphanLines(newInput);
                    if (remainingOrphans.length > 0) {
                        showOrphanConfirmDialog(remainingOrphans, newInput).then(resolve);
                    } else {
                        resolve(newInput);
                    }
                } else {
                    // ä¿æŒåŸæ ·ï¼Œç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ª
                    const remainingOrphans = orphans.slice(1);
                    if (remainingOrphans.length > 0) {
                        showOrphanConfirmDialog(remainingOrphans, input).then(resolve);
                    } else {
                        resolve(input);
                    }
                }
            };
        });
    }
    
    // è·å–æ ¼å¼è®¾ç½®
    // API Key å·²ç§»è‡³é˜¿é‡Œäº‘å‡½æ•°ç¯å¢ƒå˜é‡ï¼Œå‰ç«¯ä¸å†å­˜å‚¨
    function getFormatSettings() {
        try {
            const saved = JSON.parse(localStorage.getItem('lhc_format_settings') || '{}');
            // AIé…ç½®ï¼šKeyåœ¨åç«¯ï¼Œå‰ç«¯åªéœ€è¦çŸ¥é“æ˜¯å¦å¯ç”¨å’Œä½¿ç”¨å“ªä¸ªæ¨¡å‹
            // ã€ä¿®å¤ã€‘ä¼˜å…ˆä» ai_provider è¯»å–ç”¨æˆ·åˆ‡æ¢çš„æ¨¡å‹é€‰æ‹©
            // ğŸ†• v3.11.69 é»˜è®¤æ”¹ä¸ºtuziï¼Œå…”å­APIæ›´å¿«
            saved.aiProvider = localStorage.getItem('ai_provider') || saved.aiProvider || 'tuzi';
            if (saved.aiEnabled === undefined) {
                saved.aiEnabled = true; // é»˜è®¤å¯ç”¨
            }
            return saved;
        } catch(e) {
            return {
            aiEnabled: true,
            aiProvider: localStorage.getItem('ai_provider') || 'tuzi'  // ğŸ†• v3.11.69 å…”å­API
        };
        }
    }
    
    // è§£æè‡ªå®šä¹‰å…³é”®è¯
    function parseCustomKeywords(line, settings) {
        const bets = [];
        const keywords = (settings.customKeywords || '').split('\n').filter(k => k.trim());
        
        for (const kw of keywords) {
            const [key, playType] = kw.split('=').map(s => s.trim());
            if (key && playType && line.includes(key)) {
                // æå–å…³é”®è¯åé¢çš„æ•°å­—ä½œä¸ºé‡‘é¢
                const amountMatch = line.match(new RegExp(key + '.*?(\\d+)'));
                if (amountMatch) {
                    // æå–å¯èƒ½çš„å·ç æˆ–ç”Ÿè‚–
                    const numMatch = line.match(/(\d+)/g);
                    if (numMatch && numMatch.length >= 2) {
                        bets.push({ 
                            type: playType, 
                            value: numMatch[0], 
                            number: parseInt(numMatch[0]),
                            amount: parseInt(numMatch[numMatch.length - 1]), 
                            raw: line 
                        });
                        return bets;
                    }
                }
            }
        }
        return null;
    }
    
    // å¢å¼ºç‰ˆè§£æå•è¡Œä¸‹æ³¨
    function parseBetLine(line) {
        const bets = [];
        const settings = getFormatSettings();
        const shengxiaoList = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'];
        
        // ã€å…³é”®ä¿®å¤ã€‘é¢„å¤„ç†ï¼šå…¨è§’è½¬åŠè§’ï¼ˆè§£å†³æ‰‹æœºè¾“å…¥é—®é¢˜ï¼‰
        if (typeof normalizeFullWidth === 'function') {
            line = normalizeFullWidth(line);
        }
        
        // é¢„å¤„ç†ï¼šè½¬æ¢ä¸­æ–‡æ•°å­—
        if (settings.cnNumber !== false) {
        line = convertChineseNumber(line);
        }
        
        // é¢„å¤„ç†ï¼šæ¸…ç†å¤šä½™ç©ºæ ¼
        if (settings.ignoreSpace !== false) {
            line = line.replace(/\s+/g, ' ').trim();
        }
        
        // é¢„å¤„ç†ï¼šåŒéŸ³å­—çº æ­£
        if (settings.autoCorrect !== false) {
            line = correctHomophones(line);
        }
        
        // ä¼˜å…ˆæ£€æŸ¥è‡ªå®šä¹‰å…³é”®è¯
        const customResult = parseCustomKeywords(line, settings);
        if (customResult && customResult.length > 0) {
            return customResult;
        }
        
        // ========== æ¨¡å¼1: å¤šå·ç å„ä¸‹æ³¨ ==========
        // "31.34å„20" æˆ– "31 34å„20" æˆ– "31,34å„20"
        if (settings.tplMultiNum !== false) {
            const multiMatch = line.match(/^(\d+[\s.,ï¼Œã€]+\d+(?:[\s.,ï¼Œã€]+\d+)*)å„(\d+)å…ƒ?$/);
        if (multiMatch) {
                const nums = multiMatch[1].split(/[\s.,ï¼Œã€]+/).map(n => parseInt(n));
            const amount = parseInt(multiMatch[2]);
            for (const num of nums) {
                    if (num >= 1 && num <= 49) {
                bets.push({ type: 'ç‰¹ç ', number: num, amount: amount, raw: line });
            }
                }
                if (bets.length) return bets;
            }
        }
        
        // ========== æ¨¡å¼2: ç‰¹ç ä¸‹æ³¨ ==========
        // "ç‰¹43 20å…ƒ" "ç‰¹ç  05 100" "ç‰¹43 20"
        if (settings.tplTema !== false) {
            const temaMatch = line.match(/ç‰¹ç ?\s*(\d+)\s*[,ï¼Œ]?\s*(\d+)å…ƒ?/);
        if (temaMatch) {
            bets.push({ type: 'ç‰¹ç ', number: parseInt(temaMatch[1]), amount: parseInt(temaMatch[2]), raw: line });
            return bets;
            }
        }
        
        // ========== æ¨¡å¼3: Xè¡¨ç¤ºé‡‘é¢ ==========
        // "46,45,X50" "22ï¼Œ33ï¼ŒX15" "é¸¡é¼ çŒ´X10"
        if (settings.tplXAmount !== false) {
            // æ•°å­—+Xé‡‘é¢
            const xNumMatch = line.match(/(\d+(?:[,ï¼Œã€\s]+\d+)*)[,ï¼Œã€\s]*[Xx](\d+)/);
            if (xNumMatch) {
                const nums = xNumMatch[1].split(/[,ï¼Œã€\s]+/).map(n => parseInt(n)).filter(n => n >= 1 && n <= 49);
                const amount = parseInt(xNumMatch[2]);
                for (const num of nums) {
                    bets.push({ type: 'ç‰¹ç ', number: num, amount: amount, raw: line });
                }
                if (bets.length) return bets;
            }
            
            // ç”Ÿè‚–+Xé‡‘é¢
            const xSxMatch = line.match(/([é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]+)[Xx](\d+)/);
            if (xSxMatch) {
                const animals = xSxMatch[1].split('');
                const amount = parseInt(xSxMatch[2]);
                for (const sx of animals) {
                    if (shengxiaoList.includes(sx)) {
                        bets.push({ type: 'ç”Ÿè‚–', value: sx, amount: amount, raw: line });
                    }
                }
                if (bets.length) return bets;
            }
        }
        
        // ========== æ¨¡å¼4: ä¹°ç”Ÿè‚– ==========
        // "ä¹°çŒªå„10" "ä¹°é¾™å„20" "ä¹°çŒª10"
        if (settings.tplShengxiao !== false) {
            const buyMatch = line.match(/ä¹°([é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]+)å„?(\d+)å…ƒ?/);
            if (buyMatch) {
                const animals = buyMatch[1].split('');
                const amount = parseInt(buyMatch[2]);
                for (const sx of animals) {
                    if (shengxiaoList.includes(sx)) {
                        bets.push({ type: 'ç”Ÿè‚–', value: sx, amount: amount, raw: line });
                    }
                }
                if (bets.length) return bets;
            }
            
            // å•ç‹¬ç”Ÿè‚– "é¾™ 200" "çŒª200"
        for (const sx of shengxiaoList) {
                const sxMatch = line.match(new RegExp(`^${sx}\\s*(\\d+)å…ƒ?$`));
            if (sxMatch) {
                bets.push({ type: 'ç”Ÿè‚–', value: sx, amount: parseInt(sxMatch[1]), raw: line });
                return bets;
                }
            }
        }
        
        // ========== æ¨¡å¼5: å°¾æ•°ä¸‹æ³¨ ==========
        // "5å°¾100" "å°¾5 100"
        if (settings.tplWei !== false) {
            const weiMatch = line.match(/(\d)å°¾\s*(\d+)å…ƒ?/) || line.match(/å°¾(\d)\s*(\d+)å…ƒ?/);
            if (weiMatch) {
                bets.push({ type: 'å°¾æ•°', value: weiMatch[1], amount: parseInt(weiMatch[2]), raw: line });
                return bets;
            }
        }
        
        // ========== æ¨¡å¼6: å¤šè‚–ä¸‹æ³¨ ==========
        // "å…­è‚–é¼ ç¾Šé¸¡ç‰›é©¬äºŒ200" "ä¸‰è‚–é¾™è™è›‡100"
        if (settings.tplDuoxiao !== false) {
            const duoxiaoMatch = line.match(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+è‚–|è‚–)([é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]+)\s*(\d+)å…ƒ?/);
            if (duoxiaoMatch) {
                const animals = duoxiaoMatch[2].split('');
                const amount = parseInt(duoxiaoMatch[3]);
                for (const sx of animals) {
                    if (shengxiaoList.includes(sx)) {
                        bets.push({ type: 'å¤šè‚–', value: sx, amount: amount, raw: line });
                    }
                }
                if (bets.length) return bets;
            }
        }
        
        // ========== æ¨¡å¼7: å¹³ç‰¹ç”Ÿè‚– ==========
        // "å¹³ç‰¹çŒ´é¸¡å„200" "å¹³ç‰¹çŒª100"
        if (settings.tplPingte !== false) {
            const pingteMatch = line.match(/å¹³ç‰¹([é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]+)å„?(\d+)å…ƒ?/);
            if (pingteMatch) {
                const animals = pingteMatch[1].split('');
                const amount = parseInt(pingteMatch[2]);
                for (const sx of animals) {
                    if (shengxiaoList.includes(sx)) {
                        bets.push({ type: 'å¹³ç‰¹ç”Ÿè‚–', value: sx, amount: amount, raw: line });
                    }
                }
                if (bets.length) return bets;
            }
        }
        
        // ========== æ¨¡å¼8: æ³¢è‰² ==========
        // "çº¢æ³¢ 50" "çº¢ 50" "è“æ³¢100"
        if (settings.tplBose !== false) {
            const boseMatch = line.match(/(çº¢|è“|ç»¿)æ³¢?\s*(\d+)å…ƒ?/);
        if (boseMatch) {
            bets.push({ type: 'æ³¢è‰²', value: boseMatch[1] + 'æ³¢', amount: parseInt(boseMatch[2]), raw: line });
            return bets;
            }
        }
        
        // ========== æ¨¡å¼9: ä¸¤é¢ï¼ˆå¤§å°å•åŒï¼‰ ==========
        // "å¤§ 100" "å°100" "å•åŒå„50"
        if (settings.tplDxds !== false) {
            const dxdsMatch = line.match(/^(å¤§|å°|å•|åŒ)\s*(\d+)å…ƒ?$/);
        if (dxdsMatch) {
            bets.push({ type: 'ä¸¤é¢', value: dxdsMatch[1], amount: parseInt(dxdsMatch[2]), raw: line });
            return bets;
            }
            
            // "å•åŒå„50"
            const dxdsGeMatch = line.match(/(å¤§å°|å•åŒ)å„(\d+)å…ƒ?/);
            if (dxdsGeMatch) {
                const types = dxdsGeMatch[1].split('');
                const amount = parseInt(dxdsGeMatch[2]);
                for (const t of types) {
                    bets.push({ type: 'ä¸¤é¢', value: t, amount: amount, raw: line });
                }
                if (bets.length) return bets;
            }
        }
        
        // ========== æ¨¡å¼10: çº¯æ•°å­—+é‡‘é¢ ==========
        // "43 20" ç®€å†™å½¢å¼
        const simpleMatch = line.match(/^(\d{1,2})\s+(\d+)å…ƒ?$/);
        if (simpleMatch) {
            const num = parseInt(simpleMatch[1]);
            if (num >= 1 && num <= 49) {
                bets.push({ type: 'ç‰¹ç ', number: num, amount: parseInt(simpleMatch[2]), raw: line });
                return bets;
            }
        }
        
        // ========== æ¨¡å¼11: å¤šç”Ÿè‚–å„ä¸‹æ³¨ ==========
        // "é¼ ç¾Šé¸¡ç‰›é©¬å„200"
        const multiSxMatch = line.match(/^([é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]{2,})å„(\d+)å…ƒ?$/);
        if (multiSxMatch) {
            const animals = multiSxMatch[1].split('');
            const amount = parseInt(multiSxMatch[2]);
            for (const sx of animals) {
                if (shengxiaoList.includes(sx)) {
                    bets.push({ type: 'ç”Ÿè‚–', value: sx, amount: amount, raw: line });
                }
            }
            if (bets.length) return bets;
        }
        
        return null;
    }
    
    // åŒéŸ³å­—çº æ­£
    function correctHomophones(str) {
        const corrections = {
            'çŒª': ['ä¸»', 'æœ±', 'ç ', 'è¯¸'],
            'ç‰›': ['å¦', 'çº½', 'é’®'],
            'è™': ['æˆ·', 'æ²ª', 'æŠ¤'],
            'é¾™': ['éš†', 'è‹', 'ç¬¼'],
            'è›‡': ['èˆ', 'æ¶‰', 'è®¾'],
            'é©¬': ['å¦ˆ', 'ç ', 'ç›','å—'],
            'ç¾Š': ['é˜³', 'æ‰¬', 'æ¨', 'æ´‹'],
            'çŒ´': ['ä¾¯', 'å€™', 'å–‰'],
            'é¸¡': ['æœº', 'åŸº', 'æ¿€', 'åŠ'],
            'ç‹—': ['å¤Ÿ', 'è´­', 'æ„', 'æ²Ÿ'],
            'é¼ ': ['æš‘', 'æ•°', 'å±', 'ç½²'],
            'å…”': ['å', 'å›¾', 'åœŸ', 'é€”']
        };
        
        for (const [correct, wrongs] of Object.entries(corrections)) {
            for (const wrong of wrongs) {
                str = str.replace(new RegExp(wrong, 'g'), correct);
            }
        }
        return str;
    }
    
    // è½¬æ¢ä¸­æ–‡æ•°å­—ï¼ˆæ™ºèƒ½ç‰ˆï¼šæ­£ç¡®å¤„ç†å„ç§ä¸­æ–‡æ•°å­—æ ¼å¼ï¼‰
    function convertChineseNumber(str) {
        // å®šä¹‰ä¸­æ–‡æ•°å­—æ˜ å°„
        const digitMap = {'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸¤':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9};
        
        // å¤„ç†å®Œæ•´çš„ä¸­æ–‡æ•°å­—ï¼ˆå¦‚"äºŒåäº”"ã€"ä¸€ç™¾äºŒå"ç­‰ï¼‰
        function parseChineseNum(cnStr) {
            let result = 0;
            let temp = 0;
            
            for (let i = 0; i < cnStr.length; i++) {
                const char = cnStr[i];
                if (digitMap[char] !== undefined) {
                    temp = digitMap[char];
                } else if (char === 'å') {
                    if (temp === 0 && i === 0) temp = 1; // "å"å¼€å¤´è¡¨ç¤º10
                    result += temp * 10;
                    temp = 0;
                } else if (char === 'ç™¾') {
                    result += temp * 100;
                    temp = 0;
                } else if (char === 'åƒ') {
                    result += temp * 1000;
                    temp = 0;
                }
            }
            result += temp; // åŠ ä¸Šæœ€åçš„ä¸ªä½æ•°
            return result;
        }
        
        // åŒ¹é…ä¸­æ–‡æ•°å­—ä¸²å¹¶æ›¿æ¢
        // åŒ¹é…æ¨¡å¼ï¼šè¿ç»­çš„ä¸­æ–‡æ•°å­—å­—ç¬¦
        const cnNumPattern = /[é›¶ä¸€äºŒä¸¤ä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+/g;
        
        str = str.replace(cnNumPattern, (match) => {
            const num = parseChineseNum(match);
            return num.toString();
        });
        
        return str;
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                    ã€æ¨¡å—2ã€‘è®¡ç®—é€»è¾‘æ¨¡å—                        â•‘
    // â•‘  æ–‡ä»¶åˆ†ç¦»æ—¶æå–åˆ°: js/calculator.js                             â•‘
    // â•‘  åŠŸèƒ½: æ ¹æ®å¼€å¥–å·ç å’Œä¸‹æ³¨ä¿¡æ¯è®¡ç®—ä¸­å¥–ç»“æœ                        â•‘
    // â•‘  ğŸ†• v3.0 è®¡ç®—é€»è¾‘å·²è¿ç§»åˆ°åç«¯ï¼Œå‰ç«¯åªåšå±•ç¤º                      â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /**
     * ğŸ†• v3.4 è·å–èµ”ç‡é…ç½®ï¼ˆè½¬æ¢ä¸ºåç«¯æ ¼å¼ï¼‰
     * ğŸ†• v3.11.2 æ·»åŠ  PT2-PT5 å¹³ç‰¹è¿è‚–èµ”ç‡
     * @returns {Object} èµ”ç‡é…ç½®
     */
    function getOddsConfig() {
        const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
        return {
            r1: parseFloat(savedOdds['odds-tema']) || 43,        // ç‰¹ç å€ç‡
            r2: parseFloat(savedOdds['odds-shengxiao']) || 12,   // ç”Ÿè‚–å€ç‡
            r3: parseFloat(savedOdds['odds-pingte1']) || 11,     // å¹³ç‰¹ä¸€è‚–(PT1)å€ç‡
            r_pt2: parseFloat(savedOdds['odds-pingte2x']) || 26, // å¹³ç‰¹äºŒè¿è‚–(PT2)å€ç‡
            r_pt3: parseFloat(savedOdds['odds-pingte3x']) || 66, // å¹³ç‰¹ä¸‰è¿è‚–(PT3/ä¸‰å‹)å€ç‡
            r_pt4: parseFloat(savedOdds['odds-pingte4x']) || 180,// å¹³ç‰¹å››è¿è‚–(PT4)å€ç‡
            r_pt5: parseFloat(savedOdds['odds-pingte5x']) || 500,// å¹³ç‰¹äº”è¿è‚–(PT5)å€ç‡
            r_dxds: parseFloat(savedOdds['odds-dxds']) || 1.98   // å¤§å°å•åŒå€ç‡
        };
    }
    
    /**
     * ğŸ†• v3.11.68 ç½‘ç»œè¯·æ±‚é‡è¯•å°è£…
     * åŸç†ï¼šæ‰‹æœºç½‘ç»œï¼ˆ4G/5G/WiFiï¼‰åˆ‡æ¢æ—¶å®¹æ˜“æ–­è¿ï¼Œè‡ªåŠ¨é‡è¯•æå‡æˆåŠŸç‡
     * @param {string} url è¯·æ±‚åœ°å€
     * @param {Object} options fetché€‰é¡¹
     * @param {number} retries é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡
     * @param {number} delay é‡è¯•é—´éš”(ms)ï¼Œé»˜è®¤1000ms
     * @returns {Promise<Response>}
     */
    async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
        for (let i = 0; i <= retries; i++) {
            try {
                const response = await fetch(url, options);
                // å¦‚æœè¯·æ±‚æˆåŠŸï¼ˆå³ä½¿æ˜¯4xx/5xxä¹Ÿç®—"å®Œæˆ"ï¼‰ï¼Œç›´æ¥è¿”å›
                return response;
            } catch (err) {
                // ç½‘ç»œé”™è¯¯ï¼ˆæ–­è¿ã€è¶…æ—¶ç­‰ï¼‰
                if (i < retries) {
                    console.warn(`âš ï¸ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•... (${i + 1}/${retries})`, err.message);
                    await new Promise(r => setTimeout(r, delay));
                } else {
                    console.error(`âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå·²é‡è¯•${retries}æ¬¡ä»å¤±è´¥:`, err.message);
                    throw err;
                }
            }
        }
    }
    
    /**
     * ğŸ†• v3.0 è°ƒç”¨åç«¯è®¡ç®—æ¥å£ï¼ˆä¸€ç«™å¼ï¼šè¯†åˆ«+è®¡ç®—ï¼‰
     * @param {string} sanitizedInput ä»£å·è½¬æ¢åçš„è¾“å…¥æ–‡æœ¬ï¼ˆZä»£å·æ ¼å¼ï¼‰
     * @param {Array} dataArr æ•°æ®æ•°ç»„ï¼ˆ7ä¸ªæ•°å­—ï¼‰
     * @param {Object} config é…ç½®å‚æ•° {r1, r2, r3}
     * @param {string} provider æœåŠ¡å•†
     * @param {string} model æ¨¡å‹
     * @returns {Object} è®¡ç®—ç»“æœ {success, items, s1, s2, s3, s4, error}
     */
    async function callBackendCalc(sanitizedInput, dataArr, config, provider = 'deepseek', model = null, hkDataArr = null) {
        const requestBody = {
            t: sanitizedInput,   // ä»£å·è½¬æ¢åçš„æ–‡æœ¬ï¼ˆZä»£å·æ ¼å¼ï¼‰
            d: dataArr,          // æ•°æ®æ•°ç»„ï¼ˆ7ä¸ªæ•°å­—ï¼‰- æ¾³é—¨å¼€å¥–
            c: config,           // é…ç½®å‚æ•°
            p: provider,         // æœåŠ¡å•†
            m: model             // æ¨¡å‹
        };
        
        // ğŸ†• v3.11.30 å¦‚æœæœ‰é¦™æ¸¯å¼€å¥–æ•°æ®ï¼Œä¼ é€’ç»™åç«¯
        if (hkDataArr && hkDataArr.length === 7) {
            requestBody.hk_d = hkDataArr;
        }
        
        // ğŸ†• v3.12 ç²¾ç®€æ—¥å¿—ï¼šåªä¿ç•™å…³é”®ä¿¡æ¯
        console.log('%cğŸ“¤ å‘é€è¯·æ±‚', 'color: #2196f3; font-weight: bold', `| æ–‡æœ¬é•¿åº¦:${sanitizedInput.length}å­—ç¬¦ | æœåŠ¡å•†:${provider}`);
        
        // ğŸ†• v3.11.68 ä½¿ç”¨å¸¦é‡è¯•çš„ fetchï¼ˆç½‘ç»œæŠ–åŠ¨æ—¶è‡ªåŠ¨é‡è¯•3æ¬¡ï¼‰
        const response = await fetchWithRetry(`${ALIYUN_PROXY_URL}/api/calc`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        }, 3, 1000);  // é‡è¯•3æ¬¡ï¼Œé—´éš”1ç§’
        
        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`åç«¯è®¡ç®—å¤±è´¥: ${response.status} - ${errText}`);
        }
        
        const result = await response.json();
        
        // ğŸ†• v3.12 ç²¾ç®€æ—¥å¿—ï¼šæ¸…æ™°å±•ç¤ºå¤„ç†ç»“æœ
        if (result.success) {
            // ç»Ÿè®¡æ•°æ®æ¥æºï¼ˆv3.5.3 ç§»é™¤æ­£åˆ™å¼•æ“ååªæœ‰ flashlex å’Œ aiï¼‰
            let flashlexCount = 0, aiCount = 0;
            if (result.items) {
                result.items.forEach(item => {
                    if (item.source === 'flashlex' || item.source === 'v2') flashlexCount++;
                    else if (item.source === 'ai') aiCount++;
                });
            }
            
            // ä¸€è¡Œæ±‡æ€»æ—¥å¿—
            console.log(
                '%câœ… è®¡ç®—å®Œæˆ%c | è€—æ—¶:%dms | è¯†åˆ«:%dæ¡ | ğŸš€FlashLex:%d | ğŸ¤–AI:%d | æŠ•æ³¨:%då…ƒ | ç»“ç®—:%s%då…ƒ',
                'color: #4caf50; font-weight: bold', 'color: inherit',
                result.latency_ms || 0,
                result.items?.length || 0,
                flashlexCount, aiCount,
                result.s1 || 0,
                result.s4 >= 0 ? '+' : '', result.s4 || 0
            );
            
            // ğŸ†• v3.12 åªåœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºè¯¦ç»†å†…å®¹
            if (IS_DEBUG && result.items && result.items.length > 0) {
                const CODE_MAP = {
                    'T01': 'ç‰¹ç ', 'SXTM': 'ç”Ÿè‚–ç‰¹ç ', 'SX': 'ç”Ÿè‚–',
                    'PT1': 'å¹³ç‰¹ä¸€è‚–', 'PT2': 'äºŒè¿è‚–', 'PT3': 'ä¸‰è¿è‚–',
                    'BS': 'æ³¢è‰²', 'BZ': 'ä¸ä¸­', 'XS': 'å°æ•°', 'DS': 'å¤§æ•°'
                };
                const sourceMap = {'ai': 'ğŸ¤–', 'flashlex': 'ğŸš€', 'v2': 'ğŸš€'};  // v3.5.3 ç§»é™¤regex
                
                console.log('%câ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'color: #888');
                result.items.forEach((item, idx) => {
                    const src = sourceMap[item.source] || '?';
                    const type = CODE_MAP[item.code] || item.code;
                    const win = item.w ? '%câœ“%c' : '%câœ—%c';
                    const winColor = item.w ? 'color:#4caf50;font-weight:bold' : 'color:#999';
                    const zodiac = item.z ? `ç”Ÿè‚–:${item.z}` : '';
                    const nums = item.n?.length > 3 ? `[${item.n.slice(0,3).join(',')}...å…±${item.n.length}ä¸ª]` : (item.n?.join(',') || '-');
                    
                    console.log(
                        `${src} ${win} ${type} | å·ç :${nums} ${zodiac} | ${item.a}å…ƒ | "${(item.raw || '').substring(0,20)}"`,
                        winColor, 'color:inherit'
                    );
                });
                console.log('%câ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'color: #888');
            }
        } else {
            console.log('%câŒ è®¡ç®—å¤±è´¥%c:', 'color: #f44336; font-weight: bold', 'color: inherit', result.error || 'æœªçŸ¥é”™è¯¯');
        }
        
        return result;
    }
    
    // è®¡ç®—å•æ³¨ç»“æœï¼ˆğŸ†• v3.0 ä»…ä½œä¸ºæœ¬åœ°è§£æçš„å¤‡ç”¨ï¼Œä¸»è¦é€»è¾‘åœ¨åç«¯ï¼‰
    function calculateSingleBet(bet, lotteryNumbers) {
        const tema = lotteryNumbers[6]; // ç‰¹ç 
        const pingma = lotteryNumbers.slice(0, 6); // å¹³ç 
        const allNumbers = lotteryNumbers; // æ‰€æœ‰å·ç 
        
        let isWin = false;
        let odds = 1;
        let winAmount = 0;
        let detail = '';
        
        // è·å–èµ”ç‡
        const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
        
        if (bet.type === 'ç‰¹ç ') {
            odds = parseFloat(savedOdds['odds-tema']) || 43;
            // ğŸ†• v2.4.8 ä¿®å¤ï¼šå…¼å®¹æœ¬åœ°è§£æ(number)å’ŒAIè§£æ(value)ä¸¤ç§å­—æ®µ
            const betNum = parseInt(bet.number || bet.value);
            isWin = betNum === parseInt(tema);
            // ğŸ†• v3.3 ç”Ÿè‚–ç‰¹ç åˆå¹¶åˆ°ç‰¹ç ï¼Œé€šè¿‡zodiacå­—æ®µåŒºåˆ†æ˜¾ç¤º
            if (bet.zodiac) {
                detail = `ç‰¹ç (${bet.zodiac}) ${String(betNum).padStart(2,'0')} vs å¼€å¥–ç‰¹ç  ${String(tema).padStart(2,'0')}`;
            } else {
                detail = `ç‰¹ç  ${String(betNum).padStart(2,'0')} vs å¼€å¥–ç‰¹ç  ${String(tema).padStart(2,'0')}`;
            }
        } else if (bet.type === 'ç”Ÿè‚–ç‰¹ç ') {
            // ğŸ†• v3.3 å…¼å®¹æ—§ç‰ˆ"ç”Ÿè‚–ç‰¹ç "ç±»å‹ï¼ˆé€æ­¥åºŸå¼ƒï¼‰
            odds = parseFloat(savedOdds['odds-tema']) || 43;
            const betNum = parseInt(bet.number || bet.value);
            isWin = betNum === parseInt(tema);
            const zodiacName = bet.zodiac || '';
            detail = `ç‰¹ç (${zodiacName}) ${String(betNum).padStart(2,'0')} vs å¼€å¥–ç‰¹ç  ${String(tema).padStart(2,'0')}`;
        } else if (bet.type === 'ç”Ÿè‚–' || bet.type === 'å¤šè‚–') {
            odds = parseFloat(savedOdds['odds-shengxiao']) || 12;
            const sxNums = LHC_DATA.shengxiao[bet.value] || [];
            isWin = sxNums.includes(parseInt(tema));
            detail = `ç”Ÿè‚– ${bet.value} (${sxNums.join(',')}) vs ç‰¹ç  ${tema}`;
        } else if (bet.type === 'å¹³ç‰¹ç”Ÿè‚–') {
            // å¹³ç‰¹ç”Ÿè‚–ï¼šæ£€æŸ¥å¹³ç ä¸­æ˜¯å¦æœ‰è¯¥ç”Ÿè‚–
            odds = parseFloat(savedOdds['odds-pingte']) || 12;
            const sxNums = LHC_DATA.shengxiao[bet.value] || [];
            isWin = pingma.some(num => sxNums.includes(num));
            const matchNums = pingma.filter(num => sxNums.includes(num));
            detail = `å¹³ç‰¹ ${bet.value} (${sxNums.join(',')}) vs å¹³ç  [${pingma.join(',')}]${matchNums.length > 0 ? ' ä¸­' + matchNums.join(',') : ''}`;
        } else if (bet.type === 'æ³¢è‰²') {
            const colorKey = bet.value === 'çº¢æ³¢' ? 'odds-red' : bet.value === 'è“æ³¢' ? 'odds-blue' : 'odds-green';
            odds = parseFloat(savedOdds[colorKey]) || 2.8;
            const boseNums = LHC_DATA.bose[bet.value] || [];
            isWin = boseNums.includes(tema);
            detail = `${bet.value} vs ç‰¹ç  ${tema}`;
        } else if (bet.type === 'ä¸¤é¢') {
            odds = 2;
            if (bet.value === 'å¤§') isWin = tema >= 25 && tema <= 49;
            else if (bet.value === 'å°') isWin = tema >= 1 && tema <= 24;
            else if (bet.value === 'å•') isWin = tema % 2 === 1;
            else if (bet.value === 'åŒ') isWin = tema % 2 === 0;
            detail = `${bet.value} vs ç‰¹ç  ${tema}`;
        } else if (bet.type === 'å°¾æ•°') {
            // å°¾æ•°ï¼šæ£€æŸ¥ç‰¹ç å°¾æ•°
            odds = parseFloat(savedOdds['odds-weishu']) || 9.8;
            const temaWei = tema % 10;
            isWin = parseInt(bet.value) === temaWei;
            detail = `${bet.value}å°¾ vs ç‰¹ç  ${tema} (å°¾æ•°${temaWei})`;
        } else if (bet.type === 'è¿ç ') {
            // è¿ç ï¼šæ£€æŸ¥æ‰€æœ‰å·ç æ˜¯å¦éƒ½åœ¨å¼€å¥–å·ç ä¸­
            odds = parseFloat(savedOdds['odds-lianma']) || 20;
            const nums = String(bet.value).split(',').map(n => parseInt(n));
            isWin = nums.every(n => allNumbers.includes(n));
            detail = `è¿ç  [${nums.join(',')}] vs å¼€å¥– [${allNumbers.join(',')}]`;
        } else {
            // æœªçŸ¥ç©æ³•ï¼Œé»˜è®¤ä¸ä¸­å¥–
            detail = `æœªçŸ¥ç©æ³•: ${bet.type} ${bet.value || bet.number}`;
        }
        
        if (isWin) {
            winAmount = bet.amount * odds;
        }
        
        return {
            ...bet,
            isWin,
            odds,
            winAmount,
            detail,
            netResult: isWin ? -(winAmount - bet.amount) : bet.amount
        };
    }
    
    async function calculateBets() {
        let input = document.getElementById('bet-input').value.trim();
        if (!input) {
            alert('è¯·å…ˆç²˜è´´ä¸‹æ³¨ä¿¡æ¯');
            return;
        }
        
        if (!appState.lotteryNumbers || appState.lotteryNumbers.length < 7 || appState.lotteryNumbers[0] === 0) {
            alert('è¯·å…ˆè®¾ç½®å¼€å¥–å·ç ï¼');
            return;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v3.11.68 ã€å†…å­˜ä¼˜åŒ–ã€‘ä¸»åŠ¨é‡Šæ”¾æ—§çš„å¤§å¯¹è±¡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        // åŸç†ï¼šæ—§æ‰‹æœºå†…å­˜æœ‰é™ï¼ŒdebugInfo/calcResults å¯èƒ½æ— é™å¢é•¿æ’‘çˆ†å†…å­˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        calcResults = null;  // å…ˆç½®ç©ºé‡Šæ”¾å¼•ç”¨
        calcResults = [];    // é‡æ–°åˆå§‹åŒ–
        parsedBets = [];     // é‡Šæ”¾æ—§çš„è§£æç»“æœ
        debugInfo = {        // é‡ç½®ä¸ºåˆå§‹å°å¯¹è±¡
            originalInput: '', sanitizedInput: '', normalizeInfo: '',
            aiInput: '', aiOutput: '', aiParsed: null, modelUsed: '', latencyMs: 0,
            extractItems: [], calcInputCount: 0, calcOutputCount: 0, calcItems: [],
            calcS1: 0, calcS2: 0, calcS3: 0, calcS4: 0, backendVersion: '',
            requestMode: '', requestUrl: '', responseStatus: 0, responseBody: '', errorMsg: ''
        };
        console.log('ğŸ§¹ å†…å­˜æ¸…ç†å®Œæˆ: calcResults/parsedBets/debugInfo å·²é‡ç½®');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v3.11.65 ã€è®¡ç®—å‰ä¼˜åŒ–ã€‘æ¸…é™¤æ—§ç»“æœ + æ»šåŠ¨é¡¶éƒ¨ + æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 1. æ¸…é™¤æ—§çš„è®¡ç®—ç»“æœ
        const resultContent = document.getElementById('result-content');
        if (resultContent) {
            resultContent.innerHTML = '';
        }
        
        // 2. ğŸ†• v3.11.66 å¿«é€Ÿæ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨ï¼ˆç‚¹å‡»è®¡ç®—åç«‹å³åˆ°é¡¶éƒ¨ï¼‰
        window.scrollTo({ top: 0, behavior: 'instant' });
        
        // 3. æ˜¾ç¤ºæŒç»­çš„è®¡ç®—åŠ è½½æç¤º
        showCalculatingLoader();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v2.4.4 ã€é¢„å¤„ç†ã€‘å»é™¤æ ‡ç­¾å‰ç¼€ï¼ˆå¦‚ "åé¾™:" "123:" "XXX:"ï¼‰
        // è§„åˆ™1ï¼šå¦‚æœæ•´è¡Œåªæœ‰ "XXX:" æ ¼å¼ï¼Œåˆ é™¤è¿™ä¸€è¡Œ
        // è§„åˆ™2ï¼šå¦‚æœæ˜¯ "XXX:å†…å®¹" æ ¼å¼ï¼Œå»æ‰å‰ç¼€ä¿ç•™å†…å®¹
        // æ”¹è¿›ï¼šæ”¯æŒå†’å·å‰åæœ‰ç©ºæ ¼ã€ä¸­è‹±æ–‡å†’å·ã€ä¸‹åˆ’çº¿ç­‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        console.log('ğŸ”§ â•â•â• å¼€å§‹é¢„å¤„ç†è¾“å…¥ï¼ˆv2.4.4ï¼‰â•â•â•');
        console.log('åŸå§‹è¾“å…¥è¡Œæ•°:', input.split('\n').length);
        
        input = input.split('\n').map((line, idx) => {
            const trimmed = line.trim();
            
            // ç©ºè¡Œä¿ç•™ï¼ˆç”¨äºåˆ†ç»„ï¼‰
            if (!trimmed) {
                return line;
            }
            
            // è§„åˆ™1ï¼šæ•´è¡Œåªæœ‰ "XXX:" æ ¼å¼ï¼ˆçº¯æ ‡ç­¾è¡Œï¼‰ï¼Œæ ‡è®°ä¸ºåˆ é™¤
            // æ”¯æŒ: åé¾™:ã€åé¾™ï¼šã€åé¾™ :ã€123:ã€ABC: ç­‰
            // æ­£åˆ™: å¼€å¤´ + (ä¸­æ–‡/å­—æ¯/æ•°å­—/ä¸‹åˆ’çº¿)+ + å¯é€‰ç©ºæ ¼ + å†’å· + å¯é€‰ç©ºæ ¼ + ç»“å°¾
            if (/^[\u4e00-\u9fa5a-zA-Z0-9_]+\s*[:ï¼š]\s*$/.test(trimmed)) {
                console.log(`ğŸ·ï¸ [è¡Œ${idx+1}] åˆ é™¤çº¯æ ‡ç­¾è¡Œ: "${trimmed}"`);
                return '__DELETE_LINE__';  // æ ‡è®°ä¸ºéœ€è¦åˆ é™¤
            }
            
            // è§„åˆ™2ï¼šå¦‚æœæ˜¯ "XXX:å†…å®¹" æ ¼å¼ï¼Œå»æ‰å‰ç¼€ä¿ç•™å†…å®¹
            // æ”¯æŒ: åé¾™:ä¹°çŒªå„10ã€åé¾™ï¼šä¹°çŒªå„10ã€åé¾™ : ä¹°çŒªå„10 ç­‰
            const prefixMatch = trimmed.match(/^([\u4e00-\u9fa5a-zA-Z0-9_]+\s*[:ï¼š]\s*)(.+)$/);
            if (prefixMatch && prefixMatch[2]) {
                const prefix = prefixMatch[1].trim();
                const content = prefixMatch[2].trim();
                console.log(`ğŸ·ï¸ [è¡Œ${idx+1}] å»é™¤å‰ç¼€: "${prefix}" â†’ ä¿ç•™: "${content}"`);
                return content;
            }
            
            return line;  // ä¿æŒåŸæ ·
        }).filter(line => line !== '__DELETE_LINE__').join('\n');
        
        // æ¸…ç†è¿ç»­ç©ºè¡Œï¼ˆä¿ç•™å•ä¸ªç©ºè¡Œç”¨äºåˆ†ç»„ï¼‰
        input = input.replace(/\n{3,}/g, '\n\n');
        
        console.log('ğŸ”§ é¢„å¤„ç†åè¡Œæ•°:', input.split('\n').length);
        console.log('ğŸ”§ â•â•â• é¢„å¤„ç†å®Œæˆ â•â•â•');
        
        // ğŸ†• æ›´æ–°è¾“å…¥æ¡†å†…å®¹ï¼ˆè®©ç”¨æˆ·çœ‹åˆ°å¤„ç†åçš„ç»“æœï¼‰
        const originalInputValue = document.getElementById('bet-input').value;
        if (input !== originalInputValue.trim()) {
            document.getElementById('bet-input').value = input;
            console.log('ğŸ”§ é¢„å¤„ç†åçš„è¾“å…¥ï¼ˆå·²æ›´æ–°è¾“å…¥æ¡†ï¼‰:\n', input);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v3.11.24 ã€å½©ç§æ£€æµ‹ã€‘æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸æ”¯æŒçš„"æ—§æ¾³"
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const lotteryTypes = analyzeLotteryTypes(input);
        console.log('ğŸ¯ [å½©ç§æ£€æµ‹]', lotteryTypes);
        
        if (lotteryTypes.hasOldAM) {
            hideCalculatingLoader(); // ğŸ†• v3.11.65 ä¸æ”¯æŒçš„å½©ç§è¦éšè—åŠ è½½æç¤º
            alert(`âš ï¸ æš‚ä¸æ”¯æŒ"${lotteryTypes.oldAmKeyword}"è®¡ç®—\nç›®å‰åªæ”¯æŒï¼šæ–°æ¾³é—¨ã€é¦™æ¸¯`);
            return;
        }
        
        // ğŸ†• v3.11.24 è®°å½•æ˜¯å¦éœ€è¦æ˜¾ç¤ºåŒå¼€å¥–ç»“æœ
        window.showBothLotteryResults = lotteryTypes.hasHK;
        console.log('ğŸ¯ [åŒå¼€å¥–æ˜¾ç¤º]', window.showBothLotteryResults ? 'æ˜¯ï¼ˆåŒ…å«é¦™æ¸¯ä¸‹æ³¨ï¼‰' : 'å¦');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• ã€å­¤å„¿è¡Œæ£€æµ‹ã€‘åœ¨æ­£å¼è§£æå‰æ£€æµ‹å¯èƒ½çš„æ–­è¡Œ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const orphans = detectOrphanLines(input);
        if (orphans.length > 0) {
            console.log('ğŸ” æ£€æµ‹åˆ°å­¤å„¿è¡Œ:', orphans);
            // æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼Œç­‰å¾…ç”¨æˆ·å¤„ç†
            input = await showOrphanConfirmDialog(orphans, input);
            // æ›´æ–°è¾“å…¥æ¡†å†…å®¹ï¼ˆå¯èƒ½å·²è¢«ä¿®æ”¹ï¼‰
        }
        
        const settings = getFormatSettings();
        const lines = input.split('\n').filter(line => line.trim());
        
        // åˆå§‹åŒ–
        parsedBets = [];
        parsedGroups = [];  // ğŸ†• é‡ç½®åˆ†ç»„
        
        // é‡ç½®è°ƒè¯•ä¿¡æ¯
        debugInfo.aiInput = input;
        debugInfo.aiOutput = '';
        debugInfo.aiParsed = null;
        debugInfo.aiBets = [];
        debugInfo.lastError = '';
        
        // ğŸ†• v3.0 ã€æ–°æ¶æ„ã€‘è®¡ç®—é€»è¾‘åœ¨åç«¯ï¼Œå‰ç«¯åªåšå±•ç¤º
        // API Key å·²ç§»è‡³åç«¯ï¼Œåªéœ€æ£€æŸ¥ aiEnabled
        if (settings.aiEnabled) {
            // ğŸ†• v3.11.65 æ—§çš„toastæç¤ºå·²ç”±å…¨å±åŠ è½½åŠ¨ç”»æ›¿ä»£
            try {
                // ğŸ†• v3.11.4 ç”Ÿè‚–ä»£å·è½¬æ¢ï¼ˆåç«¯FlashLexå¼•æ“éœ€è¦ Z1-Z12 æ ¼å¼ï¼‰
                const sanitizedInput = sanitizeText(input);
                debugInfo.sanitizedInput = sanitizedInput;
                console.log('ğŸ”„ ä»£å·è½¬æ¢å:', sanitizedInput);
                
                // ğŸ†• v3.0 è°ƒç”¨åç«¯ä¸€ç«™å¼è®¡ç®—æ¥å£
                const config = getOddsConfig();
                
                // ğŸ†• v3.11.43 ä¿®å¤ï¼šå§‹ç»ˆä¼ é€’æ­£ç¡®çš„æ¾³é—¨å’Œé¦™æ¸¯å¼€å¥–æ•°æ®
                // é—®é¢˜ï¼šä¹‹å‰ç”¨ appState.lotteryNumbersï¼ˆå½“å‰å½©ç§æ•°æ®ï¼‰ï¼Œå¯¼è‡´é€‰æ‹©é¦™æ¸¯æ—¶æ¾³é—¨ä¸‹æ³¨ç”¨é”™æ•°æ®
                // ä¿®å¤ï¼šå§‹ç»ˆä» lotteryData è·å–å¯¹åº”å½©ç§çš„æ•°æ®
                const mcData = appState.lotteryData['xam'];
                const hkData = appState.lotteryData['hk'];
                
                // d å‚æ•°å§‹ç»ˆæ˜¯æ¾³é—¨æ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰æ¾³é—¨æ•°æ®ï¼Œç”¨å½“å‰å·ç ä½œä¸º fallbackï¼‰
                const mcNums = (mcData?.numbers && mcData.numbers.length === 7) 
                    ? mcData.numbers 
                    : appState.lotteryNumbers;
                
                // hk_d å‚æ•°å§‹ç»ˆæ˜¯é¦™æ¸¯æ•°æ®
                const hkNums = (hkData?.numbers && hkData.numbers.length === 7) 
                    ? hkData.numbers 
                    : null;
                
                console.log('ğŸ° [callBackendCalc] æ¾³é—¨æ•°æ®:', mcNums?.join(',') || 'æ— ');
                console.log('ğŸ° [callBackendCalc] é¦™æ¸¯æ•°æ®:', hkNums?.join(',') || 'æ— ');
                
                const backendResult = await callBackendCalc(
                    sanitizedInput,
                    mcNums,  // ğŸ†• v3.11.43 å§‹ç»ˆä¼ æ¾³é—¨å¼€å¥–æ•°æ®
                    config,
                    settings.aiProvider || 'tuzi',  // ğŸ†• v3.11.69 é»˜è®¤tuziå…”å­API
                    null,
                    hkNums  // é¦™æ¸¯å¼€å¥–æ•°æ®
                );
                
                // ğŸ†• v3.11.29 æ£€æµ‹æ—§æ¾³é—¨é”™è¯¯
                if (!backendResult.success && backendResult.error === 'old_mc_not_supported') {
                    alert('âš ï¸ æš‚ä¸æ”¯æŒæ—§æ¾³é—¨\nè¯·ä½¿ç”¨æ–°æ¾³æˆ–é¦™æ¸¯');
                    return;
                }
                
                if (backendResult.success && backendResult.items && backendResult.items.length > 0) {
                    // ğŸ†• v3.0 è½¬æ¢åç«¯ç»“æœä¸ºå‰ç«¯æ ¼å¼
                    // ğŸ†• v3.11.13 å®Œå–„ç±»å‹æ˜ å°„ï¼ˆæ·»åŠ å…­è‚–ã€ç‰¹è‚–ç­‰ï¼‰
                    const TYPE_NAME_MAP = {
                        'T01': 'ç‰¹ç ', 'SXTM': 'ç”Ÿè‚–ç‰¹ç ', 'SX': 'ç”Ÿè‚–',
                        // ğŸ†• v3.12.3 æ·»åŠ æ³¢è‰²ç‹¬ç«‹ä»£å·æ˜ å°„
                        'BS': 'æ³¢è‰²', 'C1': 'çº¢æ³¢', 'C2': 'è“æ³¢', 'C3': 'ç»¿æ³¢',
                        'BB': 'åŠæ³¢', 'PT1': 'å¹³ç‰¹ä¸€è‚–',
                        'PT2': 'å¹³ç‰¹äºŒè¿è‚–', 'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–', 'PT4': 'å¹³ç‰¹å››è¿è‚–', 'PT5': 'å¹³ç‰¹äº”è¿è‚–',
                        'PTW': 'å¹³ç‰¹å°¾æ•°', 'DP': 'å•å¹³',
                        'XS': 'å°æ•°', 'DS': 'å¤§æ•°', 'ODD': 'å•æ•°', 'EVEN': 'åŒæ•°', 'DXDS': 'å¤§å°å•åŒ',
                        // ğŸ†• v3.11.13 å…­è‚–çš„æ‰€æœ‰å¯èƒ½ä»£ç 
                        'SX6': 'å…­è‚–', 'LX6': 'å…­è‚–', 'LX': 'å…­è‚–', '6X': 'å…­è‚–', 'LIUXIAO': 'å…­è‚–',
                        'TX': 'ç‰¹è‚–', 'HX': 'åˆè‚–', 'ZX': 'æ­£è‚–',
                        'E2': 'äºŒä¸­äºŒ', 'S3': 'ä¸‰ä¸­ä¸‰', 'BZ': 'ä¸ä¸­',
                        'WX': 'äº”è¡Œ', 'JY': 'å®¶é‡', 'ZH': 'æ€»å’Œ',
                        'TS': 'å¤´æ•°', 'WS': 'å°¾æ•°',
                        'UK': 'æœªçŸ¥'
                    };
                    
                    // ğŸ†• v3.1 ä»åŸå§‹è¾“å…¥ä¸­è§£æåˆ†ç»„ä¿¡æ¯ï¼ˆç©ºè¡Œåˆ†éš”ï¼‰
                    const rawInput = document.getElementById('bet-input')?.value || '';
                    const inputGroups = [];  // æ¯ç»„çš„åŸæ–‡è¡Œåˆ—è¡¨
                    let currentGroup = [];
                    rawInput.split('\n').forEach(line => {
                        if (line.trim() === '') {
                            // ç©ºè¡Œï¼šä¿å­˜å½“å‰ç»„ï¼Œå¼€å§‹æ–°ç»„
                            if (currentGroup.length > 0) {
                                inputGroups.push(currentGroup);
                                currentGroup = [];
                            }
                        } else {
                            currentGroup.push(line.trim());
                        }
                    });
                    if (currentGroup.length > 0) {
                        inputGroups.push(currentGroup);
                    }
                    
                    console.log('ğŸ“¦ è¾“å…¥åˆ†ç»„:', inputGroups);
                    
                    // ğŸ†• v3.8.3 ä¸ºæ¯ä¸ªç‰‡æ®µåˆ†é…å…¨å±€é¡ºåºå·ï¼ˆç”¨äºæ­£ç¡®æ’åºï¼‰
                    let globalFragmentOrder = 0;
                    const fragmentOrderMap = {};  // normalizedKey â†’ { order, originalLine, sanitizedLine }
                    
                    // æå–æ•°å­—åºåˆ—ä½œä¸ºåŒ¹é…é”®ï¼ˆå¿½ç•¥åˆ†éš”ç¬¦å·®å¼‚ï¼‰
                    const extractNumbers = (str) => (str.match(/\d+/g) || []).join('-');
                    
                    // ğŸ†• v3.1 æ„å»ºè¡Œâ†’åˆ†ç»„æ˜ å°„
                    const lineToGroupMap = {};  // ä»£å·è½¬æ¢åçš„è¡Œ â†’ {groupId, lineIndex}
                    inputGroups.forEach((group, gIdx) => {
                        group.forEach((line, lIdx) => {
                            // å¯¹åŸå§‹è¡Œè¿›è¡Œä»£å·è½¬æ¢ï¼Œç”¨äºåŒ¹é…åç«¯è¿”å›çš„ raw
                            const sanitizedLine = sanitizeText(line);
                            
                            // ğŸ†• v3.8.3 ç”¨å¤šç§åˆ†éš”ç¬¦æ‹†åˆ†è¡Œä¸ºç‰‡æ®µ
                            const fragments = sanitizedLine.split(/\s{2,}|\t/).filter(f => f.trim());
                            
                            fragments.forEach((frag, fIdx) => {
                                const numKey = extractNumbers(frag);
                                if (numKey && !fragmentOrderMap[numKey]) {
                                    fragmentOrderMap[numKey] = {
                                        order: globalFragmentOrder++,
                                        originalLine: line,
                                        sanitizedLine: sanitizedLine,
                                        fragment: frag,
                                        groupId: gIdx + 1,
                                        lineIndex: lIdx
                                    };
                                }
                            });
                            
                            // ä¹Ÿå­˜æ•´è¡Œçš„æ•°å­—é”®
                            const lineNumKey = extractNumbers(sanitizedLine);
                            if (lineNumKey && !fragmentOrderMap[lineNumKey]) {
                                fragmentOrderMap[lineNumKey] = {
                                    order: globalFragmentOrder++,
                                    originalLine: line,
                                    sanitizedLine: sanitizedLine,
                                    fragment: sanitizedLine,
                                    groupId: gIdx + 1,
                                    lineIndex: lIdx
                                };
                            }
                            
                            lineToGroupMap[sanitizedLine] = {
                                groupId: gIdx + 1,
                                lineIndex: lIdx,
                                originalLine: line
                            };
                        });
                    });
                    
                    console.log('ğŸ“‹ è¡Œâ†’åˆ†ç»„æ˜ å°„:', lineToGroupMap);
                    console.log('ğŸ”¢ ç‰‡æ®µé¡ºåºæ˜ å°„:', fragmentOrderMap);
                    
                    parsedBets = backendResult.items.map((item, idx) => {
                        // ğŸ†• v3.1 æ ¹æ® item.raw æ‰¾åˆ°å¯¹åº”çš„åˆ†ç»„
                        const itemRaw = item.raw || '';
                        let groupInfo = lineToGroupMap[itemRaw];
                        
                        // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
                        if (!groupInfo) {
                            for (const [key, info] of Object.entries(lineToGroupMap)) {
                                if (itemRaw.includes(key) || key.includes(itemRaw)) {
                                    groupInfo = info;
                                    break;
                                }
                            }
                        }
                        
                        // ğŸ†• v3.11.13 å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•åŸºäºç±»å‹å…³é”®è¯+ç”Ÿè‚–ä»£å·çš„æ™ºèƒ½åŒ¹é…
                        // è§£å†³ï¼šåç«¯æŠŠ "å¹³ç‰¹Z9Z10å„200" æ‹†åˆ†æˆ "å¹³ç‰¹Z9å„200" å’Œ "å¹³ç‰¹Z10å„200"ï¼Œå¯¼è‡´åŒ¹é…å¤±è´¥
                        if (!groupInfo) {
                            const typeKeywords = ['å¹³ç‰¹', 'å…­è‚–', 'äºŒå‹', 'ä¸‰å‹', 'ä¸€å‹', 'ç‰¹è‚–', 'æ­£è‚–', 'åˆè‚–', 'æ³¢', 'ä¸ä¸­'];
                            const itemZodiacs = itemRaw.match(/Z\d{1,2}/g) || [];
                            const itemTypeKw = typeKeywords.find(kw => itemRaw.includes(kw)) || '';
                            
                            for (const [key, info] of Object.entries(lineToGroupMap)) {
                                // æ£€æŸ¥ï¼šå®Œæ•´è¡ŒåŒ…å« raw ä¸­çš„ç±»å‹å…³é”®è¯ AND è‡³å°‘ä¸€ä¸ªç”Ÿè‚–ä»£å·
                                const hasTypeMatch = itemTypeKw && key.includes(itemTypeKw);
                                const hasZodiacMatch = itemZodiacs.length > 0 && itemZodiacs.some(z => key.includes(z));
                                if (hasTypeMatch && hasZodiacMatch) {
                                    groupInfo = info;
                                    break;
                                }
                            }
                        }
                        
                        // é»˜è®¤åˆ†ç»„
                        if (!groupInfo) {
                            groupInfo = { groupId: 1, lineIndex: 0, originalLine: itemRaw };
                        }
                        
                        // ğŸ†• v3.8.3 æ ¹æ®æ•°å­—é”®æŸ¥æ‰¾ç‰‡æ®µé¡ºåº
                        const itemNumKey = extractNumbers(itemRaw);
                        let fragmentInfo = fragmentOrderMap[itemNumKey];
                        
                        // ğŸ†• v3.11.16 å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œä½¿ç”¨æœ€é•¿åŒ¹é…ä¼˜å…ˆç­–ç•¥
                        // è§£å†³ï¼šæ¨¡ç³ŠåŒ¹é…å¯èƒ½é”™è¯¯åœ°åŒ¹é…åˆ°çŸ­çš„ numKeyï¼ˆå¦‚ "20" åŒ¹é…åˆ° "å°æ•°å„æ•°20"ï¼‰
                        if (!fragmentInfo) {
                            let bestMatch = null;
                            let bestMatchLength = 0;
                            
                            for (const [numKey, info] of Object.entries(fragmentOrderMap)) {
                                // æ£€æŸ¥æ˜¯å¦åŒ…å«å…³ç³»
                                const isMatch = itemNumKey.includes(numKey) || numKey.includes(itemNumKey);
                                if (isMatch) {
                                    // ä¼˜å…ˆé€‰æ‹©åŒ¹é…é•¿åº¦æœ€é•¿çš„ï¼ˆæ›´ç²¾ç¡®ï¼‰
                                    const matchLength = Math.min(numKey.length, itemNumKey.length);
                                    if (matchLength > bestMatchLength) {
                                        bestMatchLength = matchLength;
                                        bestMatch = info;
                                    }
                                }
                            }
                            fragmentInfo = bestMatch;
                        }
                        
                        const fragmentOrder = fragmentInfo ? fragmentInfo.order : 9999;
                        
                        // ğŸ†• v3.11.16 ä¼˜å…ˆä½¿ç”¨ fragmentInfo çš„ groupIdï¼ˆåŸºäºæ•°å­—åºåˆ—ç²¾ç¡®åŒ¹é…ï¼‰
                        // fragmentInfo æ˜¯åŸºäºæå–æ•°å­—åºåˆ—åŒ¹é…çš„ï¼Œæ¯” groupInfo çš„æ–‡æœ¬æ¨¡ç³ŠåŒ¹é…æ›´ç²¾ç¡®
                        const finalGroupId = fragmentInfo?.groupId || groupInfo.groupId;
                        const finalLineIndex = fragmentInfo?.lineIndex !== undefined ? fragmentInfo.lineIndex : groupInfo.lineIndex;
                        
                        return {
                            type: TYPE_NAME_MAP[item.code] || item.code,
                            number: item.n && item.n.length === 1 ? item.n[0] : null,
                            numbers: item.n || [],
                            amount: item.a || 0,
                            raw: restoreText(item.raw || ''),
                            originalLine: restoreText(fragmentInfo?.originalLine || groupInfo.originalLine || item.raw || ''),
                            zodiac: item.z || null,
                            fromAI: true,
                            // ğŸ†• v3.11.52 ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ group_idxï¼ˆç”¨æˆ·è¾“å…¥ç»„å·ï¼‰
                            // åç«¯ group_idx ä»0å¼€å§‹ï¼Œå‰ç«¯ groupId ä»1å¼€å§‹ï¼Œæ‰€ä»¥ +1
                            groupId: item.group_idx !== undefined ? item.group_idx + 1 : finalGroupId,
                            lineId: `${item.group_idx !== undefined ? item.group_idx + 1 : finalGroupId}-${finalLineIndex}`,
                            globalLineIndex: idx,
                            betIndexInLine: item.idx || 0,
                            // ğŸ†• v3.11.37 ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„input_orderï¼ˆä¿è¯æŒ‰ç”¨æˆ·è¾“å…¥é¡ºåºï¼‰
                            // å¦‚æœåç«¯æ²¡æœ‰è¿”å›ï¼Œåˆ™ä½¿ç”¨å‰ç«¯è®¡ç®—çš„fragmentOrder
                            fragmentOrder: item.input_order !== undefined && item.input_order !== 9999 
                                ? item.input_order : fragmentOrder,
                            // ğŸ†• v3.11.29 å½©ç§æ ‡è¯†
                            lt: item.lt || 'mc',
                            // ğŸ†• v3.0 åç«¯è®¡ç®—çš„ç»“æœ
                            isWin: item.w || false,
                            winAmount: item.v || 0,
                            odds: item.r || 1,
                            detail: `${TYPE_NAME_MAP[item.code] || item.code} ${item.n ? item.n.join(',') : ''} vs ç‰¹ç ${appState.lotteryNumbers[6]}`,
                            netResult: item.w ? -(item.v - item.a) : item.a
                        };
                    });
                    
                    // ğŸ†• v3.0 ç›´æ¥ä½¿ç”¨åç«¯è®¡ç®—çš„ç»“æœ
                    calcResults = parsedBets;
                    
                    // ğŸ†• v3.0 ä½¿ç”¨åç«¯è¿”å›çš„ç»Ÿè®¡æ•°æ®
                    const totalBet = backendResult.s1 || 0;      // æ€»æŠ•æ³¨
                    const totalWin = backendResult.s2 || 0;      // ä¸­å¥–æ³¨æ•°
                    const totalWinAmount = backendResult.s3 || 0; // æ´¾å½©é‡‘é¢
                    const settleAmount = backendResult.s4 || 0;   // ç»“ç®—
                    
                    // è®°å½•è°ƒè¯•ä¿¡æ¯
                    debugInfo.modelUsed = backendResult.model_used || 'unknown';
                    debugInfo.latencyMs = backendResult.latency_ms || 0;
                    
                    // ğŸ†• v3.1 ä¿å­˜åç«¯è¿”å›çš„è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆç”¨äºåé¦ˆè¿½è¸ªï¼‰
                    debugInfo.extractItems = backendResult.extract_items || [];  // æ­£åˆ™/AI è¯†åˆ«çš„æ¯æ¡è¯¦æƒ…
                    debugInfo.calcInputCount = backendResult.input_count || 0;   // è¯†åˆ«æ¡æ•°
                    debugInfo.calcOutputCount = backendResult.output_count || 0; // å±•å¼€åæ¡æ•°
                    debugInfo.calcItems = backendResult.items || [];             // è®¡ç®—åçš„æ¯æ¡è¯¦æƒ…
                    debugInfo.backendVersion = backendResult.backend_version || '';  // ğŸ†• v3.2.1 åç«¯ç‰ˆæœ¬
                    debugInfo.calcS1 = totalBet;
                    debugInfo.calcS2 = totalWin;
                    debugInfo.calcS3 = totalWinAmount;
                    debugInfo.calcS4 = settleAmount;
                    // ğŸ†• v3.11.22 å¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼ˆç²¾å‡†å®šä½é—®é¢˜ï¼‰
                    debugInfo.skipRegexReason = backendResult.skip_regex_reason || '';  // è·³è¿‡æ­£åˆ™çš„åŸå› 
                    debugInfo.aiItemsCount = backendResult.ai_items_count || 0;        // AIè¯†åˆ«çš„åŸå§‹è®°å½•æ•°
                    debugInfo.preprocessLog = backendResult.preprocess_log || [];       // é¢„å¤„ç†æ—¥å¿—
                    
                    console.log(`âœ… åç«¯è®¡ç®—å®Œæˆ: è¯†åˆ«${debugInfo.calcInputCount}æ¡â†’å±•å¼€${debugInfo.calcOutputCount}æ¡, æ€»æŠ•${totalBet}, ä¸­${totalWin}æ³¨, æ´¾å½©${totalWinAmount}, ç»“ç®—${settleAmount}`);
                    showAutoCloseToast(`âœ… è®¡ç®—å®Œæˆ ${calcResults.length} æ³¨`, 2000);
                    
                    // ğŸ†• v3.0 ç›´æ¥è·³è½¬åˆ°æ˜¾ç¤ºç»“æœéƒ¨åˆ†
                    // è·å–å¼€å¥–ä¿¡æ¯
                    const tema = appState.lotteryNumbers[6];
                    const lotteryStr = appState.lotteryNumbers.slice(0,6).map(n => String(n).padStart(2,'0')).join(' ') + ' + ç‰¹ç ' + String(tema).padStart(2,'0');
                    
                    // ğŸ†• v3.11.29 æ ¹æ®åç«¯è¿”å›çš„hk/mcæ±‡æ€»åˆ¤æ–­å¼€å¥–æ˜¾ç¤º
                    // è§„åˆ™ï¼šåªæœ‰hkâ†’åªæ˜¾ç¤ºé¦™æ¸¯ï¼›åªæœ‰mcâ†’åªæ˜¾ç¤ºæ–°æ¾³ï¼›æ··åˆâ†’æ˜¾ç¤ºä¸¤ä¸ª
                    const hasHK = backendResult.hk_summary && backendResult.hk_summary.s1 > 0;
                    const hasMC = backendResult.mc_summary && backendResult.mc_summary.s1 > 0;
                    const isMixed = hasHK && hasMC;
                    
                    let lotteryResultText = '';
                    const xamData = appState.lotteryData['xam'];
                    const hkData = appState.lotteryData['hk'];
                    const xamNums = xamData?.numbers || appState.lotteryNumbers;
                    const hkNums = hkData?.numbers || [];
                    
                    const xamStr = xamNums.length === 7 
                        ? xamNums.slice(0,6).map(n => String(n).padStart(2,'0')).join(' ') + ' + ç‰¹ç ' + String(xamNums[6]).padStart(2,'0')
                        : 'æœªè®¾ç½®';
                    const hkStr = hkNums.length === 7
                        ? hkNums.slice(0,6).map(n => String(n).padStart(2,'0')).join(' ') + ' + ç‰¹ç ' + String(hkNums[6]).padStart(2,'0')
                        : 'æœªè®¾ç½®';
                    
                    if (isMixed) {
                        // æ··åˆä¸‹æ³¨ï¼šæ˜¾ç¤ºä¸¤ä¸ªå¼€å¥–ç»“æœ
                        lotteryResultText = `ğŸ° æ–°æ¾³å¼€å¥–: ${xamStr}\nğŸ° é¦™æ¸¯å¼€å¥–: ${hkStr}\n`;
                    } else if (hasHK) {
                        // çº¯é¦™æ¸¯ï¼šåªæ˜¾ç¤ºé¦™æ¸¯
                        lotteryResultText = `ğŸ° é¦™æ¸¯å¼€å¥–: ${hkStr}\n`;
                    } else {
                        // çº¯æ¾³é—¨æˆ–é»˜è®¤ï¼šåªæ˜¾ç¤ºæ–°æ¾³
                        lotteryResultText = `ğŸ° æ–°æ¾³å¼€å¥–: ${xamStr}\n`;
                    }
                    
                    // ğŸ†• v3.11.29 ä¿å­˜æ··åˆçŠ¶æ€ä¾›åç»­ä½¿ç”¨
                    window.currentCalcHasHK = hasHK;
                    window.currentCalcHasMC = hasMC;
                    window.currentCalcIsMixed = isMixed;
                    
                    // ç”Ÿæˆç»“æœæ–‡æœ¬
                    let resultText = `ğŸ“Š è®¡ç®—ç»“æœ\n`;
                    resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    resultText += lotteryResultText;
                    resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    resultText += `ğŸ“‹ è¯†åˆ« ${calcResults.length} æ³¨ | æ€»æŠ• ${totalBet}å…ƒ\n`;
                    resultText += `ä¸­${totalWin}æ³¨ | æ´¾å½© ${totalWinAmount}å…ƒ\n`;
                    resultText += `ğŸ’° ç»“ç®—: ${settleAmount >= 0 ? '+' : ''}${settleAmount}å…ƒ\n`;
                    resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ†• v3.11.10 å…¨æ–°åˆ†ç»„é€»è¾‘ï¼šæŒ‰ç”¨æˆ·è¾“å…¥é¡ºåº + ç›¸é‚»åŒç±»å‹åŒé‡‘é¢åˆå¹¶
                    // æ ¸å¿ƒè§„åˆ™ï¼š
                    // 1. æŒ‰ fragmentOrder é¡ºåºéå†æ¯æ¡è®°å½•
                    // 2. ç›¸é‚» + åŒç±»å‹ + åŒé‡‘é¢ â†’ åˆå¹¶
                    // 3. å¦åˆ™ â†’ æ–°å»ºä¸€ç»„
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    // ç¬¬1æ­¥ï¼šæŒ‰ groupId + fragmentOrder æ’åºæ‰€æœ‰ç»“æœ
                    // ğŸ†• v3.11.52 ä¿®å¤ï¼šä¼˜å…ˆæŒ‰ç”¨æˆ·è¾“å…¥ç»„å·æ’åºï¼Œç¡®ä¿åŒä¸€ç»„çš„è®°å½•åœ¨ä¸€èµ·
                    const sortedResults = [...calcResults].sort((a, b) => {
                        // ä¼˜å…ˆæŒ‰ groupId æ’åºï¼ˆç”¨æˆ·è¾“å…¥çš„ç©ºè¡Œåˆ†ç»„ï¼‰
                        const groupA = a.groupId !== undefined ? a.groupId : 9999;
                        const groupB = b.groupId !== undefined ? b.groupId : 9999;
                        if (groupA !== groupB) {
                            return groupA - groupB;
                        }
                        // åŒç»„å†…æŒ‰ fragmentOrder æ’åºï¼ˆä¿æŒè¾“å…¥é¡ºåºï¼‰
                        const orderA = a.fragmentOrder !== undefined ? a.fragmentOrder : 9999;
                        const orderB = b.fragmentOrder !== undefined ? b.fragmentOrder : 9999;
                        return orderA - orderB;
                    });
                    
                    // ğŸ†• v3.11.11 æŒ‰ originalLine + type + amount é¢„åˆ†ç»„
                    // ç¡®ä¿åŒä¸€ç”¨æˆ·è¾“å…¥çš„åŒç±»å‹åŒé‡‘é¢èƒ½åˆå¹¶ï¼ˆå¦‚"å¹³ç‰¹çŒ´é¸¡å„200"ï¼‰
                    const calcPreGroupMap = {};
                    
                    sortedResults.forEach((r) => {
                        const originalLine = r.originalLine || '';
                        const itemType = r.type || 'æœªçŸ¥';
                        const itemAmount = r.amount || 0;
                        const itemGroupId = r.groupId || 1;  // ğŸ†• v3.11.15 è·å–ç”¨æˆ·è¾“å…¥è¡Œçš„ç»„ID
                        const itemLt = r.lt || 'mc';  // ğŸ†• v3.11.37 è·å–å½©ç§æ ‡è¯†
                        // ğŸ†• v3.11.37 groupKey åŠ å…¥ lt å­—æ®µï¼Œé˜²æ­¢é¦™æ¸¯/æ¾³é—¨çš„åŒç±»å‹é¡¹ç›®è¢«é”™è¯¯åˆå¹¶
                        const groupKey = `${originalLine}|||${itemType}|||${itemAmount}|||${itemLt}`;
                        
                        if (!calcPreGroupMap[groupKey]) {
                            calcPreGroupMap[groupKey] = {
                                originalLine: originalLine,
                                type: itemType,
                                amount: itemAmount,
                                lt: itemLt,  // ğŸ†• v3.11.37 ä¿å­˜å½©ç§æ ‡è¯†
                                items: [],
                                odds: r.odds || 1,
                                minOrder: r.fragmentOrder !== undefined ? r.fragmentOrder : 9999,
                                groupId: itemGroupId  // ğŸ†• v3.11.15 ä¿å­˜ç»„IDç”¨äºåˆ†å‰²çº¿
                            };
                        }
                        calcPreGroupMap[groupKey].items.push(r);
                        const order = r.fragmentOrder !== undefined ? r.fragmentOrder : 9999;
                        if (order < calcPreGroupMap[groupKey].minOrder) {
                            calcPreGroupMap[groupKey].minOrder = order;
                        }
                    });
                    
                    // æŒ‰ groupId + minOrder æ’åº
                    // ğŸ†• v3.11.52 ä¿®å¤ï¼šä¼˜å…ˆæŒ‰ç”¨æˆ·è¾“å…¥ç»„å·æ’åº
                    const sortedGroups = Object.values(calcPreGroupMap).sort((a, b) => {
                        const groupA = a.groupId !== undefined ? a.groupId : 9999;
                        const groupB = b.groupId !== undefined ? b.groupId : 9999;
                        if (groupA !== groupB) {
                            return groupA - groupB;
                        }
                        return a.minOrder - b.minOrder;
                    });
                    
                    // ğŸ†• v3.11.13 è½¬æ¢æ ¼å¼ï¼šä¼˜å…ˆä»ç”¨æˆ·è¾“å…¥è¡Œæå–åŸå§‹ç‰‡æ®µ
                    const userInputText = document.getElementById('bet-input')?.value || '';
                    const userInputFragments = userInputText.split(/[,ï¼Œ\n]+/).map(s => s.trim()).filter(Boolean);
                    
                    sortedGroups.forEach((pg) => {
                        const displayTexts = [];
                        pg.items.forEach(r => {
                            const rawText = r.raw || '';
                            if (rawText && !displayTexts.includes(rawText)) {
                                displayTexts.push(rawText);
                            }
                        });
                        pg.displayTexts = displayTexts;
                        
                        // ğŸ†• v3.11.13 å¦‚æœæœ‰å¤šä¸ª raw æ–‡æœ¬ï¼Œå°è¯•ä»ç”¨æˆ·è¾“å…¥ä¸­æå–åŸå§‹ç‰‡æ®µ
                        // è§£å†³ï¼šåç«¯æŠŠ "å¹³ç‰¹çŒ´é¸¡å„200" æ‹†åˆ†æˆ "å¹³ç‰¹çŒ´å„200" å’Œ "å¹³ç‰¹é¸¡å„200"
                        let bestDisplayText = displayTexts.join(' ');
                        if (displayTexts.length > 1) {
                            // ç±»å‹å…³é”®è¯æ˜ å°„
                            const typeKeywords = {
                                'å¹³ç‰¹ä¸€è‚–': ['å¹³ç‰¹'], 'PT1': ['å¹³ç‰¹'],
                                'å¹³ç‰¹äºŒè¿è‚–': ['äºŒå‹'], 'PT2': ['äºŒå‹'],
                                'å¹³ç‰¹ä¸‰è¿è‚–': ['ä¸‰å‹'], 'PT3': ['ä¸‰å‹'],
                                'å…­è‚–': ['å…­è‚–', '6è‚–'], 'SX6': ['å…­è‚–', '6è‚–'],
                                'ç‰¹ç ': ['ç‰¹'], 'T01': ['ç‰¹'],
                            };
                            const keywords = typeKeywords[pg.type] || [];
                            
                            // åœ¨ç”¨æˆ·è¾“å…¥ç‰‡æ®µä¸­æŸ¥æ‰¾åŒ¹é…çš„åŸå§‹æ–‡æœ¬
                            for (const fragment of userInputFragments) {
                                const hasKeyword = keywords.some(kw => fragment.includes(kw));
                                // æ£€æŸ¥ç‰‡æ®µä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰ items çš„ç”Ÿè‚–
                                const itemZodiacs = pg.items.map(it => it.zodiac).filter(Boolean);
                                const allZodiacsInFragment = itemZodiacs.every(z => {
                                    const zodiacName = CODE_TO_ZODIAC[z] || z;
                                    return fragment.includes(zodiacName);
                                });
                                
                                if (hasKeyword && (itemZodiacs.length === 0 || allZodiacsInFragment)) {
                                    bestDisplayText = fragment;
                                    break;
                                }
                            }
                        }
                        
                        pg.originalLine = bestDisplayText;
                        pg.perAmount = pg.amount;
                        pg.fragmentOrder = pg.minOrder;
                    });
                    
                    // è°ƒè¯•æ—¥å¿—
                    console.log('ğŸ“Š v3.11.11 åˆ†ç»„ç»“æœ:');
                    sortedGroups.forEach((g, i) => {
                        console.log(`  [${i}] type=${g.type} | amt=${g.perAmount} | items=${g.items.length} | "${g.originalLine?.substring(0,30)}..."`);
                    });
                    
                    // ğŸ†• v3.11.9 å¤åˆç±»å‹å®šä¹‰ï¼ˆè¿™äº›ç±»å‹è™½ç„¶å±•å¼€å¤šæ¡ï¼Œä½†å®é™…æ˜¯1æ³¨ï¼‰
                    const COMPOSITE_TYPES = [
                        'å…­è‚–', 'LX', 'LX6', 'SX6',           // å…­è‚–
                        'å¹³ç‰¹äºŒè¿è‚–', 'PT2',                   // å¹³ç‰¹äºŒè¿è‚–
                        'å¹³ç‰¹ä¸‰è¿è‚–', 'PT3',                   // å¹³ç‰¹ä¸‰è¿è‚–
                        'å¹³ç‰¹å››è¿è‚–', 'PT4',                   // å¹³ç‰¹å››è¿è‚–
                        'å¹³ç‰¹äº”è¿è‚–', 'PT5',                   // å¹³ç‰¹äº”è¿è‚–
                        'åˆè‚–', 'HX',                          // åˆè‚–
                        'äºŒä¸­äºŒ', 'E2',                        // äºŒä¸­äºŒ
                        'ä¸‰ä¸­ä¸‰', 'S3'                         // ä¸‰ä¸­ä¸‰
                    ];
                    
                    // ğŸ†• v3.11.15 è®°å½•ä¸Šä¸€ä¸ª groupIdï¼Œç”¨äºåœ¨ä¸åŒç»„ä¹‹é—´æ·»åŠ åˆ†å‰²çº¿
                    let lastGroupId = null;
                    
                    for (const group of sortedGroups) {
                        const items = group.items;
                        const rawType = group.type;
                        const originalLine = group.originalLine;
                        const currentGroupId = group.groupId || items[0]?.groupId || 1;
                        
                        // ğŸ†• v3.11.15 åœ¨ä¸åŒç»„ä¹‹é—´æ·»åŠ åˆ†å‰²çº¿ï¼ˆåŒç»„å†…ä¸åŠ ï¼‰
                        if (lastGroupId !== null && currentGroupId !== lastGroupId) {
                            resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                        }
                        lastGroupId = currentGroupId;
                        
                        // ğŸ†• v3.11.14 ç±»å‹ä»£ç â†’ä¸­æ–‡åç§°è½¬æ¢ + æ™ºèƒ½è¯†åˆ«
                        const CALC_TYPE_CODE_TO_NAME = {
                            'T01': 'ç‰¹ç ', 'SXTM': 'ç‰¹ç ', 'ç‰¹ç ': 'ç‰¹ç ',
                            'PT1': 'å¹³ç‰¹ä¸€è‚–', 'PT2': 'å¹³ç‰¹äºŒè¿è‚–', 'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–',
                            'PT4': 'å¹³ç‰¹å››è¿è‚–', 'PT5': 'å¹³ç‰¹äº”è¿è‚–', 'PTW': 'å¹³ç‰¹å°¾æ•°',
                            'SX6': 'å…­è‚–', 'LX6': 'å…­è‚–', 'LX': 'å…­è‚–', '6X': 'å…­è‚–', 'LIUXIAO': 'å…­è‚–',
                            'TX': 'ç‰¹è‚–', 'HX': 'åˆè‚–', 'ZX': 'æ­£è‚–', 'SX': 'ç”Ÿè‚–',
                            'BS': 'æ³¢è‰²', 'BB': 'åŠæ³¢', 'DP': 'å•å¹³', 'DXDS': 'å¤§å°å•åŒ',
                            'E2': 'äºŒä¸­äºŒ', 'S3': 'ä¸‰ä¸­ä¸‰', 'BZ': 'ä¸ä¸­',
                            'WX': 'äº”è¡Œ', 'JY': 'å®¶é‡', 'ZH': 'æ€»å’Œ',
                            'UK': 'æœªçŸ¥', 'æœªçŸ¥': 'æœªçŸ¥'
                        };
                        let type = CALC_TYPE_CODE_TO_NAME[rawType] || rawType;
                        
                        // ğŸ†• v3.11.14 æ™ºèƒ½è¯†åˆ«ï¼šå¦‚æœæ˜¾ç¤ºæ–‡æœ¬åŒ…å«"å…­è‚–"å…³é”®è¯ï¼Œå¼ºåˆ¶è®¾ä¸ºå…­è‚–ç±»å‹
                        if ((originalLine.includes('å…­è‚–') || originalLine.includes('6è‚–')) && (type === 'æœªçŸ¥' || type === rawType)) {
                            type = 'å…­è‚–';
                        }
                        
                        // ğŸ†• v3.11.10 å¤åˆç±»å‹æ³¨æ•°å›ºå®šä¸º1æ³¨
                        const isCompositeType = COMPOSITE_TYPES.includes(type) || COMPOSITE_TYPES.includes(rawType);
                        // ğŸ†• v3.11.10 ä½¿ç”¨åˆ†ç»„æ—¶å·²è®¡ç®—å¥½çš„ perAmount
                        const perAmount = group.perAmount || items[0]?.amount || 0;
                        
                        // ğŸ†• v3.11.12 æ£€æµ‹"å„"/"æ¯"å…³é”®è¯ï¼Œè®¡ç®—ç”Ÿè‚–æ•°é‡ä½œä¸ºæ³¨æ•°
                        // è§„åˆ™ï¼šå¹³ç‰¹ä¸€è‚–ï¼ˆPT1ï¼‰ä¸­ï¼Œ"å¹³ç‰¹çŒ´é¸¡å„200" = 2æ³¨ï¼ˆæ¯ä¸ªç”Ÿè‚–=1æ³¨ï¼‰
                        const hasEachKeyword = /å„|æ¯/.test(originalLine);
                        const zodiacCount = hasEachKeyword ? countZodiacsInText(originalLine) : 0;
                        
                        // ğŸ†• v3.11.12 æ³¨æ•°è®¡ç®—ï¼šå¤åˆç±»å‹=1æ³¨ï¼›æœ‰"å„"å…³é”®è¯æ—¶ç”¨ç”Ÿè‚–æ•°ï¼›å¦åˆ™ç”¨itemsæ•°
                        let betCount;
                        if (isCompositeType) {
                            betCount = 1;
                        } else if (hasEachKeyword && zodiacCount > 0) {
                            betCount = Math.max(items.length, zodiacCount);
                        } else {
                            betCount = items.length;
                        }
                        // ğŸ†• v3.11.12 æ€»é‡‘é¢ï¼šå¤åˆç±»å‹=å•æ³¨é‡‘é¢ï¼›å…¶ä»–=æ³¨æ•°Ã—å•æ³¨é‡‘é¢
                        const typeTotal = isCompositeType ? perAmount : (betCount * perAmount);
                        
                        // ğŸ†• v3.11.14 ä¿®å¤å¤åˆç±»å‹ä¸­å¥–åˆ¤æ–­ï¼šPT2/PT3ç­‰è¿è‚–ç±»å‹å¿…é¡»æ‰€æœ‰ç”Ÿè‚–éƒ½ä¸­æ‰ç®—ä¸­å¥–
                        // å› ä¸ºåç«¯AIå¯èƒ½é”™è¯¯åœ°å°†"äºŒå‹çŒªç‹—200"æ‹†æˆä¸¤æ¡PT2ï¼ˆçŒªä¸€æ¡ã€ç‹—ä¸€æ¡ï¼‰ï¼Œ
                        // å¦‚æœåªæœ‰çŒªä¸­å¥–ï¼ˆå‡ºç°åœ¨å¼€å¥–å·ç ä¸­ï¼‰è€Œç‹—æ²¡ä¸­ï¼Œåº”è¯¥æ•´ä½“ä¸ä¸­å¥–
                        const isLianXiaoType = ['PT2', 'PT3', 'PT4', 'PT5', 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–', 'å¹³ç‰¹å››è¿è‚–', 'å¹³ç‰¹äº”è¿è‚–'].includes(type) || 
                                               ['PT2', 'PT3', 'PT4', 'PT5'].includes(rawType);
                        const hasWin = isLianXiaoType ? items.every(r => r.isWin) : items.some(r => r.isWin);
                        // ğŸ†• v3.11.14 æ ¹æ®ç±»å‹è·å–æ­£ç¡®çš„èµ”ç‡
                        const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
                        let typeOdds = items[0]?.odds || 1;
                        if (type === 'ç‰¹ç ' || rawType === 'T01' || rawType === 'SXTM') {
                            typeOdds = parseFloat(savedOdds['odds-tema']) || 43;
                        } else if (type === 'å¹³ç‰¹ä¸€è‚–' || rawType === 'PT1') {
                            typeOdds = parseFloat(savedOdds['odds-pingte1']) || 11;
                        } else if (type === 'å¹³ç‰¹äºŒè¿è‚–' || rawType === 'PT2') {
                            typeOdds = parseFloat(savedOdds['odds-pt2']) || 26;
                        } else if (type === 'å¹³ç‰¹ä¸‰è¿è‚–' || rawType === 'PT3') {
                            typeOdds = parseFloat(savedOdds['odds-pt3']) || 66;
                        } else if (type === 'å…­è‚–' || rawType === 'SX6' || rawType === 'LX' || rawType === 'LX6') {
                            typeOdds = parseFloat(savedOdds['odds-liuxiao']) || 4.2;
                        } else if (type === 'ç”Ÿè‚–' || rawType === 'SX') {
                            typeOdds = parseFloat(savedOdds['odds-shengxiao']) || 12;
                        } else if (type === 'æ³¢è‰²' || rawType === 'BS') {
                            typeOdds = parseFloat(savedOdds['odds-bose']) || 2;
                        } else if (type === 'åŠæ³¢' || rawType === 'BB') {
                            typeOdds = parseFloat(savedOdds['odds-banbo']) || 4;
                        }
                        const winPayout = items.filter(r => r.isWin).reduce((s, r) => s + r.winAmount, 0);
                        
                        // ğŸ†• v3.6.1 ä¼˜åŒ–å±•ç¤ºï¼šèšåˆå·ç åˆ—è¡¨
                        const allNums = items.map(it => it.number || (it.numbers && it.numbers[0])).filter(n => n);
                        const winNums = items.filter(r => r.isWin).map(it => it.number || (it.numbers && it.numbers[0])).filter(n => n);
                        
                        // ğŸ†• v3.8.3 åªæœ‰ç”Ÿè‚–è¾“å…¥æ‰æ˜¾ç¤ºå·ç åˆ—è¡¨ï¼ˆç›´æ¥è¾“å…¥å·ç çš„ä¸æ˜¾ç¤ºï¼Œé¿å…å†—ä½™ï¼‰
                        // ğŸ†• v3.11.14 å¹³ç‰¹ç±»å‹ä¸æ˜¾ç¤ºå·ç åˆ—è¡¨ï¼Œåªæœ‰ç‰¹ç ç±»å‹æ‰æ˜¾ç¤º
                        const hasZodiac = items.some(it => it.zodiac);
                        // ğŸ†• v3.12.3 å¢å¼ºå¹³ç‰¹ç±»å‹æ£€æµ‹ï¼šåŒæ—¶æ£€æŸ¥ type å’Œ originalLine
                        const isPingteType = ['PT1', 'PT2', 'PT3', 'PT4', 'PT5', 'å¹³ç‰¹ä¸€è‚–', 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–', 'å¹³ç‰¹å››è¿è‚–', 'å¹³ç‰¹äº”è¿è‚–', 'å¹³ç‰¹'].includes(type)
                            || /å¹³ç‰¹|ä¸€è‚–|äºŒè‚–|ä¸‰è‚–|å››è‚–|äº”è‚–|ä¸€å‹|äºŒå‹|ä¸‰å‹|å››å‹|äº”å‹|ä¸€æœ‰|äºŒæœ‰|ä¸‰æœ‰|å››æœ‰|äº”æœ‰/.test(originalLine);
                        
                        // ğŸ†• v3.12.3 æ£€æµ‹æ˜¯å¦æ˜¯æ³¢è‰²å±•å¼€ï¼ˆå…°æ³¢/è“æ³¢/çº¢æ³¢/ç»¿æ³¢ + å„/æ¯/xï¼‰
                        const isColorExpand = /[çº¢è“å…°ç»¿]æ³¢|[çº¢è“å…°ç»¿]è‰²/.test(originalLine) && /[å„æ¯xXÃ—\*]/.test(originalLine);
                        
                        let numsDisplay = '';
                        
                        // ğŸ†• v3.12.3 å¹³ç‰¹ç±»å‹ä¸æ˜¾ç¤ºå·ç åˆ—è¡¨
                        if (isPingteType) {
                            numsDisplay = '';
                        }
                        // ğŸ†• v3.12.3 æ³¢è‰²å±•å¼€æ˜¾ç¤ºå·ç 
                        else if (isColorExpand && allNums.length > 0 && betCount > 1) {
                            // åˆ¤æ–­æ³¢è‰²ç±»å‹
                            let colorName = '';
                            if (/çº¢æ³¢|çº¢è‰²/.test(originalLine)) colorName = 'çº¢æ³¢';
                            else if (/è“æ³¢|å…°æ³¢|è“è‰²/.test(originalLine)) colorName = 'è“æ³¢';
                            else if (/ç»¿æ³¢|ç»¿è‰²/.test(originalLine)) colorName = 'ç»¿æ³¢';
                            
                            const numsStr = allNums.map(n => String(n).padStart(2,'0')).join(',');
                            numsDisplay = ` (${colorName}${numsStr})`;
                        }
                        // ç”Ÿè‚–æ˜¾ç¤ºå·ç ï¼ˆä»…ç‰¹ç ç±»å‹ï¼‰
                        else if (hasZodiac && allNums.length > 0 && betCount > 1) {
                            // ğŸ†• v3.8.4 æŒ‰ç”Ÿè‚–åˆ†ç»„æ˜¾ç¤ºå·ç ï¼ˆå¦‚ï¼šçŒ´10,22,34,46,é¾™02,14,26,38ï¼‰
                            // Zä»£å·è½¬ç”Ÿè‚–åç§°æ˜ å°„
                            const Z_TO_NAME = {
                                'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
                                'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
                                'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
                            };
                            const zodiacGroups = {};
                            items.forEach(it => {
                                const z = it.zodiac;
                                const num = it.number || (it.numbers && it.numbers[0]);
                                if (z && num) {
                                    if (!zodiacGroups[z]) zodiacGroups[z] = [];
                                    if (!zodiacGroups[z].includes(num)) zodiacGroups[z].push(num);
                                }
                            });
                            // æŒ‰itemsä¸­é¦–æ¬¡å‡ºç°çš„é¡ºåºæ’åˆ—ç”Ÿè‚–
                            const zodiacOrder = [];
                            items.forEach(it => {
                                if (it.zodiac && !zodiacOrder.includes(it.zodiac)) {
                                    zodiacOrder.push(it.zodiac);
                                }
                            });
                            const parts = zodiacOrder.map(z => {
                                const nums = zodiacGroups[z] || [];
                                // å°†Zä»£å·è½¬æ¢ä¸ºç”Ÿè‚–åç§°ï¼ˆå¦‚Z9â†’çŒ´ï¼‰
                                const zName = Z_TO_NAME[z] || z;
                                return zName + nums.map(n => String(n).padStart(2,'0')).join(',');
                            });
                            numsDisplay = ` (${parts.join(',')})`;
                        }
                        
                        const icon = hasWin ? 'âœ“' : 'âœ—';
                        const profitStr = hasWin ? ` ç›ˆ+${winPayout - typeTotal}å…ƒ` : '';
                        
                        // ğŸ†• v3.11.29 æ··åˆä¸‹æ³¨æ—¶æ·»åŠ [é¦™]/[æ¾³]å‰ç¼€
                        let ltPrefix = '';
                        if (window.currentCalcIsMixed) {
                            // è·å–è¯¥ç»„çš„å½©ç§æ ‡è¯†ï¼ˆå–ç¬¬ä¸€æ¡è®°å½•çš„ltï¼‰
                            const groupLt = items[0]?.lt || 'mc';
                            ltPrefix = groupLt === 'hk' ? '[é¦™] ' : '[æ¾³] ';
                        }
                        
                        // ğŸ†• v3.8.4 åˆ é™¤"å„"å­—ï¼Œæ ¼å¼ï¼šç±»å‹(å€ç‡): åŸæ–‡ (å·ç åˆ—è¡¨) é‡‘é¢*æ³¨æ•°=æ€»é¢
                        resultText += `${ltPrefix}${icon} ${type} (${typeOdds}å€): ${originalLine}${numsDisplay} ${perAmount}å…ƒ*${betCount}æ³¨=${typeTotal}å…ƒ${profitStr}\n`;
                    }
                    
                    resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    resultText += `ğŸ’¡ ç»“æœæœ‰è¯¯ï¼Ÿç‚¹å‡»ä¸‹æ–¹"æäº¤åé¦ˆ"ï¼ˆç‚¹å‡»ç»“æœå¯è·³è¿‡åŠ¨ç”»ï¼‰\n`;
                    
                    // ğŸ†• v3.11.65 éšè—è®¡ç®—åŠ è½½æç¤º
                    hideCalculatingLoader();
                    
                    // ğŸ†• v3.11.64 ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºç»“æœ
                    displayResultWithTypewriter(resultText, true);
                    return; // ğŸ†• v3.0 åç«¯è®¡ç®—å®Œæˆï¼Œç›´æ¥è¿”å›
                } else {
                    // åç«¯è¿”å›ç©ºç»“æœæˆ–å¤±è´¥ï¼Œå›é€€æœ¬åœ°è§£æ
                    console.warn('âš ï¸ åç«¯è®¡ç®—å¤±è´¥æˆ–è¿”å›ç©ºç»“æœ:', backendResult.error);
                    debugInfo.lastError = backendResult.error || 'åç«¯è¿”å›ç©ºç»“æœ';
                    showAutoCloseToast('âš ï¸ åç«¯è®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è§£æ', 2000);
                    parsedBets = parseBetInput(input);
                }
            } catch (e) {
                console.error('âŒ åç«¯è®¡ç®—å¼‚å¸¸:', e);
                debugInfo.lastError = e.message || String(e);
                hideCalculatingLoader(); // ğŸ†• v3.11.65 å¼‚å¸¸æ—¶ä¹Ÿè¦éšè—åŠ è½½æç¤º
                showAutoCloseToast('âŒ åç«¯è®¡ç®—å¼‚å¸¸: ' + e.message, 3000);
                // å›é€€åˆ°æœ¬åœ°è§£æ
                parsedBets = parseBetInput(input);
            }
        } else {
            // æœªå¯ç”¨AIï¼Œä½¿ç”¨æœ¬åœ°è§£æ
            parsedBets = parseBetInput(input);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ä»¥ä¸‹æ˜¯æœ¬åœ°è§£æçš„å›é€€é€»è¾‘ï¼ˆå½“åç«¯è®¡ç®—å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (parsedBets.length === 0) {
            hideCalculatingLoader(); // ğŸ†• v3.11.65 æ— ç»“æœæ—¶ä¹Ÿè¦éšè—åŠ è½½æç¤º
            alert('âŒ æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„ä¸‹æ³¨ä¿¡æ¯\n\nå»ºè®®ï¼š\n1. æ£€æŸ¥è¾“å…¥æ ¼å¼\n2. åœ¨"è‡ªå®šä¹‰æ ¼å¼"ä¸­æ·»åŠ è§„åˆ™\n3. å¯ç”¨AIæ™ºèƒ½è§£æ');
            return;
        }
        
        // æœ¬åœ°è®¡ç®—ï¼ˆå›é€€æ¨¡å¼ï¼‰
        calcResults = parsedBets.map(bet => calculateSingleBet(bet, appState.lotteryNumbers));
        
        // æ±‡æ€»
        const totalBet = calcResults.reduce((sum, r) => sum + r.amount, 0);
        const totalWin = calcResults.filter(r => r.isWin).length;
        const totalWinAmount = calcResults.filter(r => r.isWin).reduce((sum, r) => sum + r.winAmount, 0);
        const netResult = calcResults.reduce((sum, r) => sum + r.netResult, 0);
        
        // è·å–å¼€å¥–ä¿¡æ¯
        const tema = appState.lotteryNumbers[6];
        const lotteryStr = appState.lotteryNumbers.slice(0,6).map(n => String(n).padStart(2,'0')).join(' ') + ' + ç‰¹ç ' + String(tema).padStart(2,'0');
        
        // ğŸ†• v3.11.29 ç”Ÿæˆå¼€å¥–ç»“æœï¼ˆä¸åç«¯æ¨¡å¼ä¿æŒä¸€è‡´ï¼‰
        // æœ¬åœ°å›é€€æ¨¡å¼ç›®å‰æ²¡æœ‰hk/mcä¿¡æ¯ï¼Œä½¿ç”¨windowå˜é‡ï¼ˆä»å‰ç«¯æ£€æµ‹å¾—åˆ°ï¼‰
        const hasHK2 = window.currentCalcHasHK || false;
        const hasMC2 = window.currentCalcHasMC !== false;
        const isMixed2 = window.currentCalcIsMixed || false;
        
        let lotteryResultText2 = '';
        const xamData2 = appState.lotteryData['xam'];
        const hkData2 = appState.lotteryData['hk'];
        const xamNums2 = xamData2?.numbers || appState.lotteryNumbers;
        const hkNums2 = hkData2?.numbers || [];
        
        const xamStr2 = xamNums2.length === 7 
            ? xamNums2.slice(0,6).map(n => String(n).padStart(2,'0')).join(' ') + ' + ç‰¹ç ' + String(xamNums2[6]).padStart(2,'0')
            : 'æœªè®¾ç½®';
        const hkStr2 = hkNums2.length === 7
            ? hkNums2.slice(0,6).map(n => String(n).padStart(2,'0')).join(' ') + ' + ç‰¹ç ' + String(hkNums2[6]).padStart(2,'0')
            : 'æœªè®¾ç½®';
        
        if (isMixed2) {
            lotteryResultText2 = `ğŸ° æ–°æ¾³å¼€å¥–: ${xamStr2}\nğŸ° é¦™æ¸¯å¼€å¥–: ${hkStr2}\n`;
        } else if (hasHK2 && !hasMC2) {
            lotteryResultText2 = `ğŸ° é¦™æ¸¯å¼€å¥–: ${hkStr2}\n`;
        } else {
            lotteryResultText2 = `ğŸ° æ–°æ¾³å¼€å¥–: ${xamStr2}\n`;
        }
        
        // ç”Ÿæˆç»“æœæ–‡æœ¬ï¼ˆæ›´æ¸…æ™°çš„æ ¼å¼ï¼‰
        let resultText = `ğŸ“Š è®¡ç®—ç»“æœ\n`;
        resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        resultText += lotteryResultText2;
        resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        // ğŸ†• v2.4.8 ç»Ÿè®¡ä¿¡æ¯ï¼šè¯†åˆ«æ³¨æ•° | æ€»æŠ• | ä¸­å¥–æ³¨æ•° | æ´¾å½©
        resultText += `ğŸ“‹ è¯†åˆ« ${calcResults.length} æ³¨ | æ€»æŠ• ${totalBet}å…ƒ\n`;
        resultText += `ä¸­${totalWin}æ³¨ | æ´¾å½© ${totalWinAmount}å…ƒ\n`;
        // ğŸ†• v2.4.8 ç»“ç®—ï¼šä»ç©å®¶è§’åº¦ï¼Œæ´¾å½© - æ€»æŠ•å…¥ = å‡€ç›ˆäºï¼ˆæ­£æ•°ä¸ºèµ¢ï¼‰
        const settleAmount = totalWinAmount - totalBet;
        resultText += `ğŸ’° ç»“ç®—: ${settleAmount >= 0 ? '+' : ''}${settleAmount}å…ƒ\n`;
        resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        
        // æŒ‰åŸæ–‡åˆ†ç»„æ˜¾ç¤ºï¼ˆğŸ†• v3.7.2 ä¼˜å…ˆä½¿ç”¨ originalLine ä½œä¸ºèšåˆ keyï¼‰
        const byOriginal = {};
        calcResults.forEach(r => {
            // ä¼˜å…ˆä½¿ç”¨ originalLineï¼ˆç”¨æˆ·åŸå§‹è¾“å…¥ï¼‰ï¼Œè€Œä¸æ˜¯ rawï¼ˆåç«¯å±•å¼€åçš„å•æ¡æ•°æ®ï¼‰
            const key = r.originalLine || r.raw || r.type;
            if (!byOriginal[key]) {
                byOriginal[key] = { type: r.type, originalLine: key, items: [], odds: r.odds || 1 };
            }
            byOriginal[key].items.push(r);
        });
        
        const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
        
        for (const group of Object.values(byOriginal)) {
            const items = group.items;
            const type = group.type;
            const originalLine = group.originalLine;
            const betCount = items.length;
            const typeTotal = items.reduce((s, it) => s + it.amount, 0);
            // ğŸ†• v3.11.14 ä¿®å¤å¤åˆç±»å‹ä¸­å¥–åˆ¤æ–­ï¼šPT2/PT3ç­‰è¿è‚–ç±»å‹å¿…é¡»æ‰€æœ‰ç”Ÿè‚–éƒ½ä¸­æ‰ç®—ä¸­å¥–
            const isLianXiaoType = ['PT2', 'PT3', 'PT4', 'PT5', 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–', 'å¹³ç‰¹å››è¿è‚–', 'å¹³ç‰¹äº”è¿è‚–'].includes(type);
            const hasWin = isLianXiaoType ? items.every(r => r.isWin) : items.some(r => r.isWin);
            const perAmount = items[0]?.amount || 0;
            const winPayout = items.filter(r => r.isWin).reduce((s, r) => s + r.winAmount, 0);
            let typeOdds = items[0]?.odds || 1;
            // ğŸ†• v3.3 ç”Ÿè‚–ç‰¹ç å·²åˆå¹¶åˆ°ç‰¹ç ï¼Œä½†ä¿ç•™å…¼å®¹æ—§ç‰ˆæ•°æ®
            if (type === 'ç‰¹ç ' || type === 'ç”Ÿè‚–ç‰¹ç ') {
                typeOdds = parseFloat(savedOdds['odds-tema']) || 43;
            } else if (type === 'å¹³ç‰¹ç”Ÿè‚–' || type === 'å¹³ç‰¹ä¸€è‚–') {
                typeOdds = parseFloat(savedOdds['odds-pingte1']) || 11;
            }
            
            // ğŸ†• v3.6.1 ä¼˜åŒ–å±•ç¤ºï¼šèšåˆå·ç åˆ—è¡¨
            const allNums = items.map(it => it.number || (it.numbers && it.numbers[0])).filter(n => n);
            
            // ğŸ†• v3.8.3 åªæœ‰ç”Ÿè‚–è¾“å…¥æ‰æ˜¾ç¤ºå·ç åˆ—è¡¨ï¼ˆç›´æ¥è¾“å…¥å·ç çš„ä¸æ˜¾ç¤ºï¼Œé¿å…å†—ä½™ï¼‰
            // ğŸ†• v3.11.14 å¹³ç‰¹ç±»å‹ä¸æ˜¾ç¤ºå·ç åˆ—è¡¨ï¼Œåªæœ‰ç‰¹ç ç±»å‹æ‰æ˜¾ç¤º
            const hasZodiac = items.some(it => it.zodiac);
            // ğŸ†• v3.12.3 å¢å¼ºå¹³ç‰¹ç±»å‹æ£€æµ‹ï¼šåŒæ—¶æ£€æŸ¥ type å’Œ originalLine
            const isPingteType = ['PT1', 'PT2', 'PT3', 'PT4', 'PT5', 'å¹³ç‰¹ä¸€è‚–', 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–', 'å¹³ç‰¹å››è¿è‚–', 'å¹³ç‰¹äº”è¿è‚–', 'å¹³ç‰¹'].includes(type) 
                || /å¹³ç‰¹|ä¸€è‚–|äºŒè‚–|ä¸‰è‚–|å››è‚–|äº”è‚–|ä¸€å‹|äºŒå‹|ä¸‰å‹|å››å‹|äº”å‹|ä¸€æœ‰|äºŒæœ‰|ä¸‰æœ‰|å››æœ‰|äº”æœ‰/.test(originalLine);
            
            // ğŸ†• v3.12.3 æ£€æµ‹æ˜¯å¦æ˜¯æ³¢è‰²å±•å¼€ï¼ˆå…°æ³¢/è“æ³¢/çº¢æ³¢/ç»¿æ³¢ + å„/æ¯/xï¼‰
            const isColorExpand = /[çº¢è“å…°ç»¿]æ³¢|[çº¢è“å…°ç»¿]è‰²/.test(originalLine) && /[å„æ¯xXÃ—\*]/.test(originalLine);
            
            let numsDisplay = '';
            
            // ğŸ†• v3.12.3 å¹³ç‰¹ç±»å‹ä¸æ˜¾ç¤ºå·ç åˆ—è¡¨
            if (isPingteType) {
                numsDisplay = '';
            }
            // ğŸ†• v3.12.3 æ³¢è‰²å±•å¼€æ˜¾ç¤ºå·ç 
            else if (isColorExpand && allNums.length > 0 && betCount > 1) {
                // åˆ¤æ–­æ³¢è‰²ç±»å‹
                let colorName = '';
                if (/çº¢æ³¢|çº¢è‰²/.test(originalLine)) colorName = 'çº¢æ³¢';
                else if (/è“æ³¢|å…°æ³¢|è“è‰²/.test(originalLine)) colorName = 'è“æ³¢';
                else if (/ç»¿æ³¢|ç»¿è‰²/.test(originalLine)) colorName = 'ç»¿æ³¢';
                
                const numsStr = allNums.map(n => String(n).padStart(2,'0')).join(',');
                numsDisplay = ` (${colorName}${numsStr})`;
            }
            // ç”Ÿè‚–æ˜¾ç¤ºå·ç ï¼ˆä»…ç‰¹ç ç±»å‹ï¼‰
            else if (hasZodiac && allNums.length > 0 && betCount > 1) {
                // ğŸ†• v3.8.4 æŒ‰ç”Ÿè‚–åˆ†ç»„æ˜¾ç¤ºå·ç ï¼ˆå¦‚ï¼šçŒ´10,22,34,46,é¾™02,14,26,38ï¼‰
                // Zä»£å·è½¬ç”Ÿè‚–åç§°æ˜ å°„
                const Z_TO_NAME = {
                    'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
                    'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
                    'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
                };
                const zodiacGroups = {};
                items.forEach(it => {
                    const z = it.zodiac;
                    const num = it.number || (it.numbers && it.numbers[0]);
                    if (z && num) {
                        if (!zodiacGroups[z]) zodiacGroups[z] = [];
                        if (!zodiacGroups[z].includes(num)) zodiacGroups[z].push(num);
                    }
                });
                // æŒ‰itemsä¸­é¦–æ¬¡å‡ºç°çš„é¡ºåºæ’åˆ—ç”Ÿè‚–
                const zodiacOrder = [];
                items.forEach(it => {
                    if (it.zodiac && !zodiacOrder.includes(it.zodiac)) {
                        zodiacOrder.push(it.zodiac);
                    }
                });
                const parts = zodiacOrder.map(z => {
                    const nums = zodiacGroups[z] || [];
                    // å°†Zä»£å·è½¬æ¢ä¸ºç”Ÿè‚–åç§°ï¼ˆå¦‚Z9â†’çŒ´ï¼‰
                    const zName = Z_TO_NAME[z] || z;
                    return zName + nums.map(n => String(n).padStart(2,'0')).join(',');
                });
                numsDisplay = ` (${parts.join(',')})`;
            }
            
            const icon = hasWin ? 'âœ“' : 'âœ—';
            const profitStr = hasWin ? ` ç›ˆ+${winPayout - typeTotal}å…ƒ` : '';
            // ğŸ†• v3.8.4 åˆ é™¤"å„"å­—
            resultText += `${icon} ${type} (${typeOdds}å€): ${originalLine}${numsDisplay} ${perAmount}å…ƒ*${betCount}æ³¨=${typeTotal}å…ƒ${profitStr}\n`;
        }
        
        resultText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        resultText += `ğŸ’¡ ç»“æœæœ‰è¯¯ï¼Ÿç‚¹å‡»ä¸‹æ–¹"æäº¤åé¦ˆ"ï¼ˆç‚¹å‡»ç»“æœå¯è·³è¿‡åŠ¨ç”»ï¼‰\n`;
        
        // ğŸ†• v3.11.65 éšè—è®¡ç®—åŠ è½½æç¤º
        hideCalculatingLoader();
        
        // ğŸ†• v3.11.64 ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºç»“æœ
        displayResultWithTypewriter(resultText, true);
    }
    
    // æ˜¾ç¤ºæ ¸å¯¹è¯¦æƒ…
    function showCheckDetail() {
        if (calcResults.length === 0) {
            alert('è¯·å…ˆç‚¹å‡»"å¼€å§‹è®¡ç®—"');
            return;
        }
        
        // æ±‡æ€»æ•°æ®
        const totalBet = calcResults.reduce((sum, r) => sum + r.amount, 0);
        const totalWin = calcResults.filter(r => r.isWin).length;
        const netResult = calcResults.reduce((sum, r) => sum + r.netResult, 0);
        
        document.getElementById('check-total-bet').textContent = totalBet + 'å…ƒ';
        document.getElementById('check-win-count').textContent = totalWin + '/' + calcResults.length;
        
        const resultEl = document.getElementById('check-result');
        resultEl.textContent = (netResult >= 0 ? '+' : '') + netResult + 'å…ƒ';
        resultEl.className = 'check-summary-value ' + (netResult >= 0 ? 'lose' : 'win');
        
        // ç”Ÿæˆè¯¦æƒ…åˆ—è¡¨
        const listEl = document.getElementById('check-detail-list');
        listEl.innerHTML = calcResults.map(r => {
            const statusClass = r.isWin ? 'win' : 'lose';
            const badge = r.isWin ? 'ğŸ¯ ä¸­å¥–' : 'æœªä¸­';
            const badgeClass = r.isWin ? '' : 'miss';
            const resultClass = r.netResult >= 0 ? 'lose' : 'win';
            const resultText = (r.netResult >= 0 ? '+' : '') + r.netResult;
            
            // æ˜¾ç¤ºAIä¸ç¨‹åºè¯†åˆ«å·®å¼‚
            let typeConflictHtml = '';
            if (r.fromAI && r.localType) {
                typeConflictHtml = `<div class="check-detail-info" style="color:#ffa500;font-size:11px;">âš ï¸ AIè¯†åˆ«: ${r.aiType || r.type} | ç¨‹åºè¯†åˆ«: ${r.localType}</div>`;
            } else if (r.fromAI) {
                typeConflictHtml = `<div class="check-detail-info" style="color:#4CAF50;font-size:11px;">ğŸ¤– AIè¯†åˆ«</div>`;
            }
            
            return `
                <div class="check-detail-item ${statusClass}">
                    <div class="check-detail-header">
                        <span class="check-detail-type">${r.type} ${r.number ? String(r.number).padStart(2,'0') : (r.value || '')}</span>
                        <span class="check-detail-badge ${badgeClass}">${badge}</span>
                    </div>
                    ${typeConflictHtml}
                    <div class="check-detail-info">ä¸‹æ³¨é‡‘é¢ï¼š${r.amount}å…ƒ</div>
                    <div class="check-detail-calc">${r.detail}</div>
                    ${r.isWin ? `<div class="check-detail-calc">ä¸­å¥–ï¼š${r.amount} Ã— ${r.odds} = ${r.winAmount}</div>` : ''}
                    <div class="check-detail-result ${resultClass}">${resultText}å…ƒ</div>
                </div>
            `;
        }).join('');
        
        showPage('page-check');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ã€åˆ†ç»„ç¼–è¾‘å™¨ v2.4ã€‘æ‰‹åŠ¨æ§åˆ¶ä¸‹æ³¨è¡Œçš„åˆ†ç»„
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ä¸´æ—¶å­˜å‚¨åˆ†ç»„ç¼–è¾‘çŠ¶æ€
    let groupEditorLines = [];  // æ¯ä¸ªå…ƒç´  { text: string, hasGroupBreakAfter: boolean }
    
    /**
     * æ‰“å¼€åˆ†ç»„ç¼–è¾‘å™¨
     */
    function showGroupEditor() {
        const input = document.getElementById('bet-input').value;
        if (!input.trim()) {
            alert('è¯·å…ˆç²˜è´´ä¸‹æ³¨ä¿¡æ¯');
            return;
        }
        
        // ğŸ†• v2.4.1 æ”¹è¿›çš„ç©ºè¡Œæ£€æµ‹ï¼šç»Ÿä¸€æ¢è¡Œç¬¦ï¼Œè¿ç»­ç©ºè¡Œè§†ä¸ºä¸€ä¸ªåˆ†ç»„åˆ†éš”
        const normalizedInput = input
            .replace(/\r\n/g, '\n')
            .replace(/\r/g, '\n');
        
        const rawLines = normalizedInput.split('\n');
        groupEditorLines = [];
        
        let lastWasEmpty = false;  // è·Ÿè¸ªä¸Šä¸€è¡Œæ˜¯å¦ä¸ºç©º
        
        for (let i = 0; i < rawLines.length; i++) {
            const line = rawLines[i].trim();
            
            // ç©ºè¡Œï¼ˆåŒ…æ‹¬åªæœ‰ç©ºæ ¼çš„è¡Œï¼‰
            if (!line) {
                // è¿ç»­ç©ºè¡Œåªæ ‡è®°ä¸€æ¬¡
                if (!lastWasEmpty && groupEditorLines.length > 0) {
                    groupEditorLines[groupEditorLines.length - 1].hasGroupBreakAfter = true;
                }
                lastWasEmpty = true;
                continue;
            }
            
            lastWasEmpty = false;
            groupEditorLines.push({
                text: line,
                hasGroupBreakAfter: false
            });
        }
        
        // è°ƒè¯•ï¼šæ˜¾ç¤ºè¯†åˆ«åˆ°çš„åˆ†ç»„æ•°
        const groupCount = groupEditorLines.filter(l => l.hasGroupBreakAfter).length + 1;
        console.log(`ğŸ“¦ åˆ†ç»„ç¼–è¾‘å™¨è¯†åˆ«: ${groupEditorLines.length} è¡Œ, ${groupCount} ç»„`);
        groupEditorLines.forEach((l, i) => {
            console.log(`  ${i+1}. "${l.text.substring(0,20)}..." ${l.hasGroupBreakAfter ? 'ã€åˆ†ç»„çº¿ã€‘' : ''}`);
        });
        
        // æ¸²æŸ“ç¼–è¾‘å™¨
        renderGroupEditor();
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('group-editor-modal').style.display = 'flex';
    }
    
    /**
     * æ¸²æŸ“åˆ†ç»„ç¼–è¾‘å™¨ç•Œé¢
     */
    function renderGroupEditor() {
        const container = document.getElementById('group-editor-lines');
        
        if (groupEditorLines.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">æš‚æ— å†…å®¹</div>';
            return;
        }
        
        let html = '';
        let currentGroupId = 1;
        
        groupEditorLines.forEach((lineData, idx) => {
            // å¦‚æœä¸Šä¸€è¡Œæœ‰åˆ†ç»„çº¿ï¼Œå½“å‰è¡Œæ˜¯æ–°ç»„çš„å¼€å§‹
            if (idx > 0 && groupEditorLines[idx - 1].hasGroupBreakAfter) {
                currentGroupId++;
            }
            
            // ç»„é¢œè‰²
            const groupColors = ['#667eea', '#e94560', '#4ade80', '#f59e0b', '#06b6d4', '#ec4899'];
            const groupColor = groupColors[(currentGroupId - 1) % groupColors.length];
            
            html += `
            <div style="margin-bottom:4px;">
                <!-- è¡Œå†…å®¹ -->
                <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(${currentGroupId % 2 === 1 ? '102,126,234' : '233,69,96'},0.1);border-radius:6px;border-left:3px solid ${groupColor};">
                    <span style="color:${groupColor};font-size:10px;font-weight:bold;min-width:24px;">ç»„${currentGroupId}</span>
                    <span style="flex:1;color:#fff;font-size:13px;">${escapeHtml(lineData.text)}</span>
                    <button onclick="removeGroupLine(${idx})" style="background:none;border:none;color:#f44336;font-size:14px;cursor:pointer;opacity:0.5;" title="åˆ é™¤æ­¤è¡Œ">ğŸ—‘ï¸</button>
                </div>
                
                <!-- åˆ†ç»„çº¿æŒ‰é’® (æœ€åä¸€è¡Œä¸æ˜¾ç¤º) -->
                ${idx < groupEditorLines.length - 1 ? `
                <div style="display:flex;align-items:center;justify-content:center;padding:2px 0;">
                    ${lineData.hasGroupBreakAfter ? `
                        <button onclick="toggleGroupBreak(${idx})" style="padding:4px 12px;background:linear-gradient(90deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:10px;cursor:pointer;display:flex;align-items:center;gap:4px;">
                            <span>â”â”â” åˆ†ç»„çº¿ â”â”â”</span>
                            <span style="opacity:0.7;">âœ•ç§»é™¤</span>
                        </button>
                    ` : `
                        <button onclick="toggleGroupBreak(${idx})" style="padding:3px 10px;background:rgba(255,255,255,0.05);color:#888;border:1px dashed rgba(255,255,255,0.2);border-radius:10px;font-size:10px;cursor:pointer;">
                            + æ’å…¥åˆ†ç»„çº¿
                        </button>
                    `}
                </div>
                ` : ''}
            </div>
            `;
        });
        
        // æ˜¾ç¤ºåˆ†ç»„é¢„è§ˆ
        const groupCount = groupEditorLines.filter(l => l.hasGroupBreakAfter).length + 1;
        html += `
        <div style="margin-top:12px;padding:10px;background:rgba(102,126,234,0.1);border-radius:6px;text-align:center;">
            <span style="color:#667eea;font-size:12px;">ğŸ“Š å½“å‰å…± <strong>${groupCount}</strong> ä¸ªåˆ†ç»„ï¼Œ<strong>${groupEditorLines.length}</strong> è¡Œæ•°æ®</span>
        </div>
        `;
        
        container.innerHTML = html;
    }
    
    /**
     * åˆ‡æ¢åˆ†ç»„çº¿
     */
    function toggleGroupBreak(lineIdx) {
        if (lineIdx >= 0 && lineIdx < groupEditorLines.length) {
            groupEditorLines[lineIdx].hasGroupBreakAfter = !groupEditorLines[lineIdx].hasGroupBreakAfter;
            renderGroupEditor();
        }
    }
    
    /**
     * åˆ é™¤æŸä¸€è¡Œ
     */
    function removeGroupLine(lineIdx) {
        if (lineIdx >= 0 && lineIdx < groupEditorLines.length) {
            groupEditorLines.splice(lineIdx, 1);
            renderGroupEditor();
        }
    }
    
    /**
     * é‡ç½®åˆ†ç»„ç¼–è¾‘å™¨
     */
    function resetGroupEditor() {
        // ç§»é™¤æ‰€æœ‰åˆ†ç»„çº¿
        groupEditorLines.forEach(line => {
            line.hasGroupBreakAfter = false;
        });
        renderGroupEditor();
        showAutoCloseToast('âœ… å·²é‡ç½®ä¸ºå•ç»„', 1500);
    }
    
    /**
     * åº”ç”¨åˆ†ç»„ç¼–è¾‘
     */
    function applyGroupEdits() {
        // æ ¹æ®åˆ†ç»„çº¿é‡å»ºæ–‡æœ¬
        let result = [];
        let currentGroup = [];
        
        groupEditorLines.forEach((lineData, idx) => {
            currentGroup.push(lineData.text);
            
            if (lineData.hasGroupBreakAfter || idx === groupEditorLines.length - 1) {
                result.push(currentGroup.join('\n'));
                currentGroup = [];
            }
        });
        
        // ç”¨åŒæ¢è¡Œè¿æ¥å„ç»„
        const newInput = result.join('\n\n');
        
        // æ›´æ–°è¾“å…¥æ¡†
        document.getElementById('bet-input').value = newInput;
        
        // å…³é—­å¼¹çª—
        closeGroupEditor();
        
        // æç¤º
        const groupCount = result.length;
        showAutoCloseToast(`âœ… å·²åº”ç”¨ ${groupCount} ä¸ªåˆ†ç»„`, 2000);
    }
    
    /**
     * å…³é—­åˆ†ç»„ç¼–è¾‘å™¨
     */
    function closeGroupEditor() {
        document.getElementById('group-editor-modal').style.display = 'none';
    }
    
    /**
     * HTMLè½¬ä¹‰
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ†• v3.11.64 æ‰“å­—æœºæ•ˆæœæ¨¡å— - å¢å¼ºç”¨æˆ·ä½“éªŒ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // æ‰“å­—æœºçŠ¶æ€ç®¡ç†
    let typewriterState = {
        isRunning: false,      // æ˜¯å¦æ­£åœ¨è¿è¡Œ
        timeoutId: null,       // å®šæ—¶å™¨IDï¼ˆç”¨äºå–æ¶ˆï¼‰
        skipRequested: false,  // æ˜¯å¦è¯·æ±‚è·³è¿‡
        fullText: '',          // å®Œæ•´æ–‡æœ¬
    };
    
    /**
     * ğŸ†• v3.11.64 æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸé¡¶éƒ¨
     */
    function scrollToResultSection() {
        const resultSection = document.getElementById('result-section');
        if (resultSection) {
            // å…ˆæ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultSection.classList.add('show');
            // å¹³æ»‘æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            setTimeout(() => {
                resultSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
        }
    }
    
    /**
     * ğŸ†• v3.11.64 æ™ºèƒ½æ»šåŠ¨è·Ÿéšï¼ˆè®©å…‰æ ‡å§‹ç»ˆå¯è§ï¼‰
     * @param {HTMLElement} element - ç»“æœå®¹å™¨å…ƒç´ 
     */
    function smartScrollFollow(element) {
        if (!element) return;
        
        // å†…éƒ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆè®©æ–°å†…å®¹å’Œå…‰æ ‡å¯è§ï¼‰
        element.scrollTop = element.scrollHeight;
        
        // æ£€æŸ¥å…ƒç´ åº•éƒ¨æ˜¯å¦åœ¨è§†å£ä¸­ï¼Œå¦‚æœä¸åœ¨åˆ™æ»šåŠ¨é¡µé¢
        const rect = element.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        // å¦‚æœå…ƒç´ åº•éƒ¨è¶…å‡ºè§†å£ï¼Œæ»šåŠ¨é¡µé¢è·Ÿéš
        if (rect.bottom > viewportHeight - 50) {
            window.scrollBy({
                top: Math.min(rect.bottom - viewportHeight + 80, 50), // æ¯æ¬¡æœ€å¤šæ»šåŠ¨50pxï¼Œé¿å…æŠ–åŠ¨
                behavior: 'smooth'
            });
        }
    }
    
    /**
     * ğŸ†• v3.11.64 æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºHTMLå†…å®¹
     * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
     * @param {string} fullText - å®Œæ•´æ–‡æœ¬ï¼ˆå¸¦\næ¢è¡Œï¼‰
     * @param {number} speed - æ¯å­—ç¬¦å»¶è¿Ÿ(ms)ï¼Œé»˜è®¤5ms
     * @param {Function} callback - å®Œæˆå›è°ƒ
     */
    function typewriterHTML(element, fullText, speed = 5, callback) {
        // ä¿å­˜çŠ¶æ€
        typewriterState.isRunning = true;
        typewriterState.skipRequested = false;
        typewriterState.fullText = fullText;
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (typewriterState.timeoutId) {
            clearTimeout(typewriterState.timeoutId);
        }
        
        // å°†æ–‡æœ¬æŒ‰è¡Œåˆ†å‰²
        const lines = fullText.split('\n');
        let currentLineIdx = 0;
        let currentCharIdx = 0;
        let displayedHTML = '';
        
        // æ£€æµ‹å¤´éƒ¨åŒºåŸŸï¼ˆå¼€å¥–ç»“æœéƒ¨åˆ†ï¼‰ï¼Œä½¿ç”¨è¾ƒæ…¢é€Ÿåº¦
        // å¤´éƒ¨é€šå¸¸æ˜¯å‰å‡ è¡Œï¼ˆğŸ“Š è®¡ç®—ç»“æœã€â”â”â”ã€ğŸ° å¼€å¥–...ï¼‰
        const headerEndLine = Math.min(5, lines.length);
        
        function typeNextChar() {
            // æ£€æŸ¥æ˜¯å¦è¯·æ±‚è·³è¿‡
            if (typewriterState.skipRequested) {
                // ç›´æ¥æ˜¾ç¤ºå®Œæ•´å†…å®¹
                element.innerHTML = fullText.replace(/\n/g, '<br>');
                typewriterState.isRunning = false;
                if (callback) callback();
                return;
            }
            
            if (currentLineIdx >= lines.length) {
                // å®Œæˆ
                typewriterState.isRunning = false;
                if (callback) callback();
                return;
            }
            
            const currentLine = lines[currentLineIdx];
            
            if (currentCharIdx < currentLine.length) {
                // è¿˜åœ¨å½“å‰è¡Œ
                currentCharIdx++;
                const partialLine = currentLine.substring(0, currentCharIdx);
                const cursorHTML = '<span class="typewriter-cursor">â–Œ</span>';
                
                // æ„å»ºæ˜¾ç¤ºå†…å®¹ï¼šå·²å®Œæˆçš„è¡Œ + å½“å‰è¡Œéƒ¨åˆ† + å…‰æ ‡
                let html = displayedHTML;
                if (displayedHTML) html += '<br>';
                html += partialLine + cursorHTML;
                
                element.innerHTML = html;
                smartScrollFollow(element);
                
                // åŠ¨æ€é€Ÿåº¦ï¼šå¤´éƒ¨æ…¢(30ms)ï¼Œç»“æœå¿«(5ms)
                const isHeader = currentLineIdx < headerEndLine;
                const currentSpeed = isHeader ? 25 : speed;
                
                typewriterState.timeoutId = setTimeout(typeNextChar, currentSpeed);
            } else {
                // å½“å‰è¡Œå®Œæˆï¼Œç§»åˆ°ä¸‹ä¸€è¡Œ
                if (displayedHTML) displayedHTML += '<br>';
                displayedHTML += currentLine;
                currentLineIdx++;
                currentCharIdx = 0;
                
                // è¡Œé—´æœ‰çŸ­æš‚åœé¡¿ï¼ˆè®©ç”¨æˆ·èƒ½çœ‹æ¸…æ¯è¡Œï¼‰
                const linePause = currentLine.includes('â”â”') ? 50 : 10;
                typewriterState.timeoutId = setTimeout(typeNextChar, linePause);
            }
        }
        
        // æ·»åŠ ç‚¹å‡»è·³è¿‡åŠŸèƒ½
        const skipHandler = function() {
            if (typewriterState.isRunning) {
                typewriterState.skipRequested = true;
            }
            element.removeEventListener('click', skipHandler);
        };
        element.addEventListener('click', skipHandler);
        
        // å¼€å§‹æ‰“å­—
        typeNextChar();
    }
    
    /**
     * ğŸ†• v3.11.66 å¹³ç¨³æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
     * æ¨¡æ‹Ÿç”¨æˆ·æ‰‹å·¥ç‚¹å‡»ç©ºä½åå¾€ä¸Šæ»‘åŠ¨çš„æ•ˆæœ
     */
    function smoothScrollToTop() {
        // ä½¿ç”¨å¹³æ»‘æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
        window.scrollTo({ 
            top: 0, 
            behavior: 'smooth' 
        });
        console.log('ğŸ“ å¹³ç¨³æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨');
    }
    
    /**
     * ğŸ†• v3.11.66 æ˜¾ç¤ºç»“æœï¼ˆå¸¦æ‰“å­—æœºæ•ˆæœï¼‰
     * ä¿®æ”¹ï¼šæ‰“å­—æœºæ•ˆæœå®Œæˆåï¼Œè‡ªåŠ¨å¹³ç¨³æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
     * @param {string} resultText - ç»“æœæ–‡æœ¬
     * @param {boolean} useTypewriter - æ˜¯å¦ä½¿ç”¨æ‰“å­—æœºæ•ˆæœï¼Œé»˜è®¤true
     */
    /**
     * ğŸ†• v3.11.67 ç¦ç”¨æ‰“å­—æœºæ•ˆæœï¼Œç›´æ¥æ˜¾ç¤ºç»“æœï¼ˆæå‡å“åº”é€Ÿåº¦ï¼‰
     * åŸå› ï¼šæ‰“å­—æœºæ•ˆæœéœ€è¦5-10ç§’ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
     */
    function displayResultWithTypewriter(resultText, useTypewriter = false) {
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');
        
        if (!resultSection || !resultContent) {
            console.error('âŒ æ‰¾ä¸åˆ°ç»“æœæ˜¾ç¤ºåŒºåŸŸ');
            return;
        }
        
        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        scrollToResultSection();
        
        // ğŸ†• v3.11.67 ç›´æ¥æ˜¾ç¤ºç»“æœï¼ˆä¸ä½¿ç”¨æ‰“å­—æœºæ•ˆæœï¼‰
        resultContent.innerHTML = resultText.replace(/\n/g, '<br>');
        console.log('âœ… ç»“æœæ˜¾ç¤ºå®Œæˆ');
    }
    
    /**
     * ğŸ†• v3.11.64 åœæ­¢æ‰“å­—æœºæ•ˆæœ
     */
    function stopTypewriter() {
        if (typewriterState.isRunning) {
            typewriterState.skipRequested = true;
        }
        if (typewriterState.timeoutId) {
            clearTimeout(typewriterState.timeoutId);
            typewriterState.timeoutId = null;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function clearInput() {
        document.getElementById('bet-input').value = '';
        document.getElementById('result-section').classList.remove('show');
        stopTypewriter();  // ğŸ†• v3.11.64 æ¸…ç©ºæ—¶åœæ­¢æ‰“å­—æœº
        parsedBets = [];
        calcResults = [];
    }
    
    // ==================== è‡ªå®šä¹‰æ ¼å¼è®¾ç½® ====================
    
    // ğŸ†• v3.4 è‡ªå®šä¹‰è¯†åˆ«è§„åˆ™å­˜å‚¨
    let customRules = [];
    
    // åŠ è½½è‡ªå®šä¹‰è§„åˆ™
    function loadCustomRules() {
        const saved = localStorage.getItem('lhc_custom_rules');
        if (saved) {
            try {
                customRules = JSON.parse(saved);
            } catch(e) {
                customRules = [];
            }
        }
        renderCustomRules();
    }
    
    // ğŸ†• v3.6 å®Œæ•´ç±»å‹åç§°æ˜ å°„
    const RULE_TYPE_NAMES = {
        'T01': 'ç‰¹ç ', 'T01_EXPAND': 'ç‰¹ç (å±•å¼€)',
        'XS': 'å°æ•°', 'DS': 'å¤§æ•°', 'ODD': 'å•æ•°', 'EVEN': 'åŒæ•°',
        'HXS': 'åˆå°', 'HDS': 'åˆå¤§', 'HODD': 'åˆå•', 'HEVEN': 'åˆåŒ',
        'C1': 'çº¢æ³¢', 'C2': 'è“æ³¢', 'C3': 'ç»¿æ³¢',
        'PT1': 'å¹³ç‰¹ä¸€è‚–', 'TX': 'ç‰¹è‚–', 'ZX': 'æ­£è‚–', 'SX': 'ç”Ÿè‚–',
        'PT2': 'äºŒè¿è‚–', 'PT3': 'ä¸‰è¿è‚–', 'PTW': 'å¹³ç‰¹å°¾',
        'E2': 'äºŒä¸­äºŒ', 'S3': 'ä¸‰ä¸­ä¸‰',
        'BZ5': 'äº”ä¸ä¸­', 'BZ6': 'å…­ä¸ä¸­', 'BZ7': 'ä¸ƒä¸ä¸­', 
        'BZ8': 'å…«ä¸ä¸­', 'BZ9': 'ä¹ä¸ä¸­', 'BZ10': 'åä¸ä¸­',
        'DP': 'å•å¹³', 'TS': 'å¤´æ•°', 'WS': 'å°¾æ•°', 'WX': 'äº”è¡Œ',
        'JY': 'å®¶é‡', 'ZH': 'æ€»å’Œ', 'BB': 'åŠæ³¢', 'SX6': 'å…­è‚–', 'HX': 'åˆè‚–',
        'BS': 'æ³¢è‰²'
    };
    
    // ğŸ†• v3.6 é¢„è®¾å·ç æ•°æ®
    const PRESET_NUMBERS = {
        'small': [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
        'big': [25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49],
        'tail0': [10,20,30,40],
        'tail1': [1,11,21,31,41],
        'tail2': [2,12,22,32,42],
        'tail3': [3,13,23,33,43],
        'tail4': [4,14,24,34,44],
        'tail5': [5,15,25,35,45],
        'tail6': [6,16,26,36,46],
        'tail7': [7,17,27,37,47],
        'tail8': [8,18,28,38,48],
        'tail9': [9,19,29,39,49],
        'red': [1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46],
        'blue': [3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48],
        'green': [5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49],
        'Z1': [6,18,30,42],  // 2025è›‡å¹´
        'Z2': [5,17,29,41],
        'Z3': [4,16,28,40],
        'Z4': [3,15,27,39],
        'Z5': [2,14,26,38],
        'Z6': [1,13,25,37,49],
        'Z7': [12,24,36,48],
        'Z8': [11,23,35,47],
        'Z9': [10,22,34,46],
        'Z10': [9,21,33,45],
        'Z11': [8,20,32,44],
        'Z12': [7,19,31,43]
    };
    
    // æ¸²æŸ“è§„åˆ™åˆ—è¡¨
    function renderCustomRules() {
        const listEl = document.getElementById('custom-rules-list');
        if (!listEl) return;
        
        if (customRules.length === 0) {
            listEl.innerHTML = '<div style="text-align:center;color:#666;padding:20px;font-size:12px;">æš‚æ— è‡ªå®šä¹‰è§„åˆ™</div>';
            return;
        }
        
        listEl.innerHTML = customRules.map((rule, idx) => {
            const typeName = RULE_TYPE_NAMES[rule.type] || rule.type;
            const expandInfo = rule.expand && rule.numbers ? ` â†’ ${rule.numbers.length}ä¸ªå·` : '';
            const amountMode = rule.amountMode === 'total' ? ' [æ€»é¢åˆ†]' : '';
            return `
            <div style="display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;margin-bottom:6px;">
                <span style="flex:1;font-size:12px;color:#fff;">
                    <b style="color:#fbbf24;">${rule.keyword}</b> â†’ 
                    <span style="color:#a78bfa;">${typeName}</span>
                    <span style="color:#81c784;font-size:10px;">${expandInfo}${amountMode}</span>
                </span>
                <button onclick="editCustomRule(${idx})" style="padding:4px 8px;background:rgba(102,126,234,0.2);color:#667eea;border:none;border-radius:4px;font-size:10px;cursor:pointer;margin-right:4px;">ä¿®æ”¹</button>
                <button onclick="deleteCustomRule(${idx})" style="padding:4px 8px;background:rgba(244,67,54,0.2);color:#f44336;border:none;border-radius:4px;font-size:10px;cursor:pointer;">åˆ é™¤</button>
            </div>
        `}).join('');
    }
    
    // ğŸ†• v3.6.1 ç¼–è¾‘è§„åˆ™
    function editCustomRule(idx) {
        const rule = customRules[idx];
        if (!rule) return;
        
        if (rule.expand && rule.numbers) {
            // å±•å¼€ç±»å‹ï¼šå¼¹å‡ºè®¾ç½®çª—å£
            document.getElementById('expand-modal-keyword').textContent = rule.keyword;
            document.getElementById('expand-numbers-input').value = rule.numbers.join(',');
            updateNumbersCount();
            document.querySelector(`input[name="amount-mode"][value="${rule.amountMode || 'each'}"]`).checked = true;
            document.getElementById('expand-modal').style.display = 'block';
            // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
            window.editingRuleIndex = idx;
        } else {
            // éå±•å¼€ç±»å‹ï¼šå¡«å……åˆ°è¾“å…¥æ¡†
            document.getElementById('new-rule-keyword').value = rule.keyword;
            document.getElementById('new-rule-type').value = rule.type;
            // åˆ é™¤æ—§è§„åˆ™
            customRules.splice(idx, 1);
            localStorage.setItem('lhc_custom_rules', JSON.stringify(customRules));
            renderCustomRules();
            showAutoCloseToast('ğŸ“ è¯·ä¿®æ”¹åé‡æ–°æ·»åŠ ');
        }
    }
    
    // ğŸ†• v3.6 ç±»å‹é€‰æ‹©å˜åŒ–æ—¶
    function onRuleTypeChange() {
        const type = document.getElementById('new-rule-type')?.value;
        if (type === 'T01_EXPAND') {
            // å¼¹å‡ºå±•å¼€è®¾ç½®çª—å£
            const keyword = document.getElementById('new-rule-keyword')?.value?.trim();
            if (!keyword) {
                showAutoCloseToast('âš ï¸ è¯·å…ˆè¾“å…¥å…³é”®è¯');
                document.getElementById('new-rule-type').value = '';
                return;
            }
            showExpandModal(keyword);
        }
    }
    
    // ğŸ†• v3.6 æ˜¾ç¤ºå±•å¼€è®¾ç½®å¼¹çª—
    function showExpandModal(keyword) {
        document.getElementById('expand-modal-keyword').textContent = keyword;
        document.getElementById('expand-numbers-input').value = '';
        document.getElementById('expand-numbers-count').textContent = 'å·²é€‰ 0 ä¸ªå·ç ';
        document.querySelector('input[name="amount-mode"][value="each"]').checked = true;
        document.getElementById('expand-modal').style.display = 'block';
        
        // ğŸ†• v3.12.3 é‡ç½®å•åŒæ•°ç­›é€‰æŒ‰é’®çŠ¶æ€
        resetOddEvenFilters();
        
        // ç›‘å¬å·ç è¾“å…¥å˜åŒ–
        document.getElementById('expand-numbers-input').addEventListener('input', updateNumbersCount);
    }
    
    // ğŸ†• v3.6 å…³é—­å±•å¼€å¼¹çª—
    function closeExpandModal() {
        document.getElementById('expand-modal').style.display = 'none';
        document.getElementById('new-rule-type').value = '';
        window.editingRuleIndex = undefined; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
    }
    
    // ğŸ†• v3.7 æ˜¾ç¤ºè‡ªå®šä¹‰è§„åˆ™å¸®åŠ©å¼¹çª—
    function showCustomRuleHelp() {
        document.getElementById('custom-rule-help-modal').style.display = 'block';
    }
    
    // ğŸ†• v3.7 å…³é—­è‡ªå®šä¹‰è§„åˆ™å¸®åŠ©å¼¹çª—
    function closeCustomRuleHelp() {
        document.getElementById('custom-rule-help-modal').style.display = 'none';
    }
    
    // ğŸ†• v3.6 å¡«å……é¢„è®¾å·ç 
    function fillPreset(presetKey) {
        const numbers = PRESET_NUMBERS[presetKey];
        if (numbers) {
            document.getElementById('expand-numbers-input').value = numbers.join(',');
            updateNumbersCount();
            // é‡ç½®å•åŒæ•°ç­›é€‰æŒ‰é’®çŠ¶æ€
            resetOddEvenFilters();
        }
    }
    
    // ğŸ†• v3.12.3 å•åŒæ•°ç­›é€‰çŠ¶æ€
    let oddFilterActive = false;
    let evenFilterActive = false;
    let originalNumbers = []; // ä¿å­˜åŸå§‹å·ç ï¼Œç”¨äºç­›é€‰æ¢å¤
    
    // ğŸ†• v3.12.3 é‡ç½®å•åŒæ•°ç­›é€‰æŒ‰é’®çŠ¶æ€
    function resetOddEvenFilters() {
        oddFilterActive = false;
        evenFilterActive = false;
        originalNumbers = [];
        const oddBtn = document.getElementById('filter-odd-btn');
        const evenBtn = document.getElementById('filter-even-btn');
        if (oddBtn) {
            oddBtn.style.background = 'transparent';
            oddBtn.style.color = '#ff9800';
        }
        if (evenBtn) {
            evenBtn.style.background = 'transparent';
            evenBtn.style.color = '#ff9800';
        }
    }
    
    // ğŸ†• v3.12.3 åˆ‡æ¢å•åŒæ•°ç­›é€‰
    function toggleOddEvenFilter(type) {
        const input = document.getElementById('expand-numbers-input');
        const currentValue = input?.value || '';
        
        // è§£æå½“å‰å·²é€‰å·ç 
        let numbers = currentValue.split(/[,ï¼Œ\s]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n >= 1 && n <= 49);
        
        if (numbers.length === 0 && originalNumbers.length === 0) {
            showAutoCloseToast('âš ï¸ è¯·å…ˆé€‰æ‹©å·ç å†è¿›è¡Œç­›é€‰');
            return;
        }
        
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»ç­›é€‰ï¼Œä¿å­˜åŸå§‹å·ç 
        if (originalNumbers.length === 0) {
            originalNumbers = [...numbers];
        }
        
        const oddBtn = document.getElementById('filter-odd-btn');
        const evenBtn = document.getElementById('filter-even-btn');
        
        if (type === 'odd') {
            oddFilterActive = !oddFilterActive;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            if (oddFilterActive) {
                oddBtn.style.background = '#ff9800';
                oddBtn.style.color = '#fff';
            } else {
                oddBtn.style.background = 'transparent';
                oddBtn.style.color = '#ff9800';
            }
        } else if (type === 'even') {
            evenFilterActive = !evenFilterActive;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            if (evenFilterActive) {
                evenBtn.style.background = '#ff9800';
                evenBtn.style.color = '#fff';
            } else {
                evenBtn.style.background = 'transparent';
                evenBtn.style.color = '#ff9800';
            }
        }
        
        // åŸºäºåŸå§‹å·ç è¿›è¡Œç­›é€‰
        let filteredNumbers = originalNumbers;
        if (oddFilterActive && !evenFilterActive) {
            // åªé€‰å•æ•°
            filteredNumbers = originalNumbers.filter(n => n % 2 === 1);
        } else if (!oddFilterActive && evenFilterActive) {
            // åªé€‰åŒæ•°
            filteredNumbers = originalNumbers.filter(n => n % 2 === 0);
        }
        // å¦‚æœä¸¤ä¸ªéƒ½é€‰ä¸­æˆ–éƒ½ä¸é€‰ä¸­ï¼Œæ˜¾ç¤ºå…¨éƒ¨åŸå§‹å·ç 
        
        // æ›´æ–°è¾“å…¥æ¡†
        input.value = filteredNumbers.join(',');
        updateNumbersCount();
    }
    
    // ğŸ†• v3.6 æ›´æ–°å·ç è®¡æ•°
    function updateNumbersCount() {
        const input = document.getElementById('expand-numbers-input')?.value || '';
        const numbers = input.split(/[,ï¼Œ\s]+/).filter(n => {
            const num = parseInt(n);
            return !isNaN(num) && num >= 1 && num <= 49;
        });
        document.getElementById('expand-numbers-count').textContent = `å·²é€‰ ${numbers.length} ä¸ªå·ç `;
    }
    
    // ğŸ†• v3.6 ç¡®è®¤æ·»åŠ å±•å¼€è§„åˆ™
    function confirmExpandRule() {
        const keyword = document.getElementById('expand-modal-keyword').textContent;
        const numbersStr = document.getElementById('expand-numbers-input')?.value?.trim();
        const amountMode = document.querySelector('input[name="amount-mode"]:checked')?.value || 'each';
        
        if (!numbersStr) {
            showAutoCloseToast('âš ï¸ è¯·é€‰æ‹©æˆ–è¾“å…¥å·ç ');
            return;
        }
        
        const numbers = numbersStr.split(/[,ï¼Œ\s]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n >= 1 && n <= 49);
        if (numbers.length === 0) {
            showAutoCloseToast('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆå·ç (1-49)');
            return;
        }
        
        // ğŸ†• v3.11.49 å…³é”®è¯éªŒè¯ï¼šè­¦å‘Šå…³é”®è¯ä»¥æ•°å­—ç»“å°¾å¯èƒ½å¯¼è‡´é‡‘é¢è¯†åˆ«é—®é¢˜
        if (/\d$/.test(keyword)) {
            const confirmAdd = confirm(
                'âš ï¸ å…³é”®è¯ä»¥æ•°å­—ç»“å°¾ï¼Œå¯èƒ½å¯¼è‡´é‡‘é¢è¯†åˆ«é”™è¯¯ï¼\n\n' +
                'ä¾‹å¦‚ï¼šå…³é”®è¯"å°ç 1"é‡åˆ°è¾“å…¥"å°ç 100"æ—¶ï¼Œå¯èƒ½è¯¯å°†é‡‘é¢è¯†åˆ«ä¸º"00"=0\n\n' +
                'å»ºè®®ï¼šå…³é”®è¯ä¸è¦åŒ…å«æ•°å­—ï¼Œå¦‚ä½¿ç”¨"å°ç "è€Œé"å°ç 1"\n\n' +
                'æ˜¯å¦ç»§ç»­æ·»åŠ æ­¤è§„åˆ™ï¼Ÿ'
            );
            if (!confirmAdd) return;
        }
        
        // ğŸ†• v3.6.1 ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰è§„åˆ™
        const editingIdx = window.editingRuleIndex;
        if (typeof editingIdx === 'number' && editingIdx >= 0) {
            customRules[editingIdx] = {
                keyword,
                type: 'T01',
                expand: true,
                numbers: numbers,
                amountMode: amountMode
            };
            window.editingRuleIndex = undefined;
            localStorage.setItem('lhc_custom_rules', JSON.stringify(customRules));
            document.getElementById('new-rule-keyword').value = '';
            document.getElementById('new-rule-type').value = '';
            closeExpandModal();
            renderCustomRules();
            showAutoCloseToast(`âœ… è§„åˆ™å·²æ›´æ–° (${numbers.length}ä¸ªå·ç )`);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå†²çªæ£€æµ‹ï¼‰
        const existingIdx = customRules.findIndex(r => r.keyword === keyword);
        if (existingIdx >= 0) {
            showAutoCloseToast('âš ï¸ å…³é”®è¯å†²çªï¼è¯¥å…³é”®è¯å·²å­˜åœ¨');
            return;
        }
        
        const rule = {
            keyword,
            type: 'T01',  // å±•å¼€ç±»å‹å®é™…æ˜¯T01
            expand: true,
            numbers: numbers,
            amountMode: amountMode
        };
        
        customRules.push(rule);
        localStorage.setItem('lhc_custom_rules', JSON.stringify(customRules));
        
        // æ¸…ç©ºè¾“å…¥å¹¶å…³é—­å¼¹çª—
        document.getElementById('new-rule-keyword').value = '';
        document.getElementById('new-rule-type').value = '';
        closeExpandModal();
        
        renderCustomRules();
        showAutoCloseToast(`âœ… è§„åˆ™æ·»åŠ æˆåŠŸ (${numbers.length}ä¸ªå·ç )`);
    }
    
    // æ·»åŠ æ–°è§„åˆ™
    function addCustomRule() {
        const keyword = document.getElementById('new-rule-keyword')?.value?.trim();
        const type = document.getElementById('new-rule-type')?.value;
        
        if (!keyword) {
            showAutoCloseToast('âš ï¸ è¯·è¾“å…¥å…³é”®è¯');
            return;
        }
        if (!type) {
            showAutoCloseToast('âš ï¸ è¯·é€‰æ‹©ç±»å‹');
            return;
        }
        
        // å±•å¼€ç±»å‹ç”±å¼¹çª—å¤„ç†
        if (type === 'T01_EXPAND') {
            showExpandModal(keyword);
            return;
        }
        
        // ğŸ†• v3.11.49 å…³é”®è¯éªŒè¯ï¼šè­¦å‘Šå…³é”®è¯ä»¥æ•°å­—ç»“å°¾ï¼ˆéå±•å¼€ç±»å‹é€šå¸¸é—®é¢˜ä¸å¤§ï¼Œä½†ä»æç¤ºï¼‰
        if (/\d$/.test(keyword)) {
            console.warn(`âš ï¸ å…³é”®è¯"${keyword}"ä»¥æ•°å­—ç»“å°¾ï¼Œå¯èƒ½å½±å“è¯†åˆ«å‡†ç¡®æ€§`);
        }
        
        // ğŸ†• v3.6.1 å†²çªæ£€æµ‹
        if (customRules.some(r => r.keyword === keyword)) {
            showAutoCloseToast('âš ï¸ å…³é”®è¯å†²çªï¼è¯¥å…³é”®è¯å·²å­˜åœ¨ï¼Œè¯·å…ˆåˆ é™¤æˆ–ä¿®æ”¹');
            return;
        }
        
        const rule = { keyword, type, expand: false };
        
        customRules.push(rule);
        localStorage.setItem('lhc_custom_rules', JSON.stringify(customRules));
        
        // æ¸…ç©ºè¾“å…¥
        document.getElementById('new-rule-keyword').value = '';
        document.getElementById('new-rule-type').value = '';
        
        renderCustomRules();
        showAutoCloseToast('âœ… è§„åˆ™æ·»åŠ æˆåŠŸ');
    }
    
    // åˆ é™¤è§„åˆ™
    function deleteCustomRule(idx) {
        customRules.splice(idx, 1);
        localStorage.setItem('lhc_custom_rules', JSON.stringify(customRules));
        renderCustomRules();
        showAutoCloseToast('âœ… è§„åˆ™å·²åˆ é™¤');
    }
    
    // å¯¼å‡ºæ‰€æœ‰é…ç½®
    function exportAllSettings() {
        const config = {
            version: '3.4',
            exportTime: new Date().toISOString(),
            customRules: customRules,
            odds: JSON.parse(localStorage.getItem('lhc_odds') || '{}'),
            formatSettings: JSON.parse(localStorage.getItem('lhc_format_settings') || '{}')
        };
        
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lhc_config_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showAutoCloseToast('âœ… é…ç½®å·²å¯¼å‡º');
    }
    
    // å¯¼å…¥é…ç½®
    function importAllSettings(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                
                if (config.customRules) {
                    customRules = config.customRules;
                    localStorage.setItem('lhc_custom_rules', JSON.stringify(customRules));
                }
                if (config.odds) {
                    localStorage.setItem('lhc_odds', JSON.stringify(config.odds));
                }
                if (config.formatSettings) {
                    localStorage.setItem('lhc_format_settings', JSON.stringify(config.formatSettings));
                }
                
                renderCustomRules();
                showAutoCloseToast('âœ… é…ç½®å¯¼å…¥æˆåŠŸï¼Œåˆ·æ–°é¡µé¢ç”Ÿæ•ˆ');
                setTimeout(() => location.reload(), 1500);
            } catch(err) {
                showAutoCloseToast('âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // æ¸…ç©ºï¼Œå…è®¸é‡å¤å¯¼å…¥
    }
    
    // è·å–è‡ªå®šä¹‰è§„åˆ™ï¼ˆä¾›è¯†åˆ«æ—¶ä½¿ç”¨ï¼‰
    function getCustomRules() {
        return customRules;
    }
    
    function saveFormatSettings() {
        // ğŸ†• v3.6 ä¿å­˜å‰è‡ªåŠ¨æ·»åŠ å¡«å†™ä¸­çš„è§„åˆ™
        const pendingKeyword = document.getElementById('new-rule-keyword')?.value?.trim();
        const pendingType = document.getElementById('new-rule-type')?.value;
        if (pendingKeyword && pendingType && pendingType !== 'T01_EXPAND') {
            // ğŸ†• v3.6.1 å†²çªæ£€æµ‹
            if (customRules.some(r => r.keyword === pendingKeyword)) {
                showAutoCloseToast('âš ï¸ å…³é”®è¯å†²çªï¼è¯¥å…³é”®è¯å·²å­˜åœ¨');
                return;
            }
            customRules.push({ keyword: pendingKeyword, type: pendingType, expand: false });
            localStorage.setItem('lhc_custom_rules', JSON.stringify(customRules));
            document.getElementById('new-rule-keyword').value = '';
            document.getElementById('new-rule-type').value = '';
            renderCustomRules();
        }
        
        const settings = {
            // AIè®¾ç½®ï¼ˆé»˜è®¤å¯ç”¨ï¼ŒAPI Keyåœ¨åç«¯ç¯å¢ƒå˜é‡ï¼‰
            aiEnabled: document.getElementById('ai-parse-enabled')?.checked !== false,
            aiProvider: localStorage.getItem('ai_provider') || 'tuzi'  // ğŸ†• v3.11.69 å…”å­API
        };
        localStorage.setItem('lhc_format_settings', JSON.stringify(settings));
        showAutoCloseToast('âœ… è®¾ç½®å·²ä¿å­˜ï¼');
        
        // ğŸ†• v3.6.1 ä¿å­˜åè¿”å›é¦–é¡µ
        setTimeout(() => {
            showPage('page-main');
        }, 800);
    }
    
    function loadFormatSettings() {
        const saved = localStorage.getItem('lhc_format_settings');
        if (saved) {
            try {
                const s = JSON.parse(saved);
                
                // AIè®¾ç½®ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
                const aiCheckbox = document.getElementById('ai-parse-enabled');
                if (aiCheckbox) {
                    aiCheckbox.checked = s.aiEnabled !== false;
                }
            } catch(e) {
                console.error('åŠ è½½æ ¼å¼è®¾ç½®å¤±è´¥:', e);
                loadDefaultAIConfig();
            }
        } else {
            loadDefaultAIConfig();
        }
        
        // ğŸ†• v3.4 åŠ è½½è‡ªå®šä¹‰è§„åˆ™
        loadCustomRules();
    }
    
    // åŠ è½½é»˜è®¤AIé…ç½®ï¼ˆé»˜è®¤å¯ç”¨AIè§£æï¼‰
    function loadDefaultAIConfig() {
        const aiCheckbox = document.getElementById('ai-parse-enabled');
        if (aiCheckbox) {
            aiCheckbox.checked = true; // é»˜è®¤å¯ç”¨
        }
    }
    
    function resetFormatSettings() {
        if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
            localStorage.removeItem('lhc_format_settings');
            location.reload();
        }
    }
    
    // ==================== AIæ™ºèƒ½è§£ææ¨¡å— ====================
    
    // AIæœåŠ¡å•†é…ç½®
    // region: 'cn' = å›½å†…æ¨¡å‹ï¼ˆèµ°é˜¿é‡Œäº‘ä»£ç†ï¼‰ï¼Œ'overseas' = æµ·å¤–æ¨¡å‹ï¼ˆèµ°Cloudflareä»£ç†ï¼‰ï¼Œ'direct' = ç›´è¿ï¼ˆç¬¬ä¸‰æ–¹ä¸­è½¬APIï¼‰
    const AI_PROVIDERS = {
        // âš ï¸ API Key å·²ç§»è‡³é˜¿é‡Œäº‘å‡½æ•°ç¯å¢ƒå˜é‡ï¼Œä¸å†åœ¨å‰ç«¯å­˜å‚¨
        // ğŸ° å…”å­API - é»˜è®¤æ¨èï¼ŒGemini ä¸­è½¬æœåŠ¡
        tuzi: {
            name: 'Geminiï¼ˆå…”å­APIï¼‰',
            shortName: 'Gemini',
            url: 'https://api.tu-zi.com/v1/chat/completions',
            model: 'gemini-2.0-flash',  // å…”å­API - Gemini 2.0 Flash
            region: 'foreign'  // å›½å¤–æœåŠ¡ï¼Œèµ°é¦™æ¸¯æœåŠ¡å™¨
        },
        deepseek: {
            name: 'DeepSeek',
            shortName: 'DS',
            url: 'https://api.deepseek.com/v1/chat/completions',
            model: 'deepseek-chat',  // DeepSeek å®˜æ–¹å¯¹è¯æ¨¡å‹ï¼ˆç¨³å®šï¼‰
            region: 'cn'
        },
        tuzi: {
            name: 'Gemini-Flash',
            shortName: 'Gemini',
            url: 'https://api.tu-zi.com/v1/chat/completions',  // ä¼šè¢«å¤šç«™ç‚¹åˆ‡æ¢è¦†ç›–
            model: 'gemini-2.0-flash',  // å…”å­API - Gemini 2.0 Flashï¼ˆå¿«é€Ÿç‰ˆï¼‰
            region: 'cn',  // èµ°é˜¿é‡Œäº‘ä»£ç†ï¼Œæ‰‹æœºæ— éœ€VPN
            useTuziMultiSite: true  // æ ‡è®°ä½¿ç”¨å…”å­APIå¤šç«™ç‚¹
        },
        qwen: {
            name: 'é€šä¹‰åƒé—®',
            shortName: 'åƒé—®',
            url: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
            model: 'qwen-turbo',
            region: 'cn'
        },
        // æ™ºè°±GLM - æ”¯æŒFunction Calling
        zhipu: {
            name: 'æ™ºè°±GLM-4',
            shortName: 'æ™ºè°±',
            url: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
            model: 'glm-4-plus',  // æ™ºè°±GLM-4 Plusï¼ˆæ›´å¼ºæ¨¡å‹ï¼‰
            region: 'cn'
        },
        // è±†åŒ… - å­—èŠ‚è·³åŠ¨ï¼Œæ”¯æŒFunction Calling
        doubao: {
            name: 'è±†åŒ…',
            shortName: 'è±†åŒ…',
            url: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
            model: 'doubao-lite-32k',  // è±†åŒ…è½»é‡ç‰ˆï¼ˆæ€§ä»·æ¯”é«˜ï¼‰
            region: 'cn'
        },
        claude: {
            name: 'Claude-Sonnet',
            shortName: 'Claude',
            url: 'https://api.tu-zi.com/v1/chat/completions',  // ä¼šè¢«å¤šç«™ç‚¹åˆ‡æ¢è¦†ç›–
            model: 'claude-sonnet-4-0',  // å…”å­API - Claude Sonnet 4.0
            region: 'cn',  // èµ°é˜¿é‡Œäº‘ä»£ç†
            useTuziMultiSite: true  // æ ‡è®°ä½¿ç”¨å…”å­APIå¤šç«™ç‚¹
        },
        gpt: {
            name: 'GPT-4o-Mini',
            shortName: 'GPT4o',
            url: 'https://api.tu-zi.com/v1/chat/completions',  // ä¼šè¢«å¤šç«™ç‚¹åˆ‡æ¢è¦†ç›–
            model: 'gpt-4o-mini',  // å…”å­API - GPT-4o Miniï¼ˆæ€§ä»·æ¯”æœ€é«˜ï¼‰
            region: 'cn',  // èµ°é˜¿é‡Œäº‘ä»£ç†
            useTuziMultiSite: true  // æ ‡è®°ä½¿ç”¨å…”å­APIå¤šç«™ç‚¹
        }
    };
    
    // ==================== å…”å­API å¤šç«™ç‚¹æ™ºèƒ½åˆ‡æ¢ ====================
    // ç«™ç‚¹åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼šå¹¿å· > æ·±åœ³ > ä¸»ç«™ > å¤‡ç”¨ï¼‰
    const TUZI_SITES = [
        { name: 'å¹¿å·', url: 'https://api.ourzhishi.top/v1/chat/completions' },
        { name: 'æ·±åœ³', url: 'https://apisz.ourzhishi.top/v1/chat/completions' },
        { name: 'ä¸»ç«™', url: 'https://api.tu-zi.com/v1/chat/completions' },
        { name: 'å¤‡ç”¨1-cdn', url: 'https://apius.tu-zi.com/v1/chat/completions' },
        { name: 'å¤‡ç”¨2-cdn', url: 'https://apicdn.tu-zi.com/v1/chat/completions' }
    ];
    
    // å¤šç«™ç‚¹çŠ¶æ€ç®¡ç†
    const tuziSiteManager = {
        currentIndex: 0,           // å½“å‰ä½¿ç”¨çš„ç«™ç‚¹ç´¢å¼•
        successCount: 0,           // è¿ç»­æˆåŠŸæ¬¡æ•°
        å›å½’æ£€æŸ¥é˜ˆå€¼: 10,          // æ¯æˆåŠŸNæ¬¡å°è¯•å›åˆ°æ›´é«˜ä¼˜å…ˆçº§ç«™ç‚¹
        
        // è·å–å½“å‰ç«™ç‚¹URL
        getCurrentUrl() {
            return TUZI_SITES[this.currentIndex].url;
        },
        
        // è·å–å½“å‰ç«™ç‚¹åç§°
        getCurrentName() {
            return TUZI_SITES[this.currentIndex].name;
        },
        
        // è¯·æ±‚æˆåŠŸæ—¶è°ƒç”¨
        onSuccess() {
            this.successCount++;
            console.log(`âœ… å…”å­API [${this.getCurrentName()}] è¯·æ±‚æˆåŠŸï¼Œè¿ç»­æˆåŠŸ: ${this.successCount}æ¬¡`);
            
            // å¦‚æœä¸æ˜¯æœ€é«˜ä¼˜å…ˆçº§ç«™ç‚¹ï¼Œä¸”è¿ç»­æˆåŠŸè¾¾åˆ°é˜ˆå€¼ï¼Œå°è¯•å›åˆ°æ›´é«˜ä¼˜å…ˆçº§
            if (this.currentIndex > 0 && this.successCount >= this.å›å½’æ£€æŸ¥é˜ˆå€¼) {
                console.log(`ğŸ”„ å°è¯•å›å½’åˆ°æ›´é«˜ä¼˜å…ˆçº§ç«™ç‚¹...`);
                this.currentIndex = 0;  // å›åˆ°æœ€é«˜ä¼˜å…ˆçº§ï¼ˆå¹¿å·ï¼‰
                this.successCount = 0;
            }
        },
        
        // è¯·æ±‚å¤±è´¥æ—¶è°ƒç”¨ï¼Œè¿”å›æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªç«™ç‚¹å¯å°è¯•
        onFailure() {
            const failedSite = this.getCurrentName();
            this.successCount = 0;  // é‡ç½®æˆåŠŸè®¡æ•°
            
            if (this.currentIndex < TUZI_SITES.length - 1) {
                this.currentIndex++;
                console.log(`âš ï¸ å…”å­API [${failedSite}] å¤±è´¥ï¼Œåˆ‡æ¢åˆ° [${this.getCurrentName()}]`);
                return true;  // è¿˜æœ‰ä¸‹ä¸€ä¸ªç«™ç‚¹
            } else {
                console.log(`âŒ å…”å­API æ‰€æœ‰ç«™ç‚¹éƒ½å¤±è´¥äº†`);
                this.currentIndex = 0;  // é‡ç½®ï¼Œä¸‹æ¬¡ä»å¤´å¼€å§‹
                return false;  // æ²¡æœ‰æ›´å¤šç«™ç‚¹äº†
            }
        },
        
        // é‡ç½®çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        reset() {
            this.currentIndex = 0;
            this.successCount = 0;
            console.log('ğŸ”„ å…”å­APIç«™ç‚¹ç®¡ç†å™¨å·²é‡ç½®');
        }
    };
    
    // åˆ‡æ¢AIæ¨¡å‹ï¼ˆæŒ‰é’®ç‚¹å‡»ï¼‰
    function switchAIModel(provider) {
        const config = AI_PROVIDERS[provider];
        if (!config) return;
        
        // æ›´æ–°éšè—çš„ selectï¼ˆAPI Key åœ¨åç«¯ï¼Œä¸éœ€è¦è®¾ç½®ï¼‰
        document.getElementById('ai-provider').value = provider;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.ai-model-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.provider === provider) {
                btn.classList.add('active');
            }
        });
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆAPI Key å·²åœ¨åç«¯é…ç½®ï¼‰
        const statusEl = document.getElementById('ai-model-status');
        if (statusEl) {
            let regionText, bgColor, textColor;
            if (config.region === 'overseas') {
                regionText = 'æµ·å¤–Cloudflareä»£ç†';
                bgColor = 'rgba(255,152,0,0.1)';
                textColor = '#ffa726';
            } else if (config.region === 'direct') {
                regionText = 'ç¬¬ä¸‰æ–¹ä¸­è½¬ç›´è¿';
                bgColor = 'rgba(33,150,243,0.1)';
                textColor = '#64b5f6';
            } else if (config.region === 'foreign') {
                regionText = 'å…”å­API Â· é¦™æ¸¯æœåŠ¡å™¨';
                bgColor = 'rgba(139,92,246,0.1)';
                textColor = '#a78bfa';
            } else {
                regionText = 'é¦™æ¸¯æœåŠ¡å™¨';
                bgColor = 'rgba(76,175,80,0.1)';
                textColor = '#81c784';
            }
            statusEl.innerHTML = 'âœ… å½“å‰ï¼š' + config.name + 'ï¼ˆ' + regionText + 'ï¼‰';
            statusEl.style.background = bgColor;
            statusEl.style.color = textColor;
        }
        
        // ä¿å­˜é€‰æ‹©
        localStorage.setItem('ai_provider', provider);
        console.log('ğŸ¤– AIæ¨¡å‹åˆ‡æ¢ä¸º:', provider, config.name);
    }
    
    // ==================== AI é¢„å¤„ç†å‡½æ•° ====================
    // æ ‡å‡†åŒ–ç”¨æˆ·è¾“å…¥ï¼Œè®© AI æ›´å®¹æ˜“ç†è§£ï¼ˆç¡®å®šæ€§è§„åˆ™ï¼Œä¸ä¾èµ– AIï¼‰
    function normalizeForAI(text) {
        if (!text) return text;
        
        let result = text;
        
        // 1. åˆ†éš”ç¬¦ç»Ÿä¸€ä¸ºç©ºæ ¼ï¼ˆç‚¹ã€é€—å·ã€é¡¿å·ã€æ–œæ ã€çŸ­æ¨ªçº¿ï¼‰
        result = result.replace(/[\.ã€‚,ï¼Œã€\/\-]/g, ' ');
        
        // 2. é‡‘é¢ç¬¦å·ç»Ÿä¸€ä¸º"å„"
        // ç»Ÿä¸€ â†’ å„ï¼Œç»Ÿ â†’ å„ï¼ŒÃ— â†’ å„ï¼ŒX â†’ å„ï¼Œx â†’ å„ï¼Œ* â†’ å„ï¼Œ@ â†’ å„
        result = result.replace(/ç»Ÿä¸€/g, 'å„');
        result = result.replace(/ç»Ÿ(?!\d)/g, 'å„');  // "ç»Ÿ"åé¢ä¸æ˜¯æ•°å­—æ—¶æ‰æ›¿æ¢
        result = result.replace(/[Ã—\*@]/g, 'å„');
        // x/X åœ¨æ•°å­—åé¢æ—¶æ›¿æ¢ä¸º"å„"ï¼ˆå¦‚ 10x20 â†’ 10å„20ï¼‰
        result = result.replace(/(\d)\s*[xX]\s*(\d)/g, '$1å„$2');
        
        // 3. å»æ‰é‡‘é¢å•ä½
        result = result.replace(/å…ƒ|å—|åœ†/g, '');
        
        // 4. æ¸…ç†å¤šä½™ç©ºæ ¼
        result = result.replace(/\s+/g, ' ').trim();
        
        console.log('ğŸ”„ AIé¢„å¤„ç†:', text, 'â†’', result);
        return result;
    }
    
    // ==================== ã€å½©ç§è¯†åˆ«ç³»ç»Ÿ v3.11.24ã€‘ ====================
    // ğŸ¯ è¯†åˆ«ç”¨æˆ·è¾“å…¥ä¸­çš„å½©ç§æ ‡è¯†ï¼ˆé¦™æ¸¯/æ–°æ¾³/æ—§æ¾³ï¼‰
    // ğŸ“ è§„åˆ™ï¼š
    //   - é¦™æ¸¯/é¦™/æ¸¯ â†’ é¦™æ¸¯
    //   - æ–°å¥¥/æ¾³/å¥¥/æ–°æ¾³/æ¾³é—¨ â†’ æ–°æ¾³é—¨
    //   - æ— æ ‡è¯† â†’ é»˜è®¤æ–°æ¾³é—¨
    //   - æ—§æ¾³/æ—§æ¾³é—¨/æ—§å¥¥ â†’ ä¸æ”¯æŒï¼Œå¼¹çª—æé†’
    
    /**
     * ğŸ†• v3.11.26 æ£€æµ‹è¾“å…¥æ–‡æœ¬ä¸­çš„å½©ç§ç±»å‹
     * âš ï¸ æ³¨æ„ï¼šä¸ä½¿ç”¨åè¡Œæ–­è¨€(?<=)ï¼Œå…¼å®¹ iOS Safari
     * @param {string} line å•è¡Œæ–‡æœ¬
     * @returns {object} { type: 'hk'|'xam'|'old_am'|'default', keyword: åŒ¹é…åˆ°çš„å…³é”®å­— }
     */
    function detectLotteryType(line) {
        if (!line) return { type: 'default', keyword: null };
        
        // ğŸš« ä¼˜å…ˆæ£€æµ‹ä¸æ”¯æŒçš„"æ—§æ¾³"ç±»å‹ï¼ˆå¿…é¡»æœ€å…ˆæ£€æµ‹ï¼‰
        if (line.indexOf('æ—§æ¾³é—¨') !== -1) return { type: 'old_am', keyword: 'æ—§æ¾³é—¨' };
        if (line.indexOf('æ—§æ¾³') !== -1) return { type: 'old_am', keyword: 'æ—§æ¾³' };
        if (line.indexOf('æ—§å¥¥') !== -1) return { type: 'old_am', keyword: 'æ—§å¥¥' };
        
        // ğŸ‡­ğŸ‡° æ£€æµ‹é¦™æ¸¯ï¼ˆç®€åŒ–é€»è¾‘ï¼Œé¿å…å¤æ‚æ­£åˆ™ï¼‰
        // æ’é™¤åŒ…å«"æ–°æ¾³|æ¾³é—¨"çš„æƒ…å†µ
        if (line.indexOf('æ–°æ¾³') === -1 && line.indexOf('æ¾³é—¨') === -1) {
            if (line.indexOf('é¦™æ¸¯') !== -1) return { type: 'hk', keyword: 'é¦™æ¸¯' };
            if (line.indexOf('é¦™') === 0) return { type: 'hk', keyword: 'é¦™' };  // è¡Œé¦–çš„"é¦™"
            if (line.indexOf('æ¸¯') === 0) return { type: 'hk', keyword: 'æ¸¯' };  // è¡Œé¦–çš„"æ¸¯"
            // è¡Œå°¾çš„"æ¸¯"ï¼ˆä½†å‰é¢ä¸æ˜¯"é¦™"å’Œ"æ¾³"ï¼‰
            if (line.length > 0 && line.charAt(line.length - 1) === 'æ¸¯') {
                var prevChar = line.length > 1 ? line.charAt(line.length - 2) : '';
                if (prevChar !== 'é¦™' && prevChar !== 'æ¾³') {
                    return { type: 'hk', keyword: 'æ¸¯' };
                }
            }
        }
        
        // ğŸ‡²ğŸ‡´ æ£€æµ‹æ–°æ¾³é—¨
        if (line.indexOf('æ–°æ¾³é—¨') !== -1) return { type: 'xam', keyword: 'æ–°æ¾³é—¨' };
        if (line.indexOf('æ–°æ¾³') !== -1) return { type: 'xam', keyword: 'æ–°æ¾³' };
        if (line.indexOf('æ–°å¥¥') !== -1) return { type: 'xam', keyword: 'æ–°å¥¥' };
        if (line.indexOf('æ¾³é—¨') !== -1) return { type: 'xam', keyword: 'æ¾³é—¨' };
        if (line.indexOf('æ¾³') === 0) return { type: 'xam', keyword: 'æ¾³' };  // è¡Œé¦–çš„"æ¾³"
        if (line.indexOf('å¥¥') === 0) return { type: 'xam', keyword: 'å¥¥' };  // è¡Œé¦–çš„"å¥¥"
        // è¡Œå°¾çš„"æ¾³"æˆ–"å¥¥"
        if (line.length > 0) {
            var lastChar = line.charAt(line.length - 1);
            if (lastChar === 'æ¾³') return { type: 'xam', keyword: 'æ¾³' };
            if (lastChar === 'å¥¥') return { type: 'xam', keyword: 'å¥¥' };
        }
        
        // é»˜è®¤ï¼šæ–°æ¾³é—¨
        return { type: 'default', keyword: null };
    }
    
    /**
     * åˆ†ææ•´ä¸ªè¾“å…¥æ–‡æœ¬ï¼Œè¿”å›åŒ…å«çš„å½©ç§
     * @param {string} input å®Œæ•´è¾“å…¥æ–‡æœ¬
     * @returns {object} { hasHK: bool, hasXAM: bool, hasOldAM: bool, oldAmKeyword: string }
     */
    function analyzeLotteryTypes(input) {
        const lines = input.split('\n');
        let hasHK = false;
        let hasXAM = false;
        let hasOldAM = false;
        let oldAmKeyword = null;
        
        for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed) continue;
            
            const result = detectLotteryType(trimmed);
            if (result.type === 'hk') hasHK = true;
            if (result.type === 'xam') hasXAM = true;
            if (result.type === 'old_am') {
                hasOldAM = true;
                oldAmKeyword = result.keyword;
            }
            // default ç±»å‹è®¡å…¥æ–°æ¾³é—¨
            if (result.type === 'default') hasXAM = true;
        }
        
        return { hasHK, hasXAM, hasOldAM, oldAmKeyword };
    }
    
    // ==================== ã€è¾“å…¥æ ‡å‡†åŒ–ç³»ç»Ÿ v3.11.6ã€‘ ====================
    // ğŸ¯ ç›®çš„1ï¼šå°†åŒä¹‰è¯/å˜ä½“ç»Ÿä¸€ä¸ºæ ‡å‡†æ ¼å¼ï¼ˆæé«˜AIè¯†åˆ«ç‡ï¼‰
    // ğŸ¯ ç›®çš„2ï¼šå°†ä¸­æ–‡ç”Ÿè‚–è½¬æ¢ä¸º Z ä»£å·ï¼ˆåç«¯FlashLexå¼•æ“ä¾èµ–æ­¤æ ¼å¼ï¼‰
    // ğŸ“ å¤„ç†é¡ºåºï¼šåŒä¹‰è¯æ ‡å‡†åŒ– â†’ ç”Ÿè‚–ä»£å·è½¬æ¢
    
    // ========== åŒä¹‰è¯æ˜ å°„è¡¨ï¼ˆç”¨æˆ·å˜ä½“ â†’ æ ‡å‡†æ ¼å¼ï¼‰==========
    // ğŸ†• v3.11.6 æ–°å¢ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥çš„å„ç§å˜ä½“å†™æ³•
    const SYNONYM_MAP = {
        // ===== å…­è‚–å˜ä½“ =====
        '6è‚–': 'å…­è‚–',
        'é™†è‚–': 'å…­è‚–',
        'å…­ä¸ªç”Ÿè‚–': 'å…­è‚–',
        '6ä¸ªç”Ÿè‚–': 'å…­è‚–',
        
        // ===== å¹³ç‰¹å˜ä½“ =====
        'å¹³ç ': 'å¹³ç‰¹',
        'PT1': 'å¹³ç‰¹',
        'pt1': 'å¹³ç‰¹',
        'PT': 'å¹³ç‰¹',
        'pt': 'å¹³ç‰¹',
        
        // ===== ä¸€å‹å˜ä½“ï¼ˆå¹³ç‰¹ä¸€è‚–ï¼‰=====
        // ğŸ†• v3.12.7 æ·»åŠ åŒéŸ³é”™åˆ«å­—æ”¯æŒ
        '1å‹': 'ä¸€å‹',  // ä¸€å‹=å¹³ç‰¹ä¸€è‚–ï¼ˆé€‰1ä¸ªç”Ÿè‚–ï¼‰
        'ä¸€æœ‰': 'ä¸€å‹', // åŒéŸ³é”™åˆ«å­—
        '1æœ‰': 'ä¸€å‹',
        
        // ===== äºŒå‹/äºŒè¿è‚–å˜ä½“ï¼ˆå¹³ç‰¹äºŒè¿è‚–ï¼‰=====
        '2å‹': 'äºŒå‹',  // äºŒå‹=å¹³ç‰¹äºŒè¿è‚–ï¼ˆé€‰2ä¸ªç”Ÿè‚–ï¼‰
        'ä¸¤å‹': 'äºŒå‹',
        'åŒå‹': 'äºŒå‹',
        'äºŒè¿è‚–': 'äºŒå‹',
        '2è¿è‚–': 'äºŒå‹',
        'äºŒæœ‰': 'äºŒå‹', // åŒéŸ³é”™åˆ«å­—
        '2æœ‰': 'äºŒå‹',
        'ä¸¤æœ‰': 'äºŒå‹',
        
        // ===== ä¸‰å‹/ä¸‰è¿è‚–å˜ä½“ =====
        '3å‹': 'ä¸‰å‹',
        'ä¸‰è¿è‚–': 'ä¸‰å‹',
        '3è¿è‚–': 'ä¸‰å‹',
        'ä¸‰æœ‰': 'ä¸‰å‹', // åŒéŸ³é”™åˆ«å­—
        '3æœ‰': 'ä¸‰å‹',
        
        // ===== å››å‹/äº”å‹å˜ä½“ =====
        '4å‹': 'å››å‹',
        'å››è¿è‚–': 'å››å‹',
        'å››æœ‰': 'å››å‹', // åŒéŸ³é”™åˆ«å­—
        '4æœ‰': 'å››å‹',
        '5å‹': 'äº”å‹',
        'äº”è¿è‚–': 'äº”å‹',
        'äº”æœ‰': 'äº”å‹', // åŒéŸ³é”™åˆ«å­—
        '5æœ‰': 'äº”å‹',
        
        // ===== æ³¢è‰²å˜ä½“ =====
        'çº¢æ³¢': 'çº¢',
        'è“æ³¢': 'è“',
        'ç»¿æ³¢': 'ç»¿',
        // ğŸ†• v3.12.3 æ³¢è‰²åŒéŸ³è¯ä¸åœ¨å‰ç«¯è½¬æ¢ï¼Œä¿ç•™ç”¨æˆ·åŸå§‹è¾“å…¥
        // åç«¯ preprocess_service.py å·²èƒ½å¤„ç† å…°æ³¢/ç¯®æ³¢ ç­‰å˜ä½“
        
        // ===== é‡‘é¢å•ä½ç»Ÿä¸€ =====
        'å—': 'å…ƒ',
        'åœ†': 'å…ƒ',
        'å—é’±': 'å…ƒ',
        
        // ===== ä¹˜å·ç»Ÿä¸€ =====
        // ğŸ†• v3.11.67 æ–°å¢å¤šç§ä¹˜å·å˜ä½“ï¼Œè®©æ›´å¤šè¾“å…¥èµ°FlashLexå‡å°‘AIè°ƒç”¨
        'Ã—': 'x',
        'X': 'x',
        'âœ–ï¸': 'x',   // emojiä¹˜å·ï¼ˆç”¨æˆ·å¸¸ç”¨ï¼‰
        'âœ–': 'x',    // emojiä¹˜å·æ— å˜ä½“
        'âœ•': 'x',    // ä¹˜å·
        'âœ—': 'x',    // å‰å·
        'âœ˜': 'x',    // ç²—å‰å·
        'â…©': 'x',    // ç½—é©¬æ•°å­—10ï¼ˆç”¨æˆ·è¯¯è¾“å…¥ï¼‰
        'â…¹': 'x',    // å°å†™ç½—é©¬æ•°å­—
        'ï¼Š': '*',
        'â': '*',    // æ˜Ÿå·å˜ä½“
        
        // ===== ç‰¹æ®Šå­—ç¬¦å…¨è§’è½¬åŠè§’ =====
        'ï¼Œ': ',',
        'ã€‚': '.',
        'ï¼›': ';',
        'ï¼š': ':',
        'ã€€': ' ',   // å…¨è§’ç©ºæ ¼
    };
    
    // åŒä¹‰è¯æ˜ å°„é”®ï¼ˆæŒ‰é•¿åº¦é™åºæ’åˆ—ï¼Œé¿å…çŸ­è¯å…ˆåŒ¹é…ï¼‰
    const SYNONYM_KEYS_SORTED = Object.keys(SYNONYM_MAP).sort((a, b) => b.length - a.length);
    
    // ========== ç”Ÿè‚–ä»£å·æ˜ å°„è¡¨ï¼ˆä¸­æ–‡ç”Ÿè‚– â†’ Zä»£å·ï¼‰==========
    // ğŸ†• v3.12.7 æ·»åŠ åŒéŸ³å­—æ”¯æŒï¼š"å…"="å…”"(Z4)
    const ZODIAC_TO_CODE = {
        'é¼ ': 'Z1', 'ç‰›': 'Z2', 'è™': 'Z3', 'å…”': 'Z4', 'å…': 'Z4',
        'é¾™': 'Z5', 'è›‡': 'Z6', 'é©¬': 'Z7', 'ç¾Š': 'Z8',
        'çŒ´': 'Z9', 'é¸¡': 'Z10', 'ç‹—': 'Z11', 'çŒª': 'Z12'
    };
    
    // ğŸ”„ å…¼å®¹æ—§ä»£ç ï¼ˆä¿ç•™ SANITIZE_MAP å˜é‡åï¼Œé¿å…ç ´åå…¶ä»–å¼•ç”¨ï¼‰
    const SANITIZE_MAP = ZODIAC_TO_CODE;
    
    // è¿˜åŸæ˜ å°„è¡¨ï¼ˆZä»£å· â†’ ä¸­æ–‡ç”Ÿè‚–ï¼‰
    const CODE_TO_ZODIAC = {};
    for (const [zodiac, code] of Object.entries(ZODIAC_TO_CODE)) {
        CODE_TO_ZODIAC[code] = zodiac;
    }
    
    // å…¼å®¹æ—§ä»£ç 
    const RESTORE_MAP = CODE_TO_ZODIAC;
    
    // è·å–æŒ‰é•¿åº¦é™åºæ’åˆ—çš„é”®ï¼ˆé¿å… Z1 å…ˆäº Z10 åŒ¹é…ï¼‰
    const ZODIAC_KEYS_SORTED = Object.keys(ZODIAC_TO_CODE).sort((a, b) => b.length - a.length);
    const CODE_KEYS_SORTED = Object.keys(CODE_TO_ZODIAC).sort((a, b) => b.length - a.length);
    
    // å…¼å®¹æ—§ä»£ç 
    const SANITIZE_KEYS_SORTED = ZODIAC_KEYS_SORTED;
    const RESTORE_KEYS_SORTED = CODE_KEYS_SORTED;
    
    /**
     * è½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦
     */
    function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    /**
     * ğŸ†• v3.11.12 è®¡ç®—æ–‡æœ¬ä¸­çš„ç”Ÿè‚–æ•°é‡
     * ç”¨äº "å¹³ç‰¹çŒ´é¸¡å„200" è¿™ç±»è¾“å…¥ï¼Œæ­£ç¡®è¯†åˆ«æ³¨æ•°ï¼ˆæ¯ä¸ªç”Ÿè‚–=1æ³¨ï¼‰
     * @param {string} text æ˜¾ç¤ºæ–‡æœ¬
     * @returns {number} ç”Ÿè‚–æ•°é‡
     */
    function countZodiacsInText(text) {
        if (!text) return 0;
        // ğŸ†• v3.12.7 æ·»åŠ  "å…" åŒéŸ³å­—æ”¯æŒ
        const zodiacs = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'å…', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'];
        let count = 0;
        for (const z of zodiacs) {
            if (text.includes(z)) count++;
        }
        return count;
    }
    
    /**
     * è¾“å…¥æ ‡å‡†åŒ–å‡½æ•°
     * ğŸ†• v3.11.6 å¤„ç†é¡ºåºï¼šåŒä¹‰è¯æ ‡å‡†åŒ– â†’ è‡ªå®šä¹‰è§„åˆ™ â†’ ç”Ÿè‚–ä»£å·è½¬æ¢
     * @param {string} text åŸå§‹æ–‡æœ¬
     * @returns {string} æ ‡å‡†åŒ–åçš„æ–‡æœ¬
     */
    function sanitizeText(text) {
        if (!text) return text;
        let result = text;
        
        // ğŸ†• v3.11.6 ç¬¬1æ­¥ï¼šåŒä¹‰è¯æ ‡å‡†åŒ–ï¼ˆ6è‚–â†’å…­è‚–ã€2å‹â†’äºŒå‹ ç­‰ï¼‰
        for (const key of SYNONYM_KEYS_SORTED) {
            if (result.includes(key)) {
                result = result.split(key).join(SYNONYM_MAP[key]);
            }
        }
        
        // ğŸ†• v3.12.8 ç¬¬1.5æ­¥ï¼šç±»å‹å…³é”®è¯ç´§è·Ÿçš„é€—å·/å†’å·è½¬ä¸ºç©ºæ ¼ï¼ˆé˜²æ­¢é”™è¯¯åˆ†å‰²ï¼‰
        // é—®é¢˜ï¼š"ä¸€æœ‰ï¼Œå…100" ä¸­çš„é€—å·å¯¼è‡´ "ä¸€æœ‰" å’Œ "å…100" è¢«åˆ†å‰²ï¼Œ"ä¸€æœ‰"è¢«ä¸¢å¼ƒ
        // è§„åˆ™ï¼šåªå¤„ç†ã€ç±»å‹å…³é”®è¯ç´§è·Ÿã€‘çš„é€—å·/å†’å·ï¼Œä¸å½±å“å…¶ä»–æ­£å¸¸åˆ†éš”
        // ç¤ºä¾‹ï¼š
        //   "ä¸€å‹ï¼Œå…100" â†’ "ä¸€å‹ å…100" âœ… ç±»å‹å…³é”®è¯åçš„é€—å·è½¬ç©ºæ ¼
        //   "é¼ 100ï¼Œç‰›200" â†’ "é¼ 100ï¼Œç‰›200" âœ… æ­£å¸¸åˆ†éš”ç¬¦ä¿ç•™
        //   "å¹³ç‰¹ï¼šçŒ´100" â†’ "å¹³ç‰¹ çŒ´100" âœ… å†’å·ä¹Ÿæ˜¯è¿æ¥ç¬¦
        // ä½¿ç”¨å•ä¸ªæ­£åˆ™ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰ç±»å‹å…³é”®è¯
        result = result.replace(
            /(ä¸€å‹|äºŒå‹|ä¸‰å‹|å››å‹|äº”å‹|å¹³ç‰¹|å…­è‚–|6è‚–|ç‰¹è‚–|æ­£è‚–|åˆè‚–|æ³¢è‰²|ä¸ä¸­)[ï¼Œ,ï¼š:ã€]+/g,
            '$1 '
        );
        
        // ğŸ†• v3.12.9 ç¬¬1.6æ­¥ï¼šç§»é™¤ç±»å‹å…³é”®è¯å‰çš„æ— æ„ä¹‰å†—ä½™å­—ç¬¦
        // é—®é¢˜ï¼š"é—¨å¹³ç‰¹é¼ 600" ä¸­çš„"é—¨"æ˜¯ç”¨æˆ·æ‰“å­—å†—ä½™ï¼Œä¸åº”è¯¥ä¿ç•™
        // è§„åˆ™ï¼šç§»é™¤ç±»å‹å…³é”®è¯å‰çš„å•ç‹¬"é—¨"å­—ï¼ˆä¸å½±å“"æ¾³é—¨"ç­‰åˆæ³•å…³é”®è¯ï¼‰
        // ç¤ºä¾‹ï¼š
        //   "é—¨å¹³ç‰¹é¼ 600" â†’ "å¹³ç‰¹é¼ 600" âœ… ç§»é™¤å†—ä½™çš„"é—¨"
        //   "æ¾³é—¨å¹³ç‰¹é¼ 600" â†’ "æ¾³é—¨å¹³ç‰¹é¼ 600" âœ… ä¿ç•™åˆæ³•çš„"æ¾³é—¨"
        //   "æ–°æ¾³é—¨å¹³ç‰¹" â†’ "æ–°æ¾³é—¨å¹³ç‰¹" âœ… ä¿ç•™
        // ä½¿ç”¨è´Ÿå‘åé¡¾ç¡®ä¿"é—¨"å‰é¢ä¸æ˜¯"æ¾³"æˆ–"æ–°"
        result = result.replace(
            /(?<![æ¾³æ–°å¥¥])é—¨(å¹³ç‰¹|ä¸€å‹|äºŒå‹|ä¸‰å‹|å››å‹|äº”å‹|å…­è‚–|6è‚–|ç‰¹è‚–|æ­£è‚–|åˆè‚–|æ³¢è‰²|ä¸ä¸­)/g,
            '$1'
        );
        
        // ğŸ†• v3.4 ç¬¬2æ­¥ï¼šåº”ç”¨è‡ªå®šä¹‰è§„åˆ™ï¼ˆå…³é”®è¯â†’ä»£å·æ˜ å°„ï¼‰
        // ğŸ†• v3.11.48 ä¿®å¤ï¼šå±•å¼€æ—¶æ·»åŠ  #CUSTOM:åŸå§‹è¾“å…¥# æ ‡è®°ï¼Œç¡®ä¿æ˜¾ç¤ºæ—¶è¿˜åŸç”¨æˆ·åŸå§‹è¾“å…¥
        // ğŸ†• v3.11.49 ä¿®å¤ï¼šæ”¹è¿›é‡‘é¢æå–é€»è¾‘ï¼Œè§£å†³å…³é”®è¯åç´§è·Ÿé‡‘é¢æ—¶æå–é”™è¯¯çš„é—®é¢˜
        const rules = getCustomRules();
        if (rules && rules.length > 0) {
            const sortedRules = [...rules].sort((a, b) => b.keyword.length - a.keyword.length);
            for (const rule of sortedRules) {
                if (result.includes(rule.keyword)) {
                    if (rule.expand && rule.numbers && rule.numbers.length > 0) {
                        // ğŸ†• v3.11.49 æ”¹è¿›çš„é‡‘é¢æå–é€»è¾‘
                        // é—®é¢˜ï¼šåŸæ­£åˆ™å½“å…³é”®è¯ç´§è·Ÿé‡‘é¢æ—¶ï¼ˆå¦‚"å°ç 100"ï¼‰ï¼Œå¦‚æœç”¨æˆ·è¯¯å°†é‡‘é¢çš„ä¸€éƒ¨åˆ†
                        //       åŒ…å«åœ¨å…³é”®è¯ä¸­ï¼ˆå¦‚é…ç½®"å°ç 1"è€Œé"å°ç "ï¼‰ï¼Œä¼šå¯¼è‡´é‡‘é¢æå–é”™è¯¯
                        // è§£å†³æ–¹æ¡ˆï¼š
                        //   1. æŒ‰è¡Œå¤„ç†ï¼Œä½¿ç”¨è¡Œå°¾é”šç‚¹ç¡®ä¿é‡‘é¢æå–å®Œæ•´
                        //   2. æ·»åŠ é‡‘é¢éªŒè¯å’Œæ™ºèƒ½ä¿®æ­£
                        //   3. æ”¯æŒå¤šç§æ ¼å¼ï¼šå°ç 100ã€å°ç  100ã€å°ç å„100ã€å°ç 100å…ƒ
                        
                        const keywordEscaped = escapeRegex(rule.keyword);
                        
                        // æŒ‰è¡Œå¤„ç†ï¼Œç¡®ä¿æ¯è¡Œçš„é‡‘é¢æå–æ­£ç¡®
                        const lines = result.split('\n');
                        const processedLines = lines.map(line => {
                            if (!line.includes(rule.keyword)) return line;
                            
                            // ğŸ†• v3.11.49 æ”¹è¿›çš„æ­£åˆ™ï¼šåŒ¹é…å…³é”®è¯ + å¯é€‰åˆ†éš”ç¬¦ + é‡‘é¢ + å¯é€‰å•ä½
                            // ä½¿ç”¨è¡Œå°¾é”šç‚¹ $ ç¡®ä¿é‡‘é¢æ˜¯è¯¥è¡Œæœ€åçš„æ•°å­—ä¸²
                            const expandRegex = new RegExp(
                                keywordEscaped + '\\s*[å„æ¯ç»Ÿ]?\\s*(\\d+)(?:å…ƒ|å—|é’±)?\\s*$',
                                'i'
                            );
                            
                            let matched = false;
                            const newLine = line.replace(expandRegex, (match, amountStr) => {
                                matched = true;
                                let amount = parseInt(amountStr);
                                
                                // ğŸ†• v3.11.49 é‡‘é¢éªŒè¯ï¼šå¦‚æœé‡‘é¢å¼‚å¸¸å°ï¼Œå°è¯•æ™ºèƒ½ä¿®æ­£
                                if (isNaN(amount) || amount <= 0) {
                                    console.warn(`âš ï¸ è‡ªå®šä¹‰è§„åˆ™é‡‘é¢å¼‚å¸¸: å…³é”®è¯="${rule.keyword}", æå–="${amountStr}"`);
                                    // ä»æ•´ä¸ªåŒ¹é…ä¸­æå–æœ€åä¸€ä¸ªå®Œæ•´æ•°å­—ä½œä¸ºé‡‘é¢
                                    const allDigits = match.match(/\d+/g);
                                    if (allDigits && allDigits.length > 0) {
                                        amount = parseInt(allDigits[allDigits.length - 1]);
                                        console.log(`ğŸ”„ é‡‘é¢ä¿®æ­£: 0 â†’ ${amount}`);
                                    }
                                }
                                
                                if (rule.amountMode === 'total') {
                                    amount = Math.floor(amount / rule.numbers.length);
                                }
                                
                                const originalMatch = match.trim();
                                console.log(`ğŸ¯ è‡ªå®šä¹‰è§„åˆ™å±•å¼€: "${rule.keyword}" â†’ ${rule.numbers.length}æ¡, é‡‘é¢=${amount} (åŸå§‹: "${originalMatch}")`);
                                
                                // æ¯è¡Œéƒ½å¸¦æ ‡è®°ï¼Œæ ¼å¼: #CUSTOM:åŸå§‹è¾“å…¥#T01 1 100
                                return rule.numbers.map(num => `#CUSTOM:${originalMatch}#${rule.type} ${num} ${amount}`).join('\n');
                            });
                            
                            // å¦‚æœè¡Œå°¾æ¨¡å¼æ²¡åŒ¹é…åˆ°ï¼Œå°è¯•æ›´å®½æ¾çš„æ¨¡å¼ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                            if (!matched && line.includes(rule.keyword)) {
                                const fallbackRegex = new RegExp(
                                    keywordEscaped + '\\s*[å„æ¯ç»Ÿ]?\\s*(\\d+)',
                                    'i'
                                );
                                return line.replace(fallbackRegex, (match, amountStr) => {
                                    let amount = parseInt(amountStr);
                                    
                                    // é‡‘é¢å¼‚å¸¸æ—¶å°è¯•ä»åŸå§‹è¡Œæå–
                                    if (isNaN(amount) || amount <= 0) {
                                        const lineDigits = line.match(/\d+/g);
                                        if (lineDigits && lineDigits.length > 0) {
                                            amount = parseInt(lineDigits[lineDigits.length - 1]);
                                        }
                                    }
                                    
                                    if (rule.amountMode === 'total') {
                                        amount = Math.floor(amount / rule.numbers.length);
                                    }
                                    
                                    const originalMatch = match.trim();
                                    console.log(`ğŸ¯ è‡ªå®šä¹‰è§„åˆ™å±•å¼€(fallback): "${rule.keyword}" â†’ ${rule.numbers.length}æ¡, é‡‘é¢=${amount}`);
                                    return rule.numbers.map(num => `#CUSTOM:${originalMatch}#${rule.type} ${num} ${amount}`).join('\n');
                                });
                            }
                            
                            return newLine;
                        });
                        
                        result = processedLines.join('\n');
                    } else {
                        // ğŸ†• v3.12.3 éå±•å¼€ç±»å‹ï¼šç®€å•æ›¿æ¢å…³é”®è¯ä¸ºç±»å‹ä»£å·
                        // æ— è®ºæ˜¯å¦æœ‰é‡‘é¢ï¼Œéƒ½æ·»åŠ  #CUSTOM:...# æ ‡è®°ä¿ç•™ç”¨æˆ·åŸå§‹è¾“å…¥
                        const lines = result.split('\n');
                        const processedLines = lines.map(line => {
                            if (!line.includes(rule.keyword)) return line;
                            
                            const originalLine = line.trim();
                            // æ›¿æ¢å…³é”®è¯ä¸ºä»£å·ï¼Œæ·»åŠ ç©ºæ ¼é˜²æ­¢ç²˜è¿
                            const converted = line.replace(rule.keyword, rule.type + ' ');
                            console.log(`ğŸ¯ è‡ªå®šä¹‰è§„åˆ™: "${originalLine}" â†’ "${converted.trim()}"`);
                            // å§‹ç»ˆæ·»åŠ æ ‡è®°ä¿ç•™åŸå§‹è¾“å…¥
                            return `#CUSTOM:${originalLine}#${converted.trim()}`;
                        });
                        result = processedLines.join('\n');
                    }
                }
            }
        }
        
        // ğŸ†• v3.11.4 ç¬¬3æ­¥ï¼šç”Ÿè‚–â†’Zä»£å·è½¬æ¢ï¼ˆåç«¯FlashLexå¼•æ“ä¾èµ– Z\d{1,2} æ ¼å¼ï¼‰
        // ğŸ†• v3.12.2 ä¿®å¤ï¼šä¸è½¬æ¢ #CUSTOM:...# æ ‡è®°å†…çš„åŸå§‹å†…å®¹ï¼Œä¿æŒä¸­æ–‡ç”Ÿè‚–ç”¨äºæ˜¾ç¤º
        const convertZodiac = (text) => {
            let converted = text;
            for (const zodiac of ZODIAC_KEYS_SORTED) {
                converted = converted.split(zodiac).join(ZODIAC_TO_CODE[zodiac]);
            }
            // ä¿®å¤Zä»£å·ç²˜è¿é—®é¢˜
            converted = converted.replace(/(Z1[0-2])(\d)/g, '$1 $2');
            converted = converted.replace(/(Z[1-9])(\d)/g, (match, z, d) => {
                if (z === 'Z1' && ['0','1','2'].includes(d)) return match;
                return z + ' ' + d;
            });
            return converted;
        };
        
        // æŒ‰è¡Œå¤„ç†ï¼Œä¿æŠ¤ #CUSTOM:...# æ ‡è®°å†…çš„åŸå§‹å†…å®¹
        const lines = result.split('\n');
        result = lines.map(line => {
            const customMatch = line.match(/^(#CUSTOM:[^#]+#)(.*)$/);
            if (customMatch) {
                // æœ‰æ ‡è®°ï¼šåªè½¬æ¢ # åé¢çš„å†…å®¹ï¼Œä¿ç•™æ ‡è®°å†…çš„åŸå§‹ä¸­æ–‡
                const marker = customMatch[1];
                const content = customMatch[2];
                return marker + convertZodiac(content);
            }
            // æ— æ ‡è®°ï¼šæ­£å¸¸è½¬æ¢
            return convertZodiac(line);
        }).join('\n');
        
        if (text !== result) {
            console.log('ğŸ”„ è¾“å…¥æ ‡å‡†åŒ–:', text.substring(0, 30), 'â†’', result.substring(0, 30));
        }
        return result;
    }
    
    /**
     * ä»£å·è¿˜åŸå‡½æ•°
     * å°† Z ä»£å·è¿˜åŸä¸ºä¸­æ–‡ç”Ÿè‚–ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
     * @param {string} text Zä»£å·æ ¼å¼çš„æ–‡æœ¬
     * @returns {string} è¿˜åŸåçš„ä¸­æ–‡æ–‡æœ¬
     */
    function restoreText(text) {
        if (!text) return text;
        let result = text;
        
        for (const code of CODE_KEYS_SORTED) {
            result = result.split(code).join(CODE_TO_ZODIAC[code]);
        }
        
        return result;
    }
    
    /**
     * è¿˜åŸAIè¿”å›çš„ç»“æœæ•°ç»„
     * @param {Array} aiResult AIè¿”å›çš„æ•°ç»„ï¼Œæ”¯æŒä¸¤ç§æ ¼å¼ï¼š
     *   - æ—§ç‰ˆ: [["ç±»å‹","åŸæ–‡"], ...]
     *   - æ–°ç‰ˆ(Function Calling): [{code, original, numbers, amount}, ...]
     * @returns {Array} ç»Ÿä¸€æ ¼å¼çš„æ•°ç»„ [[code, original, numbers?, amount?, zodiac_code?], ...]
     */
    function restoreAIResult(aiResult) {
        if (!Array.isArray(aiResult)) return aiResult;
        
        return aiResult.map(item => {
            // ğŸ†• æ–°ç‰ˆ Function Calling æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰
            if (item && typeof item === 'object' && !Array.isArray(item)) {
                const code = item.code || 'UK';
                const original = restoreText(item.original || '');
                const numbers = item.numbers || null;
                const amount = item.amount || null;
                const zodiacCode = item.zodiac_code || null;
                // è¿”å›æ‰©å±•æ•°ç»„æ ¼å¼: [code, original, numbers, amount, zodiac_code]
                return [code, original, numbers, amount, zodiacCode];
            }
            // æ—§ç‰ˆæ ¼å¼ï¼ˆæ•°ç»„ï¼‰
            if (Array.isArray(item) && item.length >= 2) {
                return [item[0], restoreText(item[1])];
            }
            return item;
        });
    }
    
    /**
     * JSONä¿®å¤å‡½æ•°ï¼šä¿®å¤AIè¾“å‡ºçš„å¸¸è§æ ¼å¼é”™è¯¯
     * @param {string} str AIè¿”å›çš„åŸå§‹å­—ç¬¦ä¸²
     * @returns {string} ä¿®å¤åçš„JSONå­—ç¬¦ä¸²
     */
    function repairJSON(str) {
        if (!str) return str;
        let result = str.trim();
        
        // 1. ç§»é™¤markdownä»£ç å—
        result = result.replace(/```json?\n?/g, '').replace(/```/g, '');
        
        // 2. æå–JSONæ•°ç»„ï¼ˆç§»é™¤å‰åçš„è§£é‡Šæ–‡å­—ï¼‰
        const jsonMatch = result.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
            result = jsonMatch[0];
        }
        
        // 3. ä¿®å¤å°¾éƒ¨é€—å· [["a","b"],] â†’ [["a","b"]]
        result = result.replace(/,(\s*[\]\}])/g, '$1');
        
        // 4. ä¿®å¤ç¼ºå¤±å¼•å·çš„ç±»å‹ [[TM,"xxx"]] â†’ [["TM","xxx"]]
        result = result.replace(/\[([A-Z][A-Z0-9]*),/g, '["$1",');
        
        // 5. ä¿®å¤å•å¼•å· [['TM','xxx']] â†’ [["TM","xxx"]]
        result = result.replace(/'/g, '"');
        
        return result;
    }
    
    /**
     * æ ¡éªŒAIè¿”å›ç»“æœçš„æ ¼å¼
     * @param {Array} data è§£æåçš„æ•°æ®ï¼Œæ”¯æŒä¸¤ç§æ ¼å¼ï¼š
     *   - æ—§ç‰ˆ: [["ç±»å‹","åŸæ–‡"], ...]
     *   - æ–°ç‰ˆ(Function Calling): [{code, original, numbers, amount}, ...]
     * @returns {{valid: boolean, error?: string}}
     */
    function validateAIResult(data) {
        const validTypes = [
            'T01', 'TM', 'T', 'SXTM', 'SX', 'BS', 'BB',
            'PT', 'PT1', 'PT2', 'PT3', 'PT4', 'PT5', 'PTW',
            'LX6', 'HX', 'ZX', 'DP', 'DXDS',
            'E2', 'S3', 'BZ5', 'BZ6', 'BZ7', 'BZ8', 'BZ9', 'BZ10', 'BZ11', 'BZ12',
            'LM2Q', 'LM3Q', 'LM2Z', 'LM3Z', 'LMTC',
            'C1', 'C2', 'C3', 'C1S', 'C1D', 'C1B', 'C1X', 'C2S', 'C2D', 'C2B', 'C2X', 'C3S', 'C3D', 'C3B', 'C3X',
            'ZH', 'ZHB', 'ZHX', 'ZHS', 'ZHD',
            'WXJ', 'WXM', 'WXS', 'WXH', 'WXT',
            'JYJ', 'JYY', 'XS', 'DS', 'ODD', 'EVEN',
            // å…¼å®¹æ—§ä»£å·
            'LX', 'BZ', 'LM', 'WX', 'JY', 'UK'
        ];
        
        if (!Array.isArray(data)) {
            return { valid: false, error: 'è¿”å›å€¼ä¸æ˜¯æ•°ç»„' };
        }
        
        for (let i = 0; i < data.length; i++) {
            const item = data[i];
            let typeCode;
            
            // ğŸ†• æ”¯æŒæ–°ç‰ˆ Function Calling æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰
            if (item && typeof item === 'object' && !Array.isArray(item)) {
                if (!item.code || !item.original) {
                    return { valid: false, error: `ç¬¬${i+1}é¡¹ç¼ºå°‘codeæˆ–originalå­—æ®µ` };
                }
                typeCode = item.code;
            }
            // æ—§ç‰ˆæ ¼å¼ï¼ˆæ•°ç»„ï¼‰
            else if (Array.isArray(item) && item.length >= 2) {
                typeCode = item[0];
            }
            else {
                return { valid: false, error: `ç¬¬${i+1}é¡¹æ ¼å¼é”™è¯¯` };
            }
            
            // ç±»å‹å¯ä»¥æ˜¯æ–°ä»£å·æˆ–æ—§ä»£å·
            if (!validTypes.includes(typeCode)) {
                // ä¸æ˜¯ä¸¥æ ¼é”™è¯¯ï¼Œåªæ˜¯è­¦å‘Š
                console.warn(`âš ï¸ æœªçŸ¥ç±»å‹ä»£å·: ${typeCode}ï¼Œå°†å°è¯•å¤„ç†`);
            }
        }
        
        return { valid: true };
    }
    
    // ==================== ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘æµ‹è¯•æ•°æ®å­˜å‚¨ ====================
    // å­˜å‚¨å¤šè½®æµ‹è¯•ç»“æœ
    let multiRoundTestData = {
        inputContent: '',           // è¾“å…¥å†…å®¹
        standardAnswer: '',         // æ ‡å‡†ç­”æ¡ˆ
        totalRounds: 5,             // æ€»è½®æ•°
        currentRound: 0,            // å½“å‰è½®æ¬¡
        isRunning: false,           // æ˜¯å¦æ­£åœ¨è¿è¡Œ
        results: []                 // æ¯è½®ç»“æœ [{ round: 1, models: { deepseek: {...}, ... } }]
    };
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è¾¹ç¼˜æµ‹è¯•é…ç½®
    // âš ï¸ æ¯æ¬¡æµ‹è¯•æ–°ç±»å‹æ—¶ä¿®æ”¹è¿™ä¸¤ä¸ªå˜é‡ï¼
    const EDGE_TEST_TYPE = 'ç‰¹ç ';        // å½“å‰æµ‹è¯•çš„ç©æ³•ç±»å‹
    const EDGE_TEST_VERSION = 'V2';       // å½“å‰æµ‹è¯•ç‰ˆæœ¬ï¼ˆV1, V2, V3...ï¼‰
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è¾¹ç¼˜æµ‹è¯•ç”¨ä¾‹åº“
    // ç”¨ä¾‹ç‰ˆæœ¬: v1.1 | æ›´æ–°æ—¥æœŸ: 2025-12-17 | ç”¨ä¾‹æ•°: 35
    // æ›´æ–°æ–¹æ³•: ç”¨æˆ·å‘æ¡ˆä¾‹ç»™AIï¼ŒAIç”Ÿæˆè¾¹ç¼˜åŒ–ç”¨ä¾‹æ›´æ–°æ­¤æ•°ç»„
    // v1.1æ›´æ–°: æ–°å¢3ä¸ªå¤šç”Ÿè‚–è¾¹ç¼˜ç”¨ä¾‹ï¼ˆä¹°é¾™è™å…”å„30ç­‰ï¼‰
    const EDGE_TEST_CASES_VERSION = 'v1.1';
    const EDGE_TEST_CASES = [
        // ç¬¬ä¸€ç»„ï¼šåˆ†éš”ç¬¦å˜ä½“ï¼ˆæ ‡å‡†ç­”æ¡ˆï¼šç‰¹ç ï¼‰
        { input: '10,12,20,22å„30', answer: 'ç‰¹ç ', group: 'åˆ†éš”ç¬¦' },
        { input: '10ã€12ã€20ã€22å„30', answer: 'ç‰¹ç ', group: 'åˆ†éš”ç¬¦' },
        { input: '10/12/20/22å„30', answer: 'ç‰¹ç ', group: 'åˆ†éš”ç¬¦' },
        { input: '10-12-20-22å„30', answer: 'ç‰¹ç ', group: 'åˆ†éš”ç¬¦' },
        { input: '10.12.20.22å„30', answer: 'ç‰¹ç ', group: 'åˆ†éš”ç¬¦' },
        
        // ç¬¬äºŒç»„ï¼šé‡‘é¢å…³é”®è¯å˜ä½“ï¼ˆæ ‡å‡†ç­”æ¡ˆï¼šç‰¹ç ï¼‰
        { input: '25 36 47å„50', answer: 'ç‰¹ç ', group: 'é‡‘é¢å…³é”®è¯' },
        { input: '25 36 47æ¯ä¸ª50', answer: 'ç‰¹ç ', group: 'é‡‘é¢å…³é”®è¯' },
        { input: '25 36 47ç»Ÿä¸€50', answer: 'ç‰¹ç ', group: 'é‡‘é¢å…³é”®è¯' },
        { input: '25 36 47Ã—50', answer: 'ç‰¹ç ', group: 'é‡‘é¢å…³é”®è¯' },
        { input: '25 36 47X50', answer: 'ç‰¹ç ', group: 'é‡‘é¢å…³é”®è¯' },
        { input: '25 36 47x50', answer: 'ç‰¹ç ', group: 'é‡‘é¢å…³é”®è¯' },
        { input: '25 36 47*50', answer: 'ç‰¹ç ', group: 'é‡‘é¢å…³é”®è¯' },
        
        // ç¬¬ä¸‰ç»„ï¼šä¸­æ–‡é‡‘é¢ï¼ˆæ ‡å‡†ç­”æ¡ˆï¼šç‰¹ç ï¼‰
        { input: '08 18 28å„äºŒå', answer: 'ç‰¹ç ', group: 'ä¸­æ–‡é‡‘é¢' },
        { input: '31.34å„äºŒå', answer: 'ç‰¹ç ', group: 'ä¸­æ–‡é‡‘é¢' },
        { input: '08 18 28å„20å…ƒ', answer: 'ç‰¹ç ', group: 'ä¸­æ–‡é‡‘é¢' },
        { input: 'ç‰¹43 20å…ƒ', answer: 'ç‰¹ç ', group: 'ç‰¹å­—' },
        
        // ç¬¬å››ç»„ï¼šæ•°å­—èŒƒå›´ï¼ˆæ ‡å‡†ç­”æ¡ˆï¼šç‰¹ç ï¼‰
        { input: 'å°æ•°å„20', answer: 'ç‰¹ç ', group: 'æ•°å­—èŒƒå›´' },
        { input: 'å¤§æ•°å„30', answer: 'ç‰¹ç ', group: 'æ•°å­—èŒƒå›´' },
        { input: 'å•æ•°å„10', answer: 'ç‰¹ç ', group: 'æ•°å­—èŒƒå›´' },
        { input: 'åŒæ•°å„15', answer: 'ç‰¹ç ', group: 'æ•°å­—èŒƒå›´' },
        
        // ç¬¬äº”ç»„ï¼šç”Ÿè‚–ç‰¹ç ï¼ˆæ ‡å‡†ç­”æ¡ˆï¼šç”Ÿè‚–ç‰¹ç ï¼‰
        { input: 'é¾™x10', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'ç”Ÿè‚–ç‰¹ç ' },
        { input: 'ç‹—X80', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'ç”Ÿè‚–ç‰¹ç ' },
        { input: 'ä¹°çŒªå„20', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'ç”Ÿè‚–ç‰¹ç ' },
        { input: 'ä¹°é¾™è™å„20', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'ç”Ÿè‚–ç‰¹ç ' },
        { input: 'çŒ´é¸¡x50', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'ç”Ÿè‚–ç‰¹ç ' },
        { input: 'ç‹—x80ï¼ŒçŒ´é¸¡x50', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'ç”Ÿè‚–ç‰¹ç ' },
        { input: 'ä¹°é©¬X50å…ƒ', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'ç”Ÿè‚–ç‰¹ç ' },
        // V2æ–°å¢ï¼šå¤šç”Ÿè‚–+ä¹°+å„ è¾¹ç¼˜ç”¨ä¾‹
        { input: 'ä¹°é¾™è™å…”å„30', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'å¤šç”Ÿè‚–' },
        { input: 'ä¹°é¼ ç‰›è™å…”å„50', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'å¤šç”Ÿè‚–' },
        { input: 'ä¹°çŒªç‹—é¸¡çŒ´å„100', answer: 'ç”Ÿè‚–ç‰¹ç ', group: 'å¤šç”Ÿè‚–' },
        
        // ç¬¬å…­ç»„ï¼šç”Ÿè‚–ï¼ˆæ ‡å‡†ç­”æ¡ˆï¼šç”Ÿè‚–ï¼‰
        { input: 'çŒª10', answer: 'ç”Ÿè‚–', group: 'ç”Ÿè‚–' },
        
        // ç¬¬ä¸ƒç»„ï¼šæ··åˆæç«¯å˜ä½“
        { input: '01 02 03å„äºŒåå…ƒ', answer: 'ç‰¹ç ', group: 'æ··åˆæç«¯' },
        { input: '10 12 20 22 23 25 33 40 43 44 30å„20', answer: 'ç‰¹ç ', group: 'æ··åˆæç«¯' },
        { input: '06.18.42å„20', answer: 'ç‰¹ç ', group: 'æ··åˆæç«¯' },
        { input: '39X200', answer: 'ç‰¹ç ', group: 'æ··åˆæç«¯' }
    ];
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è¾¹ç¼˜æµ‹è¯•ç»“æœå­˜å‚¨
    let edgeTestResults = {
        isRunning: false,
        currentCase: 0,
        totalCases: 0,
        results: []  // [{ input, answer, models: { deepseek: {...}, ... } }]
    };
    
    // ==================== æ‰¹é‡ç²¾å‡†æµ‹è¯•ç³»ç»Ÿ v2.0 ====================
    
    // æ‰¹é‡æµ‹è¯•çŠ¶æ€
    let batchTestState = {
        isRunning: false,
        shouldStop: false,
        queue: [],        // æµ‹è¯•é˜Ÿåˆ—
        results: [],      // æµ‹è¯•ç»“æœ
        logs: [],         // å¤„ç†æ—¥å¿—
        startTime: null,
        currentIndex: 0,
        standardAnswers: {}  // ğŸ†• v2.0 æ ‡å‡†ç­”æ¡ˆ { ç»„N: { header: {...}, records: [...] } }
    };
    
    // ğŸ†• v2.0 Tabåˆ‡æ¢
    function switchBatchTab(tab) {
        const casesTab = document.getElementById('tab-test-cases');
        const answersTab = document.getElementById('tab-standard-answers');
        const casesContent = document.getElementById('batch-tab-cases');
        const answersContent = document.getElementById('batch-tab-answers');
        
        if (tab === 'cases') {
            casesTab.style.background = 'linear-gradient(90deg,#667eea,#764ba2)';
            casesTab.style.color = 'white';
            answersTab.style.background = 'rgba(255,255,255,0.1)';
            answersTab.style.color = '#888';
            casesContent.style.display = 'block';
            answersContent.style.display = 'none';
        } else {
            answersTab.style.background = 'linear-gradient(90deg,#27ae60,#2ecc71)';
            answersTab.style.color = 'white';
            casesTab.style.background = 'rgba(255,255,255,0.1)';
            casesTab.style.color = '#888';
            casesContent.style.display = 'none';
            answersContent.style.display = 'block';
        }
    }
    
    // ğŸ†• v2.0 æ›´æ–°ç­”æ¡ˆè®¡æ•°
    function updateAnswerCount() {
        const inputEl = document.getElementById('batch-standard-answers');
        const text = inputEl?.value?.trim() || '';
        const groupMatches = text.match(/#ç»„\d+/g) || [];
        const countEl = document.getElementById('answer-queue-count');
        if (countEl) countEl.textContent = groupMatches.length;
    }
    
    // ğŸ†• v2.0 æ˜¾ç¤ºæ ¼å¼å¸®åŠ©
    function showAnswerFormatHelp() {
        alert(`æ ‡å‡†ç­”æ¡ˆæ ¼å¼ï¼š

#ç»„1
æ€»æ³¨:54|æ€»æŠ•:3280|ä¸­å¥–:3|æ´¾å½©:12030|ç›ˆäº:+8750
---
1|å…­è‚–|å…­è‚–é¼ çŒ´ç¾Šé¸¡ç‰›é©¬ 200|é¼ ,çŒ´,ç¾Š,é¸¡,ç‰›,é©¬|200|1|200|âœ“
2|ç‰¹ç |é¸¡é¼ çŒ´x10|é¸¡09,21,33,45,é¼ 06,18,30,42|10|12|120|âœ—
---
3|ç‰¹ç |ç‰¹ç‰›ç‹—é¸¡å„æ•°30|ç‰›05,17,29,41,ç‹—08,20,32,44,é¸¡09,21,33,45|30|12|360|âœ“
===

å­—æ®µè¯´æ˜ï¼š
- æ€»æ³¨/æ€»æŠ•/ä¸­å¥–/æ´¾å½©/ç›ˆäºï¼šæ±‡æ€»æ•°æ®
- åºå·|ç±»å‹|åŸæ–‡|å·ç |é‡‘é¢|æ³¨æ•°|å°è®¡|ä¸­å¥–
- åˆ†éš”çº¿ --- è¡¨ç¤ºç”¨æˆ·è¾“å…¥çš„ç©ºè¡Œåˆ†ç»„
- === è¡¨ç¤ºè¯¥ç»„ç»“æŸ`);
    }
    
    // ğŸ†• v2.0 è§£ææ ‡å‡†ç­”æ¡ˆ
    function parseStandardAnswers(text) {
        const answers = {};
        if (!text.trim()) return answers;
        
        const lines = text.split('\n');
        let currentGroup = null;
        let currentHeader = null;
        let currentRecords = [];
        
        for (const line of lines) {
            const trimmed = line.trim();
            
            // åŒ¹é…ç»„æ ‡è¯†
            const groupMatch = trimmed.match(/^#ç»„(\d+)/);
            if (groupMatch) {
                // ä¿å­˜ä¸Šä¸€ç»„
                if (currentGroup !== null) {
                    answers[currentGroup] = {
                        header: currentHeader,
                        records: currentRecords
                    };
                }
                currentGroup = parseInt(groupMatch[1]);
                currentHeader = null;
                currentRecords = [];
                continue;
            }
            
            // åŒ¹é…å¤´éƒ¨æ±‡æ€»
            if (trimmed.startsWith('æ€»æ³¨:')) {
                const parts = trimmed.split('|');
                currentHeader = {};
                parts.forEach(p => {
                    const [key, val] = p.split(':');
                    if (key && val !== undefined) {
                        currentHeader[key.trim()] = val.trim().replace(/[+å…ƒ]/, '');
                    }
                });
                continue;
            }
            
            // è·³è¿‡åˆ†éš”çº¿
            if (trimmed === '---' || trimmed === '===' || !trimmed) continue;
            
            // è§£æè®°å½•è¡Œ
            const parts = trimmed.split('|');
            if (parts.length >= 7) {
                // åˆ¤æ–­æ˜¯å¦æœ‰å½©ç§åˆ—
                const hasLt = parts.length >= 9;
                const record = hasLt ? {
                    seq: parseInt(parts[0]),
                    lt: parts[1],           // å½©ç§
                    type: parts[2],         // ç±»å‹
                    raw: parts[3],          // åŸæ–‡
                    numbers: parts[4],      // å·ç 
                    amount: parseInt(parts[5]),  // é‡‘é¢
                    bets: parseInt(parts[6]),    // æ³¨æ•°
                    subtotal: parseInt(parts[7]), // å°è®¡
                    win: parts[8]?.includes('âœ“')  // ä¸­å¥–
                } : {
                    seq: parseInt(parts[0]),
                    type: parts[1],
                    raw: parts[2],
                    numbers: parts[3],
                    amount: parseInt(parts[4]),
                    bets: parseInt(parts[5]),
                    subtotal: parseInt(parts[6]),
                    win: parts[7]?.includes('âœ“')
                };
                currentRecords.push(record);
            }
        }
        
        // ä¿å­˜æœ€åä¸€ç»„
        if (currentGroup !== null) {
            answers[currentGroup] = {
                header: currentHeader,
                records: currentRecords
            };
        }
        
        console.log('ğŸ“‹ è§£ææ ‡å‡†ç­”æ¡ˆ:', Object.keys(answers).length, 'ç»„');
        return answers;
    }
    
    // æ‰“å¼€æ‰¹é‡æµ‹è¯•å¼¹çª—
    function openBatchTestModal() {
        document.getElementById('batch-test-modal').style.display = 'flex';
        switchBatchTab('cases');  // é»˜è®¤æ˜¾ç¤ºæµ‹è¯•æ¡ˆä¾‹Tab
        updateQueueCount();
        updateAnswerCount();
        console.log('ğŸ§ª æ‰¹é‡æµ‹è¯•å¼¹çª—å·²æ‰“å¼€');
    }
    
    // å…³é—­æ‰¹é‡æµ‹è¯•å¼¹çª—
    function closeBatchTestModal() {
        if (batchTestState.isRunning) {
            if (!confirm('æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ')) return;
            batchTestState.shouldStop = true;
        }
        document.getElementById('batch-test-modal').style.display = 'none';
    }
    
    // æ›´æ–°é˜Ÿåˆ—è®¡æ•°
    function updateQueueCount() {
        const inputEl = document.getElementById('batch-test-input');
        const text = inputEl?.value?.trim() || '';
        const groupMatches = text.match(/#ç»„\d+/g) || [];
        const countEl = document.getElementById('test-queue-count');
        if (countEl) countEl.textContent = groupMatches.length || text.split('\n').filter(l => l.trim()).length;
    }
    
    // æ¸…ç©ºæ‰¹é‡æµ‹è¯•
    function clearBatchTest() {
        document.getElementById('batch-test-input').value = '';
        document.getElementById('batch-standard-answers').value = '';
        batchTestState.results = [];
        batchTestState.logs = [];
        batchTestState.standardAnswers = {};
        updateQueueCount();
        updateAnswerCount();
        document.getElementById('batch-result-list').innerHTML = '';
        document.getElementById('batch-summary').style.display = 'none';
        showAutoCloseToast('ğŸ—‘ï¸ å·²æ¸…ç©º');
    }
    
    // ğŸ†• v3.12.2 è§£æåˆ†ç»„æµ‹è¯•æ¡ˆä¾‹
    // æ ¼å¼ï¼š#ç»„1|æœŸæœ›ç±»å‹|æœŸæœ›é‡‘é¢|æœŸæœ›æ³¨æ•°
    //       è¾“å…¥è¡Œ1
    //       è¾“å…¥è¡Œ2
    //       #ç»„2|...
    function parseGroupedTestCases(text) {
        const testCases = [];
        const lines = text.split('\n');
        
        let currentGroup = null;
        let currentLines = [];
        
        console.log('ğŸ“‹ å¼€å§‹è§£ææµ‹è¯•æ¡ˆä¾‹ï¼Œå…±', lines.length, 'è¡Œ');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            // ğŸ†• v3.12.6 å¢å¼ºåŒ¹é…ï¼šæ”¯æŒ # ï¼ƒ äº• ç­‰å¼€å¤´ï¼Œæ”¯æŒç©ºæ ¼å’Œé™„åŠ æ ‡ç­¾ï¼ˆå¦‚"æ··åˆ"ï¼‰
            // åŒ¹é…æ ¼å¼ï¼š#ç»„1 æˆ– #ç»„1 æ··åˆ æˆ– #ç»„1|æœŸæœ›ç±»å‹|æœŸæœ›é‡‘é¢|æœŸæœ›æ³¨æ•°
            const trimmedLine = line.trim();
            // ä¿®å¤ï¼šæ”¯æŒ #ç»„N åè·Ÿç©ºæ ¼+æ ‡ç­¾ï¼ˆå¦‚"æ··åˆ"ï¼‰ï¼Œä¸å†è¦æ±‚ä¸¥æ ¼ä»¥|æˆ–$ç»“å°¾
            const groupMatch = trimmedLine.match(/^[#ï¼ƒäº•]ç»„(\d+)(?:\s+\S+)?(?:\s*\|(.*))?$/);
            
            if (groupMatch) {
                console.log('âœ… æ£€æµ‹åˆ°ç»„æ ‡è®°:', trimmedLine, 'â†’ ç»„ID:', groupMatch[1]);
                
                // ä¿å­˜ä¸Šä¸€ç»„
                if (currentGroup !== null && currentLines.length > 0) {
                    // ğŸ†• å»é™¤é¦–å°¾ç©ºè¡Œ
                    while (currentLines.length > 0 && !currentLines[0].trim()) currentLines.shift();
                    while (currentLines.length > 0 && !currentLines[currentLines.length-1].trim()) currentLines.pop();
                    
                    if (currentLines.length > 0) {
                        testCases.push({
                            groupId: currentGroup.id,
                            input: currentLines.join('\n'),
                            expected: currentGroup.expected,
                            group: currentGroup.expected ? 'æœ‰æ ‡å‡†' : 'ä»…æµ‹è¯•'
                        });
                        console.log('ğŸ“¦ ä¿å­˜ç»„', currentGroup.id, ':', currentLines.length, 'è¡Œ');
                    }
                }
                
                // è§£ææ–°ç»„
                const groupId = parseInt(groupMatch[1]);
                const expectParts = groupMatch[2] ? groupMatch[2].split('|').map(p => p.trim()) : [];
                
                // ğŸ†• v3.12.5 æ”¯æŒç¬¬5ä¸ªæœŸæœ›å€¼ï¼šæ€»æŠ•æ³¨é¢
                // æ ¼å¼ï¼š#ç»„N|ç±»å‹|é‡‘é¢|æ³¨æ•°|æ€»æŠ•æ³¨
                currentGroup = {
                    id: groupId,
                    expected: expectParts.length >= 1 && (expectParts[0] || expectParts[2] || expectParts[3]) ? {
                        type: expectParts[0] || null,
                        amount: expectParts[1] ? parseInt(expectParts[1]) : null,
                        bets: expectParts[2] ? parseInt(expectParts[2]) : null,
                        totalBet: expectParts[3] ? parseInt(expectParts[3]) : null  // ğŸ†• æ€»æŠ•æ³¨é¢
                    } : null
                };
                currentLines = [];
            } else if (currentGroup !== null) {
                // å±äºå½“å‰ç»„çš„è¾“å…¥è¡Œ
                currentLines.push(line);
            } else {
                // å…¼å®¹æ—§æ ¼å¼ï¼šå•è¡Œæµ‹è¯•ï¼ˆæ²¡æœ‰#ç»„æ ‡è®°ï¼‰
                if (trimmedLine) {
                    const parts = trimmedLine.split('|').map(p => p.trim());
                    // è·³è¿‡æ³¨é‡Šè¡Œã€åˆ†éš”çº¿ã€æ ‡é¢˜è¡Œ
                    if (parts[0].startsWith('//') || 
                        parts[0].startsWith('===') || 
                        parts[0].startsWith('---') ||
                        parts[0].startsWith('ã€') ||
                        parts[0].startsWith('æ ¼å¼') ||
                        parts[0].startsWith('ä½¿ç”¨')) {
                        continue;
                    }
                    testCases.push({
                        groupId: testCases.length + 1,
                        input: parts[0],
                        expected: parts.length >= 2 ? {
                            type: parts[1] || null,
                            amount: parts[2] ? parseInt(parts[2]) : null,
                            bets: parts[3] ? parseInt(parts[3]) : null
                        } : null,
                        group: parts.length >= 2 ? 'æœ‰æ ‡å‡†' : 'ä»…æµ‹è¯•'
                    });
                }
            }
        }
        
        // ä¿å­˜æœ€åä¸€ç»„
        if (currentGroup !== null && currentLines.length > 0) {
            // å»é™¤é¦–å°¾ç©ºè¡Œ
            while (currentLines.length > 0 && !currentLines[0].trim()) currentLines.shift();
            while (currentLines.length > 0 && !currentLines[currentLines.length-1].trim()) currentLines.pop();
            
            if (currentLines.length > 0) {
                testCases.push({
                    groupId: currentGroup.id,
                    input: currentLines.join('\n'),
                    expected: currentGroup.expected,
                    group: currentGroup.expected ? 'æœ‰æ ‡å‡†' : 'ä»…æµ‹è¯•'
                });
                console.log('ğŸ“¦ ä¿å­˜æœ€åä¸€ç»„', currentGroup.id, ':', currentLines.length, 'è¡Œ');
            }
        }
        
        console.log('ğŸ“‹ è§£æå®Œæˆï¼Œå…±', testCases.length, 'ä¸ªæµ‹è¯•æ¡ˆä¾‹');
        return testCases;
    }
    
    // è¿è¡Œæ‰¹é‡æµ‹è¯•ï¼ˆæ”¯æŒåˆ†ç»„å¤šè¡Œè¾“å…¥ï¼‰
    async function runBatchTest() {
        // ä»è¾“å…¥æ¡†è¯»å–æµ‹è¯•æ¡ˆä¾‹
        const inputEl = document.getElementById('batch-test-input');
        const text = inputEl.value.trim();
        
        if (!text) {
            alert('è¯·ç²˜è´´æµ‹è¯•æ¡ˆä¾‹åˆ°è¾“å…¥æ¡†');
            return;
        }
        
        if (batchTestState.isRunning) {
            alert('æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­...');
            return;
        }
        
        // ğŸ†• ä½¿ç”¨æ–°çš„åˆ†ç»„è§£æå‡½æ•°
        batchTestState.queue = parseGroupedTestCases(text);
        
        if (batchTestState.queue.length === 0) {
            alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æµ‹è¯•æ¡ˆä¾‹');
            return;
        }
        
        // åˆå§‹åŒ–çŠ¶æ€
        batchTestState.isRunning = true;
        batchTestState.shouldStop = false;
        batchTestState.results = [];
        batchTestState.logs = [];
        batchTestState.startTime = Date.now();
        batchTestState.currentIndex = 0;
        
        // æ›´æ–°UI
        document.getElementById('run-batch-test-btn').style.display = 'none';
        document.getElementById('stop-batch-test-btn').style.display = 'inline-block';
        document.getElementById('batch-progress-bar').style.display = 'block';
        document.getElementById('batch-test-status').textContent = 'æµ‹è¯•ä¸­...';
        document.getElementById('batch-test-status').style.color = '#ffa726';
        document.getElementById('batch-result-list').innerHTML = '';
        document.getElementById('batch-summary').style.display = 'none';
        
        const totalCases = batchTestState.queue.length;
        
        // é€ä¸ªæµ‹è¯•
        for (let i = 0; i < totalCases; i++) {
            if (batchTestState.shouldStop) break;
            
            batchTestState.currentIndex = i;
            const testCase = batchTestState.queue[i];
            
            // æ›´æ–°è¿›åº¦
            updateProgress(i + 1, totalCases);
            
            // æ‰§è¡Œæµ‹è¯•
            const result = await executeTestCase(testCase, i);
            batchTestState.results.push(result);
            
            // å®æ—¶æ˜¾ç¤ºç»“æœ
            appendResultToList(result, i);
            
            // å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«ï¼ˆæ¶‰åŠAIæ—¶éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
            if (i < totalCases - 1 && !batchTestState.shouldStop) {
                await new Promise(r => setTimeout(r, 300));  // 300mså»¶è¿Ÿ
            }
        }
        
        // æµ‹è¯•å®Œæˆ
        finishBatchTest();
    }
    
    // ğŸ†• v2.0 æ–°ç‰ˆæ‰¹é‡æµ‹è¯•ï¼ˆæ”¯æŒæ ‡å‡†ç­”æ¡ˆç²¾ç¡®å¯¹æ¯”ï¼‰
    async function runBatchTestV2() {
        // ä»è¾“å…¥æ¡†è¯»å–æµ‹è¯•æ¡ˆä¾‹
        const inputEl = document.getElementById('batch-test-input');
        const text = inputEl.value.trim();
        
        // è¯»å–æ ‡å‡†ç­”æ¡ˆ
        const answersEl = document.getElementById('batch-standard-answers');
        const answersText = answersEl?.value?.trim() || '';
        
        if (!text) {
            alert('è¯·åœ¨"æµ‹è¯•æ¡ˆä¾‹"Tabä¸­ç²˜è´´æµ‹è¯•æ¡ˆä¾‹');
            switchBatchTab('cases');
            return;
        }
        
        if (batchTestState.isRunning) {
            alert('æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­...');
            return;
        }
        
        // è§£ææ ‡å‡†ç­”æ¡ˆ
        batchTestState.standardAnswers = parseStandardAnswers(answersText);
        const hasAnswers = Object.keys(batchTestState.standardAnswers).length > 0;
        
        if (!hasAnswers) {
            const proceed = confirm('æœªæ£€æµ‹åˆ°æ ‡å‡†ç­”æ¡ˆï¼Œå°†åªè¿è¡Œæµ‹è¯•ä¸è¿›è¡Œç²¾ç¡®éªŒè¯ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ');
            if (!proceed) {
                switchBatchTab('answers');
                return;
            }
        }
        
        // è§£ææµ‹è¯•æ¡ˆä¾‹
        batchTestState.queue = parseGroupedTestCases(text);
        
        if (batchTestState.queue.length === 0) {
            alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æµ‹è¯•æ¡ˆä¾‹');
            return;
        }
        
        // åˆå§‹åŒ–çŠ¶æ€
        batchTestState.isRunning = true;
        batchTestState.shouldStop = false;
        batchTestState.results = [];
        batchTestState.logs = [];
        batchTestState.startTime = Date.now();
        batchTestState.currentIndex = 0;
        
        // æ›´æ–°UI
        document.getElementById('run-batch-test-btn').style.display = 'none';
        document.getElementById('stop-batch-test-btn').style.display = 'inline-block';
        document.getElementById('batch-progress-bar').style.display = 'block';
        document.getElementById('batch-test-status').textContent = hasAnswers ? 'ç²¾ç¡®éªŒè¯ä¸­...' : 'æµ‹è¯•ä¸­...';
        document.getElementById('batch-test-status').style.color = '#ffa726';
        document.getElementById('batch-result-list').innerHTML = '';
        document.getElementById('batch-summary').style.display = 'none';
        
        const totalCases = batchTestState.queue.length;
        console.log(`ğŸ§ª å¼€å§‹æµ‹è¯•: ${totalCases}ç»„æ¡ˆä¾‹, ${Object.keys(batchTestState.standardAnswers).length}ç»„æ ‡å‡†ç­”æ¡ˆ`);
        
        // é€ä¸ªæµ‹è¯•
        for (let i = 0; i < totalCases; i++) {
            if (batchTestState.shouldStop) break;
            
            batchTestState.currentIndex = i;
            const testCase = batchTestState.queue[i];
            
            // æ›´æ–°è¿›åº¦
            updateProgress(i + 1, totalCases);
            
            // æ‰§è¡Œæµ‹è¯•å¹¶ä¸æ ‡å‡†ç­”æ¡ˆå¯¹æ¯”
            const result = await executeTestCaseV2(testCase, i);
            batchTestState.results.push(result);
            
            // å®æ—¶æ˜¾ç¤ºç»“æœ
            appendResultToListV2(result, i);
            
            // å»¶è¿Ÿ
            if (i < totalCases - 1 && !batchTestState.shouldStop) {
                await new Promise(r => setTimeout(r, 300));
            }
        }
        
        // æµ‹è¯•å®Œæˆ
        finishBatchTest();
    }
    
    // ğŸ†• v2.0 æ‰§è¡Œå•ä¸ªæµ‹è¯•å¹¶ä¸æ ‡å‡†ç­”æ¡ˆå¯¹æ¯”
    async function executeTestCaseV2(testCase, index) {
        const startTime = Date.now();
        const groupId = testCase.groupId || (index + 1);
        const standardAnswer = batchTestState.standardAnswers[groupId];
        
        const log = {
            index: index + 1,
            groupId: groupId,
            input: testCase.input,
            hasStandardAnswer: !!standardAnswer,
            timestamp: new Date().toISOString(),
            steps: [],
            comparison: null  // ğŸ†• å¯¹æ¯”ç»“æœ
        };
        
        try {
            // è°ƒç”¨åç«¯è®¡ç®—
            const sanitizedInput = sanitizeText(testCase.input);
            const config = getOddsConfig();
            const mcData = appState.lotteryData['xam'];
            const hkData = appState.lotteryData['hk'];
            const mcNums = (mcData?.numbers && mcData.numbers.length === 7) 
                ? mcData.numbers 
                : appState.lotteryNumbers || [41, 27, 6, 44, 15, 39, 12];
            const hkNums = (hkData?.numbers && hkData.numbers.length === 7) 
                ? hkData.numbers : null;
            
            const aiProvider = localStorage.getItem('ai_provider') || 'tuzi';
            const backendResult = await callBackendCalc(sanitizedInput, mcNums, config, aiProvider, null, hkNums);
            
            const elapsed = Date.now() - startTime;
            
            if (!backendResult.success || !backendResult.items?.length) {
                log.steps.push({ step: 'error', message: backendResult.error || 'è§£æå¤±è´¥' });
                batchTestState.logs.push(log);
                return {
                    index: index + 1,
                    groupId: groupId,
                    input: testCase.input,
                    status: 'fail',
                    details: { error: backendResult.error || 'è§£æå¤±è´¥' },
                    elapsed: elapsed,
                    comparison: null
                };
            }
            
            // ğŸ†• æ„å»ºå®é™…è¾“å‡ºæ•°æ®
            // ğŸ†• v2.2 ä¿®å¤å­—æ®µåï¼šåç«¯è¿”å› w/v/codeï¼Œä¸æ˜¯ isWin/winAmount/type
            const actualOutput = {
                header: {
                    æ€»æ³¨: backendResult.items.length,
                    æ€»æŠ•: backendResult.s1 || 0,
                    ä¸­å¥–: backendResult.items.filter(it => it.w).length,  // ğŸ†• ä¿®å¤: w ä¸æ˜¯ isWin
                    æ´¾å½©: backendResult.items.filter(it => it.w).reduce((s, it) => s + (it.v || 0), 0),  // ğŸ†• ä¿®å¤: v ä¸æ˜¯ winAmount
                    ç›ˆäº: (backendResult.s4 || 0)
                },
                records: backendResult.items.map((item, idx) => ({
                    seq: idx + 1,
                    lt: item.lt === 'hk' ? 'é¦™' : 'æ¾³',
                    type: item.code || 'T01',  // ğŸ†• ä¿®å¤: code ä¸æ˜¯ type
                    raw: item.raw || '',
                    numbers: formatItemNumbers(item),
                    amount: item.a || item.amount || 0,
                    bets: 1,
                    subtotal: item.a || item.amount || 0,
                    win: item.w || false  // ğŸ†• ä¿®å¤: w ä¸æ˜¯ isWin
                }))
            };
            
            log.steps.push({ step: 'calculated', output: actualOutput });
            
            // ğŸ†• ä¸æ ‡å‡†ç­”æ¡ˆå¯¹æ¯”
            let status = 'warn';  // é»˜è®¤å¾…éªŒè¯
            let comparison = null;
            
            if (standardAnswer) {
                // ğŸ†• v2.1 åˆå¹¶å±•å¼€çš„è®°å½•åå†å¯¹æ¯”
                // åç«¯è¿”å›æ¯ä¸ªå·ç ä¸€æ¡è®°å½•ï¼Œæ ‡å‡†ç­”æ¡ˆæ˜¯æŒ‰ç”¨æˆ·è¾“å…¥åˆ†ç»„çš„
                const mergedOutput = mergeRecordsByRaw(actualOutput);
                log.steps.push({ step: 'merged', mergedRecords: mergedOutput.records.length, originalRecords: actualOutput.records.length });
                
                comparison = compareWithStandard(mergedOutput, standardAnswer, groupId);
                log.comparison = comparison;
                status = comparison.allMatch ? 'pass' : 'fail';
                
                // è°ƒè¯•æ—¥å¿—
                console.log(`[ç»„${groupId}] åˆå¹¶å‰: ${actualOutput.records.length}æ¡, åˆå¹¶å: ${mergedOutput.records.length}æ¡, æœŸæœ›: ${standardAnswer.records?.length || 0}æ¡`);
            }
            
            batchTestState.logs.push(log);
            
            // ğŸ†• v2.1 è¿”å›åˆå¹¶åçš„æ•°æ®ç”¨äºæ˜¾ç¤º
            const mergedForDisplay = standardAnswer ? mergeRecordsByRaw(actualOutput) : actualOutput;
            
            return {
                index: index + 1,
                groupId: groupId,
                input: testCase.input,
                status: status,
                details: {
                    actual: actualOutput,           // åŸå§‹å±•å¼€æ•°æ®
                    actualMerged: mergedForDisplay, // åˆå¹¶åæ•°æ®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
                    expected: standardAnswer,
                    itemCount: backendResult.items.length,
                    mergedCount: mergedForDisplay.records.length,
                    s1: backendResult.s1,
                    s4: backendResult.s4
                },
                comparison: comparison,
                elapsed: elapsed
            };
            
        } catch (error) {
            log.steps.push({ step: 'error', message: error.message });
            batchTestState.logs.push(log);
            
            return {
                index: index + 1,
                groupId: groupId,
                input: testCase.input,
                status: 'fail',
                details: { error: error.message },
                elapsed: Date.now() - startTime,
                comparison: null
            };
        }
    }
    
    // ğŸ†• v2.2 æ ¼å¼åŒ–å·ç æ˜¾ç¤ºï¼ˆä¿®å¤åç«¯å­—æ®µåï¼‰
    function formatItemNumbers(item) {
        const Z_TO_NAME = {
            'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
            'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
            'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
        };
        
        // åç«¯è¿”å›: z=ç”Ÿè‚–ä»£å·(å¦‚Z1), n=å·ç æ•°ç»„(å¦‚[9,21,33,45])
        const zodiac = item.z || item.zodiac;
        const numbers = item.n || [];
        
        if (zodiac && Z_TO_NAME[zodiac] && numbers.length > 0) {
            // ç”Ÿè‚–+å·ç æ ¼å¼: é¸¡09,21,33,45
            const zName = Z_TO_NAME[zodiac];
            const numStr = numbers.map(n => String(n).padStart(2, '0')).join(',');
            return zName + numStr;
        } else if (numbers.length > 0) {
            // çº¯å·ç æ ¼å¼: 09,21,33,45
            return numbers.map(n => String(n).padStart(2, '0')).join(',');
        }
        
        return item.value || item.number || '';
    }
    
    // ğŸ†• v2.0 ä¸æ ‡å‡†ç­”æ¡ˆå¯¹æ¯”
    function compareWithStandard(actual, expected, groupId) {
        const mismatches = [];
        let allMatch = true;
        
        // 1. å¯¹æ¯”å¤´éƒ¨æ±‡æ€»
        if (expected.header) {
            const headerFields = ['æ€»æ³¨', 'æ€»æŠ•', 'ä¸­å¥–', 'æ´¾å½©', 'ç›ˆäº'];
            headerFields.forEach(field => {
                const expVal = parseInt(expected.header[field]) || 0;
                const actVal = parseInt(actual.header[field]) || 0;
                if (expVal !== actVal) {
                    mismatches.push({
                        type: 'header',
                        field: field,
                        expected: expVal,
                        actual: actVal,
                        diff: actVal - expVal
                    });
                    allMatch = false;
                }
            });
        }
        
        // 2. å¯¹æ¯”è®°å½•æ•°
        if (expected.records && expected.records.length !== actual.records.length) {
            mismatches.push({
                type: 'count',
                expected: expected.records.length,
                actual: actual.records.length
            });
            allMatch = false;
        }
        
        // 3. é€æ¡å¯¹æ¯”è®°å½•
        if (expected.records) {
            expected.records.forEach((expRec, idx) => {
                const actRec = actual.records[idx];
                if (!actRec) {
                    mismatches.push({
                        type: 'missing',
                        seq: expRec.seq,
                        expected: expRec
                    });
                    allMatch = false;
                    return;
                }
                
                // å¯¹æ¯”å„å­—æ®µ
                const recMismatches = [];
                
                // ç±»å‹
                if (expRec.type && actRec.type && !typesMatch(expRec.type, actRec.type)) {
                    recMismatches.push({ field: 'ç±»å‹', expected: expRec.type, actual: actRec.type });
                }
                
                // å·ç ï¼ˆğŸ†• v2.1 å®½æ¾åŒ¹é…ï¼šæå–å…³é”®ä¿¡æ¯å¯¹æ¯”ï¼‰
                if (expRec.numbers && !numbersMatch(expRec.numbers, actRec.numbers)) {
                    recMismatches.push({ field: 'å·ç ', expected: expRec.numbers, actual: actRec.numbers });
                }
                
                // é‡‘é¢
                if (expRec.amount !== actRec.amount) {
                    recMismatches.push({ field: 'é‡‘é¢', expected: expRec.amount, actual: actRec.amount });
                }
                
                // æ³¨æ•°
                if (expRec.bets !== actRec.bets) {
                    recMismatches.push({ field: 'æ³¨æ•°', expected: expRec.bets, actual: actRec.bets });
                }
                
                // å°è®¡
                if (expRec.subtotal !== actRec.subtotal) {
                    recMismatches.push({ field: 'å°è®¡', expected: expRec.subtotal, actual: actRec.subtotal });
                }
                
                // ä¸­å¥–
                if (expRec.win !== actRec.win) {
                    recMismatches.push({ field: 'ä¸­å¥–', expected: expRec.win ? 'âœ“' : 'âœ—', actual: actRec.win ? 'âœ“' : 'âœ—' });
                }
                
                if (recMismatches.length > 0) {
                    mismatches.push({
                        type: 'record',
                        seq: idx + 1,
                        mismatches: recMismatches
                    });
                    allMatch = false;
                }
            });
        }
        
        return {
            groupId: groupId,
            allMatch: allMatch,
            mismatches: mismatches
        };
    }
    
    // ğŸ†• v2.0 ç±»å‹åŒ¹é…ï¼ˆæ”¯æŒä»£ç å’Œä¸­æ–‡åï¼‰
    function typesMatch(type1, type2) {
        const TYPE_MAP = {
            'T01': 'ç‰¹ç ', 'SXTM': 'ç‰¹ç ', 'ç‰¹ç ': 'ç‰¹ç ',
            'PT1': 'å¹³ç‰¹ä¸€è‚–', 'å¹³ç‰¹ä¸€è‚–': 'å¹³ç‰¹ä¸€è‚–',
            'PT2': 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹äºŒè¿è‚–': 'å¹³ç‰¹äºŒè¿è‚–',
            'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–': 'å¹³ç‰¹ä¸‰è¿è‚–',
            'PT4': 'å¹³ç‰¹å››è¿è‚–', 'å¹³ç‰¹å››è¿è‚–': 'å¹³ç‰¹å››è¿è‚–',
            'PT5': 'å¹³ç‰¹äº”è¿è‚–', 'å¹³ç‰¹äº”è¿è‚–': 'å¹³ç‰¹äº”è¿è‚–',
            'SX6': 'å…­è‚–', 'LX': 'å…­è‚–', 'å…­è‚–': 'å…­è‚–'
        };
        const norm1 = TYPE_MAP[type1] || type1;
        const norm2 = TYPE_MAP[type2] || type2;
        return norm1 === norm2;
    }
    
    // ğŸ†• v2.1 å·ç å®½æ¾åŒ¹é…ï¼ˆæå–æ•°å­—å’Œç”Ÿè‚–å…³é”®ä¿¡æ¯å¯¹æ¯”ï¼‰
    function numbersMatch(expected, actual) {
        if (!expected || !actual) return !expected && !actual;
        if (expected === actual) return true;
        
        // æå–æ‰€æœ‰æ•°å­—
        const extractNumbers = str => {
            const nums = str.match(/\d+/g) || [];
            return nums.map(n => parseInt(n)).sort((a, b) => a - b).join(',');
        };
        
        // æå–æ‰€æœ‰ç”Ÿè‚–
        const extractZodiacs = str => {
            const zodiacs = str.match(/[é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]/g) || [];
            return [...new Set(zodiacs)].sort().join('');
        };
        
        // å¯¹æ¯”æ•°å­—æ˜¯å¦ä¸€è‡´
        const expNums = extractNumbers(expected);
        const actNums = extractNumbers(actual);
        
        // å¯¹æ¯”ç”Ÿè‚–æ˜¯å¦ä¸€è‡´
        const expZod = extractZodiacs(expected);
        const actZod = extractZodiacs(actual);
        
        // æ•°å­—å’Œç”Ÿè‚–éƒ½åŒ¹é…æ‰ç®—é€šè¿‡
        // å¦‚æœæ˜¯çº¯æ•°å­—æ ¼å¼ï¼Œåªå¯¹æ¯”æ•°å­—
        // å¦‚æœåŒ…å«ç”Ÿè‚–ï¼Œåªå¯¹æ¯”ç”Ÿè‚–ï¼ˆå› ä¸ºç”Ÿè‚–ä¼šå±•å¼€æˆæ•°å­—ï¼‰
        if (expZod && actZod) {
            return expZod === actZod;
        } else if (expNums && actNums) {
            return expNums === actNums;
        }
        
        return false;
    }
    
    // ğŸ†• v2.2 åˆå¹¶å±•å¼€çš„è®°å½•ï¼ˆæŒ‰åŸæ–‡rawåˆ†ç»„ï¼‰
    // åç«¯è¿”å›æ¯ä¸ªå·ç ä¸€æ¡è®°å½•ï¼Œæ ‡å‡†ç­”æ¡ˆæ˜¯æŒ‰ç”¨æˆ·è¾“å…¥åˆ†ç»„çš„
    // æ­¤å‡½æ•°å°†ç›¸åŒrawçš„è®°å½•åˆå¹¶ï¼Œä½¿å…¶ä¸æ ‡å‡†ç­”æ¡ˆæ ¼å¼åŒ¹é…
    function mergeRecordsByRaw(actualOutput) {
        if (!actualOutput || !actualOutput.records || actualOutput.records.length === 0) {
            return actualOutput;
        }
        
        const Z_TO_NAME = {
            'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
            'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
            'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
        };
        
        // ğŸ†• v2.2 ä» raw æ¨æ–­æ­£ç¡®çš„ç±»å‹ï¼ˆåç«¯å±•å¼€åtypeå¯èƒ½ä¸¢å¤±ï¼‰
        function inferTypeFromRaw(raw, backendType) {
            // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ç±»å‹ï¼ˆå¦‚æœä¸æ˜¯T01ï¼‰
            if (backendType && !['T01', 'SXTM', 'UK'].includes(backendType)) {
                return backendType;
            }
            // ä» raw å…³é”®è¯æ¨æ–­ç±»å‹
            if (/å…­è‚–|6è‚–/.test(raw)) return 'SX6';
            if (/äº”å‹/.test(raw)) return 'PT5';
            if (/å››å‹/.test(raw)) return 'PT4';
            if (/ä¸‰å‹/.test(raw)) return 'PT3';
            if (/äºŒå‹|ä¸¤å‹/.test(raw)) return 'PT2';
            if (/å¹³ç‰¹|ä¸€å‹/.test(raw)) return 'PT1';
            return backendType || 'T01';
        }
        
        // æŒ‰ raw åˆ†ç»„
        const groups = {};
        const groupOrder = []; // ä¿æŒåŸå§‹é¡ºåº
        
        actualOutput.records.forEach(rec => {
            // æ¸…ç†rawä¸­çš„Zä»£å·ï¼Œç»Ÿä¸€æ ¼å¼ç”¨äºåˆ†ç»„
            const rawKey = (rec.raw || '').trim();
            if (!rawKey) return;
            
            if (!groups[rawKey]) {
                groups[rawKey] = [];
                groupOrder.push(rawKey);
            }
            groups[rawKey].push(rec);
        });
        
        // åˆå¹¶æ¯ç»„è®°å½•
        const mergedRecords = groupOrder.map((rawKey, idx) => {
            const group = groups[rawKey];
            if (!group || group.length === 0) return null;
            
            const first = group[0];
            
            // ğŸ†• v2.2 ä» raw æ¨æ–­æ­£ç¡®çš„ç±»å‹
            const inferredType = inferTypeFromRaw(rawKey, first.type);
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºå¤åˆç±»å‹ï¼ˆå…­è‚–ã€å¹³ç‰¹è¿è‚–ç­‰åªç®—1æ³¨ï¼‰
            const isCompositeType = ['SX6', 'LX', 'PT2', 'PT3', 'PT4', 'PT5'].includes(inferredType);
            
            // æ”¶é›†æ‰€æœ‰å·ç 
            const allNumbers = [];
            group.forEach(rec => {
                if (rec.numbers) {
                    allNumbers.push(rec.numbers);
                }
            });
            
            // åˆå¹¶å·ç æ ¼å¼
            let mergedNumbers = '';
            if (isCompositeType && ['SX6', 'LX'].includes(inferredType)) {
                // å…­è‚–ï¼šæå–ç”Ÿè‚–åç§°
                const zodiacs = new Set();
                allNumbers.forEach(n => {
                    // å°è¯•æå–ç”Ÿè‚–å
                    const match = n.match(/^(é¼ |ç‰›|è™|å…”|é¾™|è›‡|é©¬|ç¾Š|çŒ´|é¸¡|ç‹—|çŒª)/);
                    if (match) zodiacs.add(match[1]);
                });
                // å¦‚æœæ²¡æœ‰æå–åˆ°ç”Ÿè‚–ï¼Œä»rawä¸­æå–Zä»£å·è½¬æ¢
                if (zodiacs.size === 0) {
                    const zCodes = rawKey.match(/Z\d+/g) || [];
                    zCodes.forEach(z => {
                        if (Z_TO_NAME[z]) zodiacs.add(Z_TO_NAME[z]);
                    });
                }
                mergedNumbers = Array.from(zodiacs).join(',');
            } else if (isCompositeType) {
                // å¹³ç‰¹è¿è‚–ï¼šæå–ç”Ÿè‚–åç§°
                const zodiacs = new Set();
                allNumbers.forEach(n => {
                    const match = n.match(/^(é¼ |ç‰›|è™|å…”|é¾™|è›‡|é©¬|ç¾Š|çŒ´|é¸¡|ç‹—|çŒª)/);
                    if (match) zodiacs.add(match[1]);
                });
                // å¦‚æœæ²¡æœ‰æå–åˆ°ç”Ÿè‚–ï¼Œä»rawä¸­æå–Zä»£å·è½¬æ¢
                if (zodiacs.size === 0) {
                    const zCodes = rawKey.match(/Z\d+/g) || [];
                    zCodes.forEach(z => {
                        if (Z_TO_NAME[z]) zodiacs.add(Z_TO_NAME[z]);
                    });
                }
                mergedNumbers = Array.from(zodiacs).join(',');
            } else {
                // ç‰¹ç ç­‰ï¼šåˆå¹¶æ‰€æœ‰å·ç 
                mergedNumbers = allNumbers.join(',');
            }
            
            // è®¡ç®—åˆå¹¶åçš„å€¼
            const bets = isCompositeType ? 1 : group.length;
            const subtotal = group.reduce((sum, rec) => sum + (rec.subtotal || rec.amount || 0), 0);
            const anyWin = group.some(rec => rec.win);
            
            // è·å–ç±»å‹çš„ä¸­æ–‡å
            const TYPE_TO_CN = {
                'T01': 'ç‰¹ç ', 'SXTM': 'ç‰¹ç ',
                'PT1': 'å¹³ç‰¹ä¸€è‚–',
                'PT2': 'å¹³ç‰¹äºŒè¿è‚–',
                'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–',
                'PT4': 'å¹³ç‰¹å››è¿è‚–',
                'PT5': 'å¹³ç‰¹äº”è¿è‚–',
                'SX6': 'å…­è‚–', 'LX': 'å…­è‚–'
            };
            const typeCn = TYPE_TO_CN[inferredType] || inferredType;
            
            return {
                seq: idx + 1,
                lt: first.lt,
                type: typeCn,
                typeCode: inferredType, // ä¿ç•™ç±»å‹ä»£ç ç”¨äºéªŒè¯
                raw: rawKey,
                numbers: mergedNumbers,
                amount: first.amount,
                bets: bets,
                subtotal: subtotal,
                win: anyWin
            };
        }).filter(Boolean);
        
        // é‡æ–°è®¡ç®—æ±‡æ€»ï¼ˆä½¿ç”¨åˆå¹¶åçš„è®°å½•ï¼‰
        const mergedHeader = {
            æ€»æ³¨: mergedRecords.reduce((sum, rec) => sum + rec.bets, 0),
            æ€»æŠ•: actualOutput.header.æ€»æŠ•, // æ€»æŠ•ä¿æŒä¸å˜
            ä¸­å¥–: mergedRecords.filter(rec => rec.win).length,
            æ´¾å½©: actualOutput.header.æ´¾å½©, // æ´¾å½©ä¿æŒä¸å˜
            ç›ˆäº: actualOutput.header.ç›ˆäº  // ç›ˆäºä¿æŒä¸å˜
        };
        
        return {
            header: mergedHeader,
            records: mergedRecords
        };
    }
    
    // ğŸ†• v2.0 æ˜¾ç¤ºæµ‹è¯•ç»“æœï¼ˆå¸¦å¯¹æ¯”è¯¦æƒ…ï¼‰
    function appendResultToListV2(result, index) {
        const listEl = document.getElementById('batch-result-list');
        const statusIcon = result.status === 'pass' ? 'âœ…' : result.status === 'fail' ? 'âŒ' : 'âš ï¸';
        const statusColor = result.status === 'pass' ? '#4ade80' : result.status === 'fail' ? '#ef5350' : '#ffa726';
        
        const inputDisplay = result.input.includes('\n')
            ? result.input.split('\n')[0].substring(0, 30) + '...(å…±' + result.input.split('\n').length + 'è¡Œ)'
            : result.input.substring(0, 50);
        
        let detailHtml = '';
        
        if (result.details?.error) {
            detailHtml = `<span style="color:#ef5350;">${result.details.error}</span>`;
        } else if (result.comparison) {
            // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
            const comp = result.comparison;
            if (comp.allMatch) {
                detailHtml = `<span style="color:#4ade80;">âœ… å…¨éƒ¨åŒ¹é… | æ€»æ³¨:${result.details.actual.header.æ€»æ³¨} | æ€»æŠ•:${result.details.actual.header.æ€»æŠ•}</span>`;
            } else {
                const mismatchSummary = comp.mismatches.slice(0, 3).map(m => {
                    if (m.type === 'header') return `${m.field}(æœŸæœ›${m.expected},å®é™…${m.actual})`;
                    if (m.type === 'count') return `è®°å½•æ•°(æœŸæœ›${m.expected},å®é™…${m.actual})`;
                    if (m.type === 'record') return `ç¬¬${m.seq}æ¡:${m.mismatches.map(mm => mm.field).join(',')}`;
                    return '';
                }).join('; ');
                detailHtml = `<span style="color:#ef5350;">âŒ ä¸åŒ¹é…: ${mismatchSummary}</span>`;
            }
        } else {
            // æ— æ ‡å‡†ç­”æ¡ˆï¼Œæ˜¾ç¤ºå®é™…ç»“æœ
            const act = result.details?.actual;
            if (act) {
                detailHtml = `æ€»æ³¨:${act.header.æ€»æ³¨} | æ€»æŠ•:${act.header.æ€»æŠ•} | ä¸­å¥–:${act.header.ä¸­å¥–} | <span style="color:#888;">(å¾…éªŒè¯)</span>`;
            }
        }
        
        const itemHtml = `
            <div style="padding:8px;margin-bottom:4px;background:rgba(0,0,0,0.2);border-radius:4px;border-left:3px solid ${statusColor};">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="flex:1;">
                        <span style="color:${statusColor};">${statusIcon}</span>
                        <span style="color:#fff;font-weight:bold;">[ç»„${result.groupId}]</span>
                        <span style="color:#ccc;">${inputDisplay}</span>
                    </div>
                    <span style="color:#888;font-size:10px;">${result.elapsed}ms</span>
                </div>
                <div style="font-size:10px;color:#888;margin-top:4px;">${detailHtml}</div>
            </div>
        `;
        
        listEl.innerHTML += itemHtml;
        listEl.scrollTop = listEl.scrollHeight;
    }
    
    // ğŸ†• v3.12.2 æ‰§è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ + å¢å¼ºæ—¥å¿—ï¼‰
    async function executeTestCase(testCase, index) {
        const startTime = Date.now();
        const isMultiLine = testCase.input.includes('\n');
        const inputPreview = isMultiLine 
            ? testCase.input.split('\n')[0] + '...(å…±' + testCase.input.split('\n').length + 'è¡Œ)'
            : testCase.input;
        
        const log = {
            index: index + 1,
            groupId: testCase.groupId || (index + 1),
            input: testCase.input,
            inputPreview: inputPreview,
            isMultiLine: isMultiLine,
            timestamp: new Date().toISOString(),
            steps: [],
            backendDebug: null  // ğŸ†• ä¿å­˜åç«¯debugä¿¡æ¯
        };
        
        try {
            // ç¡®ä¿ settings å·²å®šä¹‰ï¼ˆé˜²æ­¢æ—§ä»£ç ç¼“å­˜é—®é¢˜ï¼‰
            const settings = typeof getFormatSettings === 'function' ? getFormatSettings() : { aiEnabled: true };
            
            // æ­¥éª¤1: å‰ç«¯é¢„å¤„ç†ï¼ˆsanitizeTextï¼‰
            const sanitizedInput = sanitizeText(testCase.input);
            log.steps.push({ 
                step: 'sanitizeText', 
                inputLines: testCase.input.split('\n').length,
                outputLines: sanitizedInput.split('\n').length,
                result: sanitizedInput.substring(0, 200) + (sanitizedInput.length > 200 ? '...' : '')
            });
            
            // æ­¥éª¤2: è°ƒç”¨åç«¯API
            const config = getOddsConfig();
            const mcData = appState.lotteryData['xam'];
            const hkData = appState.lotteryData['hk'];
            const mcNums = (mcData?.numbers && mcData.numbers.length === 7) 
                ? mcData.numbers 
                : appState.lotteryNumbers || [41, 27, 6, 44, 15, 39, 12];
            const hkNums = (hkData?.numbers && hkData.numbers.length === 7) 
                ? hkData.numbers 
                : null;
            
            log.steps.push({ step: 'prepareRequest', mcNums, hkNums });
            
            const aiProvider = localStorage.getItem('ai_provider') || 'tuzi';
            const backendResult = await callBackendCalc(
                sanitizedInput,
                mcNums,
                config,
                aiProvider,
                null,
                hkNums
            );
            
            // ğŸ†• ä¿å­˜åç«¯debugä¿¡æ¯
            log.backendDebug = {
                latency_ms: backendResult.latency_ms,
                s1: backendResult.s1,  // æ€»æŠ•æ³¨
                s4: backendResult.s4,  // æ€»ç›ˆäº
                itemCount: backendResult.items?.length || 0,
                // ç»Ÿè®¡å¤„ç†æ¥æº
                sourceStats: {}
            };
            
            if (backendResult.items) {
                backendResult.items.forEach(item => {
                    const src = item.source || 'unknown';
                    log.backendDebug.sourceStats[src] = (log.backendDebug.sourceStats[src] || 0) + 1;
                });
            }
            
            log.steps.push({ 
                step: 'backendResponse', 
                success: backendResult.success, 
                itemCount: backendResult.items?.length || 0,
                latency_ms: backendResult.latency_ms,
                sources: log.backendDebug.sourceStats
            });
            
            const elapsed = Date.now() - startTime;
            
            // è§£æç»“æœ
            let status = 'unknown';
            let details = {};
            
            if (backendResult.success && backendResult.items?.length > 0) {
                const items = backendResult.items;
                // ğŸ†• v3.5.1 ä¿®å¤ï¼šæ³¨æ•°ç»Ÿè®¡ä¸é¦–é¡µä¸€è‡´ï¼Œç›´æ¥ä½¿ç”¨ items.length
                // é¦–é¡µæ˜¾ç¤ºçš„ "è¯†åˆ« X æ³¨" ä½¿ç”¨çš„æ˜¯ calcResults.length
                const totalBets = items.length;
                const totalAmount = backendResult.s1 || items.reduce((sum, item) => sum + (item.a || 0), 0);
                const firstItem = items[0];
                
                // ç±»å‹æ˜ å°„ï¼ˆä¸é¦–é¡µ FB_TYPE_CODE_TO_NAME ä¿æŒä¸€è‡´ï¼‰
                const TYPE_MAP = {
                    'T01': 'ç‰¹ç ', 'SXTM': 'ç‰¹ç ', 'SX': 'ç”Ÿè‚–', 'ç”Ÿè‚–ç‰¹ç ': 'ç‰¹ç ',
                    'PT1': 'å¹³ç‰¹ä¸€è‚–', 'PT2': 'å¹³ç‰¹äºŒè¿è‚–', 'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–',
                    'PT4': 'å¹³ç‰¹å››è¿è‚–', 'PT5': 'å¹³ç‰¹äº”è¿è‚–', 'PTW': 'å¹³ç‰¹å°¾æ•°',
                    'LX': 'å…­è‚–', 'LX6': 'å…­è‚–', 'SX6': 'å…­è‚–', '6X': 'å…­è‚–', 'LIUXIAO': 'å…­è‚–',
                    'TX': 'ç‰¹è‚–', 'HX': 'åˆè‚–', 'ZX': 'æ­£è‚–',
                    'BS': 'æ³¢è‰²', 'BB': 'åŠæ³¢', 'DP': 'å•å¹³', 'DXDS': 'å¤§å°å•åŒ',
                    'XS': 'å°æ•°', 'DS': 'å¤§æ•°', 'ODD': 'å•æ•°', 'EVEN': 'åŒæ•°',
                    'E2': 'äºŒä¸­äºŒ', 'S3': 'ä¸‰ä¸­ä¸‰', 'BZ': 'ä¸ä¸­',
                    'LM': 'è¿ç ', 'ZH': 'æ€»å’Œ', 'WX': 'äº”è¡Œ', 'JY': 'å®¶é‡',
                    'UK': 'ç‰¹ç '  // æœªçŸ¥ç±»å‹é»˜è®¤ä¸ºç‰¹ç 
                };
                
                // ğŸ†• å¤šè¡Œè¾“å…¥æ—¶ç»Ÿè®¡æ‰€æœ‰ç±»å‹
                const typeStats = {};
                items.forEach(item => {
                    const t = TYPE_MAP[item.code] || item.code;
                    typeStats[t] = (typeStats[t] || 0) + 1;
                });
                
                const actualType = TYPE_MAP[firstItem.code] || firstItem.code;
                const actualAmount = firstItem.a || 0;
                const actualBets = totalBets;
                const source = firstItem.source || 'unknown';
                
                details = {
                    type: actualType,
                    amount: actualAmount,
                    bets: actualBets,
                    source: source,
                    itemCount: items.length,
                    totalAmount: totalAmount,
                    typeStats: typeStats,  // ğŸ†• ç±»å‹ç»Ÿè®¡
                    sourceStats: log.backendDebug.sourceStats,  // ğŸ†• æ¥æºç»Ÿè®¡
                    // ğŸ†• ç²¾ç®€rawï¼Œåªä¿ç•™å…³é”®å­—æ®µ
                    rawSummary: items.slice(0, 5).map(it => ({
                        code: it.code,
                        raw: (it.raw || '').substring(0, 30),
                        a: it.a,
                        n: it.n,
                        source: it.source
                    }))
                };
                
                log.steps.push({ step: 'parseResult', details: { type: actualType, bets: totalBets, itemCount: items.length } });
                
                // ä¸æœŸæœ›å€¼å¯¹æ¯”
                if (testCase.expected) {
                    const exp = testCase.expected;
                    const typeMatch = !exp.type || actualType === exp.type || actualType.includes(exp.type) || exp.type.includes(actualType);
                    const amountMatch = exp.amount === null || actualAmount === exp.amount;
                    const betsMatch = exp.bets === null || actualBets === exp.bets;
                    // ğŸ†• v3.12.5 å¢åŠ æ€»æŠ•æ³¨é¢éªŒè¯
                    const actualTotalBet = backendResult.s1 || totalAmount;
                    const totalBetMatch = exp.totalBet === null || exp.totalBet === undefined || actualTotalBet === exp.totalBet;
                    
                    // ä¿å­˜æ€»æŠ•æ³¨åˆ°details
                    details.totalBet = actualTotalBet;
                    details.s4 = backendResult.s4;  // æ€»ç›ˆäº
                    
                    if (typeMatch && amountMatch && betsMatch && totalBetMatch) {
                        status = 'pass';
                    } else {
                        status = 'fail';
                        details.mismatch = {
                            type: !typeMatch ? { expected: exp.type, actual: actualType } : null,
                            amount: !amountMatch ? { expected: exp.amount, actual: actualAmount } : null,
                            bets: !betsMatch ? { expected: exp.bets, actual: actualBets } : null,
                            totalBet: !totalBetMatch ? { expected: exp.totalBet, actual: actualTotalBet } : null
                        };
                    }
                } else {
                    status = 'warn'; // æ— æœŸæœ›å€¼ï¼Œå¾…éªŒè¯
                    // å³ä½¿æ— æœŸæœ›å€¼ï¼Œä¹Ÿä¿å­˜æ€»æŠ•æ³¨ä¿¡æ¯
                    details.totalBet = backendResult.s1 || totalAmount;
                    details.s4 = backendResult.s4;
                }
            } else {
                status = 'fail';
                details = { error: backendResult.error || 'è§£æå¤±è´¥' };
            }
            
            log.steps.push({ step: 'finalStatus', status });
            batchTestState.logs.push(log);
            
            return {
                index: index + 1,
                groupId: testCase.groupId || (index + 1),  // ğŸ†• ç»„ID
                input: testCase.input,
                expected: testCase.expected,
                group: testCase.group,
                status: status,
                details: details,
                elapsed: elapsed,
                isMultiLine: isMultiLine  // ğŸ†• æ˜¯å¦å¤šè¡Œ
            };
            
        } catch (error) {
            log.steps.push({ step: 'error', message: error.message });
            batchTestState.logs.push(log);
            
            return {
                index: index + 1,
                groupId: testCase.groupId || (index + 1),
                input: testCase.input,
                expected: testCase.expected,
                group: testCase.group,
                status: 'fail',
                details: { error: error.message },
                elapsed: Date.now() - startTime,
                isMultiLine: isMultiLine
            };
        }
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress(current, total) {
        const percent = (current / total) * 100;
        document.getElementById('batch-progress-fill').style.width = percent + '%';
        document.getElementById('batch-progress-text').textContent = `è¿›åº¦ï¼š${current}/${total}`;
        
        // é¢„ä¼°å‰©ä½™æ—¶é—´
        if (current > 1 && batchTestState.startTime) {
            const elapsed = Date.now() - batchTestState.startTime;
            const avgTime = elapsed / current;
            const remaining = avgTime * (total - current);
            const remainingSec = Math.ceil(remaining / 1000);
            document.getElementById('batch-progress-time').textContent = `é¢„è®¡å‰©ä½™ï¼š${remainingSec}ç§’`;
        }
    }
    
    // æ·»åŠ ç»“æœåˆ°åˆ—è¡¨
    // ğŸ†• v3.12.2 æ˜¾ç¤ºæµ‹è¯•ç»“æœï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ï¼‰
    function appendResultToList(result, index) {
        const listEl = document.getElementById('batch-result-list');
        const statusIcon = result.status === 'pass' ? 'âœ…' : result.status === 'fail' ? 'âŒ' : 'âš ï¸';
        const statusColor = result.status === 'pass' ? '#4ade80' : result.status === 'fail' ? '#ef5350' : '#ffa726';
        
        // å¤„ç†å¤šè¡Œè¾“å…¥çš„æ˜¾ç¤º
        const isMultiLine = result.input && result.input.includes('\n');
        const inputDisplay = isMultiLine 
            ? result.input.split('\n')[0].substring(0, 30) + '...<span style="color:#60a5fa;">(å…±' + result.input.split('\n').length + 'è¡Œ)</span>'
            : (result.input || '').substring(0, 50);
        
        let detailHtml = '';
        if (result.details) {
            if (result.details.error) {
                detailHtml = `<span style="color:#ef5350;">${result.details.error}</span>`;
            } else {
                // ğŸ†• æ˜¾ç¤ºæ¥æºç»Ÿè®¡
                let sourceInfo = result.details.source || '-';
                if (result.details.sourceStats && Object.keys(result.details.sourceStats).length > 0) {
                    sourceInfo = Object.entries(result.details.sourceStats)
                        .map(([k, v]) => `${k}:${v}`)
                        .join(',');
                }
                
                // ğŸ†• v3.12.5 æ˜¾ç¤ºæ€»æŠ•æ³¨å’Œç›ˆäº
                const totalBetDisplay = result.details.totalBet || result.details.totalAmount || '-';
                const s4Display = result.details.s4 !== undefined ? result.details.s4 : '-';
                detailHtml = `ç±»å‹:${result.details.type} | é‡‘é¢:${result.details.amount} | æ³¨æ•°:${result.details.bets} | æ€»æŠ•:${totalBetDisplay} | ç›ˆäº:${s4Display} | [${sourceInfo}]`;
                
                if (result.details.mismatch) {
                    const mm = result.details.mismatch;
                    const parts = [];
                    if (mm.type) parts.push(`ç±»å‹: æœŸæœ›[${mm.type.expected}] å®é™…[${mm.type.actual}]`);
                    if (mm.amount) parts.push(`é‡‘é¢: æœŸæœ›[${mm.amount.expected}] å®é™…[${mm.amount.actual}]`);
                    if (mm.bets) parts.push(`æ³¨æ•°: æœŸæœ›[${mm.bets.expected}] å®é™…[${mm.bets.actual}]`);
                    detailHtml += `<br><span style="color:#ef5350;font-size:10px;">âš ï¸ ä¸åŒ¹é…: ${parts.join(', ')}</span>`;
                }
            }
        }
        
        const itemHtml = `
            <div style="padding:8px;margin-bottom:4px;background:rgba(0,0,0,0.2);border-radius:4px;border-left:3px solid ${statusColor};">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="flex:1;">
                        <span style="color:${statusColor};">${statusIcon}</span>
                        <span style="color:#fff;font-weight:bold;">[ç»„${result.groupId || result.index}]</span>
                        <span style="color:#ccc;">${inputDisplay}</span>
                        <span style="color:#666;font-size:10px;margin-left:8px;">(${result.group || '-'})</span>
                    </div>
                    <span style="color:#888;font-size:10px;">${result.elapsed}ms</span>
                </div>
                <div style="font-size:10px;color:#888;margin-top:4px;">${detailHtml}</div>
            </div>
        `;
        
        listEl.innerHTML += itemHtml;
        listEl.scrollTop = listEl.scrollHeight;
    }
    
    // å®Œæˆæ‰¹é‡æµ‹è¯•
    function finishBatchTest() {
        batchTestState.isRunning = false;
        
        // æ›´æ–°UI
        document.getElementById('run-batch-test-btn').style.display = 'inline-block';
        document.getElementById('stop-batch-test-btn').style.display = 'none';
        document.getElementById('batch-test-status').textContent = 'å®Œæˆ';
        document.getElementById('batch-test-status').style.color = '#4ade80';
        
        // ç»Ÿè®¡ç»“æœ
        const results = batchTestState.results;
        const passCount = results.filter(r => r.status === 'pass').length;
        const failCount = results.filter(r => r.status === 'fail').length;
        const warnCount = results.filter(r => r.status === 'warn').length;
        const avgTime = results.length > 0 ? Math.round(results.reduce((sum, r) => sum + r.elapsed, 0) / results.length) : 0;
        
        // æ˜¾ç¤ºç»Ÿè®¡
        document.getElementById('batch-summary').style.display = 'block';
        document.getElementById('batch-pass-count').textContent = passCount;
        document.getElementById('batch-fail-count').textContent = failCount;
        document.getElementById('batch-warn-count').textContent = warnCount;
        document.getElementById('batch-avg-time').textContent = avgTime;
        
        console.log('ğŸ§ª æ‰¹é‡æµ‹è¯•å®Œæˆ:', { passCount, failCount, warnCount, avgTime });
    }
    
    // åœæ­¢æ‰¹é‡æµ‹è¯•
    function stopBatchTest() {
        batchTestState.shouldStop = true;
        document.getElementById('batch-test-status').textContent = 'å·²åœæ­¢';
        document.getElementById('batch-test-status').style.color = '#ffa726';
    }
    
    // å¯¼å‡ºæ‰¹é‡æµ‹è¯•æŠ¥å‘Šï¼ˆç²¾ç®€ç‰ˆï¼‰
    function exportBatchReport(format) {
        if (batchTestState.results.length === 0) {
            alert('æ²¡æœ‰æµ‹è¯•ç»“æœå¯å¯¼å‡º');
            return;
        }
        
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        const passCount = batchTestState.results.filter(r => r.status === 'pass').length;
        const failCount = batchTestState.results.filter(r => r.status === 'fail').length;
        const warnCount = batchTestState.results.filter(r => r.status === 'warn').length;
        const avgTime = Math.round(batchTestState.results.reduce((sum, r) => sum + r.elapsed, 0) / batchTestState.results.length);
        
        // åˆ†ç±»å¤±è´¥åŸå› 
        const failReasons = {};
        batchTestState.results.filter(r => r.status === 'fail').forEach(r => {
            let reason = 'å…¶ä»–';
            if (r.details?.error) {
                reason = r.details.error.substring(0, 30);
            } else if (r.details?.mismatch) {
                if (r.details.mismatch.bets) reason = 'æ³¨æ•°é”™è¯¯';
                else if (r.details.mismatch.amount) reason = 'é‡‘é¢é”™è¯¯';
                else if (r.details.mismatch.type) reason = 'ç±»å‹é”™è¯¯';
            }
            failReasons[reason] = (failReasons[reason] || 0) + 1;
        });
        
        if (format === 'json') {
            // ğŸ†• ç²¾ç®€JSONï¼šåªä¿ç•™å¤±è´¥æ¡ˆä¾‹è¯¦æƒ…ï¼Œé€šè¿‡æ¡ˆä¾‹åªä¿ç•™æ‘˜è¦
            const failedResults = batchTestState.results
                .filter(r => r.status === 'fail')
                .map(r => ({
                    index: r.index,
                    input: r.input,
                    expected: r.expected,
                    actual: {
                        type: r.details?.type,
                        amount: r.details?.amount,
                        bets: r.details?.bets,
                        source: r.details?.source
                    },
                    mismatch: r.details?.mismatch,
                    error: r.details?.error,
                    elapsed: r.elapsed
                }));
            
            const report = {
                version: '2.0',  // ç²¾ç®€ç‰ˆ
                timestamp: new Date().toISOString(),
                summary: {
                    total: batchTestState.results.length,
                    pass: passCount,
                    fail: failCount,
                    warn: warnCount,
                    passRate: (passCount / batchTestState.results.length * 100).toFixed(1) + '%',
                    avgTime: avgTime + 'ms'
                },
                failReasons: failReasons,
                failedCases: failedResults,
                // é€šè¿‡æ¡ˆä¾‹åªä¿ç•™åºå·åˆ—è¡¨
                passedIndexes: batchTestState.results.filter(r => r.status === 'pass').map(r => r.index)
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            downloadBlob(blob, `test_report_${timestamp}.json`);
            
        } else if (format === 'csv') {
            // CSVæ ¼å¼ï¼ˆä¿æŒä¸å˜ï¼Œæ–¹ä¾¿ExcelæŸ¥çœ‹ï¼‰
            const headers = ['åºå·', 'è¾“å…¥', 'çŠ¶æ€', 'å®é™…ç±»å‹', 'å®é™…é‡‘é¢', 'å®é™…æ³¨æ•°', 'æ¥æº', 'è€—æ—¶ms', 'æœŸæœ›ç±»å‹', 'æœŸæœ›é‡‘é¢', 'æœŸæœ›æ³¨æ•°', 'é”™è¯¯'];
            const rows = batchTestState.results.map(r => [
                r.index,
                `"${r.input.replace(/"/g, '""')}"`,
                r.status === 'pass' ? 'âœ“é€šè¿‡' : r.status === 'fail' ? 'âœ—å¤±è´¥' : '?å¾…éªŒ',
                r.details?.type || '',
                r.details?.amount || '',
                r.details?.bets || '',
                r.details?.source || '',
                r.elapsed,
                r.expected?.type || '',
                r.expected?.amount || '',
                r.expected?.bets || '',
                r.details?.error || (r.details?.mismatch ? JSON.stringify(r.details.mismatch) : '')
            ]);
            
            // æ·»åŠ æ‘˜è¦è¡Œ
            const summaryRows = [
                [],
                ['=== æµ‹è¯•æ‘˜è¦ ==='],
                ['æ€»æ•°', batchTestState.results.length],
                ['é€šè¿‡', passCount],
                ['å¤±è´¥', failCount],
                ['é€šè¿‡ç‡', (passCount / batchTestState.results.length * 100).toFixed(1) + '%'],
                ['å¹³å‡è€—æ—¶', avgTime + 'ms']
            ];
            
            const csv = [headers.join(','), ...rows.map(r => r.join(',')), ...summaryRows.map(r => r.join(','))].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            downloadBlob(blob, `test_report_${timestamp}.csv`);
            
        } else if (format === 'log') {
            // ğŸ†• v2.0 å¢å¼ºæ—¥å¿—ï¼šåŒ…å«å®Œæ•´èƒŒæ™¯ä¿¡æ¯å’Œæ ‡å‡†ç­”æ¡ˆå¯¹æ¯”
            let logContent = `${'â•'.repeat(60)}\n`;
            logContent += `           æ‰¹é‡ç²¾å‡†æµ‹è¯•æŠ¥å‘Š v2.0\n`;
            logContent += `${'â•'.repeat(60)}\n\n`;
            
            // èƒŒæ™¯ä¿¡æ¯
            logContent += `ã€æµ‹è¯•ç¯å¢ƒã€‘\n`;
            logContent += `æ—¶é—´: ${new Date().toLocaleString()}\n`;
            const mcData = appState.lotteryData['xam'];
            const hkData = appState.lotteryData['hk'];
            logContent += `æ–°æ¾³å¼€å¥–: ${mcData?.numbers?.join(' ') || 'æœªè®¾ç½®'} (æœŸå·:${mcData?.issue || '-'})\n`;
            logContent += `é¦™æ¸¯å¼€å¥–: ${hkData?.numbers?.join(' ') || 'æœªè®¾ç½®'} (æœŸå·:${hkData?.issue || '-'})\n`;
            const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
            logContent += `èµ”ç‡è®¾ç½®: ç‰¹ç ${savedOdds['odds-tema'] || 43}å€ | å¹³ç‰¹${savedOdds['odds-pingte1'] || 11}å€ | å…­è‚–${savedOdds['odds-liuxiao'] || 4.2}å€\n`;
            logContent += `æœ‰æ ‡å‡†ç­”æ¡ˆ: ${Object.keys(batchTestState.standardAnswers).length}ç»„\n`;
            logContent += `\n${'â”€'.repeat(60)}\n\n`;
            
            // ç»Ÿè®¡æ‘˜è¦
            logContent += `ã€æµ‹è¯•æ‘˜è¦ã€‘\n`;
            logContent += `æ€»æ•°: ${batchTestState.results.length} | âœ…é€šè¿‡: ${passCount} | âŒå¤±è´¥: ${failCount} | âš ï¸å¾…éªŒè¯: ${warnCount}\n`;
            logContent += `é€šè¿‡ç‡: ${(passCount / batchTestState.results.length * 100).toFixed(1)}%\n`;
            logContent += `å¹³å‡è€—æ—¶: ${avgTime}ms\n`;
            logContent += `\n${'â•'.repeat(60)}\n\n`;
            
            // å¤±è´¥åŸå› ç»Ÿè®¡
            if (Object.keys(failReasons).length > 0) {
                logContent += `ã€å¤±è´¥åŸå› åˆ†ç±»ã€‘\n`;
                for (const [reason, count] of Object.entries(failReasons)) {
                    logContent += `  â€¢ ${reason}: ${count}ä¸ª\n`;
                }
                logContent += `\n${'â”€'.repeat(60)}\n\n`;
            }
            
            // è¾“å‡ºæ‰€æœ‰æ¡ˆä¾‹çš„è¯¦ç»†å¯¹æ¯”
            logContent += `ã€è¯¦ç»†å¯¹æ¯”æŠ¥å‘Šã€‘\n\n`;
            
            batchTestState.results.forEach((result, idx) => {
                const statusIcon = result.status === 'pass' ? 'âœ…' : result.status === 'fail' ? 'âŒ' : 'âš ï¸';
                const log = batchTestState.logs[idx];
                
                logContent += `${'â•'.repeat(60)}\n`;
                logContent += `${statusIcon} ç»„${result.groupId || result.index}\n`;
                logContent += `${'â”€'.repeat(60)}\n`;
                
                // åŸå§‹è¾“å…¥
                logContent += `ã€ç”¨æˆ·è¾“å…¥ã€‘\n${result.input}\n\n`;
                
                // ğŸ†• v2.0 æ ‡å‡†ç­”æ¡ˆå¯¹æ¯”
                if (result.comparison) {
                    const comp = result.comparison;
                    const expected = result.details?.expected;
                    // ğŸ†• v2.1 ä½¿ç”¨åˆå¹¶åçš„æ•°æ®è¿›è¡Œå¯¹æ¯”æ˜¾ç¤º
                    const actual = result.details?.actualMerged || result.details?.actual;
                    const originalCount = result.details?.actual?.records?.length || 0;
                    const mergedCount = actual?.records?.length || 0;
                    
                    // æ˜¾ç¤ºåˆå¹¶ä¿¡æ¯
                    if (originalCount !== mergedCount) {
                        logContent += `ã€è®°å½•åˆå¹¶ã€‘åç«¯è¿”å›${originalCount}æ¡ â†’ åˆå¹¶å${mergedCount}æ¡\n\n`;
                    }
                    
                    // å¤´éƒ¨å¯¹æ¯”
                    if (expected?.header && actual?.header) {
                        logContent += `ã€æ±‡æ€»å¯¹æ¯”ã€‘\n`;
                        logContent += `          æœŸæœ›    â”‚    å®é™…    â”‚ ç»“æœ\n`;
                        logContent += `${'â”€'.repeat(45)}\n`;
                        ['æ€»æ³¨', 'æ€»æŠ•', 'ä¸­å¥–', 'æ´¾å½©', 'ç›ˆäº'].forEach(field => {
                            const exp = expected.header[field] || 0;
                            const act = actual.header[field] || 0;
                            const match = parseInt(exp) === parseInt(act);
                            logContent += `${field.padEnd(6)}:  ${String(exp).padStart(6)}    â”‚   ${String(act).padStart(6)}    â”‚ ${match ? 'âœ“' : 'âœ—'}\n`;
                        });
                        logContent += `\n`;
                    }
                    
                    // ä¸åŒ¹é…è¯¦æƒ…
                    if (!comp.allMatch && comp.mismatches.length > 0) {
                        logContent += `ã€ä¸åŒ¹é…é¡¹ã€‘\n`;
                        comp.mismatches.forEach(m => {
                            if (m.type === 'header') {
                                logContent += `  âš  ${m.field}: æœŸæœ›${m.expected}, å®é™…${m.actual}, å·®${m.diff > 0 ? '+' : ''}${m.diff}\n`;
                            } else if (m.type === 'count') {
                                logContent += `  âš  è®°å½•æ•°: æœŸæœ›${m.expected}æ¡, å®é™…${m.actual}æ¡\n`;
                            } else if (m.type === 'record') {
                                logContent += `  âš  ç¬¬${m.seq}æ¡è®°å½•:\n`;
                                m.mismatches.forEach(mm => {
                                    logContent += `      ${mm.field}: æœŸæœ›[${mm.expected}] å®é™…[${mm.actual}]\n`;
                                });
                            } else if (m.type === 'missing') {
                                logContent += `  âš  ç¼ºå¤±è®°å½• #${m.seq}: ${m.expected?.raw || '-'}\n`;
                            }
                        });
                        logContent += `\n`;
                    }
                    
                    // é€æ¡è®°å½•å¯¹æ¯”ï¼ˆä½¿ç”¨åˆå¹¶åçš„æ•°æ®ï¼‰
                    if (expected?.records && actual?.records) {
                        logContent += `ã€è®°å½•å¯¹æ¯”ã€‘(åˆå¹¶å)\n`;
                        logContent += `åºå· â”‚ ç±»å‹     â”‚ åŸæ–‡                        â”‚ é‡‘é¢ â”‚ æ³¨æ•° â”‚ ç»“æœ\n`;
                        logContent += `${'â”€'.repeat(70)}\n`;
                        
                        const maxLen = Math.max(expected.records.length, actual.records.length);
                        for (let i = 0; i < maxLen; i++) {
                            const exp = expected.records[i];
                            const act = actual.records[i];
                            
                            if (exp && act) {
                                const match = (exp.type === act.type || typesMatch(exp.type, act.type)) && 
                                              exp.amount === act.amount && exp.bets === act.bets;
                                logContent += `${String(i+1).padStart(3)}  â”‚ ${(act.type || '-').padEnd(8)} â”‚ ${(act.raw || '-').substring(0,25).padEnd(25)} â”‚ ${String(act.amount).padStart(4)} â”‚ ${String(act.bets).padStart(4)} â”‚ ${match ? 'âœ“' : 'âœ—'}\n`;
                            } else if (act) {
                                logContent += `${String(i+1).padStart(3)}  â”‚ ${(act.type || '-').padEnd(8)} â”‚ ${(act.raw || '-').substring(0,25).padEnd(25)} â”‚ ${String(act.amount).padStart(4)} â”‚ ${String(act.bets).padStart(4)} â”‚ å¤šä½™\n`;
                            } else if (exp) {
                                logContent += `${String(i+1).padStart(3)}  â”‚ ${(exp.type || '-').padEnd(8)} â”‚ ${(exp.raw || '-').substring(0,25).padEnd(25)} â”‚ ${String(exp.amount).padStart(4)} â”‚ ${String(exp.bets).padStart(4)} â”‚ ç¼ºå¤±\n`;
                            }
                        }
                        logContent += `\n`;
                    }
                } else {
                    // æ— æ ‡å‡†ç­”æ¡ˆï¼Œæ˜¾ç¤ºå®é™…ç»“æœ
                    const actual = result.details?.actual;
                    if (actual) {
                        logContent += `ã€å®é™…ç»“æœã€‘(æ— æ ‡å‡†ç­”æ¡ˆ)\n`;
                        logContent += `æ€»æ³¨: ${actual.header.æ€»æ³¨} | æ€»æŠ•: ${actual.header.æ€»æŠ•} | ä¸­å¥–: ${actual.header.ä¸­å¥–} | æ´¾å½©: ${actual.header.æ´¾å½©} | ç›ˆäº: ${actual.header.ç›ˆäº}\n`;
                        logContent += `å…± ${actual.records.length} æ¡è®°å½•\n\n`;
                    }
                }
                
                logContent += `ã€è€—æ—¶ã€‘${result.elapsed}ms\n`;
                logContent += `${'â”€'.repeat(60)}\n\n`;
            });
            
            // ç»“å°¾
            logContent += `${'â•'.repeat(60)}\n`;
            logContent += `                    æŠ¥å‘Šç»“æŸ\n`;
            logContent += `${'â•'.repeat(60)}\n`;
            
            const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
            downloadBlob(blob, `test_report_${timestamp}.txt`);
        }
        
        showAutoCloseToast(`âœ… å·²å¯¼å‡º${format.toUpperCase()}æŠ¥å‘Š`);
    }
    
    // ä¸‹è½½Blobæ–‡ä»¶
    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // ==================== æ‰¹é‡è¾¹ç¼˜æµ‹è¯•ç³»ç»Ÿç»“æŸ ====================
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è¿è¡Œè¾¹ç¼˜æµ‹è¯•
    async function runEdgeCaseTest() {
        if (edgeTestResults.isRunning) {
            alert('æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…...');
            return;
        }
        
        const confirmed = confirm(`å³å°†è¿è¡Œ ${EDGE_TEST_CASES.length} ä¸ªè¾¹ç¼˜æµ‹è¯•ç”¨ä¾‹ï¼Œæ¯ä¸ªç”¨ä¾‹æµ‹è¯•5ä¸ªæ¨¡å‹ã€‚\né¢„è®¡è€—æ—¶çº¦ ${Math.ceil(EDGE_TEST_CASES.length * 5 / 60)} åˆ†é’Ÿã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`);
        if (!confirmed) return;
        
        // åˆå§‹åŒ–
        edgeTestResults = {
            isRunning: true,
            currentCase: 0,
            totalCases: EDGE_TEST_CASES.length,
            results: []
        };
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('multi-model-modal').style.display = 'flex';
        document.getElementById('test-progress').style.display = 'inline';
        document.getElementById('export-btn').style.display = 'none';
        document.getElementById('edge-test-btn').disabled = true;
        document.getElementById('edge-test-btn').textContent = 'ğŸ§ª æµ‹è¯•ä¸­...';
        
        // æ›´æ–°ç«™ç‚¹ä¿¡æ¯
        const siteInfoEl = document.getElementById('tuzi-site-info');
        if (siteInfoEl) {
            siteInfoEl.textContent = 'è¾¹ç¼˜æµ‹è¯•è¿›è¡Œä¸­...';
        }
        
        // é€ä¸ªæµ‹è¯•ç”¨ä¾‹
        for (let i = 0; i < EDGE_TEST_CASES.length; i++) {
            const testCase = EDGE_TEST_CASES[i];
            edgeTestResults.currentCase = i + 1;
            
            // æ›´æ–°è¿›åº¦
            document.getElementById('test-progress').textContent = `ç”¨ä¾‹ ${i + 1}/${EDGE_TEST_CASES.length}: ${testCase.group}`;
            
            // è®¾ç½®è¾“å…¥æ¡†å†…å®¹ï¼ˆè§¦å‘æµ‹è¯•ï¼‰
            document.getElementById('bet-input').value = testCase.input;
            
            // è¿è¡Œå¤šæ¨¡å‹æµ‹è¯•
            await runMultiModelTest();
            
            // ä¿å­˜ç»“æœ
            const caseResult = {
                input: testCase.input,
                answer: testCase.answer,
                group: testCase.group,
                models: {}
            };
            
            for (const [modelKey, result] of Object.entries(multiModelResults)) {
                const aiItems = result.aiItems || [];
                const firstItem = aiItems[0] || {};
                const typeOutput = firstItem.type || '(è§£æå¤±è´¥)';
                caseResult.models[modelKey] = {
                    è€—æ—¶: result.time,
                    æ ¼å¼æ­£ç¡®: result.status === 'success' || result.status === 'warning',
                    ç±»å‹è¾“å‡º: typeOutput,
                    ç†ç”±ä»£ç : firstItem.r || '',
                    å‡†ç¡®: typeOutput === testCase.answer
                };
            }
            
            edgeTestResults.results.push(caseResult);
            
            // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
            if (i < EDGE_TEST_CASES.length - 1) {
                await new Promise(r => setTimeout(r, 800));
            }
        }
        
        // æµ‹è¯•å®Œæˆ
        edgeTestResults.isRunning = false;
        document.getElementById('edge-test-btn').disabled = false;
        document.getElementById('edge-test-btn').textContent = 'ğŸ§ª è¾¹ç¼˜æµ‹è¯•';
        document.getElementById('test-progress').textContent = `âœ… å®Œæˆ ${EDGE_TEST_CASES.length} ç”¨ä¾‹`;
        document.getElementById('export-btn').style.display = 'inline';
        document.getElementById('export-btn').onclick = exportEdgeTestReport;
        
        // æ˜¾ç¤ºæ±‡æ€»
        showEdgeTestSummary();
        console.log('ğŸ“Š è¾¹ç¼˜æµ‹è¯•å®Œæˆ:', edgeTestResults);
        
        // è‡ªåŠ¨ä¸‹è½½JSONå†å²è®°å½•
        autoExportEdgeTestJSON();
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è‡ªåŠ¨å¯¼å‡ºè¾¹ç¼˜æµ‹è¯•JSONï¼ˆå†å²è®°å½•ï¼‰
    function autoExportEdgeTestJSON() {
        const jsonData = {
            æµ‹è¯•ç±»å‹: 'è¾¹ç¼˜æµ‹è¯•',
            ç‰ˆæœ¬ä¿¡æ¯: {
                ç¨‹åºç‰ˆæœ¬: 'v1.9.0',
                æç¤ºè¯ç‰ˆæœ¬: 'v2.0',
                æµ‹è¯•ç”¨ä¾‹ç‰ˆæœ¬: 'v1.0'
            },
            æµ‹è¯•æ—¶é—´: new Date().toISOString(),
            ç«™ç‚¹: tuziSiteManager.getCurrentName(),
            ç”¨ä¾‹æ€»æ•°: EDGE_TEST_CASES.length,
            æµ‹è¯•ç”¨ä¾‹: EDGE_TEST_CASES,
            æµ‹è¯•ç»“æœ: edgeTestResults.results,
            æ¨¡å‹æ±‡æ€»: calculateEdgeTestStats()
        };
        
        const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘æ–‡ä»¶åæ ¼å¼ï¼šç±»å‹_ç‰ˆæœ¬_è¾¹ç¼˜æµ‹è¯•å†å²_æ—¥æœŸ.json
        link.download = `${EDGE_TEST_TYPE}_${EDGE_TEST_VERSION}_è¾¹ç¼˜æµ‹è¯•å†å²_${new Date().toISOString().slice(0, 10)}.json`;
        link.click();
        
        console.log(`ğŸ“ å·²è‡ªåŠ¨å¯¼å‡ºJSON: ${EDGE_TEST_TYPE}_${EDGE_TEST_VERSION}`);
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è®¡ç®—è¾¹ç¼˜æµ‹è¯•ç»Ÿè®¡
    function calculateEdgeTestStats() {
        const models = ['deepseek', 'qwen', 'tuzi', 'claude', 'gpt'];
        const modelNames = { deepseek: 'DeepSeek', qwen: 'é€šä¹‰åƒé—®', tuzi: 'Gemini', claude: 'Claude', gpt: 'GPT4o' };
        
        const stats = {};
        models.forEach(m => {
            let æ­£ç¡® = 0, æ€»è€—æ—¶ = 0;
            edgeTestResults.results.forEach(r => {
                if (r.models[m]?.å‡†ç¡®) æ­£ç¡®++;
                æ€»è€—æ—¶ += r.models[m]?.è€—æ—¶ || 0;
            });
            stats[m] = {
                æ¨¡å‹åç§°: modelNames[m],
                æ­£ç¡®æ•°: æ­£ç¡®,
                æ€»æ•°: edgeTestResults.results.length,
                å‡†ç¡®ç‡: Math.round(æ­£ç¡® / edgeTestResults.results.length * 100) + '%',
                å¹³å‡è€—æ—¶: Math.round(æ€»è€—æ—¶ / edgeTestResults.results.length) + 'ms'
            };
        });
        
        return stats;
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘æ˜¾ç¤ºè¾¹ç¼˜æµ‹è¯•æ±‡æ€»
    function showEdgeTestSummary() {
        const models = ['deepseek', 'qwen', 'tuzi', 'claude', 'gpt'];
        const modelNames = { deepseek: 'DS', qwen: 'åƒé—®', tuzi: 'Gem', claude: 'Cld', gpt: 'GPT' };
        
        // ç»Ÿè®¡æ¯ä¸ªæ¨¡å‹çš„å‡†ç¡®ç‡
        const stats = {};
        models.forEach(m => {
            stats[m] = { æ­£ç¡®: 0, æ€»æ•°: edgeTestResults.results.length };
        });
        
        edgeTestResults.results.forEach(result => {
            models.forEach(m => {
                if (result.models[m]?.å‡†ç¡®) {
                    stats[m].æ­£ç¡®++;
                }
            });
        });
        
        // æ’åº
        const ranking = models.map(m => ({
            key: m,
            name: modelNames[m],
            æ­£ç¡®: stats[m].æ­£ç¡®,
            æ€»æ•°: stats[m].æ€»æ•°,
            å‡†ç¡®ç‡: Math.round(stats[m].æ­£ç¡® / stats[m].æ€»æ•° * 100) + '%'
        })).sort((a, b) => b.æ­£ç¡® - a.æ­£ç¡®);
        
        // æ˜¾ç¤ºåœ¨ç«™ç‚¹ä¿¡æ¯åŒº
        const siteInfoEl = document.getElementById('tuzi-site-info');
        if (siteInfoEl) {
            const best = ranking[0];
            siteInfoEl.innerHTML = `
                <span style="color:#4ade80;">ğŸ† ${best.name} ${best.å‡†ç¡®ç‡}(${best.æ­£ç¡®}/${best.æ€»æ•°})</span>
                <span style="margin-left:6px;color:#888;">å…±${edgeTestResults.results.length}ç”¨ä¾‹</span>
            `;
        }
        
        // åœ¨æ ‡é¢˜ä¸­æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        const modalTitle = document.querySelector('#multi-model-modal .modal-title');
        if (modalTitle) {
            modalTitle.innerHTML = `
                è¾¹ç¼˜æµ‹è¯•å®Œæˆ | 
                ${ranking.map(r => `<span style="color:${r.æ­£ç¡® === r.æ€»æ•° ? '#4ade80' : '#f87171'}">${r.name}:${r.å‡†ç¡®ç‡}</span>`).join(' ')}
            `;
        }
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘å¯¼å‡ºè¾¹ç¼˜æµ‹è¯•æŠ¥å‘Š
    function exportEdgeTestReport() {
        if (edgeTestResults.results.length === 0) {
            alert('æ²¡æœ‰æµ‹è¯•ç»“æœå¯å¯¼å‡º');
            return;
        }
        
        const models = ['deepseek', 'qwen', 'tuzi', 'claude', 'gpt'];
        const modelFullNames = { deepseek: 'DeepSeek', qwen: 'é€šä¹‰åƒé—®', tuzi: 'Gemini', claude: 'Claude', gpt: 'GPT4o' };
        const modelShortNames = { deepseek: 'DS', qwen: 'åƒé—®', tuzi: 'Gem', claude: 'Cld', gpt: 'GPT' };
        
        let csv = '';
        
        // æµ‹è¯•ä¿¡æ¯
        csv += '===== è¾¹ç¼˜æµ‹è¯•æŠ¥å‘Š =====\n';
        csv += `æµ‹è¯•æ—¶é—´,${new Date().toLocaleString()}\n`;
        csv += `æµ‹è¯•ç”¨ä¾‹æ•°,${edgeTestResults.results.length}\n`;
        csv += `ç«™ç‚¹,${tuziSiteManager.getCurrentName()}\n\n`;
        
        // æ¨¡å‹è¯„åˆ†æ±‡æ€»
        csv += '===== æ¨¡å‹è¯„åˆ†æ±‡æ€» =====\n';
        csv += 'æ’å,æ¨¡å‹,æ­£ç¡®æ•°,æ€»æ•°,å‡†ç¡®ç‡\n';
        
        const stats = {};
        models.forEach(m => {
            stats[m] = { æ­£ç¡®: 0, æ€»æ•°: edgeTestResults.results.length };
        });
        edgeTestResults.results.forEach(result => {
            models.forEach(m => {
                if (result.models[m]?.å‡†ç¡®) {
                    stats[m].æ­£ç¡®++;
                }
            });
        });
        
        const ranking = models.map(m => ({
            key: m,
            name: modelShortNames[m],
            æ­£ç¡®: stats[m].æ­£ç¡®,
            æ€»æ•°: stats[m].æ€»æ•°,
            å‡†ç¡®ç‡: Math.round(stats[m].æ­£ç¡® / stats[m].æ€»æ•° * 100) + '%'
        })).sort((a, b) => b.æ­£ç¡® - a.æ­£ç¡®);
        
        ranking.forEach((r, i) => {
            csv += `${i + 1},${r.name},${r.æ­£ç¡®},${r.æ€»æ•°},${r.å‡†ç¡®ç‡}\n`;
        });
        csv += '\n';
        
        // åˆ†ç»„ç»Ÿè®¡
        csv += '===== åˆ†ç»„ç»Ÿè®¡ =====\n';
        csv += 'åˆ†ç»„,ç”¨ä¾‹æ•°,' + models.map(m => modelShortNames[m] + 'æ­£ç¡®').join(',') + '\n';
        
        const groups = [...new Set(EDGE_TEST_CASES.map(c => c.group))];
        groups.forEach(group => {
            const groupResults = edgeTestResults.results.filter(r => r.group === group);
            const groupStats = models.map(m => groupResults.filter(r => r.models[m]?.å‡†ç¡®).length);
            csv += `${group},${groupResults.length},${groupStats.join(',')}\n`;
        });
        csv += '\n';
        
        // è¯¦ç»†ç»“æœ
        csv += '===== è¯¦ç»†ç»“æœ =====\n';
        csv += 'åºå·,åˆ†ç»„,è¾“å…¥å†…å®¹,æ ‡å‡†ç­”æ¡ˆ,' + models.map(m => `${modelShortNames[m]}è¾“å‡º`).join(',') + ',' + models.map(m => `${modelShortNames[m]}æ­£ç¡®`).join(',') + '\n';
        
        edgeTestResults.results.forEach((result, i) => {
            const outputs = models.map(m => result.models[m]?.ç±»å‹è¾“å‡º || '');
            const corrects = models.map(m => result.models[m]?.å‡†ç¡® ? 'âœ“' : 'âœ—');
            csv += `${i + 1},"${result.group}","${result.input.replace(/"/g, '""')}",${result.answer},${outputs.join(',')},${corrects.join(',')}\n`;
        });
        csv += '\n';
        
        // é”™è¯¯ç”¨ä¾‹è¯¦æƒ…
        csv += '===== é”™è¯¯ç”¨ä¾‹è¯¦æƒ… =====\n';
        csv += 'åºå·,è¾“å…¥å†…å®¹,æ ‡å‡†ç­”æ¡ˆ,é”™è¯¯æ¨¡å‹,æ¨¡å‹è¾“å‡º,ç†ç”±ä»£ç \n';
        
        let errorIndex = 0;
        edgeTestResults.results.forEach(result => {
            models.forEach(m => {
                if (!result.models[m]?.å‡†ç¡®) {
                    errorIndex++;
                    csv += `${errorIndex},"${result.input.replace(/"/g, '""')}",${result.answer},${modelShortNames[m]},${result.models[m]?.ç±»å‹è¾“å‡º || ''},${result.models[m]?.ç†ç”±ä»£ç  || ''}\n`;
                }
            });
        });
        
        // ä¸‹è½½
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘æ–‡ä»¶åæ ¼å¼ï¼šç±»å‹_ç‰ˆæœ¬_è¾¹ç¼˜æµ‹è¯•æŠ¥å‘Š_æ—¥æœŸ.csv
        link.download = `${EDGE_TEST_TYPE}_${EDGE_TEST_VERSION}_è¾¹ç¼˜æµ‹è¯•æŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è¿è¡Œå¤šè½®æµ‹è¯•
    async function runMultiRoundTest(rounds = 5) {
        const input = document.getElementById('bet-input').value.trim();
        const standardAnswer = document.getElementById('standard-answer').value;
        
        if (!input) {
            alert('è¯·å…ˆè¾“å…¥ä¸‹æ³¨å†…å®¹');
            return;
        }
        if (!standardAnswer) {
            alert('è¯·é€‰æ‹©æ ‡å‡†ç­”æ¡ˆï¼Œç”¨äºè¯„ä¼°æ¨¡å‹å‡†ç¡®ç‡');
            return;
        }
        
        // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
        multiRoundTestData = {
            inputContent: input,
            standardAnswer: standardAnswer,
            totalRounds: rounds,
            currentRound: 0,
            isRunning: true,
            results: []
        };
        
        // æ˜¾ç¤ºè¿›åº¦
        document.getElementById('test-progress').style.display = 'inline';
        document.getElementById('export-btn').style.display = 'none';
        
        // è¿è¡Œå¤šè½®æµ‹è¯•
        for (let i = 1; i <= rounds; i++) {
            multiRoundTestData.currentRound = i;
            document.getElementById('test-progress').textContent = `è¿›åº¦: ${i}/${rounds}`;
            
            // è¿è¡Œå•è½®æµ‹è¯•
            await runMultiModelTest();
            
            // ä¿å­˜æœ¬è½®ç»“æœ
            const roundResult = {
                round: i,
                timestamp: new Date().toISOString(),
                models: {}
            };
            
            for (const [modelKey, result] of Object.entries(multiModelResults)) {
                const aiItems = result.aiItems || [];
                const firstItem = aiItems[0] || {};
                roundResult.models[modelKey] = {
                    è€—æ—¶: result.time,
                    æ ¼å¼æ­£ç¡®: result.status === 'success' || result.status === 'warning',
                    ç±»å‹è¾“å‡º: firstItem.type || '(è§£æå¤±è´¥)',
                    ç†ç”±ä»£ç : firstItem.r || '',
                    å‡†ç¡®: firstItem.type === standardAnswer,
                    åŸå§‹è¾“å‡º: result.raw?.substring(0, 200) || ''
                };
            }
            
            multiRoundTestData.results.push(roundResult);
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œé¿å…è¯·æ±‚è¿‡å¿«
            if (i < rounds) {
                await new Promise(r => setTimeout(r, 1000));
            }
        }
        
        multiRoundTestData.isRunning = false;
        document.getElementById('test-progress').textContent = `âœ… å®Œæˆ ${rounds}è½®`;
        document.getElementById('export-btn').style.display = 'inline';
        
        // æ˜¾ç¤ºæ±‡æ€»
        showTestSummary();
        console.log('ğŸ“Š å¤šè½®æµ‹è¯•å®Œæˆ:', multiRoundTestData);
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘æ˜¾ç¤ºæµ‹è¯•æ±‡æ€»
    function showTestSummary() {
        const summary = calculateTestSummary();
        const siteInfoEl = document.getElementById('tuzi-site-info');
        if (siteInfoEl) {
            const bestModel = summary.ranking[0];
            siteInfoEl.innerHTML = `
                <span style="color:#4ade80;">ğŸ† ${bestModel.name} å‡†ç¡®ç‡${bestModel.å‡†ç¡®ç‡}</span>
                <span style="margin-left:6px;color:#888;">ç«™ç‚¹:${tuziSiteManager.getCurrentName()}</span>
            `;
        }
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘è®¡ç®—æµ‹è¯•æ±‡æ€»
    function calculateTestSummary() {
        const models = ['deepseek', 'qwen', 'tuzi', 'claude', 'gpt'];
        const modelNames = { deepseek: 'DS', qwen: 'åƒé—®', tuzi: 'Gem', claude: 'Cld', gpt: 'GPT' };
        
        const stats = {};
        models.forEach(m => {
            stats[m] = { name: modelNames[m], æ€»è€—æ—¶: 0, æ ¼å¼æ­£ç¡®: 0, ç±»å‹æ­£ç¡®: 0, å‡†ç¡®: 0, è½®æ•°: 0 };
        });
        
        // ç»Ÿè®¡æ¯ä¸ªæ¨¡å‹çš„è¡¨ç°
        for (const round of multiRoundTestData.results) {
            for (const [modelKey, result] of Object.entries(round.models)) {
                if (stats[modelKey]) {
                    stats[modelKey].è½®æ•°++;
                    stats[modelKey].æ€»è€—æ—¶ += result.è€—æ—¶ || 0;
                    if (result.æ ¼å¼æ­£ç¡®) stats[modelKey].æ ¼å¼æ­£ç¡®++;
                    if (result.ç±»å‹è¾“å‡º && result.ç±»å‹è¾“å‡º !== '(è§£æå¤±è´¥)' && result.ç±»å‹è¾“å‡º !== 'ç©æ³•') {
                        stats[modelKey].ç±»å‹æ­£ç¡®++;
                    }
                    if (result.å‡†ç¡®) stats[modelKey].å‡†ç¡®++;
                }
            }
        }
        
        // è®¡ç®—ç™¾åˆ†æ¯”å’Œæ’å
        const ranking = models.map(m => {
            const s = stats[m];
            const rounds = s.è½®æ•° || 1;
            return {
                key: m,
                name: s.name,
                å¹³å‡è€—æ—¶: (s.æ€»è€—æ—¶ / rounds / 1000).toFixed(1) + 's',
                æ ¼å¼æ­£ç¡®ç‡: Math.round(s.æ ¼å¼æ­£ç¡® / rounds * 100) + '%',
                ç±»å‹æ­£ç¡®ç‡: Math.round(s.ç±»å‹æ­£ç¡® / rounds * 100) + '%',
                å‡†ç¡®ç‡: Math.round(s.å‡†ç¡® / rounds * 100) + '%',
                å‡†ç¡®æ•°: s.å‡†ç¡®,
                ç»¼åˆåˆ†: s.å‡†ç¡® * 3 + s.ç±»å‹æ­£ç¡® * 2 + s.æ ¼å¼æ­£ç¡® - (s.æ€»è€—æ—¶ / rounds / 1000)
            };
        }).sort((a, b) => b.ç»¼åˆåˆ† - a.ç»¼åˆåˆ†);
        
        return { stats, ranking };
    }
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘å¯¼å‡ºCSVæŠ¥å‘Š
    function exportTestReport() {
        if (multiRoundTestData.results.length === 0) {
            alert('æ²¡æœ‰æµ‹è¯•æ•°æ®å¯å¯¼å‡º');
            return;
        }
        
        const summary = calculateTestSummary();
        
        // ç”ŸæˆCSVå†…å®¹
        let csv = '\ufeff';  // BOM for Excel
        
        // æµ‹è¯•ä¿¡æ¯
        csv += '===== æµ‹è¯•ä¿¡æ¯ =====\n';
        csv += `æµ‹è¯•æ—¶é—´,${new Date().toLocaleString()}\n`;
        csv += `è¾“å…¥å†…å®¹,"${multiRoundTestData.inputContent.replace(/"/g, '""')}"\n`;
        csv += `æ ‡å‡†ç­”æ¡ˆ,${multiRoundTestData.standardAnswer}\n`;
        csv += `æµ‹è¯•è½®æ•°,${multiRoundTestData.totalRounds}\n`;
        csv += `ç«™ç‚¹,${tuziSiteManager.getCurrentName()}\n\n`;
        
        // æ±‡æ€»è¡¨
        csv += '===== æ¨¡å‹è¯„åˆ†æ±‡æ€» =====\n';
        csv += 'æ’å,æ¨¡å‹,å¹³å‡è€—æ—¶,æ ¼å¼æ­£ç¡®ç‡,ç±»å‹æ­£ç¡®ç‡,å‡†ç¡®ç‡,ç»¼åˆè¯„åˆ†\n';
        summary.ranking.forEach((m, i) => {
            const stars = m.å‡†ç¡®ç‡ === '100%' ? 'â­â­â­â­â­' : 
                        m.å‡†ç¡®ç‡ >= '80%' ? 'â­â­â­â­' :
                        m.å‡†ç¡®ç‡ >= '60%' ? 'â­â­â­' :
                        m.å‡†ç¡®ç‡ >= '40%' ? 'â­â­' : 'â­';
            csv += `${i+1},${m.name},${m.å¹³å‡è€—æ—¶},${m.æ ¼å¼æ­£ç¡®ç‡},${m.ç±»å‹æ­£ç¡®ç‡},${m.å‡†ç¡®ç‡},${stars}\n`;
        });
        csv += '\n';
        
        // æ˜ç»†è¡¨
        csv += '===== è¯¦ç»†ç»“æœ =====\n';
        csv += 'è½®æ¬¡,æ¨¡å‹,è€—æ—¶(ms),æ ¼å¼æ­£ç¡®,ç±»å‹è¾“å‡º,ç†ç”±ä»£ç ,å‡†ç¡®\n';
        for (const round of multiRoundTestData.results) {
            for (const [modelKey, result] of Object.entries(round.models)) {
                const modelName = { deepseek: 'DeepSeek', qwen: 'é€šä¹‰åƒé—®', tuzi: 'Gemini', claude: 'Claude', gpt: 'GPT4o' }[modelKey];
                csv += `${round.round},${modelName},${result.è€—æ—¶},${result.æ ¼å¼æ­£ç¡® ? 'âœ“' : 'âœ—'},${result.ç±»å‹è¾“å‡º},${result.ç†ç”±ä»£ç },${result.å‡†ç¡® ? 'âœ“' : 'âœ—'}\n`;
            }
        }
        
        // ä¸‹è½½æ–‡ä»¶
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘æ–‡ä»¶åæ ¼å¼ï¼šç±»å‹_ç‰ˆæœ¬_æ¨¡å‹æµ‹è¯•æŠ¥å‘Š_æ—¥æœŸ.csv
        a.download = `${EDGE_TEST_TYPE}_${EDGE_TEST_VERSION}_æ¨¡å‹æµ‹è¯•æŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('âœ… CSVæŠ¥å‘Šå·²å¯¼å‡ºï¼\n\nä½ å¯ä»¥å‘ç»™AIåˆ†æï¼Œè·å–ä¼˜åŒ–å»ºè®®ã€‚');
    }
    
    // ==================== ç†ç”±ä»£ç æ˜ å°„è¡¨ ====================
    const REASON_CODES = {
        'R1': 'çº¯æ•°å­—+å„+é‡‘é¢',
        'R2': 'ç”Ÿè‚–+x/å„+é‡‘é¢',
        'R3': 'å«"ç‰¹"å­—',
        'R4': 'ç”Ÿè‚–+é‡‘é¢(æ— xæ— å„)',
        'R5': 'çº¢/è“/ç»¿+æ³¢',
        'R6': 'æ³¢è‰²+å¤§å°å•åŒ',
        'R7': 'å«å¹³ç‰¹æˆ–ä¸€å‹',
        'R8': 'å«äºŒè¿è‚–æˆ–äºŒå‹',
        'R9': 'å«ä¸‰è¿è‚–æˆ–ä¸‰å‹',
        'R10': 'å«å››è¿è‚–',
        'R11': 'å«äº”è¿è‚–',
        'R12': 'å¹³ç‰¹å°¾',
        'R13': 'å«å…­è‚–',
        'R31': 'å«ç‰¹è‚–',
        'R14': 'å«åˆè‚–',
        'R15': 'å«æ­£è‚–',
        'R16': 'å•å¹³æˆ–å¹³ç ',
        'R17': 'äºŒä¸­äºŒ',
        'R18': 'ä¸‰ä¸­ä¸‰',
        'R19': 'äºŒå…¨ä¸­',
        'R20': 'ä¸‰å…¨ä¸­',
        'R21': 'äºŒä¸­ç‰¹',
        'R22': 'ä¸‰ä¸­ç‰¹',
        'R23': 'ç‰¹ä¸²',
        'R24': 'Nä¸ä¸­',
        'R25': 'æ€»å’Œå¤§å°å•åŒ',
        'R26': 'äº”è¡Œ',
        'R27': 'å®¶ç¦½é‡å…½',
        'R28': 'å¤´å°¾æ•°',
        'R29': 'å°æ•°/å¤§æ•°+å„+é‡‘é¢',
        'R30': 'å•æ•°/åŒæ•°+å„+é‡‘é¢'
    };
    
    // è·å–ç†ç”±ä»£ç çš„å¯è¯»æ–‡å­—
    function getReasonText(code) {
        if (!code) return '';
        // æ”¯æŒå¤šä¸ªä»£ç ï¼Œå¦‚ "R1,R3"
        const codes = code.split(',').map(c => c.trim().toUpperCase());
        return codes.map(c => REASON_CODES[c] || c).join('+');
    }
    
    // ==================== å¤šæ¨¡å‹å¯¹æ¯”æµ‹è¯• ====================
    
    // å­˜å‚¨å„æ¨¡å‹çš„æµ‹è¯•ç»“æœï¼ˆ4ä¸ªæ¨¡å‹ï¼‰
    let multiModelResults = {
        deepseek: { status: 'pending', time: 0, raw: '', parsed: [], error: '' },
        qwen: { status: 'pending', time: 0, raw: '', parsed: [], error: '' },
        tuzi: { status: 'pending', time: 0, raw: '', parsed: [], error: '' },
        claude: { status: 'pending', time: 0, raw: '', parsed: [], error: '' },
        gpt: { status: 'pending', time: 0, raw: '', parsed: [], error: '' }
    };
    let currentViewingModel = 'deepseek';
    
    // ã€ä¸´æ—¶-æ¨¡å‹æ¯”æ‹¼ã€‘æ‰“å¼€å¤šæ¨¡å‹æµ‹è¯•å¼¹çª—ï¼ˆä¸éœ€è¦è¾“å…¥å†…å®¹ï¼‰
    function openMultiModelModal() {
        // ç›´æ¥æ˜¾ç¤ºå¼¹çª—
        document.getElementById('multi-model-modal').style.display = 'flex';
        
        // æ›´æ–°ç«™ç‚¹ä¿¡æ¯æ˜¾ç¤º
        const siteInfoEl = document.getElementById('tuzi-site-info');
        if (siteInfoEl) {
            siteInfoEl.textContent = 'å½“å‰ç«™ç‚¹: ' + tuziSiteManager.getCurrentName();
        }
        
        // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæ ‡ç­¾
        switchModelTab('deepseek');
        
        // é‡ç½®çŠ¶æ€æ˜¾ç¤º
        const models = ['deepseek', 'qwen', 'tuzi', 'claude', 'gpt'];
        models.forEach(m => {
            updateModelTabStatus(m, 'pending', 'ç­‰å¾…ä¸­...');
        });
        
        // æ¸…ç©ºç»“æœæ˜¾ç¤º
        document.getElementById('model-result-content').innerHTML = `
            <div style="text-align:center;color:#888;padding:40px;">
                <div style="font-size:24px;margin-bottom:10px;">ğŸ§ª</div>
                <div>è¯·é€‰æ‹©æµ‹è¯•æ–¹å¼ï¼š</div>
                <div style="margin-top:10px;font-size:12px;">
                    â€¢ <b>è¾¹ç¼˜æµ‹è¯•</b> - è¿è¡Œ32ä¸ªé¢„ç½®ç”¨ä¾‹<br>
                    â€¢ <b>5è½®æµ‹è¯•</b> - å¯¹è¾“å…¥æ¡†å†…å®¹æµ‹è¯•5è½®ï¼ˆéœ€å…ˆè¾“å…¥ï¼‰<br>
                    â€¢ <b>é‡æ–°æµ‹è¯•</b> - å¯¹è¾“å…¥æ¡†å†…å®¹æµ‹è¯•1è½®ï¼ˆéœ€å…ˆè¾“å…¥ï¼‰
                </div>
            </div>
        `;
        
        console.log('ğŸ“Š å¤šæ¨¡å‹æµ‹è¯•å¼¹çª—å·²æ‰“å¼€');
    }
    
    // è¿è¡Œå¤šæ¨¡å‹å¯¹æ¯”æµ‹è¯•
    async function runMultiModelTest() {
        const input = document.getElementById('bet-input').value.trim();
        if (!input) {
            alert('è¯·å…ˆè¾“å…¥ä¸‹æ³¨å†…å®¹');
            return;
        }
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('multi-model-modal').style.display = 'flex';
        
        // æ›´æ–°ç«™ç‚¹ä¿¡æ¯æ˜¾ç¤º
        const siteInfoEl = document.getElementById('tuzi-site-info');
        if (siteInfoEl) {
            siteInfoEl.textContent = 'å½“å‰ç«™ç‚¹: ' + tuziSiteManager.getCurrentName();
        }
        
        // é‡ç½®ç»“æœï¼ˆ4ä¸ªæ¨¡å‹ï¼‰
        multiModelResults = {
            deepseek: { status: 'running', time: 0, raw: '', parsed: [], error: '' },
            qwen: { status: 'running', time: 0, raw: '', parsed: [], error: '' },
            tuzi: { status: 'running', time: 0, raw: '', parsed: [], error: '' },
            claude: { status: 'running', time: 0, raw: '', parsed: [], error: '' },
            gpt: { status: 'running', time: 0, raw: '', parsed: [], error: '' }
        };
        
        // æ›´æ–°UIæ˜¾ç¤º"è¿è¡Œä¸­"
        ['deepseek', 'qwen', 'tuzi', 'claude', 'gpt'].forEach(model => {
            updateModelTabStatus(model, 'running', 'è¿è¡Œä¸­...');
        });
        
        // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæ ‡ç­¾
        switchModelTab('deepseek');
        
        // æ„å»ºæç¤ºè¯ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰
        let userInput = input;
        
        // ã€é¢„å¤„ç†ã€‘æ ‡å‡†åŒ–åˆ†éš”ç¬¦å’Œé‡‘é¢ç¬¦å·ï¼ˆç¡®å®šæ€§è§„åˆ™ï¼Œä¸ä¾èµ–AIï¼‰
        userInput = normalizeForAI(userInput);
        
        const prompt = `ã€å¼ºåˆ¶è§„åˆ™ã€‘åªè¾“å‡ºJSONï¼Œç¦æ­¢ä»»ä½•è§£é‡Šï¼

ã€typeå¿…é¡»æ˜¯ä»¥ä¸‹ä¹‹ä¸€ã€‘ï¼ˆç¦æ­¢è¾“å‡ºå…¶ä»–å€¼ï¼ï¼‰
ç‰¹ç /ç”Ÿè‚–ç‰¹ç /ç”Ÿè‚–/æ³¢è‰²/åŠæ³¢/å¹³ç‰¹ä¸€è‚–/å¹³ç‰¹äºŒè¿è‚–/å¹³ç‰¹ä¸‰è¿è‚–/å¹³ç‰¹å››è¿è‚–/å¹³ç‰¹äº”è¿è‚–/å¹³ç‰¹å°¾æ•°/å…­è‚–/ç‰¹è‚–/åˆè‚–/æ­£è‚–/å•å¹³/äºŒä¸­äºŒ/ä¸‰ä¸­ä¸‰/äºŒå…¨ä¸­/ä¸‰å…¨ä¸­/äºŒä¸­ç‰¹/ä¸‰ä¸­ç‰¹/ç‰¹ä¸²/äº”ä¸ä¸­/å…­ä¸ä¸­/ä¸ƒä¸ä¸­/å…«ä¸ä¸­/ä¹ä¸ä¸­/åä¸ä¸­/åä¸€ä¸ä¸­/åäºŒä¸ä¸­/æ€»å’Œå¤§å°å•åŒ/äº”è¡Œ/å®¶ç¦½é‡å…½/å¤´å°¾æ•°

ã€ç†ç”±ä»£ç rã€‘å¿…é¡»æ˜¯R1-R30ä¹‹ä¸€ï¼š
R1=çº¯æ•°å­—+å„+é‡‘é¢â†’ç‰¹ç  R2=ç”Ÿè‚–+x/X/å„+é‡‘é¢â†’ç”Ÿè‚–ç‰¹ç  R3=å«ç‰¹å­—â†’ç‰¹ç  R4=ç”Ÿè‚–+é‡‘é¢(æ— xæ— å„)â†’ç”Ÿè‚–
R5=çº¢è“ç»¿+æ³¢â†’æ³¢è‰² R6=æ³¢è‰²+å¤§å°å•åŒâ†’åŠæ³¢ R7=å¹³ç‰¹æˆ–ä¸€å‹â†’å¹³ç‰¹ä¸€è‚– R8=äºŒè¿è‚–æˆ–äºŒå‹â†’å¹³ç‰¹äºŒè¿è‚–
R9=ä¸‰è¿è‚–æˆ–ä¸‰å‹â†’å¹³ç‰¹ä¸‰è¿è‚– R10=å››è¿è‚–â†’å¹³ç‰¹å››è¿è‚– R11=äº”è¿è‚–â†’å¹³ç‰¹äº”è¿è‚– R12=å¹³ç‰¹å°¾â†’å¹³ç‰¹å°¾æ•°
R13=å…­è‚– R31=ç‰¹è‚– R14=åˆè‚– R15=æ­£è‚– R16=å•å¹³æˆ–å¹³ç â†’å•å¹³ R17=äºŒä¸­äºŒ R18=ä¸‰ä¸­ä¸‰ R19=äºŒå…¨ä¸­ R20=ä¸‰å…¨ä¸­
R21=äºŒä¸­ç‰¹ R22=ä¸‰ä¸­ç‰¹ R23=ç‰¹ä¸² R24=Nä¸ä¸­ R25=æ€»å’Œå¤§å°å•åŒ R26=äº”è¡Œ R27=å®¶ç¦½é‡å…½ R28=å¤´å°¾æ•°
R29=å°æ•°/å¤§æ•°+å„+é‡‘é¢â†’ç‰¹ç  R30=å•æ•°/åŒæ•°+å„+é‡‘é¢â†’ç‰¹ç 

ã€ç”Ÿè‚–è¯ã€‘é¼ ã€ç‰›ã€è™ã€å…”ã€é¾™ã€è›‡ã€é©¬ã€ç¾Šã€çŒ´ã€é¸¡ã€ç‹—ã€çŒª

ã€æ ¸å¿ƒè§„åˆ™-æŒ‰ä¼˜å…ˆçº§åˆ¤æ–­ã€‘
1. çº¯æ•°å­—+å„/æ¯ä¸ª+é‡‘é¢ â†’ type="ç‰¹ç ", r="R1"ï¼ˆå¦‚ï¼š10 12 20å„30ï¼‰
2. ä¹°+ç”Ÿè‚–(ä¸€ä¸ªæˆ–å¤šä¸ª)+å„+é‡‘é¢ â†’ type="ç”Ÿè‚–ç‰¹ç ", r="R2"ï¼ˆå¦‚ï¼šä¹°çŒªå„20ã€ä¹°é¾™è™å„20ã€ä¹°é¼ ç‰›è™å„30ï¼‰
3. ç”Ÿè‚–+x/X/Ã—/*/@+é‡‘é¢ â†’ type="ç”Ÿè‚–ç‰¹ç ", r="R2"ï¼ˆå¦‚ï¼šé¾™x10ã€ç‹—X80ã€çŒ´é¸¡x50ï¼‰
4. ç‰¹+å·ç +é‡‘é¢ â†’ type="ç‰¹ç ", r="R3"ï¼ˆå¦‚ï¼šç‰¹43 20å…ƒï¼‰
5. å°æ•°/å¤§æ•°+å„+é‡‘é¢ â†’ type="ç‰¹ç ", r="R29"ï¼ˆå°æ•°=1-24ï¼Œå¤§æ•°=25-49ï¼‰
6. å•æ•°/åŒæ•°+å„+é‡‘é¢ â†’ type="ç‰¹ç ", r="R30"ï¼ˆå•æ•°=1,3,5...49ï¼ŒåŒæ•°=2,4,6...48ï¼‰
7. ç”Ÿè‚–+é‡‘é¢(æ— ä¹°æ— xæ— å„) â†’ type="ç”Ÿè‚–", r="R4"ï¼ˆå¦‚ï¼šçŒª10ï¼‰

ã€é‡è¦ã€‘æœ‰"ä¹°"å­—+æœ‰"å„"å­— = ä¸€å®šæ˜¯ç”Ÿè‚–ç‰¹ç (R2)ï¼Œä¸ç®¡æœ‰å‡ ä¸ªç”Ÿè‚–ï¼

ã€é‡‘é¢æ ¼å¼ã€‘æ”¯æŒæ•°å­—(20)å’Œä¸­æ–‡(äºŒå/ä¸€ç™¾)ï¼Œå¯å¸¦å•ä½(å…ƒ/å—)
ã€åˆ†éš”ç¬¦ã€‘å·ç é—´å¯ç”¨ï¼šç©ºæ ¼ã€ç‚¹(.)ã€é€—å·(,)ã€é¡¿å·(ã€)ã€æ–œæ (/)ã€æ¨ªæ (-)

ã€ç”¨æˆ·è¾“å…¥ã€‘
${userInput}

ã€è¾“å‡ºæ ¼å¼ã€‘ä¸¥æ ¼æŒ‰æ­¤æ ¼å¼ï¼Œtypeå¿…é¡»æ˜¯ä¸Šé¢åˆ—å‡ºçš„ç©æ³•åï¼
{"items":[{"type":"ç‰¹ç ","raw":"åŸæ–‡","r":"R1"}]}`;
        
        // å¹¶è¡Œè°ƒç”¨æ‰€æœ‰æ¨¡å‹ï¼ˆ5ä¸ªï¼‰
        const modelsToTest = ['deepseek', 'qwen', 'tuzi', 'claude', 'gpt'];
        
        const promises = modelsToTest.map(async (modelKey) => {
            const config = AI_PROVIDERS[modelKey];
            if (!config) {
                multiModelResults[modelKey] = {
                    status: 'error',
                    time: 0,
                    raw: '',
                    parsed: [],
                    error: 'æ¨¡å‹æœªé…ç½®'
                };
                updateModelTabStatus(modelKey, 'error', 'æœªé…ç½®');
                return;
            }
            
            const startTime = Date.now();
            try {
                // API Key åœ¨åç«¯ï¼Œä¸éœ€è¦ä¼ é€’
                const result = await callAIAPI(prompt, modelKey);
                const elapsed = Date.now() - startTime;
                
                if (result) {
                    // è§£æç»“æœ
                    let parsed = [];
                    let aiItems = [];  // ä¿å­˜AIåŸå§‹è¾“å‡ºçš„itemsï¼ˆç”¨äºæŠ•ç¥¨ï¼‰
                    try {
                        let jsonStr = result.trim();
                        if (jsonStr.startsWith('```')) {
                            jsonStr = jsonStr.replace(/```json?\n?/g, '').replace(/```/g, '').trim();
                        }
                        const aiResult = JSON.parse(jsonStr);
                        if (aiResult.items && Array.isArray(aiResult.items)) {
                            aiItems = aiResult.items;  // ä¿å­˜åŸå§‹items
                            for (const item of aiResult.items) {
                                // ã€å·²ä¼˜åŒ–ã€‘ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®ï¼Œä¸å†è°ƒç”¨æœ¬åœ°æ­£åˆ™
                                    const reasonCode = item.r || item.reason || '';
                                    const reasonText = getReasonText(reasonCode);
                                parsed.push({
                                    type: item.type || 'æœªçŸ¥',
                                    target: item.raw,
                                    amount: item.amount || 0,
                                    numbers: item.numbers || [],
                                    raw: item.raw,
                                    reason: reasonText,
                                    reasonCode: reasonCode
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('è§£æJSONå¤±è´¥:', e, 'åŸå§‹å†…å®¹:', result.substring(0, 200));
                    }
                    
                    multiModelResults[modelKey] = {
                        status: parsed.length > 0 ? 'success' : 'warning',
                        time: elapsed,
                        raw: result,
                        parsed: parsed,
                        aiItems: aiItems,  // ä¿å­˜ç”¨äºæŠ•ç¥¨
                        error: ''
                    };
                    
                    updateModelTabStatus(modelKey, parsed.length > 0 ? 'success' : 'warning', `è€—æ—¶: ${(elapsed/1000).toFixed(1)}s`);
                } else {
                    throw new Error('è¿”å›ç»“æœä¸ºç©º');
                }
            } catch (e) {
                const elapsed = Date.now() - startTime;
                multiModelResults[modelKey] = {
                    status: 'error',
                    time: elapsed,
                    raw: '',
                    parsed: [],
                    error: e.message
                };
                updateModelTabStatus(modelKey, 'error', 'è¯·æ±‚å¤±è´¥');
            }
            
            // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªæ¨¡å‹ï¼Œæ›´æ–°æ˜¾ç¤º
            if (currentViewingModel === modelKey) {
                displayModelResult(modelKey);
            }
        });
        
        await Promise.all(promises);
        console.log('ğŸ”¬ å¤šæ¨¡å‹æµ‹è¯•å®Œæˆ:', multiModelResults);
        
        // æŠ•ç¥¨ç»Ÿè®¡
        const voteResult = calculateVoteResult();
        displayVoteResult(voteResult);
    }
    
    // æŠ•ç¥¨ç»Ÿè®¡é€»è¾‘
    function calculateVoteResult() {
        const votes = {};  // { "ç±»å‹ç»„åˆ": { count: N, models: [], items: [] } }
        const validModels = [];
        
        // æ”¶é›†å„æ¨¡å‹çš„ç»“æœ
        for (const [modelKey, result] of Object.entries(multiModelResults)) {
            if (result.status === 'success' && result.aiItems && result.aiItems.length > 0) {
                validModels.push(modelKey);
                
                // ç”ŸæˆæŠ•ç¥¨ keyï¼ˆæŒ‰ç±»å‹æ’åºçš„ç»„åˆï¼‰
                const types = result.aiItems.map(item => item.type).sort().join('|');
                
                if (!votes[types]) {
                    votes[types] = { count: 0, models: [], items: result.aiItems };
                }
                votes[types].count++;
                votes[types].models.push(modelKey);
            }
        }
        
        // æ‰¾å‡ºæœ€é«˜ç¥¨
        let maxVote = null;
        let maxCount = 0;
        for (const [types, vote] of Object.entries(votes)) {
            if (vote.count > maxCount) {
                maxCount = vote.count;
                maxVote = vote;
            }
        }
        
        // è®¡ç®—å¯ä¿¡åº¦
        let confidence = 'low';
        let confidenceText = 'âš ï¸ éœ€äººå·¥å®¡æ ¸';
        let confidenceColor = '#ffa726';
        
        if (maxCount >= 4) {
            confidence = 'high';
            confidenceText = 'âœ… é«˜å¯ä¿¡ï¼ˆ' + maxCount + '/5ç¥¨ä¸€è‡´ï¼‰';
            confidenceColor = '#4ade80';
        } else if (maxCount === 3) {
            confidence = 'medium';
            confidenceText = 'âš¡ ä¸­å¯ä¿¡ï¼ˆ3/5ç¥¨ä¸€è‡´ï¼‰';
            confidenceColor = '#60a5fa';
        } else {
            confidence = 'low';
            confidenceText = 'âš ï¸ éœ€äººå·¥å®¡æ ¸ï¼ˆåˆ†æ­§è¾ƒå¤§ï¼‰';
            confidenceColor = '#ffa726';
        }
        
        return {
            votes: votes,
            winner: maxVote,
            winnerCount: maxCount,
            totalModels: validModels.length,
            confidence: confidence,
            confidenceText: confidenceText,
            confidenceColor: confidenceColor
        };
    }
    
    // æ˜¾ç¤ºæŠ•ç¥¨ç»“æœ
    function displayVoteResult(voteResult) {
        const siteInfoEl = document.getElementById('tuzi-site-info');
        if (siteInfoEl && voteResult.winner) {
            siteInfoEl.innerHTML = `
                <span style="color:${voteResult.confidenceColor}">${voteResult.confidenceText}</span>
                <span style="margin-left:8px;color:#888;">ç«™ç‚¹: ${tuziSiteManager.getCurrentName()}</span>
            `;
            siteInfoEl.style.background = 'rgba(0,0,0,0.2)';
        }
        
        console.log('ğŸ—³ï¸ æŠ•ç¥¨ç»“æœ:', voteResult);
    }
    
    // æ›´æ–°æ¨¡å‹æ ‡ç­¾çŠ¶æ€
    function updateModelTabStatus(model, status, timeText) {
        const tab = document.querySelector(`.model-tab[data-model="${model}"]`);
        if (tab) {
            tab.classList.remove('success', 'error', 'warning');
            if (status !== 'running') {
                tab.classList.add(status);
            }
        }
        const timeEl = document.getElementById(`tab-time-${model}`);
        if (timeEl) {
            timeEl.textContent = timeText;
        }
    }
    
    // åˆ‡æ¢æ¨¡å‹æ ‡ç­¾
    function switchModelTab(model) {
        currentViewingModel = model;
        
        // æ›´æ–°æ ‡ç­¾æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.model-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.model === model) {
                tab.classList.add('active');
            }
        });
        
        // æ˜¾ç¤ºè¯¥æ¨¡å‹çš„ç»“æœ
        displayModelResult(model);
    }
    
    // æ˜¾ç¤ºæ¨¡å‹ç»“æœ
    function displayModelResult(model) {
        const result = multiModelResults[model];
        const config = AI_PROVIDERS[model];
        
        // åŸå§‹è¾“å‡º
        const rawEl = document.getElementById('model-raw-output');
        if (result.status === 'running') {
            rawEl.textContent = 'â³ æ­£åœ¨è¯·æ±‚ ' + (config?.name || model) + '...';
        } else if (result.status === 'error') {
            rawEl.textContent = 'âŒ é”™è¯¯: ' + result.error;
        } else {
            rawEl.textContent = result.raw || '(æ— è¾“å‡º)';
        }
        
        // è§£æç»“æœ
        const parsedEl = document.getElementById('model-parsed-result');
        if (result.status === 'running') {
            parsedEl.innerHTML = 'â³ ç­‰å¾…ç»“æœ...';
        } else if (result.status === 'error') {
            parsedEl.innerHTML = '<span style="color:#ef5350;">è¯·æ±‚å¤±è´¥</span>';
        } else if (result.parsed && result.parsed.length > 0) {
            parsedEl.innerHTML = result.parsed.map(bet => {
                const target = bet.numbers?.join(',') || bet.target || '';
                const reason = bet.reason ? `<span style="color:#888;font-size:10px;"> (${bet.reason})</span>` : '';
                return `${bet.type} â†’ ${target} Ã— ${bet.amount}å…ƒ${reason}`;
            }).join('<br>');
        } else {
            parsedEl.innerHTML = '<span style="color:#ffa726;">æ— æ³•è§£ææˆ–ç»“æœä¸ºç©º</span>';
        }
        
        // çŠ¶æ€åŒºåŸŸ
        const statusEl = document.getElementById('model-status');
        const useBtnEl = document.getElementById('model-use-btn');
        
        if (result.status === 'running') {
            statusEl.innerHTML = 'â³ è¿è¡Œä¸­...';
            useBtnEl.style.display = 'none';
        } else if (result.status === 'success') {
            statusEl.innerHTML = `âœ… è§£ææˆåŠŸ (${result.parsed.length}æ¡ä¸‹æ³¨)`;
            useBtnEl.style.display = 'block';
        } else if (result.status === 'warning') {
            statusEl.innerHTML = 'âš ï¸ éƒ¨åˆ†é”™è¯¯';
            useBtnEl.style.display = 'block';
        } else {
            statusEl.innerHTML = 'âŒ è¯·æ±‚å¤±è´¥';
            useBtnEl.style.display = 'none';
        }
    }
    
    // ä½¿ç”¨å½“å‰æ¨¡å‹çš„ç»“æœ
    function useModelResult() {
        const result = multiModelResults[currentViewingModel];
        if (result && result.parsed && result.parsed.length > 0) {
            // å°†è§£æç»“æœåº”ç”¨åˆ°ä¸»ç•Œé¢
            parsedBets = result.parsed;
            
            // åˆ‡æ¢åˆ°è¯¥æ¨¡å‹
            switchAIModel(currentViewingModel);
            
            // å…³é—­å¼¹çª—
            closeMultiModelModal();
            
            // æ‰§è¡Œè®¡ç®—
            calculateBets();
            
            showAutoCloseToast('âœ… å·²é€‰ç”¨ ' + AI_PROVIDERS[currentViewingModel].name + ' çš„ç»“æœ');
        }
    }
    
    // å…³é—­å¤šæ¨¡å‹å¼¹çª—
    function closeMultiModelModal() {
        document.getElementById('multi-model-modal').style.display = 'none';
    }
    
    // ==================== ç»“æŸå¤šæ¨¡å‹å¯¹æ¯”æµ‹è¯• ====================
    
    // åˆ‡æ¢AIæ¨¡å‹
    function changeAIModel(provider) {
        // åŒæ­¥åˆ°éšè—çš„ select
        document.getElementById('ai-provider').value = provider;
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('ai_provider', provider);
        
        // æ›´æ–°æç¤ºä¿¡æ¯
        const config = AI_PROVIDERS[provider];
        const tipEl = document.getElementById('ai-model-tip');
        if (tipEl && config) {
            if (config.region === 'overseas') {
                tipEl.innerHTML = 'âš ï¸ å½“å‰ï¼š' + config.name + '<br><span style="color:#ffa726;">æµ·å¤–æ¨¡å‹éœ€å…ˆéƒ¨ç½²Cloudflare Worker</span>';
                tipEl.style.background = 'rgba(255,152,0,0.1)';
                tipEl.style.color = '#ffa726';
            } else if (config.region === 'direct') {
                tipEl.innerHTML = 'âœ… å½“å‰ï¼š' + config.name + 'ï¼ˆç¬¬ä¸‰æ–¹ä¸­è½¬ï¼Œç¨³å®šç›´è¿ï¼‰';
                tipEl.style.background = 'rgba(33,150,243,0.1)';
                tipEl.style.color = '#64b5f6';
            } else {
                tipEl.innerHTML = 'âœ… å½“å‰ï¼š' + config.name + 'ï¼ˆå›½å†…ç›´è¿ï¼Œé€Ÿåº¦å¿«ï¼‰';
                tipEl.style.background = 'rgba(76,175,80,0.1)';
                tipEl.style.color = '#81c784';
            }
        }
        
        console.log('AIæ¨¡å‹å·²åˆ‡æ¢ä¸º:', provider, config);
    }
    
    // æµ‹è¯•å½“å‰AIæ¨¡å‹ï¼ˆAPI Key å·²åœ¨åç«¯é…ç½®ï¼‰
    async function testCurrentAI() {
        const provider = document.getElementById('ai-provider').value;
        const config = AI_PROVIDERS[provider];
        
        showAutoCloseToast('ğŸ”„ æ­£åœ¨æµ‹è¯• ' + config.name + '...', 10000);
        
        try {
            const startTime = Date.now();
            // API Key åœ¨åç«¯ï¼Œä¸éœ€è¦ä¼ é€’
            const result = await callAIAPI('è¯·å›å¤"è¿æ¥æˆåŠŸ"å››ä¸ªå­—', provider);
            const elapsed = Date.now() - startTime;
            
            if (result) {
                showAutoCloseToast('âœ… ' + config.name + ' è¿æ¥æˆåŠŸï¼\nå“åº”æ—¶é—´: ' + elapsed + 'ms');
            } else {
                alert('âŒ ' + config.name + ' è¿æ¥å¤±è´¥\nè¯·æ£€æŸ¥é˜¿é‡Œäº‘å‡½æ•°æ˜¯å¦æ­£ç¡®é…ç½®äº†API Key');
            }
        } catch (e) {
            alert('âŒ ' + config.name + ' è¿æ¥å¤±è´¥\n\né”™è¯¯: ' + e.message + '\n\n' + getErrorGuide(provider, e.message));
        }
    }
    
    // è·å–API Keyé…ç½®æŒ‡å—
    function getAPIKeyGuide(provider) {
        const guides = {
            deepseek: 'è·å–æ–¹å¼ï¼š\n1. è®¿é—® platform.deepseek.com\n2. æ³¨å†Œç™»å½•ååˆ›å»ºAPI Key',
            qwen: 'è·å–æ–¹å¼ï¼š\n1. è®¿é—® dashscope.console.aliyun.com\n2. å¼€é€šæ¨¡å‹æœåŠ¡å¹¶åˆ›å»ºAPI Key',
            tuzi: 'è·å–æ–¹å¼ï¼š\n1. è®¿é—® å…”å­APIå®˜ç½‘\n2. æ³¨å†Œåå……å€¼è·å–API Key',
            claude: 'ä½¿ç”¨å…”å­APIä¸­è½¬ï¼Œæ— éœ€å•ç‹¬è·å–',
            gpt: 'ä½¿ç”¨å…”å­APIä¸­è½¬ï¼Œæ— éœ€å•ç‹¬è·å–',
            openai: 'è·å–æ–¹å¼ï¼š\n1. è®¿é—® platform.openai.com\n2. åˆ›å»ºAPI Key\n\nâš ï¸ æ³¨æ„ï¼šéœ€å…ˆéƒ¨ç½²Cloudflare Workeræ‰èƒ½åœ¨å›½å†…ä½¿ç”¨'
        };
        return guides[provider] || 'è¯·åˆ°å¯¹åº”å¹³å°è·å–API Key';
    }
    
    // è·å–é”™è¯¯è¯Šæ–­æŒ‡å—
    function getErrorGuide(provider, errorMsg) {
        const config = AI_PROVIDERS[provider];
        if (config.region === 'overseas') {
            if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                return 'å¯èƒ½åŸå› ï¼š\n1. Cloudflare Workeræœªæ­£ç¡®éƒ¨ç½²\n2. ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯·å…ˆæŒ‰ç…§éƒ¨ç½²æ•™ç¨‹é…ç½®Cloudflare Worker';
            }
        }
        if (errorMsg.includes('401') || errorMsg.includes('Unauthorized')) {
            return 'å¯èƒ½åŸå› ï¼šAPI Keyæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–';
        }
        if (errorMsg.includes('429')) {
            return 'å¯èƒ½åŸå› ï¼šAPIè°ƒç”¨é¢‘ç‡è¶…é™æˆ–ä½™é¢ä¸è¶³';
        }
        return 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPI Keyé…ç½®';
    }
    
    // æµ‹è¯•AIè¿æ¥ï¼ˆAPI Key å·²åœ¨åç«¯é…ç½®ï¼‰
    async function testAIConnection() {
        const provider = document.getElementById('ai-provider').value;
        
        showAutoCloseToast('ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...', 5000);
        
        try {
            // API Key åœ¨åç«¯ï¼Œä¸éœ€è¦ä¼ é€’
            const result = await callAIAPI('æµ‹è¯•è¿æ¥ï¼Œè¯·å›å¤"è¿æ¥æˆåŠŸ"', provider);
            if (result) {
                showAutoCloseToast('âœ… AIè¿æ¥æˆåŠŸï¼');
            } else {
                alert('âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é˜¿é‡Œäº‘å‡½æ•°ç¯å¢ƒå˜é‡é…ç½®');
            }
        } catch (e) {
            alert('âŒ è¿æ¥å¤±è´¥: ' + e.message);
        }
    }
    
    // ==================== AI ä»£ç†é…ç½® ====================
    // é¦™æ¸¯æœåŠ¡å™¨ï¼ˆPythonåç«¯ï¼Œæ”¯æŒFunction Callingï¼‰
    const ALIYUN_PROXY_URL = 'https://rocket-calc.site';
    // Cloudflare Workerï¼ˆæµ·å¤–æ¨¡å‹ä½¿ç”¨ï¼Œå¯è®¿é—®Google/OpenAIï¼‰
    const CLOUDFLARE_PROXY_URL = 'https://ai-proxy.huzhirong6.workers.dev';
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨ä»£ç†ï¼ˆçº¿ä¸Šç¯å¢ƒéœ€è¦ï¼Œæœ¬åœ°ä¸éœ€è¦ï¼‰
    function shouldUseProxy() {
        const host = window.location.hostname;
        // æœ¬åœ°å¼€å‘ç¯å¢ƒä¸ä½¿ç”¨ä»£ç†
        return host !== 'localhost' && host !== '127.0.0.1' && !host.startsWith('192.168.');
    }
    
    // æ ¹æ®æ¨¡å‹åŒºåŸŸè·å–ä»£ç†URL
    // å›½å†…æ¨¡å‹ â†’ é˜¿é‡Œäº‘ï¼ˆé€Ÿåº¦å¿«ï¼‰
    // æµ·å¤–æ¨¡å‹ â†’ Cloudflareï¼ˆèƒ½è®¿é—®Google/OpenAIï¼‰
    // ç›´è¿æ¨¡å‹ â†’ è¿”å› nullï¼ˆç¬¬ä¸‰æ–¹ä¸­è½¬APIï¼Œç›´æ¥è°ƒç”¨ï¼‰
    function getProxyUrl(provider) {
        const config = AI_PROVIDERS[provider];
        if (config && config.region === 'direct') {
            console.log('ğŸ“¡ ç¬¬ä¸‰æ–¹ä¸­è½¬APIï¼Œç›´æ¥è°ƒç”¨æ— éœ€ä»£ç†');
            return null;  // ç›´è¿æ¨¡å¼ï¼Œä¸ä½¿ç”¨ä»£ç†
        }
        if (config && config.region === 'overseas') {
            console.log('ğŸ“¡ æµ·å¤–æ¨¡å‹ï¼Œä½¿ç”¨ Cloudflare ä»£ç†');
            return CLOUDFLARE_PROXY_URL;
        }
        console.log('ğŸ“¡ å›½å†…æ¨¡å‹ï¼Œä½¿ç”¨é˜¿é‡Œäº‘ä»£ç†');
        return ALIYUN_PROXY_URL;
    }
    
    // è°ƒç”¨AI APIï¼ˆå¢å¼ºç‰ˆï¼šè¯¦ç»†é”™è¯¯è¯Šæ–­ + é‡è¯•æœºåˆ¶ + å¤šç«™ç‚¹åˆ‡æ¢ï¼‰
    // âš ï¸ API Key å·²ç§»è‡³é˜¿é‡Œäº‘å‡½æ•°ç¯å¢ƒå˜é‡ï¼Œå‰ç«¯ä¸å†ä¼ é€’
    async function callAIAPI(prompt, provider, apiKey = null, retryCount = 0) {
        const config = AI_PROVIDERS[provider];
        if (!config) throw new Error('æœªçŸ¥çš„AIæœåŠ¡å•†');
        
        // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆå¢åŠ è¶…æ—¶æ—¶é—´ï¼ŒGeminiç­‰æ¨¡å‹å“åº”è¾ƒæ…¢ï¼‰
        const controller = new AbortController();
        // ç›´è¿APIï¼š60ç§’ï¼Œé˜¿é‡Œäº‘ä»£ç†ï¼š45ç§’ï¼ˆGeminiç­‰éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
        const timeoutMs = config.region === 'direct' ? 60000 : 45000;
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        
        // è®°å½•è¯·æ±‚æ¨¡å¼ï¼ˆç”¨äºè¯Šæ–­ï¼‰
        // æ ¹æ®æ¨¡å‹åŒºåŸŸé€‰æ‹©ä»£ç†ï¼šå›½å†…â†’é˜¿é‡Œäº‘ï¼Œæµ·å¤–â†’Cloudflareï¼Œç›´è¿â†’æ— ä»£ç†
        const proxyUrl = getProxyUrl(provider);
        const useProxy = shouldUseProxy() && proxyUrl;
        let proxyName, requestMode;
        if (config.region === 'direct') {
            requestMode = 'ç›´è¿æ¨¡å¼(ç¬¬ä¸‰æ–¹ä¸­è½¬)';
        } else if (useProxy) {
            proxyName = config.region === 'overseas' ? 'Cloudflare' : 'é˜¿é‡Œäº‘';
            requestMode = `ä»£ç†æ¨¡å¼(${proxyName})`;
        } else {
            requestMode = 'ç›´è¿æ¨¡å¼';
        }
        
        // å…”å­APIå¤šç«™ç‚¹æ”¯æŒ
        let tuziUrl = null;
        if (config.useTuziMultiSite) {
            tuziUrl = tuziSiteManager.getCurrentUrl();
            console.log(`ğŸ° å…”å­APIç«™ç‚¹: ${tuziSiteManager.getCurrentName()} - ${tuziUrl}`);
        }
        
        const targetUrl = useProxy ? proxyUrl : (tuziUrl || config.url);
        
        // ä¿å­˜è¯Šæ–­ä¿¡æ¯
        debugInfo.requestMode = requestMode;
        debugInfo.targetUrl = targetUrl;
        debugInfo.networkError = '';
        
        // ğŸ†• v3.12 ç²¾ç®€ï¼šè°ƒè¯•ä¿¡æ¯å·²ä¿å­˜åˆ° debugInfoï¼Œä¸è¾“å‡ºåˆ°æ§åˆ¶å°
        
        try {
            let response;
            const startTime = Date.now();
            
            // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ä»£ç†ï¼ˆå¿…é¡»ä½¿ç”¨ä»£ç†ï¼ŒAPI Key åœ¨åç«¯ï¼‰
            if (useProxy) {
                // çº¿ä¸Šç¯å¢ƒï¼šé€šè¿‡é˜¿é‡Œäº‘å‡½æ•°ä»£ç†ï¼ˆAPI Key åœ¨åç«¯ç¯å¢ƒå˜é‡ï¼‰
                // ğŸ†• ä½¿ç”¨æ–°ç‰ˆ /api/analyze æ¥å£ï¼Œæ”¯æŒ Function Calling
                const isAliyunProxy = proxyUrl === ALIYUN_PROXY_URL;
                
                if (isAliyunProxy) {
                    // é˜¿é‡Œäº‘ä»£ç†ï¼šä½¿ç”¨æ–°ç‰ˆ /api/analyze æ¥å£ (Function Calling)
                    // ğŸ†• v3.12 ç²¾ç®€ï¼šç§»é™¤å†—ä½™æ—¥å¿—
                    
                    // ä» prompt ä¸­æå–å®é™…æ–‡æœ¬å†…å®¹
                    let text = prompt;
                    if (prompt.includes('ã€è¾“å…¥ã€‘')) {
                        text = prompt.split('ã€è¾“å…¥ã€‘').pop().trim();
                    }
                    
                    // ğŸ†• v3.0 ä½¿ç”¨ä¸­æ€§å­—æ®µåï¼ˆé¿å…æ•æ„Ÿè¯ï¼‰
                    const requestBody = {
                        p: provider,    // æœåŠ¡å•†
                        t: text,        // è¾“å…¥æ–‡æœ¬
                        m: config.model,// æ¨¡å‹
                        e: true         // æ˜¯å¦æå–æ•°å€¼
                    };
                    
                    response = await fetch(`${proxyUrl}/api/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                } else {
                    // Cloudflare/å…¶ä»–ä»£ç†ï¼šä½¿ç”¨æ—§ç‰ˆæ¥å£
                    // ğŸ†• v3.0 ä½¿ç”¨ä¸­æ€§å­—æ®µå
                    const requestBody = {
                        p: provider,    // æœåŠ¡å•†
                        prompt: prompt, // æ—§ç‰ˆæ¥å£ä»éœ€ promptï¼ˆå…¼å®¹ï¼‰
                        m: config.model // æ¨¡å‹
                    };
                    if (tuziUrl) {
                        requestBody.tuziUrl = tuziUrl;
                    }
                    response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }
            } else {
                // æœ¬åœ°è°ƒè¯•ï¼šä»éœ€é€šè¿‡ä»£ç†ï¼ˆå› ä¸ºKeyåœ¨åç«¯ï¼‰
                console.log('âš ï¸ ç›´è¿æ¨¡å¼å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨ä»£ç†æ¨¡å¼');
                throw new Error('è¯·éƒ¨ç½²é˜¿é‡Œäº‘å‡½æ•°ä»£ç†ï¼ŒAPI Key å·²ç§»è‡³åç«¯');
            }
            
            clearTimeout(timeoutId);
            const elapsed = Date.now() - startTime;
            // ğŸ†• v3.12 ç²¾ç®€ï¼šåªåœ¨å¤±è´¥æ—¶è¾“å‡ºçŠ¶æ€ç 
            
            if (!response.ok) {
                const err = await response.text();
                debugInfo.networkError = `HTTP ${response.status}: ${err.substring(0, 200)}`;
                throw new Error(`APIé”™è¯¯: ${response.status} - ${err}`);
            }
            
            const responseText = await response.text();
            // ğŸ†• v3.12 ç²¾ç®€ï¼šä¸è¾“å‡ºå¤§é‡åŸå§‹å“åº”ï¼Œä¿å­˜åˆ° debugInfo å³å¯
            debugInfo.rawResponse = responseText.substring(0, 500);
            
            // å°è¯•è§£æ JSON
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseErr) {
                debugInfo.networkError = `JSONè§£æå¤±è´¥: ${responseText.substring(0, 100)}`;
                throw new Error('ä»£ç†è¿”å›éJSONæ•°æ®: ' + responseText.substring(0, 100));
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
            if (data.error) {
                debugInfo.networkError = `APIè¿”å›é”™è¯¯: ${JSON.stringify(data.error).substring(0, 200)}`;
                throw new Error(data.error.message || JSON.stringify(data.error));
            }
            
            // æ£€æŸ¥å“åº”ç»“æ„
            // ğŸ†• æ–°ç‰ˆé˜¿é‡Œäº‘ /api/analyze æ ¼å¼: { success: true, data: [...], model_used: "...", latency_ms: 123 }
            // å…”å­APIæ ¼å¼: { code: 0, data: { choices: [...] } }
            // æ ‡å‡†OpenAIæ ¼å¼: { choices: [...] }
            
            let content = null;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç‰ˆ /api/analyze å“åº”
            if (data.success !== undefined && data.data !== undefined) {
                // ğŸ†• æ–°ç‰ˆ Function Calling å“åº”
                console.log('ğŸ“¦ æ”¶åˆ° Function Calling å“åº”:', data);
                if (data.success) {
                    // data.data æ˜¯æ•°ç»„æ ¼å¼: [{code, original, numbers, amount}, ...]
                    content = JSON.stringify(data.data);
                    console.log(`âœ… Function Calling æˆåŠŸ: æ¨¡å‹=${data.model_used}, è€—æ—¶=${data.latency_ms}ms`);
                    
                    // ğŸ“Œ ä¿å­˜è°ƒè¯•ä¿¡æ¯ï¼ˆç”¨äºåé¦ˆï¼‰
                    debugInfo.modelUsed = data.model_used || 'unknown';
                    debugInfo.latencyMs = data.latency_ms || 0;
                    
                    // ğŸ” ã€è°ƒè¯•ä¿¡æ¯ã€‘æ¸…æ™°å±•ç¤º AI æ˜¯å¦‚ä½•ç†è§£è¾“å…¥çš„ï¼ˆæœ¬åœ°æ˜¾ç¤ºï¼Œå¯ç”¨ä¸­æ–‡ï¼‰
                    // ç±»å‹ä»£å·â†’ä¸­æ–‡åç§°æ˜ å°„ï¼ˆä»…ç”¨äºæœ¬åœ°æ—¥å¿—æ˜¾ç¤ºï¼‰
                    const CODE_NAME_MAP = {
                        'T01': 'ç‰¹ç ', 'TM': 'ç‰¹ç ', 'T': 'ç‰¹ç ',
                        'SXTM': 'ç”Ÿè‚–ç‰¹ç ', 'SX': 'ç”Ÿè‚–',
                        'BS': 'æ³¢è‰²', 'BB': 'åŠæ³¢',
                        'PT1': 'å¹³ç‰¹ä¸€è‚–', 'PT2': 'å¹³ç‰¹äºŒè¿è‚–', 'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–',
                        'PT4': 'å¹³ç‰¹å››è¿è‚–', 'PT5': 'å¹³ç‰¹äº”è¿è‚–', 'PTW': 'å¹³ç‰¹å°¾æ•°',
                        'LX': 'å…­è‚–', 'TX': 'ç‰¹è‚–', 'HX': 'åˆè‚–', 'ZX': 'æ­£è‚–',
                        'DP': 'å•å¹³', 'DXDS': 'å¤§å°å•åŒ',
                        'E2': 'äºŒä¸­äºŒ', 'S3': 'ä¸‰ä¸­ä¸‰',
                        'BZ': 'ä¸ä¸­', 'LM': 'è¿ç ', 'ZH': 'æ€»å’Œ',
                        'WX': 'äº”è¡Œ', 'JY': 'å®¶é‡', 'UK': 'æœªçŸ¥'
                    };
                    const ZODIAC_NAME_MAP = {
                        'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
                        'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
                        'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
                    };
                    
                    // ğŸ†• v3.12 ç²¾ç®€ï¼šAIåˆ†ææ—¥å¿—åªåœ¨è°ƒè¯•æ¨¡å¼æ˜¾ç¤º
                    if (IS_DEBUG && Array.isArray(data.data)) {
                        console.log('%cğŸ“Š AIåˆ†æç»“æœ:', 'color: #00bcd4; font-weight: bold', `å…±${data.data.length}æ¡`);
                        data.data.forEach((item, idx) => {
                            const type = CODE_NAME_MAP[item.code] || item.code;
                            console.log(`   [${idx+1}] ${type} | ${item.numbers?.length || 0}æ³¨ | ${item.amount}å…ƒ | "${(item.original||'').substring(0,25)}"`);
                        });
                    }
                } else {
                    debugInfo.networkError = `APIè¿”å›é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                    throw new Error(data.error || 'AIåˆ†æå¤±è´¥');
                }
            } else {
                // æ—§ç‰ˆå“åº”æ ¼å¼
                const responseData = data.data || data;  // å…”å­APIçš„æ•°æ®åœ¨data.dataé‡Œ
                content = responseData.choices?.[0]?.message?.content;
                if (!content && responseData.choices) {
                    debugInfo.networkError = `å“åº”ç»“æ„å¼‚å¸¸: choiceså­˜åœ¨ä½†contentä¸ºç©º`;
                } else if (!content) {
                    debugInfo.networkError = `å“åº”æ— choiceså­—æ®µ: ${JSON.stringify(data).substring(0, 200)}`;
                }
            }
            
            // ğŸ° å…”å­APIå¤šç«™ç‚¹ï¼šè¯·æ±‚æˆåŠŸ
            if (config.useTuziMultiSite && content) {
                tuziSiteManager.onSuccess();
            }
            
            return content || null;
        } catch (e) {
            clearTimeout(timeoutId);
            console.error('ğŸŒ ç½‘ç»œè¯·æ±‚å¤±è´¥:', e);
            
            const timeoutSec = timeoutMs / 1000;
            
            // ğŸ° å…”å­APIå¤šç«™ç‚¹ï¼šè¯·æ±‚å¤±è´¥ï¼Œå°è¯•åˆ‡æ¢ç«™ç‚¹
            if (config.useTuziMultiSite && retryCount < TUZI_SITES.length) {
                const hasNextSite = tuziSiteManager.onFailure();
                if (hasNextSite) {
                    console.log(`ğŸ”„ åˆ‡æ¢å…”å­APIç«™ç‚¹åé‡è¯•...`);
                    await new Promise(r => setTimeout(r, 500));  // ç­‰å¾…0.5ç§’åé‡è¯•
                    return callAIAPI(prompt, provider, apiKey, retryCount + 1);
                }
            }
            
            if (e.name === 'AbortError') {
                // è¶…æ—¶æ—¶å°è¯•é‡è¯•ä¸€æ¬¡ï¼ˆä»…å¯¹ç›´è¿æ¨¡å¼ï¼‰
                if (config.region === 'direct' && retryCount < 1) {
                    console.log(`â±ï¸ ç¬¬${retryCount + 1}æ¬¡è¶…æ—¶ï¼Œæ­£åœ¨é‡è¯•...`);
                    return callAIAPI(prompt, provider, apiKey, retryCount + 1);
                }
                debugInfo.networkError = `è¯·æ±‚è¶…æ—¶(${timeoutSec}ç§’)ï¼ŒAIå“åº”å¤ªæ…¢`;
                throw new Error(`AIè¯·æ±‚è¶…æ—¶(${timeoutSec}ç§’)`);
            }
            
            // è¯¦ç»†è®°å½•ç½‘ç»œé”™è¯¯
            if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                debugInfo.networkError = `ç½‘ç»œé”™è¯¯: ${requestMode}è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯CORS/ç½‘ç»œé—®é¢˜`;
                // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿå°è¯•é‡è¯•ï¼ˆéå…”å­APIå¤šç«™ç‚¹æƒ…å†µï¼‰
                if (!config.useTuziMultiSite && retryCount < 1) {
                    console.log(`ğŸ”„ ç½‘ç»œé”™è¯¯ï¼Œæ­£åœ¨é‡è¯•...`);
                    await new Promise(r => setTimeout(r, 1000));  // ç­‰å¾…1ç§’åé‡è¯•
                    return callAIAPI(prompt, provider, apiKey, retryCount + 1);
                }
            } else if (!debugInfo.networkError) {
                debugInfo.networkError = e.message;
            }
            
            throw e;
        }
    }
    
    // ã€ä¿®å¤æ‰‹æœºè¾“å…¥é—®é¢˜ã€‘å…¨è§’è½¬åŠè§’ + æ¸…ç†ä¸å¯è§å­—ç¬¦ï¼ˆå¢å¼ºç‰ˆï¼‰
    function normalizeFullWidth(str) {
        if (!str) return str;
        let result = str;
        
        // ========== 1. ç§»é™¤iOS/æ‰‹æœºè¾“å…¥æ³•äº§ç”Ÿçš„ä¸å¯è§å­—ç¬¦ ==========
        // é›¶å®½å­—ç¬¦ (Zero-width characters)
        result = result.replace(/[\u200B-\u200D\uFEFF]/g, '');
        // é›¶å®½ç©ºæ ¼ã€é›¶å®½è¿æ¥ç¬¦ã€é›¶å®½éè¿æ¥ç¬¦ã€BOM
        
        // å˜ä½“é€‰æ‹©å™¨ (Variation Selectors) - iOSå¸¸è§é—®é¢˜
        result = result.replace(/[\uFE00-\uFE0F]/g, '');
        
        // è½¯è¿å­—ç¬¦
        result = result.replace(/\u00AD/g, '');
        
        // å…¶ä»–ä¸å¯è§æ§åˆ¶å­—ç¬¦ï¼ˆä¿ç•™æ¢è¡Œç¬¦ \n \rï¼‰
        result = result.replace(/[\u0000-\u0009\u000B\u000C\u000E-\u001F\u007F-\u009F]/g, '');
        // æ³¨ï¼š\u000A=\n, \u000D=\r è¢«ä¿ç•™
        
        // ç»„åˆç”¨æ ‡è®°ï¼ˆCombining Marksï¼‰- å¯èƒ½å¯¼è‡´å­—ç¬¦æ˜¾ç¤ºå¼‚å¸¸
        result = result.replace(/[\u0300-\u036F]/g, '');
        
        // ========== 2. å…¨è§’è½¬åŠè§’ ==========
        // å…¨è§’æ•°å­—è½¬åŠè§’ (ï¼-ï¼™ â†’ 0-9)
        result = result.replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));
        
        // å…¨è§’å­—æ¯è½¬åŠè§’ (ï¼¡-ï¼º, ï½-ï½š â†’ A-Z, a-z)
        result = result.replace(/[ï¼¡-ï¼ºï½-ï½š]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));
        
        // å…¨è§’ç©ºæ ¼è½¬åŠè§’
        result = result.replace(/\u3000/g, ' ');
        
        // ä¸é—´æ–­ç©ºæ ¼è½¬æ™®é€šç©ºæ ¼
        result = result.replace(/\u00A0/g, ' ');
        
        // ========== 3. ç‰¹æ®Šæ•°å­—å­—ç¬¦è½¬æ¢ ==========
        // åœˆæ•°å­— â‘ -â‘¨ â†’ 1-9
        const circledNums = {'\u2460':'1','\u2461':'2','\u2462':'3','\u2463':'4','\u2464':'5',
                            '\u2465':'6','\u2466':'7','\u2467':'8','\u2468':'9','\u2469':'10'};
        for (const [special, normal] of Object.entries(circledNums)) {
            result = result.split(special).join(normal);
        }
        
        // ä¸Šæ ‡æ•°å­— â°-â¹
        const superNums = {'\u2070':'0','\u00B9':'1','\u00B2':'2','\u00B3':'3','\u2074':'4',
                        '\u2075':'5','\u2076':'6','\u2077':'7','\u2078':'8','\u2079':'9'};
        for (const [special, normal] of Object.entries(superNums)) {
            result = result.split(special).join(normal);
        }
        
        // ========== 4. å…¨è§’æ ‡ç‚¹è½¬åŠè§’ ==========
        const punctMap = {
            '\uff0e': '.', '\uff0c': ',', '\u3001': ',', '\uff1a': ':', '\uff1b': ';',
            '\uff01': '!', '\uff1f': '?', '\u201c': '"', '\u201d': '"', '\u2018': "'", '\u2019': "'",
            '\uff08': '(', '\uff09': ')', '\u3010': '[', '\u3011': ']', '\uff5b': '{', '\uff5d': '}',
            '\uff0b': '+', '\uff0d': '-', '\uff1d': '=', '\uff0a': '*', '\uff0f': '/', '\uff05': '%',
            '\uff03': '#', '\uff06': '&', '\uff20': '@', '\uff04': '$', '\uff3e': '^', '\uff5c': '|',
            '\uff3c': '\\', '\uff5e': '~', '\uff40': '`', '\uff1c': '<', '\uff1e': '>',
            '\u2014': '-', '\u2013': '-', '\u2012': '-', '\u2010': '-', // å„ç§æ¨ªçº¿è½¬å‡å·
            '\u00D7': 'x', '\u2715': 'x', '\u2716': 'x', '\u2717': 'x', // ä¹˜å·è½¬x
            '\u00F7': '/'  // é™¤å·è½¬æ–œæ 
        };
        for (const [full, half] of Object.entries(punctMap)) {
            result = result.split(full).join(half);
        }
        
        // ========== 5. è§„èŒƒåŒ–æ¢è¡Œå’Œç©ºæ ¼ ==========
        // ç»Ÿä¸€æ¢è¡Œç¬¦ä¸º \n
        result = result.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        // æ¸…ç†æ¯è¡Œé¦–å°¾ç©ºæ ¼ï¼Œä½†ä¿ç•™æ¢è¡Œ
        result = result.split('\n').map(line => line.replace(/[ \t]+/g, ' ').trim()).join('\n');
        // æ¸…ç†å¤šä¸ªè¿ç»­ç©ºè¡Œä¸ºå•ä¸ª
        result = result.replace(/\n{3,}/g, '\n\n');
        
        // ========== 6. è°ƒè¯•æ—¥å¿— ==========
        if (str !== result) {
            console.log('ğŸ“± å­—ç¬¦è§„èŒƒåŒ–:', {
                åŸå§‹: str,
                åŸå§‹é•¿åº¦: str.length,
                å¤„ç†å: result,
                å¤„ç†åé•¿åº¦: result.length,
                åŸå§‹å­—ç¬¦ç : [...str].map(c => c.charCodeAt(0).toString(16)).join(' ')
            });
        }
        
        return result;
    }
    
    // AIè§£æä¸‹æ³¨ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆï¼šZä»£å·æ ¼å¼ + JSONä¿®å¤ + é‡è¯•æœºåˆ¶ï¼‰
    async function parseWithAI(userInput) {
        // ä½¿ç”¨ getFormatSettings() è·å–å¸¦é»˜è®¤å€¼çš„è®¾ç½®ï¼ˆAPI Key å·²åœ¨åç«¯ï¼‰
        const settings = getFormatSettings();
        if (!settings.aiEnabled) {
            return null;
        }
        
        // ã€æ­¥éª¤1ã€‘é¢„å¤„ç†ï¼šå…¨è§’è½¬åŠè§’ï¼Œè§£å†³æ‰‹æœºè¾“å…¥é—®é¢˜
        const originalInput = userInput;
        userInput = normalizeFullWidth(userInput);
        
        // è®°å½•è§„èŒƒåŒ–ä¿¡æ¯
        if (originalInput !== userInput) {
            console.log('ğŸ“± æ£€æµ‹åˆ°ç‰¹æ®Šå­—ç¬¦ï¼Œå·²è§„èŒƒåŒ–:', {
                åŸå§‹è¾“å…¥: originalInput,
                è§„èŒƒåŒ–å: userInput
            });
            debugInfo.normalizeInfo = `åŸå§‹(${originalInput.length}å­—ç¬¦) â†’ è§„èŒƒåŒ–(${userInput.length}å­—ç¬¦)`;
        } else {
            debugInfo.normalizeInfo = '';
        }
        
        // ã€æ­¥éª¤2ã€‘ğŸ”„ ç”Ÿè‚–ä»£å·è½¬æ¢ï¼ˆåç«¯FlashLexå¼•æ“éœ€è¦ Z ä»£å·æ ¼å¼ï¼‰
        const sanitizedInput = sanitizeText(userInput);
        console.log('ğŸ”„ ä»£å·è½¬æ¢:', userInput.substring(0, 30), 'â†’', sanitizedInput.substring(0, 30));
        
        // ä¿å­˜è½¬æ¢å‰åçš„å¯¹åº”å…³ç³»ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        debugInfo.originalInput = userInput;
        debugInfo.sanitizedInput = sanitizedInput;
        
        // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        // â•‘     ã€AIæç¤ºè¯ v3.0ã€‘Zä»£å·æ ¼å¼ - åç«¯FlashLexå¼•æ“éœ€è¦           â•‘
        // â•‘  ä¸­æ–‡ç”Ÿè‚–å·²è½¬æ¢ä¸ºZä»£å·ï¼ˆå¦‚ ç¾Šâ†’Z8ï¼‰ï¼Œä¾¿äºæ­£åˆ™åŒ¹é…               â•‘
        // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const prompt = `ä½ æ˜¯æ•°æ®åˆ†ç±»å™¨ã€‚åˆ¤æ–­æ¯æ¡æ•°æ®çš„ç±»å‹ä»£å·ã€‚

ã€ç±»å‹ä»£å·ã€‘
TM/T=Tç±» SXTM=Zé€‰ç±» SX=Zç±» 
C1/C2/C3=Cç±» C1S/C1D/C2B/C2X=CåŠç±»
PT/PT1=PTç±»1 PT2=PTç±»2 PT3=PTç±»3 PT4=PTç±»4 PT5=PTç±»5 PTW=PTå°¾ç±»
LX6=LXç±» HX=HXç±» ZX=ZXç±» DP=DPç±» DXDS=å¤§å°å•åŒç±»
E2=E2ç±» S3=S3ç±» BZ5-BZ12=BZç±»
LM2Q/LM3Q/LM2Z/LM3Z/LMTC=LMç±»
ZH/ZHB/ZHX/ZHS/ZHD=ZHç±»
WXJ/WXM/WXS/WXH/WXT=WXç±»
JYJ/JYY=JYç±» XS=XSç±» DS=DSç±» ODD/EVEN=å¥‡å¶ç±»

ã€Zä»£å·ã€‘Z1-Z12ä»£è¡¨12ç§å±æ€§åˆ†ç±»

ã€è¯†åˆ«è§„åˆ™ã€‘æŒ‰ä¼˜å…ˆçº§ï¼š
1. Zä»£å·+x/X/å„+æ•°å€¼ â†’ SXTMï¼ˆå¦‚ï¼šZ5x10ã€é€‰Z12å„20ï¼‰
2. å«"T"å­— â†’ TMï¼ˆå¦‚ï¼šT43 20ï¼‰
3. å«PT/PT1 â†’ PT1 | PT2â†’PT2 | PT3â†’PT3 | PT4â†’PT4 | PT5â†’PT5
4. å«PTW â†’ PTW
5. å«LX6 â†’ LX6
6. å«BZ+æ•°å­— â†’ BZç±»ï¼ˆBZ5/BZ6/.../BZ12ï¼‰
7. å«E2 â†’ E2 | S3 â†’ S3
8. å«HX â†’ HX | ZX â†’ ZX | DP â†’ DP
9. å«C1/C2/C3 â†’ Cç±» | C1S/C2Dç­‰ â†’ CåŠç±»
10. å«ZH â†’ ZHç±» | WXä»£å· â†’ WXç±» | JYä»£å· â†’ JYç±»
11. å«XS â†’ XS | DS â†’ DS | ODD â†’ ODD | EVEN â†’ EVEN
12. "å¤§/å°/å•/åŒ"+æ•°å€¼ â†’ DXDS
13. Zä»£å·+çº¯æ•°å€¼(æ— xæ— å„) â†’ SX
14. çº¯æ•°å­—+å„+æ•°å€¼ â†’ TM

ã€ç¤ºä¾‹ã€‘
è¾“å…¥: é€‰Z12å„10
è¾“å‡º: [["SXTM","é€‰Z12å„10"]]

è¾“å…¥: Z5x10
è¾“å‡º: [["SXTM","Z5x10"]]

è¾“å…¥: Z11x80ï¼ŒZ9Z10x50
è¾“å‡º: [["SXTM","Z11x80"],["SXTM","Z9Z10x50"]]

è¾“å…¥: Z12 10
è¾“å‡º: [["SX","Z12 10"]]

è¾“å…¥: 10 12 20å„30
è¾“å‡º: [["TM","10 12 20å„30"]]

è¾“å…¥: XSå„20
è¾“å‡º: [["XS","XSå„20"]]

è¾“å…¥: DSå„30
è¾“å‡º: [["DS","DSå„30"]]

è¾“å…¥: PT Z8 300ï¼ŒPT3 Z8Z10Z9 100ï¼Œ35ï¼Œ47ï¼ŒX10
è¾“å‡º: [["PT1","PT Z8 300"],["PT3","PT3 Z8Z10Z9 100"],["TM","35ï¼Œ47ï¼ŒX10"]]

è¾“å…¥: BZ5 01,02,03,04,05å„100
è¾“å‡º: [["BZ5","BZ5 01,02,03,04,05å„100"]]

è¾“å…¥: C1 100
è¾“å‡º: [["C1","C1 100"]]

è¾“å…¥: 31.34å„äºŒå
è¾“å‡º: [["TM","31.34å„äºŒå"]]

ã€è¾“å…¥ã€‘
${sanitizedInput}

ã€è¾“å‡ºã€‘åªè¾“å‡ºJSONæ•°ç»„ï¼š`;

        // ä¿å­˜è¾“å…¥åˆ°è°ƒè¯•ä¿¡æ¯
        debugInfo.aiInput = sanitizedInput;  // è®°å½•ä»£å·è½¬æ¢åçš„è¾“å…¥
        debugInfo.lastError = '';
        
        try {
            console.log('ğŸ¤– å¼€å§‹è°ƒç”¨AI APIï¼ˆZä»£å·æ ¼å¼ï¼‰...');
            console.log('ğŸ”„ å‘é€ç»™AIçš„å†…å®¹:', sanitizedInput);
            
            const result = await callAIAPI(prompt, settings.aiProvider);
            console.log('ğŸ¤– AIè¿”å›åŸå§‹ç»“æœ:', result);
            
            // ä¿å­˜AIåŸå§‹è¾“å‡º
            debugInfo.aiOutput = result || '(ç©º)';
            
            if (result) {
                // ã€æ­¥éª¤3ã€‘JSONä¿®å¤ï¼šå¤„ç†AIå¯èƒ½çš„æ ¼å¼é”™è¯¯
                let jsonStr = repairJSON(result);
                console.log('ğŸ”§ JSONä¿®å¤å:', jsonStr);
                
                // è§£æJSON
                let aiResult;
                try {
                    aiResult = JSON.parse(jsonStr);
                } catch (parseError) {
                    console.error('âŒ JSONè§£æå¤±è´¥:', parseError.message);
                    debugInfo.lastError = 'JSONè§£æå¤±è´¥: ' + parseError.message;
                    return null;
                }
                
                // ã€æ­¥éª¤4ã€‘æ ¡éªŒç»“æœæ ¼å¼
                const validation = validateAIResult(aiResult);
                if (!validation.valid) {
                    console.warn('âš ï¸ AIç»“æœæ ¡éªŒè­¦å‘Š:', validation.error);
                }
                
                console.log('ğŸ¤– AIè¯†åˆ«ç»“æœï¼ˆZä»£å·ï¼‰:', aiResult);
                
                // ã€æ­¥éª¤5ã€‘è¿˜åŸä»£å·ï¼šZä»£å·â†’ä¸­æ–‡ç”Ÿè‚–
                const restoredResult = restoreAIResult(aiResult);
                // v3.11.3 ç§»é™¤å†—ä½™çš„è¿˜åŸæ—¥å¿—
                
                // ä¿å­˜è§£æåçš„JSONï¼ˆè¿˜åŸåçš„ï¼‰
                debugInfo.aiParsed = restoredResult;
                
                // ã€ä»£å·â†’ç±»å‹åæ˜ å°„ã€‘ï¼ˆæ‰©å±•ç‰ˆï¼Œæ”¯æŒæ–°æ—§ä»£å·ï¼‰
            const CODE_TO_TYPE = {
                // åŸºç¡€ç±»å‹
                'T01': 'ç‰¹ç ', 'TM': 'ç‰¹ç ', 'T': 'ç‰¹ç ', 'SXTM': 'ç”Ÿè‚–ç‰¹ç ', 'SX': 'ç”Ÿè‚–',
                    // æ³¢è‰²
                    'BS': 'æ³¢è‰²', 'C1': 'æ³¢è‰²', 'C2': 'æ³¢è‰²', 'C3': 'æ³¢è‰²',
                    'BB': 'åŠæ³¢', 'C1S': 'åŠæ³¢', 'C1D': 'åŠæ³¢', 'C1B': 'åŠæ³¢', 'C1X': 'åŠæ³¢',
                    'C2S': 'åŠæ³¢', 'C2D': 'åŠæ³¢', 'C2B': 'åŠæ³¢', 'C2X': 'åŠæ³¢',
                    'C3S': 'åŠæ³¢', 'C3D': 'åŠæ³¢', 'C3B': 'åŠæ³¢', 'C3X': 'åŠæ³¢',
                    // å¹³ç‰¹ç±»
                    'PT': 'å¹³ç‰¹ä¸€è‚–', 'PT1': 'å¹³ç‰¹ä¸€è‚–', 'PT2': 'å¹³ç‰¹äºŒè¿è‚–', 'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–',
                    'PT4': 'å¹³ç‰¹å››è¿è‚–', 'PT5': 'å¹³ç‰¹äº”è¿è‚–', 'PTW': 'å¹³ç‰¹å°¾æ•°',
                    // ç”Ÿè‚–ç»„åˆ
                    'LX': 'å…­è‚–', 'LX6': 'å…­è‚–', 'TX': 'ç‰¹è‚–', 'HX': 'åˆè‚–', 'ZX': 'æ­£è‚–',
                    // å¹³ç 
                    'DP': 'å•å¹³', 'DXDS': 'å¤§å°å•åŒ',
                    // è¿ç 
                    'E2': 'äºŒä¸­äºŒ', 'S3': 'ä¸‰ä¸­ä¸‰',
                    'LM': 'è¿ç ', 'LM2Q': 'äºŒå…¨ä¸­', 'LM3Q': 'ä¸‰å…¨ä¸­', 
                    'LM2Z': 'äºŒä¸­ç‰¹', 'LM3Z': 'ä¸‰ä¸­ç‰¹', 'LMTC': 'ç‰¹ä¸²',
                    // ä¸ä¸­
                    'BZ': 'ä¸ä¸­', 'BZ5': 'äº”ä¸ä¸­', 'BZ6': 'å…­ä¸ä¸­', 'BZ7': 'ä¸ƒä¸ä¸­',
                    'BZ8': 'å…«ä¸ä¸­', 'BZ9': 'ä¹ä¸ä¸­', 'BZ10': 'åä¸ä¸­',
                    'BZ11': 'åä¸€ä¸ä¸­', 'BZ12': 'åäºŒä¸ä¸­',
                    // å…¶ä»–
                    'ZH': 'æ€»å’Œ', 'ZHB': 'æ€»å’Œå¤§', 'ZHX': 'æ€»å’Œå°', 'ZHS': 'æ€»å’Œå•', 'ZHD': 'æ€»å’ŒåŒ',
                    'WX': 'äº”è¡Œ', 'WXJ': 'äº”è¡Œ', 'WXM': 'äº”è¡Œ', 'WXS': 'äº”è¡Œ', 'WXH': 'äº”è¡Œ', 'WXT': 'äº”è¡Œ',
                    'JY': 'å®¶é‡', 'JYJ': 'å®¶é‡', 'JYY': 'å®¶é‡',
                    'XS': 'å°æ•°', 'DS': 'å¤§æ•°', 'ODD': 'å•æ•°', 'EVEN': 'åŒæ•°',
                    'UK': 'æœªçŸ¥'
                };
                
                // ã€æ ¸å¿ƒã€‘å¤„ç†è¿˜åŸåçš„ç»“æœï¼Œæå–å…·ä½“æ•°å€¼
                const bets = [];
                
                // ğŸ†• v3.12 ç²¾ç®€ï¼šå‰ç«¯è§£ææ—¥å¿—åªåœ¨è°ƒè¯•æ¨¡å¼æ˜¾ç¤º
                if (Array.isArray(restoredResult)) {
                    for (const item of restoredResult) {
                        if (Array.isArray(item) && item.length >= 2) {
                            const code = item[0];
                            const raw = item[1];  // è¿™é‡Œæ˜¯è¿˜åŸåçš„åŸæ–‡
                            const numbers = item[2];  // ğŸ†• Function Calling æå–çš„å·ç 
                            const amount = item[3];   // ğŸ†• Function Calling æå–çš„é‡‘é¢
                            const zodiacCode = item[4]; // ğŸ†• ç”Ÿè‚–ä»£å· (SXTMç”¨)
                            const type = CODE_TO_TYPE[code] || code;
                            
                            let extracted = [];
                            
                            // ğŸ†• v3.3 T01 + zodiacCodeï¼šç”Ÿè‚–æ ¼å¼çš„ç‰¹ç ï¼ˆé€šè¿‡Zä»£å·é€‰å·ï¼‰
                            // ç”Ÿè‚–ç‰¹ç æœ¬è´¨ä¸Šæ˜¯ç‰¹ç çš„ä¸€ç§ä¸‹æ³¨æ ¼å¼ï¼Œç»Ÿä¸€æ˜¾ç¤ºä¸º"ç‰¹ç "
                            if (code === 'T01' && zodiacCode && amount) {
                                // å°† Z1-Z12 è½¬æ¢ä¸ºç”Ÿè‚–åç§°
                                const ZODIAC_MAP = {
                                    'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
                                    'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
                                    'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
                                };
                                const zodiacName = ZODIAC_MAP[zodiacCode] || zodiacCode;
                                // è·å–è¯¥ç”Ÿè‚–å¯¹åº”çš„å·ç ï¼ˆä½¿ç”¨ LHC_DATA.shengxiaoï¼‰
                                const zodiacNumbers = LHC_DATA.shengxiao[zodiacName] || [];
                                for (const num of zodiacNumbers) {
                                    extracted.push({
                                        type: 'ç‰¹ç ',  // ğŸ†• v3.3 ç»Ÿä¸€æ˜¾ç¤ºä¸º"ç‰¹ç "
                                        value: String(num).padStart(2, '0'),
                                        zodiac: zodiacName,  // ä¿ç•™ç”Ÿè‚–ä¿¡æ¯ç”¨äºæ˜¾ç¤º
                                        amount: amount,
                                        raw: raw
                                    });
                                }
                            }
                            // ğŸ†• å¦‚æœ Function Calling å·²ç»æå–äº† numbers å’Œ amountï¼Œç›´æ¥ä½¿ç”¨
                            else if (numbers && Array.isArray(numbers) && numbers.length > 0 && amount) {
                                // æ ¹æ®ç±»å‹ç”Ÿæˆä¸‹æ³¨æ•°æ®
                                if (type === 'ç‰¹ç ') {
                                    for (const num of numbers) {
                                        extracted.push({
                                            type: 'ç‰¹ç ',
                                            value: String(num).padStart(2, '0'),
                                            amount: amount,
                                            raw: raw
                                        });
                                    }
                                } else {
                                    // å…¶ä»–ç±»å‹ï¼šæ¯ä¸ªå·ç ä¸€æ³¨
                                    for (const num of numbers) {
                                        extracted.push({
                                            type: type,
                                            value: String(num).padStart(2, '0'),
                                            amount: amount,
                                            raw: raw
                                        });
                                    }
                                }
                            }
                            // ğŸ†• v3.3 å…¼å®¹æ—§ç‰ˆSXTMä»£å·ï¼ˆé€æ­¥åºŸå¼ƒï¼‰
                            else if (code === 'SXTM' && zodiacCode && amount) {
                                console.log('âš ï¸ æ”¶åˆ°æ—§ç‰ˆSXTMä»£å·ï¼Œå°†è½¬æ¢ä¸ºT01å¤„ç†:', { zodiacCode, amount });
                                // å°† Z1-Z12 è½¬æ¢ä¸ºç”Ÿè‚–åç§°
                                const ZODIAC_MAP = {
                                    'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
                                    'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
                                    'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
                                };
                                const zodiacName = ZODIAC_MAP[zodiacCode] || zodiacCode;
                                // è·å–è¯¥ç”Ÿè‚–å¯¹åº”çš„å·ç 
                                const zodiacNumbers = LHC_DATA.shengxiao[zodiacName] || [];
                                for (const num of zodiacNumbers) {
                                    extracted.push({
                                        type: 'ç‰¹ç ',  // ğŸ†• v3.3 ç»Ÿä¸€æ˜¾ç¤ºä¸º"ç‰¹ç "
                                        value: String(num).padStart(2, '0'),
                                        zodiac: zodiacName,
                                        amount: amount,
                                        raw: raw
                                    });
                                }
                            }
                            // ã€å·²ä¼˜åŒ–ã€‘åç«¯æœªè¿”å›æ•°æ®æ—¶ï¼Œè®°å½•è­¦å‘Š
                            else {
                                console.log(`   âš ï¸ åç«¯æœªè¿”å›numbers/amountï¼ŒåŸæ–‡: "${raw}"`);
                                // ä¸å†ä½¿ç”¨æœ¬åœ°æ­£åˆ™æå–ï¼Œç­‰å¾…åç«¯å®Œå–„
                                extracted = [{
                                    type: type,
                                    value: raw,
                                    amount: 0,
                                    raw: raw,  // ğŸ†• ä¿ç•™åŸæ–‡
                                    parseError: 'åç«¯æœªæå–æ•°å€¼'
                                }];
                            }
                            
                            // æ˜¾ç¤ºæœ¬æ¡å¤„ç†ç»“æœ
                            if (extracted && extracted.length > 0) {
                                const itemTotal = extracted.reduce((sum, b) => sum + (b.amount || 0), 0);
                                console.log(`   ğŸ“¤ è¾“å‡º: ${extracted.length}æ³¨, å°è®¡${itemTotal}å…ƒ`);
                                extracted.forEach((bet, i) => {
                                    console.log(`      ${i+1}. ${bet.type} ${bet.value} ${bet.amount}å…ƒ`);
                                });
                                bets.push(...extracted);
                            } else {
                                console.log(`   âŒ è¾“å‡º: 0æ³¨ (è§£æå¤±è´¥)`);
                            }
                            console.log('   ---');
                        }
                    }
                } else if (restoredResult.items && Array.isArray(restoredResult.items)) {
                    // ã€å·²ä¼˜åŒ–ã€‘å…¼å®¹æ—§æ ¼å¼ - ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®
                    console.log('âš ï¸ æ”¶åˆ°æ—§æ ¼å¼æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨åç«¯è¿”å›å†…å®¹');
                    for (const item of restoredResult.items) {
                        bets.push({
                            type: item.type || 'æœªçŸ¥',
                            value: item.raw || '',
                            amount: item.amount || 0,
                            numbers: item.numbers || []
                        });
                    }
                }
                
                // ğŸ” ã€è°ƒè¯•ä¿¡æ¯ã€‘å‰ç«¯å¤„ç†ç»“æœæ±‡æ€»
                console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #e91e63');
                console.log('%cğŸ“‹ ã€å‰ç«¯å¤„ç†ç»“æœæ±‡æ€»ã€‘', 'color: #e91e63; font-weight: bold; font-size: 14px');
                console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #e91e63');
                
                // ğŸ“º æ˜¾ç¤ºå½“å¤©å¼€å¥–ä¿¡æ¯
                const typeNames = { xam: 'æ–°æ¾³', hk: 'é¦™æ¸¯', am: 'æ¾³é—¨' };
                const currentType = appState.currentLotteryType || 'xam';
                const currentData = appState.lotteryData[currentType];
                const lotteryNumbers = currentData?.numbers || [];
                const tema = lotteryNumbers[6]; // ç‰¹ç 
                
                if (currentData && lotteryNumbers.length === 7) {
                    const numsStr = lotteryNumbers.slice(0, 6).map(n => String(n).padStart(2, '0')).join(' ');
                    const temaStr = String(tema).padStart(2, '0');
                    console.log(`   ğŸ° å½“æœŸå¼€å¥–: ${typeNames[currentType]} ç¬¬${currentData.issue}æœŸ`);
                    console.log(`   ğŸ”¢ å¼€å¥–å·ç : ${numsStr} + ç‰¹ç  ${temaStr}`);
                } else {
                    console.log(`   ğŸ° å½“æœŸå¼€å¥–: æœªè®¾ç½®`);
                }
                console.log('   ---');
                
                // è·å–èµ”ç‡è®¾ç½®
                const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
                const temaOdds = parseFloat(savedOdds['odds-tema']) || 43;
                
                // è®¡ç®—ä¸­å¥–æƒ…å†µ - ğŸ†• v3.3 ç»Ÿä¸€ä½¿ç”¨"ç‰¹ç "ç±»å‹
                let winBets = [];
                let totalWinAmount = 0;
                
                if (tema) {
                    bets.forEach(bet => {
                        const betNum = parseInt(bet.value) || parseInt(bet.number);
                        // ğŸ†• v3.3 ç‰¹ç ç±»å‹ç»Ÿä¸€åˆ¤æ–­ï¼ˆåŒ…æ‹¬ç”Ÿè‚–æ ¼å¼ï¼‰
                        if (bet.type === 'ç‰¹ç ' && betNum === tema) {
                            const winAmount = bet.amount * temaOdds;
                            winBets.push({ ...bet, winAmount, odds: temaOdds });
                            totalWinAmount += winAmount;
                        }
                    });
                }
                
                console.log(`   å…±ç”Ÿæˆ ${bets.length} æ³¨ä¸‹æ³¨:`);
                
                // ğŸ¯ æ˜¾ç¤ºä¸­å¥–ä¿¡æ¯
                if (winBets.length > 0) {
                    console.log('%c   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'color: #4CAF50');
                    console.log('%c   ğŸ¯ ä¸­å¥–å·ç :', 'color: #4CAF50; font-weight: bold');
                    winBets.forEach(wb => {
                        console.log(`%c      ${wb.type} ${wb.value} â†’ ${wb.amount}å…ƒ Ã— èµ”ç‡${wb.odds} = ${wb.winAmount}å…ƒ`, 'color: #4CAF50');
                    });
                    console.log('%c   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'color: #4CAF50');
                }
                
                // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º
                const betsByType = {};
                let totalAmount = 0;
                bets.forEach(bet => {
                    const key = bet.type;
                    if (!betsByType[key]) betsByType[key] = [];
                    betsByType[key].push(bet);
                    totalAmount += bet.amount || 0;
                });
                
                for (const [type, typeBets] of Object.entries(betsByType)) {
                    const nums = typeBets.map(b => b.value).join(', ');
                    const amt = typeBets[0]?.amount || 0;
                    const typeTotal = typeBets.reduce((sum, b) => sum + (b.amount || 0), 0);
                    console.log(`   ğŸ“Œ ${type}: ${nums} (å„${amt}å…ƒ, å…±${typeBets.length}æ³¨) ${amt}Ã—${typeBets.length}=${typeTotal}å…ƒ`);
                }
                
                console.log('   ---');
                console.log(`   ğŸ’° ä¸‹æ³¨é‡‘é¢: ${totalAmount}å…ƒ`);
                
                // æ˜¾ç¤ºä¸­å¥–é‡‘é¢å’Œç›ˆäº
                if (tema) {
                    console.log(`   ğŸ ä¸­å¥–é‡‘é¢: ${totalWinAmount}å…ƒ`);
                    const profit = totalWinAmount - totalAmount;
                    if (profit > 0) {
                        console.log(`%c   ğŸ“ˆ æ€»è®¡: ${totalWinAmount} - ${totalAmount} = +${profit}å…ƒ (ç›ˆåˆ©)`, 'color: #4CAF50; font-weight: bold');
                    } else if (profit < 0) {
                        console.log(`%c   ğŸ“‰ æ€»è®¡: ${totalWinAmount} - ${totalAmount} = ${profit}å…ƒ (äºæŸ)`, 'color: #e91e63; font-weight: bold');
                    } else {
                        console.log(`   ğŸ“Š æ€»è®¡: ${totalWinAmount} - ${totalAmount} = 0å…ƒ (æŒå¹³)`);
                    }
                } else {
                    console.log('   âš ï¸ æœªè®¾ç½®å¼€å¥–å·ç ï¼Œæ— æ³•è®¡ç®—ä¸­å¥–');
                }
                
                console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #e91e63');
                
                console.log('ğŸ¤– æœ€ç»ˆbets:', bets);
                debugInfo.aiBets = bets;
                return { bets, unparsed: [] };
            } else {
                console.log('ğŸ¤– AIè¿”å›ç©ºç»“æœ');
                debugInfo.lastError = 'AIè¿”å›ç©ºç»“æœ';
            }
        } catch (e) {
            console.error('ğŸ¤– AIè§£æå¤±è´¥:', e);
            debugInfo.lastError = e.message || String(e);
        }
        return null;
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘    ã€å·²ç§»é™¤ã€‘æœ¬åœ°æ­£åˆ™æå–æ¨¡å— - å·²è¿ç§»åˆ°åç«¯                    â•‘
    // â•‘    åç«¯ä½¿ç”¨ Function Calling å®Œæˆæ•°å€¼æå–ï¼Œå‰ç«¯ç›´æ¥ä½¿ç”¨ç»“æœ    â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ==================== å‚æ•°è®¾ç½® ====================
    // v3.7 å‚æ•°è®¾ç½®é¡µé¢ç°åœ¨åŒ…å«AIæ™ºèƒ½è§£æå’Œå¯¼å…¥/å¯¼å‡ºé…ç½®
    function saveParamSettings() {
        const settings = {
            // AIè®¾ç½®
            aiEnabled: document.getElementById('ai-parse-enabled')?.checked !== false,
            aiProvider: localStorage.getItem('ai_provider') || 'tuzi'  // ğŸ†• v3.11.69 å…”å­API
        };
        localStorage.setItem('lhc_format_settings', JSON.stringify(settings));
        showAutoCloseToast('âœ… å‚æ•°è®¾ç½®å·²ä¿å­˜ï¼');
        
        // ä¿å­˜åè¿”å›é¦–é¡µ
        setTimeout(() => {
            showPage('page-main');
        }, 800);
    }
    
    function loadParamSettings() {
        // v3.7 åŠ è½½AIè®¾ç½®åˆ°å‚æ•°è®¾ç½®é¡µé¢
        const saved = localStorage.getItem('lhc_format_settings');
        if (saved) {
            try {
                const s = JSON.parse(saved);
                const aiCheckbox = document.getElementById('ai-parse-enabled');
                if (aiCheckbox) {
                    aiCheckbox.checked = s.aiEnabled !== false;
                }
            } catch(e) {
                console.error('åŠ è½½å‚æ•°è®¾ç½®å¤±è´¥:', e);
            }
        }
        
        // åŠ è½½ä¿å­˜çš„AIæ¨¡å‹é€‰æ‹©
        const savedProvider = localStorage.getItem('ai_provider');
        if (savedProvider) {
            switchAIModel(savedProvider);
        }
    }
    
    function copyResult() {
        const result = document.getElementById('result-content').textContent;
        copyToClipboard(result);
    }
    
    // å…¼å®¹iOSçš„å¤åˆ¶å‡½æ•°
    function copyToClipboard(text) {
        // æ–¹æ³•1: ç°ä»£API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showAutoCloseToast('âœ… ç»“æœå·²å¤åˆ¶ï¼');
            }).catch(() => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }
    
    // å¤‡ç”¨å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹iOSï¼‰
    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:200px;z-index:9999;font-size:16px;';
        document.body.appendChild(textarea);
        
        // iOSç‰¹æ®Šå¤„ç†
        const range = document.createRange();
        range.selectNodeContents(textarea);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        textarea.setSelectionRange(0, text.length);
        
        try {
            document.execCommand('copy');
            showAutoCloseToast('âœ… ç»“æœå·²å¤åˆ¶ï¼');
        } catch (e) {
            showAutoCloseToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 3000);
        }
        
        document.body.removeChild(textarea);
    }
    
    // è‡ªåŠ¨å…³é—­çš„æç¤ºï¼ˆçº¦2ç§’ï¼‰
    function showAutoCloseToast(msg, duration = 2000) {
        const toast = document.createElement('div');
        toast.innerHTML = msg;
        toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#4CAF50;padding:15px 25px;border-radius:10px;font-size:14px;z-index:9999;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ†• v3.11.65 ã€è®¡ç®—åŠ è½½æç¤ºã€‘æŒç»­æ˜¾ç¤ºç›´åˆ°è®¡ç®—å®Œæˆ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let calculatingLoaderEl = null;
    let loaderStartTime = 0;
    let loaderTimerInterval = null;
    
    /**
     * æ˜¾ç¤ºè®¡ç®—ä¸­åŠ è½½æç¤ºï¼ˆæŒç»­æ˜¾ç¤ºç›´åˆ°æ‰‹åŠ¨å…³é—­ï¼‰
     */
    function showCalculatingLoader() {
        // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æç¤º
        hideCalculatingLoader();
        
        loaderStartTime = Date.now();
        
        calculatingLoaderEl = document.createElement('div');
        calculatingLoaderEl.id = 'calculating-loader';
        calculatingLoaderEl.innerHTML = `
            <div class="loader-content">
                <div class="loader-spinner"></div>
                <div class="loader-text">
                    <div class="loader-title">ğŸš€ AIæ­£åœ¨è¯†åˆ«è®¡ç®—ä¸­...</div>
                    <div class="loader-subtitle">è¯·ç¨ç­‰ï¼Œè€æ¿æ—¥è¿›æ–—é‡‘ï½</div>
                    <div class="loader-timer" id="loader-timer">å·²ç­‰å¾…: 0ç§’</div>
                </div>
            </div>
        `;
        calculatingLoaderEl.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.88);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        `;
        /* ğŸ†• v3.11.67 ç§»é™¤ backdrop-filter: blur(3px)ï¼Œæ”¹ç”¨æ›´æ·±çš„èƒŒæ™¯è‰²ï¼ˆGPUä¼˜åŒ–ï¼Œé˜²æ­¢ä½ç«¯æœºé—ªé€€ï¼‰ */
        
        // æ·»åŠ æ ·å¼
        const style = document.createElement('style');
        style.id = 'calculating-loader-style';
        style.textContent = `
            #calculating-loader .loader-content {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 2px solid #e94560;
                border-radius: 20px;
                padding: 30px 50px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(233, 69, 96, 0.3);
                animation: loaderPulse 2s ease-in-out infinite;
            }
            @keyframes loaderPulse {
                0%, 100% { box-shadow: 0 20px 60px rgba(233, 69, 96, 0.3); }
                50% { box-shadow: 0 20px 80px rgba(233, 69, 96, 0.5); }
            }
            #calculating-loader .loader-spinner {
                width: 60px;
                height: 60px;
                border: 4px solid rgba(233, 69, 96, 0.3);
                border-top-color: #e94560;
                border-radius: 50%;
                margin: 0 auto 20px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            #calculating-loader .loader-title {
                color: #4CAF50;
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 8px;
            }
            #calculating-loader .loader-subtitle {
                color: #f39c12;
                font-size: 14px;
                margin-bottom: 12px;
            }
            #calculating-loader .loader-timer {
                color: #888;
                font-size: 13px;
                font-family: 'Courier New', monospace;
            }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(calculatingLoaderEl);
        
        // å¯åŠ¨è®¡æ—¶å™¨
        loaderTimerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - loaderStartTime) / 1000);
            const timerEl = document.getElementById('loader-timer');
            if (timerEl) {
                timerEl.textContent = `å·²ç­‰å¾…: ${elapsed}ç§’`;
                // è¶…è¿‡5ç§’æ˜¾ç¤ºæç¤º
                if (elapsed >= 5 && elapsed < 10) {
                    timerEl.style.color = '#f39c12';
                } else if (elapsed >= 10) {
                    timerEl.style.color = '#e74c3c';
                    timerEl.textContent = `å·²ç­‰å¾…: ${elapsed}ç§’ï¼ˆAIæ­£åœ¨åŠªåŠ›å¤„ç†å¤æ‚å†…å®¹...ï¼‰`;
                }
            }
        }, 1000);
    }
    
    /**
     * éšè—è®¡ç®—ä¸­åŠ è½½æç¤º
     */
    function hideCalculatingLoader() {
        if (loaderTimerInterval) {
            clearInterval(loaderTimerInterval);
            loaderTimerInterval = null;
        }
        if (calculatingLoaderEl) {
            calculatingLoaderEl.remove();
            calculatingLoaderEl = null;
        }
        const style = document.getElementById('calculating-loader-style');
        if (style) {
            style.remove();
        }
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                    ã€æ¨¡å—3ã€‘èµ”ç‡è®¾ç½®æ¨¡å—                        â•‘
    // â•‘  æ–‡ä»¶åˆ†ç¦»æ—¶æå–åˆ°: js/odds.js                                   â•‘
    // â•‘  åŠŸèƒ½: èµ”ç‡çš„è¯»å–ã€ä¿å­˜ã€å¯¼å…¥å¯¼å‡º                               â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ç”Ÿæˆå¯¼å‡ºæ•°æ®
    function getExportData() {
        const allOdds = collectAllOdds();
        return {
            version: '1.0',
            type: 'odds_only',
            exportTime: new Date().toLocaleString('zh-CN'),
            odds: allOdds
        };
    }
    
    // ç”Ÿæˆæ–‡ä»¶å
    function getExportFileName() {
        const date = new Date();
        const dateStr = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
        return `èµ”ç‡é…ç½®_${dateStr}.txt`;
    }
    
    // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
    function showExportOptions() {
        document.getElementById('export-modal').classList.add('show');
    }
    
    function hideExportModal() {
        document.getElementById('export-modal').classList.remove('show');
    }
    
    // å¤åˆ¶é…ç½®æ–‡æœ¬
    function exportCopy() {
        hideExportModal();
        const jsonStr = JSON.stringify(getExportData());
        copyToClipboard(jsonStr);
    }
    
    // æ–¹å¼3ï¼šä¸‹è½½æ–‡ä»¶
    function exportDownload() {
        hideExportModal();
        const jsonStr = JSON.stringify(getExportData());
        const fileName = getExportFileName();
        downloadFile(fileName, jsonStr);
    }
    
    // ä¸‹è½½æ–‡ä»¶å‡½æ•°
    function downloadFile(fileName, content) {
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        // æç¤ºä¸‹è½½ä½ç½®
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        
        let tip = 'âœ… é…ç½®æ–‡ä»¶å·²ä¸‹è½½ï¼\n\næ–‡ä»¶åï¼š' + fileName;
        
        if (isIOS) {
            tip += '\n\nğŸ“ æŸ¥æ‰¾æ–‡ä»¶æ–¹æ³•ï¼š\n';
            tip += '1. æ‰“å¼€ã€Œæ–‡ä»¶ã€Appï¼ˆè“è‰²æ–‡ä»¶å¤¹å›¾æ ‡ï¼‰\n';
            tip += '2. ç‚¹å‡»ã€Œæµè§ˆã€\n';
            tip += '3. é€‰æ‹©ã€Œä¸‹è½½é¡¹ã€æˆ–ã€ŒiCloudäº‘ç›˜ã€';
        } else if (isAndroid) {
            tip += '\n\nğŸ“ æŸ¥æ‰¾æ–‡ä»¶æ–¹æ³•ï¼š\n';
            tip += '1. æ‰“å¼€ã€Œæ–‡ä»¶ç®¡ç†ã€æˆ–ã€Œæˆ‘çš„æ–‡ä»¶ã€\n';
            tip += '2. æ‰¾åˆ°ã€Œä¸‹è½½ã€æˆ–ã€ŒDownloadã€æ–‡ä»¶å¤¹';
        } else {
            tip += '\n\nğŸ“ æŸ¥æ‰¾æ–‡ä»¶æ–¹æ³•ï¼š\n';
            tip += 'æŒ‰ Ctrl+J æ‰“å¼€æµè§ˆå™¨ä¸‹è½½è®°å½•';
        }
        
        alert(tip);
    }
    
    function showExportFallback(jsonStr) {
        // å¼¹çª—æ˜¾ç¤ºé…ç½®ä¾›æ‰‹åŠ¨å¤åˆ¶
        const textarea = document.createElement('textarea');
        textarea.value = jsonStr;
        textarea.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;height:200px;z-index:9999;font-size:12px;';
        document.body.appendChild(textarea);
        textarea.select();
        
        alert('è¯·æ‰‹åŠ¨å¤åˆ¶ä¸‹é¢çš„é…ç½®æ–‡æœ¬ï¼š');
        
        setTimeout(() => {
            document.body.removeChild(textarea);
        }, 30000);
    }
    
    function showImportModal() {
        document.getElementById('import-modal').classList.add('show');
        document.getElementById('import-textarea').value = '';
        document.getElementById('import-file').value = '';
    }
    
    function hideImportModal() {
        document.getElementById('import-modal').classList.remove('show');
    }
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            document.getElementById('import-textarea').value = content;
            // è‡ªåŠ¨å¯¼å…¥
            importConfig();
        };
        reader.onerror = function() {
            alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
        };
        reader.readAsText(file);
    }
    
    function importConfig() {
        const jsonStr = document.getElementById('import-textarea').value.trim();
        
        if (!jsonStr) {
            alert('âŒ è¯·ç²˜è´´èµ”ç‡é…ç½®æ•°æ®ï¼');
            return;
        }
        
        try {
            const importData = JSON.parse(jsonStr);
            
            // éªŒè¯æ•°æ®æ ¼å¼
            if (!importData.version || !importData.odds) {
                throw new Error('æ— æ•ˆçš„é…ç½®æ ¼å¼');
            }
            
            // å¯¼å…¥èµ”ç‡è®¾ç½®
            applyAllOdds(importData.odds);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveOddsToStorage();
            
            hideImportModal();
            alert('âœ… èµ”ç‡é…ç½®å¯¼å…¥æˆåŠŸï¼\n\nå¯¼å…¥æ—¶é—´ï¼š' + (importData.exportTime || 'æœªçŸ¥'));
            
        } catch (e) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼šé…ç½®æ ¼å¼é”™è¯¯\n\nè¯·ç¡®ä¿ç²˜è´´çš„æ˜¯å®Œæ•´çš„èµ”ç‡é…ç½®æ•°æ®ã€‚');
        }
    }
    
    // æ”¶é›†æ‰€æœ‰èµ”ç‡è¾“å…¥æ¡†çš„å€¼
    function collectAllOdds() {
        const odds = {};
        const inputs = document.querySelectorAll('.odds-item-input');
        inputs.forEach(input => {
            odds[input.id] = parseFloat(input.value) || 0;
        });
        return odds;
    }
    
    // åº”ç”¨æ‰€æœ‰èµ”ç‡åˆ°è¾“å…¥æ¡†
    function applyAllOdds(odds) {
        for (const [id, value] of Object.entries(odds)) {
            const input = document.getElementById(id);
            if (input) {
                input.value = value;
            }
        }
    }
    
    // ä¿å­˜èµ”ç‡åˆ°æœ¬åœ°å­˜å‚¨
    function saveOddsToStorage() {
        const odds = collectAllOdds();
        localStorage.setItem('lhc_odds', JSON.stringify(odds));
    }
    
    // åŠ è½½èµ”ç‡ä»æœ¬åœ°å­˜å‚¨
    function loadOddsFromStorage() {
        const saved = localStorage.getItem('lhc_odds');
        if (saved) {
            try {
                const odds = JSON.parse(saved);
                applyAllOdds(odds);
            } catch(e) {}
        }
    }
    
    // ==================== ç‰ˆæœ¬æ›´æ–°æ£€æµ‹ ====================
    const APP_VERSION = 'v3.2.0';  // å½“å‰ç‰ˆæœ¬å·ï¼Œä¸ sw.js ä¿æŒä¸€è‡´ï¼ˆç¼“å­˜ä¼˜å…ˆç­–ç•¥ï¼‰
    
    // æ³¨å†Œ Service Worker å¹¶æ£€æµ‹æ›´æ–°
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ');
            
            // æ£€æµ‹æ›´æ–°
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæ˜¾ç¤ºæ›´æ–°æç¤º
                        showUpdateNotification();
                    }
                });
            });
        }).catch(err => {
            console.log('Service Worker æ³¨å†Œå¤±è´¥:', err);
        });
        
        // ç›‘å¬æ¥è‡ª Service Worker çš„æ¶ˆæ¯
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'SW_UPDATED') {
                console.log('ğŸ“¦ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬:', event.data.version);
                showUpdateNotification();
            }
        });
    }
    
    // æ˜¾ç¤ºæ›´æ–°æç¤º
    function showUpdateNotification() {
        // å¦‚æœå·²ç»æ˜¾ç¤ºè¿‡ï¼Œä¸é‡å¤æ˜¾ç¤º
        if (document.getElementById('update-notification')) return;
        
        const notification = document.createElement('div');
        notification.id = 'update-notification';
        notification.innerHTML = `
            <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
                background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                color:white;padding:15px 20px;border-radius:12px;
                box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:99999;
                display:flex;align-items:center;gap:15px;max-width:90%;
                animation:slideUp 0.3s ease-out;">
                <div style="flex:1;">
                    <div style="font-weight:bold;margin-bottom:3px;">ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬</div>
                    <div style="font-size:12px;opacity:0.9;">ç‚¹å‡»åˆ·æ–°è·å–æœ€æ–°åŠŸèƒ½</div>
                </div>
                <button onclick="location.reload()" 
                    style="background:white;color:#764ba2;border:none;
                    padding:8px 16px;border-radius:6px;font-weight:bold;
                    cursor:pointer;white-space:nowrap;">
                    ç«‹å³åˆ·æ–°
                </button>
                <button onclick="this.parentElement.parentElement.remove()" 
                    style="background:transparent;color:white;border:none;
                    font-size:18px;cursor:pointer;padding:0 5px;">
                    âœ•
                </button>
            </div>
        `;
        document.body.appendChild(notification);
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('update-animation-style')) {
            const style = document.createElement('style');
            style.id = 'update-animation-style';
            style.textContent = `
                @keyframes slideUp {
                    from { transform: translateX(-50%) translateY(100px); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    // æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼Œè°ƒè¯•ç”¨ï¼‰
    console.log('ğŸ“± å…­å”ç«ç®­è®¡ç®—å™¨ ' + APP_VERSION);
    
    // ==================== åé¦ˆç³»ç»Ÿ ====================
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://cdvoeabekfuujaehxocl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkdm9lYWJla2Z1dWphZWh4b2NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNjM3MDQsImV4cCI6MjA4MTczOTcwNH0.VrT3fJfKKXwwOF_dx1v_vMkNm1bXIEhhL_4iui0RKB8';
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘              å…¨å±åé¦ˆè¯„ä»·ç³»ç»Ÿï¼ˆæ–°ç‰ˆï¼‰                           â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘          ç²¾å‡†çº é”™ç‰ˆ - åé¦ˆç³»ç»Ÿ JS ä»£ç                           â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // åé¦ˆæ•°æ®å­˜å‚¨
    let feedbackData = {
        items: [],      // æ¯é¡¹çš„é”™è¯¯æ ‡è®°æ•°æ®
        errorCount: 0   // æ ‡è®°ä¸ºé”™è¯¯çš„æ¡ç›®æ•°
    };
    
    // ğŸ†• v3.4 Zä»£å·åˆ°ç”Ÿè‚–åç§°çš„æ˜ å°„
    const Z_CODE_NAMES = {
        'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
        'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
        'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
    };
    
    // ğŸ†• v3.4 å®Œæ•´ç©æ³•ç±»å‹é…ç½®ï¼ˆæ ¹æ®ã€Šç©æ³•è§„åˆ™å¤§å…¨ã€‹ï¼‰
    const PLAY_TYPE_CONFIG = {
        // ========== T01 ç‰¹ç ç±» ==========
        'T01': {
            name: 'ç‰¹ç ',
            subTypes: null,  // æ— å­ç±»å‹ï¼Œåªéœ€è¦å·ç +é‡‘é¢
            winRule: 'æŠ•æ³¨çš„å·ç ä¸å¼€å¥–ç‰¹ç ç›¸åŒå³ä¸­å¥–',
            needFields: ['numbers', 'amount'],
            defaultOdds: 46
        },
        
        // ========== DXDS å¤§å°å•åŒç±» ==========
        'DXDS': {
            name: 'å¤§å°å•åŒ',
            subTypes: ['å°æ•°', 'å¤§æ•°', 'å•æ•°', 'åŒæ•°', 'åˆå¤§', 'åˆå°', 'åˆå•', 'åˆåŒ'],
            winRule: {
                'å°æ•°': 'ç‰¹ç  1-24',
                'å¤§æ•°': 'ç‰¹ç  25-48',
                'å•æ•°': 'ç‰¹ç ä¸ºå¥‡æ•°',
                'åŒæ•°': 'ç‰¹ç ä¸ºå¶æ•°',
                'åˆå¤§': 'åˆæ•°(åä½+ä¸ªä½) 7-13',
                'åˆå°': 'åˆæ•°(åä½+ä¸ªä½) 0-6',
                'åˆå•': 'åˆæ•°ä¸ºå¥‡æ•°',
                'åˆåŒ': 'åˆæ•°ä¸ºå¶æ•°'
            },
            special49: 'ç‰¹ç 49ä¸º"å’Œ"ï¼Œé€€å›æœ¬é‡‘',
            needFields: ['subType', 'amount'],
            defaultOdds: 1.98
        },
        
        // ========== BS æ³¢è‰²ç±» ==========
        'BS': {
            name: 'æ³¢è‰²',
            subTypes: ['çº¢æ³¢', 'è“æ³¢', 'ç»¿æ³¢'],
            winRule: 'å¼€å¥–ç‰¹ç çš„é¢œè‰²ä¸æ‰€é€‰é¢œè‰²ç›¸åŒå³ä¸­å¥–',
            colorNums: {
                'çº¢æ³¢': [1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46],
                'è“æ³¢': [3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48],
                'ç»¿æ³¢': [5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49]
            },
            needFields: ['subType', 'amount'],
            defaultOdds: 2.8
        },
        
        // ========== BB åŠæ³¢ç±» ==========
        'BB': {
            name: 'åŠæ³¢',
            subTypes: ['çº¢å•', 'çº¢åŒ', 'çº¢å¤§', 'çº¢å°', 'è“å•', 'è“åŒ', 'è“å¤§', 'è“å°', 'ç»¿å•', 'ç»¿åŒ', 'ç»¿å¤§', 'ç»¿å°'],
            winRule: 'å¼€å¥–ç‰¹ç åŒæ—¶æ»¡è¶³é¢œè‰²å’Œå¤§å°/å•åŒæ¡ä»¶å³ä¸­å¥–',
            needFields: ['subType', 'amount'],
            defaultOdds: 3.2
        },
        
        // ========== PT1 å¹³ç‰¹ä¸€è‚– ==========
        'PT1': {
            name: 'å¹³ç‰¹ä¸€è‚–',
            subTypes: ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'],
            winRule: '7ä¸ªå¼€å¥–å·ç ä¸­æœ‰è¯¥ç”Ÿè‚–çš„å·ç ',
            needFields: ['zodiac', 'amount'],
            defaultOdds: 11
        },
        
        // ========== TX ç‰¹è‚– ==========
        'TX': {
            name: 'ç‰¹è‚–',
            subTypes: ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'],
            winRule: 'å¼€å¥–ç‰¹ç çš„ç”Ÿè‚–ä¸æ‰€é€‰ç”Ÿè‚–ç›¸åŒå³ä¸­å¥–',
            needFields: ['zodiac', 'amount'],
            defaultOdds: 12
        },
        
        // ========== SX ç”Ÿè‚– ==========
        'SX': {
            name: 'ç”Ÿè‚–',
            subTypes: ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'],
            winRule: 'å¼€å¥–ç‰¹ç çš„ç”Ÿè‚–ä¸æ‰€é€‰ç”Ÿè‚–ç›¸åŒå³ä¸­å¥–',
            needFields: ['zodiac', 'amount'],
            defaultOdds: 12
        },
        
        // ========== SX6 å…­è‚– ==========
        'SX6': {
            name: 'å…­è‚–',
            subTypes: null,
            winRule: 'ç‰¹ç å±äºæ‰€é€‰6ä¸ªç”Ÿè‚–ä¹‹ä¸€',
            needFields: ['zodiacs', 'amount'],
            defaultOdds: 4.2
        },
        
        // ========== HX åˆè‚– ==========
        'HX': {
            name: 'åˆè‚–',
            subTypes: ['äºŒåˆè‚–', 'ä¸‰åˆè‚–', 'å››åˆè‚–'],
            winRule: 'ç‰¹ç å±äºæ‰€é€‰ç”Ÿè‚–ä¹‹ä¸€',
            needFields: ['zodiacs', 'amount'],
            defaultOdds: { 'äºŒåˆè‚–': 6, 'ä¸‰åˆè‚–': 4, 'å››åˆè‚–': 3 }
        },
        
        // ========== DP å•å¹³/å¹³ç  ==========
        'DP': {
            name: 'å•å¹³',
            subTypes: null,
            winRule: 'æŠ•æ³¨å·ç åœ¨å‰6ä¸ªæ­£ç ä¸­ï¼ˆä¸å«ç‰¹ç ï¼‰',
            needFields: ['numbers', 'amount'],
            defaultOdds: 9.8
        },
        
        // ========== E2 äºŒä¸­äºŒ ==========
        'E2': {
            name: 'äºŒä¸­äºŒ',
            subTypes: null,
            winRule: 'é€‰2ä¸ªå·ç ï¼Œåœ¨6ä¸ªæ­£ç ï¼ˆä¸å«ç‰¹ç ï¼‰ä¸­è‡³å°‘å‡ºç°2ä¸ª',
            needFields: ['numbers', 'amount'],
            defaultOdds: 38
        },
        
        // ========== S3 ä¸‰ä¸­ä¸‰ ==========
        'S3': {
            name: 'ä¸‰ä¸­ä¸‰',
            subTypes: null,
            winRule: 'é€‰3ä¸ªå·ç ï¼Œåœ¨6ä¸ªæ­£ç ï¼ˆä¸å«ç‰¹ç ï¼‰ä¸­è‡³å°‘å‡ºç°3ä¸ª',
            needFields: ['numbers', 'amount'],
            defaultOdds: 180
        },
        
        // ========== BZ ä¸ä¸­ç±» ==========
        'BZ5': { name: 'äº”ä¸ä¸­', subTypes: null, winRule: '5ä¸ªå·ç å…¨ä¸å‡ºç°åœ¨7ä¸ªå¼€å¥–å·ç ä¸­', needFields: ['numbers', 'amount'], defaultOdds: 2.8 },
        'BZ6': { name: 'å…­ä¸ä¸­', subTypes: null, winRule: '6ä¸ªå·ç å…¨ä¸å‡ºç°åœ¨7ä¸ªå¼€å¥–å·ç ä¸­', needFields: ['numbers', 'amount'], defaultOdds: 4.2 },
        'BZ7': { name: 'ä¸ƒä¸ä¸­', subTypes: null, winRule: '7ä¸ªå·ç å…¨ä¸å‡ºç°åœ¨7ä¸ªå¼€å¥–å·ç ä¸­', needFields: ['numbers', 'amount'], defaultOdds: 7 },
        'BZ8': { name: 'å…«ä¸ä¸­', subTypes: null, winRule: '8ä¸ªå·ç å…¨ä¸å‡ºç°åœ¨7ä¸ªå¼€å¥–å·ç ä¸­', needFields: ['numbers', 'amount'], defaultOdds: 12 },
        'BZ9': { name: 'ä¹ä¸ä¸­', subTypes: null, winRule: '9ä¸ªå·ç å…¨ä¸å‡ºç°åœ¨7ä¸ªå¼€å¥–å·ç ä¸­', needFields: ['numbers', 'amount'], defaultOdds: 20 },
        'BZ10': { name: 'åä¸ä¸­', subTypes: null, winRule: '10ä¸ªå·ç å…¨ä¸å‡ºç°åœ¨7ä¸ªå¼€å¥–å·ç ä¸­', needFields: ['numbers', 'amount'], defaultOdds: 35 },
        
        // ========== PTW å¹³ç‰¹å°¾æ•° ==========
        'PTW': {
            name: 'å¹³ç‰¹å°¾æ•°',
            subTypes: ['0å°¾', '1å°¾', '2å°¾', '3å°¾', '4å°¾', '5å°¾', '6å°¾', '7å°¾', '8å°¾', '9å°¾'],
            winRule: '7ä¸ªå¼€å¥–å·ç ä¸­æœ‰è¯¥å°¾æ•°çš„å·ç ',
            needFields: ['tail', 'amount'],
            defaultOdds: 2.8
        },
        
        // ========== ZX æ­£è‚– ==========
        'ZX': {
            name: 'æ­£è‚–',
            subTypes: ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'],
            winRule: 'å‰6ä¸ªæ­£ç ä¸­æœ‰è¯¥ç”Ÿè‚–çš„å·ç ï¼ˆä¸å«ç‰¹ç ï¼‰',
            needFields: ['zodiac', 'amount'],
            defaultOdds: 2
        },
        
        // ========== ZH æ€»å’Œ ==========
        'ZH': {
            name: 'æ€»å’Œ',
            subTypes: ['æ€»å’Œå¤§', 'æ€»å’Œå°', 'æ€»å’Œå•', 'æ€»å’ŒåŒ'],
            winRule: {
                'æ€»å’Œå¤§': '7ä¸ªå·ç ä¹‹å’Œ >= 175',
                'æ€»å’Œå°': '7ä¸ªå·ç ä¹‹å’Œ <= 174',
                'æ€»å’Œå•': '7ä¸ªå·ç ä¹‹å’Œä¸ºå¥‡æ•°',
                'æ€»å’ŒåŒ': '7ä¸ªå·ç ä¹‹å’Œä¸ºå¶æ•°'
            },
            needFields: ['subType', 'amount'],
            defaultOdds: 1.98
        },
        
        // ========== JY å®¶ç¦½é‡å…½ ==========
        'JY': {
            name: 'å®¶ç¦½é‡å…½',
            subTypes: ['å®¶ç¦½', 'é‡å…½'],
            winRule: {
                'å®¶ç¦½': 'ç‰¹ç ç”Ÿè‚–å±äºç‰›é©¬ç¾Šé¸¡ç‹—çŒª',
                'é‡å…½': 'ç‰¹ç ç”Ÿè‚–å±äºé¼ è™å…”é¾™è›‡çŒ´'
            },
            needFields: ['subType', 'amount'],
            defaultOdds: 1.98
        },
        
        // ========== TS å¤´æ•° ==========
        'TS': {
            name: 'å¤´æ•°',
            subTypes: ['0å¤´', '1å¤´', '2å¤´', '3å¤´', '4å¤´'],
            winRule: 'ç‰¹ç çš„åä½æ•° = æŠ•æ³¨å¤´æ•°',
            needFields: ['subType', 'amount'],
            defaultOdds: 4
        },
        
        // ========== WS å°¾æ•° ==========
        'WS': {
            name: 'å°¾æ•°',
            subTypes: ['0å°¾', '1å°¾', '2å°¾', '3å°¾', '4å°¾', '5å°¾', '6å°¾', '7å°¾', '8å°¾', '9å°¾'],
            winRule: 'ç‰¹ç çš„ä¸ªä½æ•° = æŠ•æ³¨å°¾æ•°',
            needFields: ['subType', 'amount'],
            defaultOdds: 9
        },
        
        // ========== WX äº”è¡Œ ==========
        'WX': {
            name: 'äº”è¡Œ',
            subTypes: ['é‡‘', 'æœ¨', 'æ°´', 'ç«', 'åœŸ'],
            winRule: 'ç‰¹ç å±äºæ‰€é€‰äº”è¡Œçš„å·ç ',
            needFields: ['subType', 'amount'],
            defaultOdds: 4.8
        }
    };
    
    // ç®€åŒ–çš„ç©æ³•ç±»å‹åˆ—è¡¨ï¼ˆç”¨äºä¸‹æ‹‰æ¡†ï¼‰
    const PLAY_TYPES = [
        // å¤§ç±»
        'ç‰¹ç ', 'å¤§å°å•åŒ', 'æ³¢è‰²', 'åŠæ³¢', 'å¹³ç‰¹ä¸€è‚–', 'ç‰¹è‚–', 'ç”Ÿè‚–', 'å…­è‚–', 'åˆè‚–',
        'å•å¹³', 'äºŒä¸­äºŒ', 'ä¸‰ä¸­ä¸‰', 'äº”ä¸ä¸­', 'å…­ä¸ä¸­', 'ä¸ƒä¸ä¸­', 'å…«ä¸ä¸­', 'ä¹ä¸ä¸­', 'åä¸ä¸­',
        'å¹³ç‰¹å°¾æ•°', 'æ­£è‚–', 'æ€»å’Œ', 'å®¶ç¦½é‡å…½', 'å¤´æ•°', 'å°¾æ•°', 'äº”è¡Œ',
        // DXDSå­ç±»å‹
        'å°æ•°', 'å¤§æ•°', 'å•æ•°', 'åŒæ•°', 'åˆå¤§', 'åˆå°', 'åˆå•', 'åˆåŒ',
        // BSå­ç±»å‹
        'çº¢æ³¢', 'è“æ³¢', 'ç»¿æ³¢',
        // BBå­ç±»å‹
        'çº¢å•', 'çº¢åŒ', 'çº¢å¤§', 'çº¢å°', 'è“å•', 'è“åŒ', 'è“å¤§', 'è“å°', 'ç»¿å•', 'ç»¿åŒ', 'ç»¿å¤§', 'ç»¿å°',
        // ZHå­ç±»å‹
        'æ€»å’Œå¤§', 'æ€»å’Œå°', 'æ€»å’Œå•', 'æ€»å’ŒåŒ',
        // JYå­ç±»å‹
        'å®¶ç¦½', 'é‡å…½',
        // TSå­ç±»å‹
        '0å¤´', '1å¤´', '2å¤´', '3å¤´', '4å¤´',
        // WS/PTWå­ç±»å‹
        '0å°¾', '1å°¾', '2å°¾', '3å°¾', '4å°¾', '5å°¾', '6å°¾', '7å°¾', '8å°¾', '9å°¾',
        // WXå­ç±»å‹
        'é‡‘', 'æœ¨', 'æ°´', 'ç«', 'åœŸ'
    ];
    
    // æ ¹æ®ç±»å‹ä»£å·è·å–é…ç½®
    function getTypeConfig(code) {
        return PLAY_TYPE_CONFIG[code] || PLAY_TYPE_CONFIG['T01'];
    }
    
    // æ ¹æ®æ˜¾ç¤ºåç§°è·å–ä»£å·
    function getTypeCode(displayName) {
        for (const [code, config] of Object.entries(PLAY_TYPE_CONFIG)) {
            if (config.name === displayName) return code;
            if (config.subTypes && config.subTypes.includes(displayName)) return code;
        }
        return 'T01';
    }
    
    // æ˜¾ç¤ºç²¾å‡†çº é”™é¡µé¢
    function showFeedbackModal() {
        // åˆå§‹åŒ–åé¦ˆæ•°æ®
        feedbackData = { items: [], errorCount: 0 };
        
        // è·å–å¼€å¥–ä¿¡æ¯
        const currentType = appState.currentLotteryType || 'xam';
        const typeNames = { xam: 'æ–°æ¾³', hk: 'é¦™æ¸¯', am: 'æ¾³é—¨' };
        const lotteryNums = appState.lotteryNumbers || [];
        const tema = lotteryNums[6];
        const issue = appState.lotteryData[currentType]?.issue || 'æœªçŸ¥';
        const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
        const temaOdds = parseFloat(savedOdds['odds-tema']) || 43;
        
        // è®¡ç®—æ±‡æ€»
        const totalBet = calcResults?.reduce((sum, r) => sum + r.amount, 0) || 0;
        const winCount = calcResults?.filter(r => r.isWin).length || 0;
        const winAmount = calcResults?.filter(r => r.isWin).reduce((sum, r) => sum + r.winAmount, 0) || 0;
        // ğŸ†• v2.4.8 ä»ç©å®¶è§’åº¦ï¼šç›ˆäº = æ´¾å½© - æŠ•å…¥ï¼ˆæ­£æ•°ä¸ºèµ¢ï¼‰
        const profit = winAmount - totalBet;
        
        // æ›´æ–°é¡¶éƒ¨å›ºå®šæ 
        document.getElementById('fb-total-bet').textContent = totalBet;
        document.getElementById('fb-win-count').textContent = winCount;
        document.getElementById('fb-win-amount').textContent = winAmount;
        document.getElementById('fb-total-result').textContent = (profit >= 0 ? '+' : '') + profit;
        document.getElementById('fb-total-result').style.color = profit >= 0 ? '#4caf50' : '#f44336';
        
        // ğŸ†• v3.11.24 æ¸²æŸ“å¼€å¥–å·ç åŒºåŸŸï¼ˆæ”¯æŒåŒå¼€å¥–ï¼‰
        renderFeedbackLotterySection();
        
        // æ¸²æŸ“å¡ç‰‡åˆ—è¡¨
        renderFeedbackCards();
        
        // æ›´æ–°æäº¤æŒ‰é’®
        updateErrorCount();
        
        // åˆ‡æ¢åˆ°åé¦ˆé¡µé¢
        showPage('page-feedback');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ†• v3.11.24 æ¸²æŸ“åé¦ˆé¡µçš„å¼€å¥–åŒºåŸŸï¼ˆæœŸå·åœ¨å·¦ï¼Œå·ç çƒåœ¨å³ï¼Œæ”¯æŒåŒå¼€å¥–ï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderFeedbackLotterySection() {
        const container = document.getElementById('fb-lottery-section');
        if (!container) return;
        
        const typeNames = { xam: 'æ–°æ¾³', hk: 'é¦™æ¸¯', am: 'æ¾³é—¨' };
        const currentType = appState.currentLotteryType || 'xam';
        
        // ğŸ†• v3.11.29 ä½¿ç”¨æ›´å‡†ç¡®çš„å½©ç§åˆ¤æ–­å˜é‡
        const hasHK = window.currentCalcHasHK || false;
        const hasMC = window.currentCalcHasMC !== false;  // é»˜è®¤true
        const isMixed = window.currentCalcIsMixed || false;
        
        let html = '';
        
        if (isMixed) {
            // æ··åˆä¸‹æ³¨ï¼šæ˜¾ç¤ºä¸¤ä¸ªå¼€å¥–ç»“æœ
            const xamData = appState.lotteryData['xam'];
            const hkData = appState.lotteryData['hk'];
            
            // æ–°æ¾³é—¨å¼€å¥–
            html += renderSingleLotteryRow('æ–°æ¾³', xamData?.issue || 'æœªçŸ¥', xamData?.numbers || []);
            // é¦™æ¸¯å¼€å¥–
            html += renderSingleLotteryRow('é¦™æ¸¯', hkData?.issue || 'æœªçŸ¥', hkData?.numbers || []);
        } else if (hasHK && !hasMC) {
            // çº¯é¦™æ¸¯ï¼šåªæ˜¾ç¤ºé¦™æ¸¯
            const hkData = appState.lotteryData['hk'];
            html += renderSingleLotteryRow('é¦™æ¸¯', hkData?.issue || 'æœªçŸ¥', hkData?.numbers || []);
        } else {
            // çº¯æ¾³é—¨æˆ–é»˜è®¤ï¼šåªæ˜¾ç¤ºæ–°æ¾³
            const xamData = appState.lotteryData['xam'];
            const issue = xamData?.issue || 'æœªçŸ¥';
            const nums = xamData?.numbers || appState.lotteryNumbers || [];
            html += renderSingleLotteryRow('æ–°æ¾³', issue, nums);
        }
        
        container.innerHTML = html;
    }
    
    // æ¸²æŸ“å•è¡Œå¼€å¥–ç»“æœï¼ˆæœŸå·åœ¨å·¦ï¼Œå·ç çƒåœ¨å³ï¼‰
    function renderSingleLotteryRow(typeName, issue, lotteryNums) {
        let ballsHtml = '';
        
        if (!lotteryNums || lotteryNums.length < 7) {
            ballsHtml = '<span style="color:#666;font-size:12px;">æœªè®¾ç½®</span>';
        } else {
            // å‰6ä¸ªå¹³ç 
            for (let i = 0; i < 6; i++) {
                const num = lotteryNums[i];
                const color = getNumberColor(num);
                const shengxiao = getNumberShengxiao(num);
                ballsHtml += `
                    <div class="ball-wrapper" style="transform:scale(0.75);">
                        <div class="ball ${color} no-anim">${String(num).padStart(2, '0')}</div>
                        <div class="ball-info">${shengxiao}</div>
                    </div>
                `;
            }
            
            ballsHtml += '<span class="ball-plus" style="font-size:12px;">+</span>';
            
            // ç‰¹ç 
            const special = lotteryNums[6];
            const specialColor = getNumberColor(special);
            const specialShengxiao = getNumberShengxiao(special);
            ballsHtml += `
                <div class="ball-wrapper" style="transform:scale(0.75);">
                    <div class="ball ${specialColor} no-anim">${String(special).padStart(2, '0')}</div>
                    <div class="ball-info">${specialShengxiao}</div>
                </div>
            `;
        }
        
        // æœŸå·é¢œè‰²ï¼šæ–°æ¾³ç”¨çº¢è‰²ï¼Œé¦™æ¸¯ç”¨ç»¿è‰²
        const typeColor = typeName === 'é¦™æ¸¯' ? '#4CAF50' : '#e94560';
        
        return `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:11px;color:${typeColor};font-weight:bold;white-space:nowrap;min-width:80px;">${typeName} ç¬¬${issue}æœŸ</span>
                <div class="lottery-balls" style="gap:2px;justify-content:flex-start;flex:1;flex-wrap:nowrap;">
                    ${ballsHtml}
                </div>
            </div>
        `;
    }
    
    // å…¼å®¹æ—§ä»£ç ï¼šä¿ç•™åŸå‡½æ•°ä½†å†…éƒ¨è°ƒç”¨æ–°å‡½æ•°
    function renderFeedbackLotteryBalls(lotteryNums) {
        renderFeedbackLotterySection();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ†• v3.4 æ ¹æ®ç©æ³•ç±»å‹åŠ¨æ€ç”Ÿæˆé”™è¯¯æŒ‰é’®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function generateErrorButtons(index, typeName, typeCode) {
        // é€šç”¨é”™è¯¯ç±»å‹ï¼ˆæ‰€æœ‰ç©æ³•éƒ½æœ‰ï¼‰
        const commonErrors = [
            { err: 'type', label: 'ç±»å‹é”™' },
            { err: 'amount', label: 'é‡‘é¢é”™' }
        ];
        
        // æ ¹æ®ç©æ³•ç±»å‹å†³å®šæ˜¯å¦æ˜¾ç¤º"å·ç é”™"æŒ‰é’®
        const needNumError = ['ç‰¹ç ', 'äºŒä¸­äºŒ', 'ä¸‰ä¸­ä¸‰', 'äº”ä¸ä¸­', 'å…­ä¸ä¸­', 'ä¸ƒä¸ä¸­', 'å…«ä¸ä¸­', 'ä¹ä¸ä¸­', 'åä¸ä¸­', 'å•å¹³', 'å¹³ç '];
        
        // æ ¹æ®ç©æ³•ç±»å‹å†³å®šæ˜¯å¦æ˜¾ç¤º"å­ç±»å‹é”™"æŒ‰é’®
        const needSubtypeError = ['å¤§å°å•åŒ', 'æ³¢è‰²', 'åŠæ³¢', 'å¹³ç‰¹ä¸€è‚–', 'ç‰¹è‚–', 'ç”Ÿè‚–', 'å…­è‚–', 'åˆè‚–', 'æ€»å’Œ', 'å®¶ç¦½é‡å…½', 'å¤´æ•°', 'å°¾æ•°', 'äº”è¡Œ', 'å¹³ç‰¹å°¾æ•°', 'æ­£è‚–',
                                   'å°æ•°', 'å¤§æ•°', 'å•æ•°', 'åŒæ•°', 'åˆå¤§', 'åˆå°', 'åˆå•', 'åˆåŒ',
                                   'çº¢æ³¢', 'è“æ³¢', 'ç»¿æ³¢',
                                   'çº¢å•', 'çº¢åŒ', 'çº¢å¤§', 'çº¢å°', 'è“å•', 'è“åŒ', 'è“å¤§', 'è“å°', 'ç»¿å•', 'ç»¿åŒ', 'ç»¿å¤§', 'ç»¿å°'];
        
        let buttons = [];
        
        // 1. ç±»å‹é”™æŒ‰é’®
        buttons.push({ err: 'type', label: 'ç±»å‹é”™' });
        
        // 2. é‡‘é¢é”™æŒ‰é’®
        buttons.push({ err: 'amount', label: 'é‡‘é¢é”™' });
        
        // 3. æ ¹æ®ç±»å‹å†³å®šæ˜¯å¦æ˜¾ç¤º"å·ç é”™"
        if (needNumError.includes(typeName)) {
            buttons.push({ err: 'num', label: 'å·ç é”™' });
        }
        
        // 4. æ ¹æ®ç±»å‹å†³å®šæ˜¯å¦æ˜¾ç¤º"å­ç±»å‹é”™"
        if (needSubtypeError.includes(typeName)) {
            buttons.push({ err: 'subtype', label: 'é€‰é¡¹é”™' });
        }
        
        // 5. æ³¨æ•°é”™ï¼ˆæ‰€æœ‰ç©æ³•ï¼‰
        buttons.push({ err: 'count', label: 'æ³¨æ•°é”™' });
        
        // 6. å‘½ä¸­åˆ¤æ–­é”™ï¼ˆæ‰€æœ‰ç©æ³•ï¼‰
        buttons.push({ err: 'win', label: 'å‘½ä¸­é”™' });
        
        // ç”ŸæˆHTML
        return buttons.map(btn => `
            <span class="fb-err-tag" data-idx="${index}" data-err="${btn.err}" onclick="selectErrorType(${index},'${btn.err}',this)" 
                style="flex:1;min-width:50px;padding:4px 2px;border-radius:3px;font-size:10px;cursor:pointer;background:rgba(255,255,255,0.1);color:#ccc;border:1px solid rgba(255,255,255,0.15);text-align:center;">
                ${btn.label}
            </span>
        `).join('');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ã€ç®€æ´åé¦ˆç³»ç»Ÿ v4.0ã€‘ä¸€ç›®äº†ç„¶çš„æ–‡å­—åˆ—è¡¨
    // æ ¼å¼ï¼šåŸæ–‡ï¼ˆå·ç åˆ—è¡¨ï¼‰æ³¨æ•°Ã—é‡‘é¢=æ€»é¢  ç›ˆäº
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderFeedbackCards() {
        const listEl = document.getElementById('feedback-list');
        
        if (!calcResults || calcResults.length === 0) {
            listEl.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">æš‚æ— è®¡ç®—ç»“æœ</div>';
            return;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ã€æ­¥éª¤1ã€‘åˆå§‹åŒ–åé¦ˆæ•°æ®
        // ğŸ†• v2.4.5 ä¿®å¤ï¼šä½¿ç”¨ AI è¿”å›çš„åŸæ–‡ (raw) ä½œä¸ºåˆ†ç»„ä¾æ®ï¼Œé¿å…è¡ŒåŒ¹é…é”™è¯¯
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v3.2 åˆå§‹åŒ–åé¦ˆæ•°æ®ï¼ŒåŒ…å«å®Œæ•´ç³»ç»Ÿè¯†åˆ«å€¼
        // ğŸ†• v3.11.7 ä¿®å¤ä¸€è¡Œå¤šç±»å‹æ˜¾ç¤ºï¼šä½¿ç”¨ raw ä½œä¸ºæ˜¾ç¤ºæ–‡æœ¬ï¼Œä¿ç•™åŸå§‹å­—æ®µ
        feedbackData.items = calcResults.map((r, index) => {
            // ğŸ†• v3.11.7 å§‹ç»ˆä½¿ç”¨åç«¯è¿”å›çš„ raw å­—æ®µä½œä¸ºè¯¥æ¡ç›®çš„æ˜¾ç¤ºæ–‡æœ¬
            // raw æ˜¯åç«¯æ‹†åˆ†åçš„åŸæ–‡ï¼Œç²¾ç¡®å¯¹åº”è¯¥æ¡ç›®çš„å†…å®¹
            // originalLine æ˜¯ç”¨æˆ·è¾“å…¥çš„æ•´è¡Œï¼ˆä¸€è¡Œå¤šç±»å‹æ—¶ä¼šåŒ…å«å…¶ä»–ç±»å‹å†…å®¹ï¼‰
            const rawText = r.raw || '';
            const originalText = r.originalLine || '';
            
            return {
            index: index,
            groupId: r.groupId || 1,
            lineId: r.lineId || `1-0`,
            // ğŸ†• v3.11.7 ä¿ç•™åŸå§‹çš„ raw å­—æ®µï¼ˆç”¨äºæ˜¾ç¤ºè¯¥æ¡ç›®å¯¹åº”çš„å†…å®¹ï¼‰
            raw: rawText,
            // ğŸ†• v3.11.7 originalLine ä¿ç•™ç”¨æˆ·è¾“å…¥çš„æ•´è¡Œï¼ˆç”¨äºåˆ†ç»„ï¼‰
            originalLine: originalText || rawText,
            // ğŸ†• v3.8.3 ç‰‡æ®µé¡ºåºï¼ˆç”¨äºæ’åºï¼‰
            fragmentOrder: r.fragmentOrder !== undefined ? r.fragmentOrder : 9999,
            type: r.type || 'æœªè¯†åˆ«',
            value: r.value || '',
            number: r.number || r.value || '',  // å•ç‹¬ä¿å­˜å·ç 
            numbers: r.number || r.value || '',  // æ”¹ä¸ºåªä¿å­˜å•ä¸ªå·ç ï¼Œèšåˆæ—¶å†åˆå¹¶
            amount: r.amount || 0,
            isWin: r.isWin || false,
            winAmount: r.winAmount || 0,
            odds: r.odds || 43,
            zodiac: r.zodiac || null,  // ğŸ†• ç”Ÿè‚–ä»£å·
            lt: r.lt || 'mc',  // ğŸ†• v3.11.31 å½©ç§æ ‡è¯†ï¼ˆhk/mcï¼‰
            isError: r.isError || false,
            hasError: false,
            errorType: '',        // type/amount/num/count/win
            correction: '',       // ç”¨æˆ·å¡«å†™çš„ä¿®æ­£å€¼
            errorBlame: '',       // regex_service/calc_service
            systemValue: null,    // ğŸ†• v3.2 ç³»ç»Ÿè¯†åˆ«å€¼ï¼ˆé€‰æ‹©é”™è¯¯ç±»å‹æ—¶å¡«å……ï¼‰
            note: '',             // ğŸ†• v3.2 å¤‡æ³¨
            // ğŸ†• v3.11.17 æŒ‰é”™è¯¯ç±»å‹ç‹¬ç«‹å­˜å‚¨ä¿®æ­£å€¼å’Œå¤‡æ³¨
            correctionsByType: {},  // { type: '', amount: '', num: '', count: '', win: '' }
            notesByType: {}         // { type: '', amount: '', num: '', count: '', win: '' }
        };});
        
        // ğŸ†• è°ƒè¯•æ—¥å¿—ï¼šæ˜¾ç¤ºè§£æç»“æœè¯¦æƒ…
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ“Š åé¦ˆæ•°æ®åˆå§‹åŒ–:', feedbackData.items.length, 'æ¡');
        feedbackData.items.forEach((item, i) => {
            console.log(`  ${i+1}. [${item.lineId}] ${item.type} ${item.number} ${item.amount}å…ƒ | åŸæ–‡: ${item.originalLine?.substring(0,20)}...`);
        });
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ã€æ­¥éª¤2ã€‘æŒ‰ç±»å‹+ç”¨æˆ·è¾“å…¥è¡Œèšåˆæ•°æ®
        // ğŸ†• v3.11.8 ä¿®å¤ï¼šä»ç”¨æˆ·è¾“å…¥è¡Œä¸­æå–è¯¥ç±»å‹å¯¹åº”çš„ç‰‡æ®µä½œä¸ºæ˜¾ç¤ºæ–‡æœ¬
        // èšåˆè§„åˆ™ï¼šåŒä¸€ç±»å‹ + åŒä¸€ç”¨æˆ·è¾“å…¥è¡Œ â†’ åˆå¹¶æ˜¾ç¤º
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v3.11.10 å…¨æ–°åˆ†ç»„é€»è¾‘ï¼šæŒ‰ç”¨æˆ·è¾“å…¥é¡ºåº + ç›¸é‚»åŒç±»å‹åŒé‡‘é¢åˆå¹¶
        // æ ¸å¿ƒè§„åˆ™ï¼šç›¸é‚» + åŒç±»å‹ + åŒé‡‘é¢ â†’ åˆå¹¶ï¼›å¦åˆ™ â†’ æ–°å»ºä¸€ç»„
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ç¬¬1æ­¥ï¼šæŒ‰ groupId + fragmentOrder æ’åºæ‰€æœ‰ items
        // ğŸ†• v3.11.52 ä¿®å¤ï¼šä¼˜å…ˆæŒ‰ç”¨æˆ·è¾“å…¥ç»„å·æ’åºï¼Œç¡®ä¿åŒä¸€ç»„çš„è®°å½•åœ¨ä¸€èµ·
        const sortedItems = [...feedbackData.items].sort((a, b) => {
            // ä¼˜å…ˆæŒ‰ groupId æ’åºï¼ˆç”¨æˆ·è¾“å…¥çš„ç©ºè¡Œåˆ†ç»„ï¼‰
            const groupA = a.groupId !== undefined ? a.groupId : 9999;
            const groupB = b.groupId !== undefined ? b.groupId : 9999;
            if (groupA !== groupB) {
                return groupA - groupB;
            }
            // åŒç»„å†…æŒ‰ fragmentOrder æ’åºï¼ˆä¿æŒè¾“å…¥é¡ºåºï¼‰
            const orderA = a.fragmentOrder !== undefined ? a.fragmentOrder : 9999;
            const orderB = b.fragmentOrder !== undefined ? b.fragmentOrder : 9999;
            return orderA - orderB;
        });
        
        // ç¬¬2æ­¥ï¼šæŒ‰"ç›¸é‚»+åŒç±»å‹+åŒé‡‘é¢"è§„åˆ™åˆ†ç»„
        const sortedLines = [];
        let fbCurrentLine = null;
        
        // ğŸ†• v3.11.11 å…ˆæŒ‰ originalLine + type + amount é¢„åˆ†ç»„ï¼ˆç¡®ä¿åŒä¸€ç”¨æˆ·è¾“å…¥çš„åŒç±»å‹åŒé‡‘é¢èƒ½åˆå¹¶ï¼‰
        const preGroupMap = {};  // key: originalLine|||type|||amount â†’ items[]
        
        sortedItems.forEach((item) => {
            const originalLine = item.originalLine || '';
            const itemType = item.type || 'æœªçŸ¥';
            const itemAmount = item.amount || 0;
            const itemLt = item.lt || 'mc';  // ğŸ†• v3.11.37 è·å–å½©ç§æ ‡è¯†
            // ğŸ†• v3.11.37 groupKey åŠ å…¥ lt å­—æ®µï¼Œé˜²æ­¢é¦™æ¸¯/æ¾³é—¨çš„åŒç±»å‹é¡¹ç›®è¢«é”™è¯¯åˆå¹¶
            const groupKey = `${originalLine}|||${itemType}|||${itemAmount}|||${itemLt}`;
            
            if (!preGroupMap[groupKey]) {
                preGroupMap[groupKey] = {
                    originalLine: originalLine,
                    type: itemType,
                    amount: itemAmount,
                    lt: itemLt,  // ğŸ†• v3.11.37 ä¿å­˜å½©ç§æ ‡è¯†
                    items: [],
                    groupId: item.groupId,
                    minOrder: item.fragmentOrder !== undefined ? item.fragmentOrder : 9999
                };
            }
            preGroupMap[groupKey].items.push(item);
            // è®°å½•æœ€å°çš„ fragmentOrder ç”¨äºæ’åº
            const order = item.fragmentOrder !== undefined ? item.fragmentOrder : 9999;
            if (order < preGroupMap[groupKey].minOrder) {
                preGroupMap[groupKey].minOrder = order;
            }
        });
        
        // æŒ‰ groupId + minOrder æ’åºé¢„åˆ†ç»„
        // ğŸ†• v3.11.52 ä¿®å¤ï¼šä¼˜å…ˆæŒ‰ç”¨æˆ·è¾“å…¥ç»„å·æ’åº
        const preGroups = Object.values(preGroupMap).sort((a, b) => {
            const groupA = a.groupId !== undefined ? a.groupId : 9999;
            const groupB = b.groupId !== undefined ? b.groupId : 9999;
            if (groupA !== groupB) {
                return groupA - groupB;
            }
            return a.minOrder - b.minOrder;
        });
        
        // è½¬æ¢ä¸º sortedLines æ ¼å¼
        preGroups.forEach((pg) => {
            // æ”¶é›†æ‰€æœ‰ raw æ–‡æœ¬ï¼ˆå»é‡ï¼‰
            const displayTexts = [];
            pg.items.forEach(item => {
                const rawText = item.raw || '';
                if (rawText && !displayTexts.includes(rawText)) {
                    displayTexts.push(rawText);
                }
            });
            
            sortedLines.push({
                lineId: pg.items[0]?.lineId,
                groupId: pg.groupId,
                type: pg.type,
                displayTexts: displayTexts,
                items: pg.items,
                perAmount: pg.amount,
                fragmentOrder: pg.minOrder,
                lastFragmentOrder: pg.items[pg.items.length - 1]?.fragmentOrder || pg.minOrder
            });
        });
        
        // ğŸ†• v3.11.13 ç¬¬3æ­¥ï¼šç”Ÿæˆæ¯ç»„çš„æ˜¾ç¤ºæ–‡æœ¬ï¼ˆä¼˜å…ˆä»ç”¨æˆ·è¾“å…¥æå–åŸå§‹ç‰‡æ®µï¼‰
        const fbUserInputText = document.getElementById('bet-input')?.value || '';
        const fbUserInputFragments = fbUserInputText.split(/[,ï¼Œ\n]+/).map(s => s.trim()).filter(Boolean);
        
        sortedLines.forEach(line => {
            let bestDisplayText = line.displayTexts.join(' ');
            
            // å¦‚æœæœ‰å¤šä¸ª raw æ–‡æœ¬ï¼Œå°è¯•ä»ç”¨æˆ·è¾“å…¥ä¸­æå–åŸå§‹ç‰‡æ®µ
            if (line.displayTexts.length > 1) {
                const typeKeywords = {
                    'å¹³ç‰¹ä¸€è‚–': ['å¹³ç‰¹'], 'PT1': ['å¹³ç‰¹'],
                    'å¹³ç‰¹äºŒè¿è‚–': ['äºŒå‹'], 'PT2': ['äºŒå‹'],
                    'å¹³ç‰¹ä¸‰è¿è‚–': ['ä¸‰å‹'], 'PT3': ['ä¸‰å‹'],
                    'å…­è‚–': ['å…­è‚–', '6è‚–'], 'SX6': ['å…­è‚–', '6è‚–'],
                    'ç‰¹ç ': ['ç‰¹'], 'T01': ['ç‰¹'],
                };
                const keywords = typeKeywords[line.type] || [];
                
                // åœ¨ç”¨æˆ·è¾“å…¥ç‰‡æ®µä¸­æŸ¥æ‰¾åŒ¹é…çš„åŸå§‹æ–‡æœ¬
                for (const fragment of fbUserInputFragments) {
                    const hasKeyword = keywords.some(kw => fragment.includes(kw));
                    // æ£€æŸ¥ç‰‡æ®µä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰ items çš„ç”Ÿè‚–
                    const itemZodiacs = line.items.map(it => it.zodiac).filter(Boolean);
                    const allZodiacsInFragment = itemZodiacs.every(z => {
                        const zodiacName = CODE_TO_ZODIAC[z] || z;
                        return fragment.includes(zodiacName);
                    });
                    
                    if (hasKeyword && (itemZodiacs.length === 0 || allZodiacsInFragment)) {
                        bestDisplayText = fragment;
                        break;
                    }
                }
            }
            
            line.displayText = bestDisplayText;
        });
        
        // è°ƒè¯•æ—¥å¿—
        console.log('ğŸ“‹ v3.11.10 åé¦ˆåˆ†ç»„ç»“æœ:');
        sortedLines.forEach((line, i) => {
            console.log(`  [${i}] type=${line.type} | amt=${line.perAmount} | items=${line.items.length} | "${line.displayText?.substring(0,30)}..."`);
        });
        
        // æŒ‰ groupId åˆ†ç»„
        const groupMap = {};
        sortedLines.forEach(line => {
            const gid = line.groupId;
            if (!groupMap[gid]) {
                groupMap[gid] = [];
            }
            groupMap[gid].push(line);
        });
        
        // ğŸ†• v3.11.15 ç¡®ä¿æ¯ä¸ªç»„å†…çš„è¡ŒæŒ‰ fragmentOrder æ­£ç¡®æ’åºï¼ˆç”¨æˆ·è¾“å…¥é¡ºåºï¼‰
        Object.keys(groupMap).forEach(gid => {
            groupMap[gid].sort((a, b) => {
                const orderA = a.fragmentOrder !== undefined ? a.fragmentOrder : 9999;
                const orderB = b.fragmentOrder !== undefined ? b.fragmentOrder : 9999;
                return orderA - orderB;
            });
        });
        
        const groupIds = Object.keys(groupMap).map(Number).sort((a, b) => a - b);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ã€æ­¥éª¤3ã€‘ç”Ÿæˆç®€æ´æ–‡å­—æ ¼å¼
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let html = '';
        
        groupIds.forEach((gid) => {
            const lines = groupMap[gid];
            
            // è®¡ç®—ç»„ç›ˆäº
            const groupProfit = lines.reduce((sum, line) => {
                return sum + line.items.reduce((s, it) => {
                    if (it.isError) return s;
                    return s + (it.isWin ? it.winAmount - it.amount : -it.amount);
                }, 0);
            }, 0);
            
            // ç»„æ ‡é¢˜
            html += `
            <div class="fb-group" style="margin-bottom:12px;background:rgba(30,30,45,0.9);border-radius:8px;overflow:hidden;border:1px solid rgba(102,126,234,0.3);">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(102,126,234,0.2);border-bottom:1px solid rgba(102,126,234,0.3);">
                    <span style="color:#a78bfa;font-weight:bold;font-size:13px;">ç¬¬${gid}ç»„</span>
                    <span style="font-size:13px;font-weight:bold;color:${groupProfit >= 0 ? '#4caf50' : '#f44336'};">${groupProfit >= 0 ? '+' : ''}${groupProfit}å…ƒ</span>
                </div>
                <div style="padding:8px 12px;">
            `;
            
            // æ¯è¡Œæ•°æ®
            lines.forEach((line, lineIdx) => {
                const items = line.items.filter(it => !it.isError);
                const errorItems = line.items.filter(it => it.isError);
                
                if (items.length === 0 && errorItems.length > 0) {
                    // ğŸ†• v3.5 è§£æå¤±è´¥çš„è¡Œä¹Ÿè¦æ˜¾ç¤ºåé¦ˆæŒ‰é’®
                    const errIndex = errorItems[0]?.index ?? feedbackData.items.findIndex(it => it.raw === line.displayText);
                    html += `
                    <div class="fb-line" data-index="${errIndex}" style="
                        display:flex;
                        align-items:center;
                        padding:8px 0;
                        border-bottom:${lineIdx < lines.length - 1 ? '1px dashed rgba(255,255,255,0.1)' : 'none'};
                        border-left:3px solid #f44336;
                        padding-left:8px;
                        margin-left:-8px;
                    ">
                        <div style="flex:1;font-size:12px;line-height:1.5;">
                            <span style="color:#f44336;font-weight:bold;font-size:14px;">âœ—</span>
                            <span style="color:#f44336;margin-left:4px;">æœªè¯†åˆ«:</span>
                            <span style="color:#fbbf24;font-weight:bold;margin-left:4px;">${line.displayText || 'æ— æ³•è¯†åˆ«'}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:10px;color:#888;">ç‚¹å‡»åé¦ˆâ†’</span>
                            <span id="fb-err-btn-${errIndex}" onclick="toggleErrorPanel(${errIndex})" style="cursor:pointer;font-size:14px;opacity:0.7;">âŒ</span>
                        </div>
                    </div>
                    
                    <!-- ğŸ†• v3.5 æœªè¯†åˆ«é¡¹ç›®çš„é”™è¯¯é¢æ¿ -->
                    <div id="fb-err-panel-${errIndex}" data-type="æœªè¯†åˆ«" data-code="UK" style="display:none;background:rgba(244,67,54,0.1);padding:8px;margin:4px 0 8px 0;border-radius:6px;border:1px solid rgba(244,67,54,0.2);">
                        <div style="font-size:10px;color:#f44336;margin-bottom:6px;font-weight:bold;">âš ï¸ è¯·é€‰æ‹©æ­£ç¡®çš„ç±»å‹</div>
                        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
                            <span class="fb-err-tag" data-idx="${errIndex}" data-type="type" onclick="selectErrorType(${errIndex},'type','regex_service')" style="padding:4px 8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:3px;font-size:10px;color:#ccc;cursor:pointer;">ç±»å‹é”™</span>
                        </div>
                        <div id="fb-hint-${errIndex}" style="display:none;font-size:10px;color:#ffc107;margin-bottom:4px;padding:4px 6px;background:rgba(255,193,7,0.1);border-radius:3px;"></div>
                        <div id="fb-input-wrapper-${errIndex}" style="display:none;margin-bottom:6px;">
                            <div id="fb-type-select-${errIndex}">
                                <select onchange="setCorrection(${errIndex}, this.value)" style="width:100%;padding:6px;background:#2a2a3e;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:4px;font-size:11px;">
                                    <option value="">é€‰æ‹©æ­£ç¡®ç±»å‹</option>
                                    ${PLAY_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <textarea id="fb-note-${errIndex}" placeholder="è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰" style="width:100%;height:40px;padding:6px;background:#2a2a3e;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:4px;font-size:10px;resize:none;"></textarea>
                    </div>
                    `;
                    return;
                }
                
                if (items.length === 0) {
                    // æ²¡æœ‰ä»»ä½•é¡¹ç›®ï¼Œè·³è¿‡
                    return;
                }
                
                // ğŸ†• v3.11.11 è·å–ç±»å‹åç§°ï¼ˆä»£ç â†’ä¸­æ–‡è½¬æ¢ï¼‰
                const rawTypeName = items[0]?.type || 'æœªçŸ¥';
                const FB_TYPE_CODE_TO_NAME = {
                    'T01': 'ç‰¹ç ', 'SXTM': 'ç‰¹ç ', 'ç‰¹ç ': 'ç‰¹ç ', 'ç”Ÿè‚–ç‰¹ç ': 'ç‰¹ç ',
                    'XS': 'å°æ•°', 'DS': 'å¤§æ•°', 'ODD': 'å•æ•°', 'EVEN': 'åŒæ•°',
                    'PT1': 'å¹³ç‰¹ä¸€è‚–', 'PT2': 'å¹³ç‰¹äºŒè¿è‚–', 'PT3': 'å¹³ç‰¹ä¸‰è¿è‚–',
                    'PT4': 'å¹³ç‰¹å››è¿è‚–', 'PT5': 'å¹³ç‰¹äº”è¿è‚–', 'PTW': 'å¹³ç‰¹å°¾æ•°',
                    // ğŸ†• v3.11.11 å…­è‚–çš„æ‰€æœ‰å¯èƒ½ä»£ç 
                    'LX': 'å…­è‚–', 'LX6': 'å…­è‚–', 'SX6': 'å…­è‚–', '6X': 'å…­è‚–', 'LIUXIAO': 'å…­è‚–',
                    'TX': 'ç‰¹è‚–', 'HX': 'åˆè‚–', 'ZX': 'æ­£è‚–', 'SX': 'ç”Ÿè‚–',
                    // ğŸ†• v3.12.3 æ·»åŠ æ³¢è‰²ç‹¬ç«‹ä»£å·æ˜ å°„
                    'BS': 'æ³¢è‰²', 'C1': 'çº¢æ³¢', 'C2': 'è“æ³¢', 'C3': 'ç»¿æ³¢',
                    'BB': 'åŠæ³¢', 'DP': 'å•å¹³', 'DXDS': 'å¤§å°å•åŒ',
                    'E2': 'äºŒä¸­äºŒ', 'S3': 'ä¸‰ä¸­ä¸‰', 'BZ': 'ä¸ä¸­',
                    'LM': 'è¿ç ', 'ZH': 'æ€»å’Œ', 'WX': 'äº”è¡Œ', 'JY': 'å®¶é‡',
                    'TS': 'å¤´æ•°', 'WS': 'å°¾æ•°',
                    'å¹³ç‰¹ä¸€è‚–': 'å¹³ç‰¹ä¸€è‚–', 'å¹³ç‰¹äºŒè¿è‚–': 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–': 'å¹³ç‰¹ä¸‰è¿è‚–',
                    'å…­è‚–': 'å…­è‚–', 'æ³¢è‰²': 'æ³¢è‰²', 'çº¢æ³¢': 'çº¢æ³¢', 'è“æ³¢': 'è“æ³¢', 'ç»¿æ³¢': 'ç»¿æ³¢',
                    'åŠæ³¢': 'åŠæ³¢', 'æœªçŸ¥': 'æœªçŸ¥'
                };
                // ğŸ†• v3.11.11 æ™ºèƒ½è¯†åˆ«ï¼šå¦‚æœæ˜¾ç¤ºæ–‡æœ¬åŒ…å«"å…­è‚–"å…³é”®è¯ï¼Œå¼ºåˆ¶è®¾ä¸ºå…­è‚–ç±»å‹
                let typeName = FB_TYPE_CODE_TO_NAME[rawTypeName] || rawTypeName;
                const displayText = line.displayText || '';
                if ((displayText.includes('å…­è‚–') || displayText.includes('6è‚–')) && typeName === 'æœªçŸ¥') {
                    typeName = 'å…­è‚–';
                }
                
                // ğŸ†• v3.11.7 ä¿®å¤æ³¨æ•°è®¡ç®—ï¼šå¤åˆç±»å‹ï¼ˆå…­è‚–ã€å¹³ç‰¹è¿è‚–ç­‰ï¼‰å§‹ç»ˆæ˜¯1æ³¨
                // è¿™äº›ç±»å‹è™½ç„¶å±•å¼€äº†å¤šæ¡è®°å½•ï¼ˆæ¯ä¸ªç”Ÿè‚–ä¸€æ¡ï¼‰ï¼Œä½†å®é™…æ˜¯1æ³¨é€‰å¤šä¸ªç”Ÿè‚–
                const COMPOSITE_TYPES = ['å…­è‚–', 'LX', 'LX6', 'SX6', 'å¹³ç‰¹äºŒè¿è‚–', 'PT2', 'å¹³ç‰¹ä¸‰è¿è‚–', 'PT3', 
                    'å¹³ç‰¹å››è¿è‚–', 'PT4', 'å¹³ç‰¹äº”è¿è‚–', 'PT5', 'åˆè‚–', 'HX', 'äºŒä¸­äºŒ', 'E2', 'ä¸‰ä¸­ä¸‰', 'S3'];
                const isCompositeType = COMPOSITE_TYPES.includes(rawTypeName) || COMPOSITE_TYPES.includes(typeName);
                
                // ğŸ†• v3.11.10 ä½¿ç”¨åˆ†ç»„æ—¶å·²è®¡ç®—å¥½çš„ perAmount
                const unitAmount = line.perAmount || items[0]?.amount || 0;
                
                // ğŸ†• v3.11.12 æ£€æµ‹"å„"/"æ¯"å…³é”®è¯ï¼Œè®¡ç®—ç”Ÿè‚–æ•°é‡ä½œä¸ºæ³¨æ•°
                // è§„åˆ™ï¼šå¹³ç‰¹ä¸€è‚–ï¼ˆPT1ï¼‰ä¸­ï¼Œ"å¹³ç‰¹çŒ´é¸¡å„200" = 2æ³¨ï¼ˆæ¯ä¸ªç”Ÿè‚–=1æ³¨ï¼‰
                const fbHasEachKeyword = /å„|æ¯/.test(displayText);
                const fbZodiacCount = fbHasEachKeyword ? countZodiacsInText(displayText) : 0;
                
                // ğŸ†• v3.11.12 æ³¨æ•°è®¡ç®—ï¼šå¤åˆç±»å‹=1æ³¨ï¼›æœ‰"å„"å…³é”®è¯æ—¶ç”¨ç”Ÿè‚–æ•°ï¼›å¦åˆ™ç”¨itemsæ•°
                let betCount;
                if (isCompositeType) {
                    betCount = 1;
                } else if (fbHasEachKeyword && fbZodiacCount > 0) {
                    betCount = Math.max(items.length, fbZodiacCount);
                } else {
                    betCount = items.length;
                }
                // ğŸ†• v3.11.12 æ€»é‡‘é¢ï¼šå¤åˆç±»å‹=å•æ³¨é‡‘é¢ï¼›å…¶ä»–=æ³¨æ•°Ã—å•æ³¨é‡‘é¢
                const totalAmount = isCompositeType ? unitAmount : (betCount * unitAmount);
                const lineProfit = items.reduce((s, it) => {
                    return s + (it.isWin ? it.winAmount - it.amount : -it.amount);
                }, 0);
                // ğŸ†• v3.11.14 ä¿®å¤å¤åˆç±»å‹ä¸­å¥–åˆ¤æ–­ï¼šPT2/PT3ç­‰è¿è‚–ç±»å‹å¿…é¡»æ‰€æœ‰ç”Ÿè‚–éƒ½ä¸­æ‰ç®—ä¸­å¥–
                const isLianXiaoType = ['PT2', 'PT3', 'PT4', 'PT5', 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–', 'å¹³ç‰¹å››è¿è‚–', 'å¹³ç‰¹äº”è¿è‚–'].includes(rawTypeName) ||
                                       ['PT2', 'PT3', 'PT4', 'PT5', 'å¹³ç‰¹äºŒè¿è‚–', 'å¹³ç‰¹ä¸‰è¿è‚–', 'å¹³ç‰¹å››è¿è‚–', 'å¹³ç‰¹äº”è¿è‚–'].includes(typeName);
                const hasWin = isLianXiaoType ? items.every(it => it.isWin) : items.some(it => it.isWin);
                const firstIndex = items[0]?.index || 0;
                
                // ğŸ†• v3.11.6 è·å–å¯¹åº”ç±»å‹çš„èµ”ç‡ï¼ˆä»èµ”ç‡è®¾ç½®è·å–ï¼‰
                const savedOdds = JSON.parse(localStorage.getItem('lhc_odds') || '{}');
                let typeOdds = items[0]?.odds || 1;
                // æ ¹æ®ç±»å‹è·å–æ­£ç¡®çš„èµ”ç‡
                if (typeName === 'ç‰¹ç ' || rawTypeName === 'T01' || rawTypeName === 'SXTM') {
                    typeOdds = parseFloat(savedOdds['odds-tema']) || 43;
                } else if (typeName === 'å¹³ç‰¹ä¸€è‚–' || rawTypeName === 'PT1') {
                    typeOdds = parseFloat(savedOdds['odds-pingte1']) || 11;
                } else if (typeName === 'å¹³ç‰¹äºŒè¿è‚–' || rawTypeName === 'PT2') {
                    typeOdds = parseFloat(savedOdds['odds-pt2']) || 26;
                } else if (typeName === 'å¹³ç‰¹ä¸‰è¿è‚–' || rawTypeName === 'PT3') {
                    typeOdds = parseFloat(savedOdds['odds-pt3']) || 66;
                } else if (typeName === 'å…­è‚–' || rawTypeName === 'LX' || rawTypeName === 'LX6' || rawTypeName === 'SX6') {
                    typeOdds = parseFloat(savedOdds['odds-liuxiao']) || 4.2;
                } else if (typeName === 'ç”Ÿè‚–' || rawTypeName === 'SX') {
                    typeOdds = parseFloat(savedOdds['odds-shengxiao']) || 12;
                } else if (typeName === 'æ³¢è‰²' || rawTypeName === 'BS') {
                    typeOdds = parseFloat(savedOdds['odds-bose']) || 2;
                } else if (typeName === 'åŠæ³¢' || rawTypeName === 'BB') {
                    typeOdds = parseFloat(savedOdds['odds-banbo']) || 4;
                }
                
                // ğŸ†• ä¸­å¥–çŠ¶æ€æ ‡è®°
                const statusIcon = hasWin 
                    ? '<span style="color:#4caf50;font-weight:bold;font-size:14px;">âœ“</span>' 
                    : '<span style="color:#f44336;font-weight:bold;font-size:14px;">âœ—</span>';
                
                // ğŸ†• v2.4.8 é«˜äº®ä¸­å¥–å·ç çš„å‡½æ•°
                const fbTema = appState.lotteryNumbers?.[6];
                function fbHighlightWinNum(text, winNum) {
                    if (!winNum) return text;
                    return String(text).replace(/(\d{1,2})/g, (match) => {
                        if (parseInt(match) === parseInt(winNum)) {
                            return `<span style="color:#ff4d4f;font-weight:bold;">${match}</span>`;
                        }
                        return match;
                    });
                }
                
                // ğŸ†• v3.6.1 æå–æ‰€æœ‰å·ç åˆ—è¡¨ï¼ˆå±•å¼€ç±»å‹æ˜¾ç¤ºï¼‰
                const allNumbers = items.map(it => {
                    const num = it.numbers || it.number || it.value || '';
                    return parseInt(num);
                }).filter(n => n && !isNaN(n));
                const uniqueNumbers = [...new Set(allNumbers)].sort((a,b) => a-b);
                
                // ğŸ†• v3.3 æ£€æŸ¥æ˜¯å¦æ˜¯ç”Ÿè‚–æ ¼å¼ï¼ˆé€šè¿‡zodiacå­—æ®µåˆ¤æ–­ï¼‰
                const hasZodiac = items.some(it => it.zodiac);
                
                // ğŸ†• v3.11.7 ä½¿ç”¨ displayTextï¼ˆç²¾ç¡®å¯¹åº”è¯¥ç±»å‹çš„å†…å®¹ï¼‰
                let displayOriginalLine = line.displayText || line.originalLine;
                let numbersStr = '';
                if (typeName === 'ç‰¹ç ' || typeName === 'ç”Ÿè‚–ç‰¹ç ') {
                    displayOriginalLine = fbHighlightWinNum(line.displayText || line.originalLine, fbTema);
                    // ğŸ†• v3.8.4 æŒ‰ç”Ÿè‚–åˆ†ç»„æ˜¾ç¤ºå·ç ï¼ˆå¦‚ï¼šçŒ´10,22,34,46,é¾™02,14,26,38ï¼‰
                    if (hasZodiac && uniqueNumbers.length > 0) {
                        // Zä»£å·è½¬ç”Ÿè‚–åç§°æ˜ å°„
                        const Z_TO_NAME = {
                            'Z1': 'é¼ ', 'Z2': 'ç‰›', 'Z3': 'è™', 'Z4': 'å…”',
                            'Z5': 'é¾™', 'Z6': 'è›‡', 'Z7': 'é©¬', 'Z8': 'ç¾Š',
                            'Z9': 'çŒ´', 'Z10': 'é¸¡', 'Z11': 'ç‹—', 'Z12': 'çŒª'
                        };
                        // æŒ‰ç”Ÿè‚–åˆ†ç»„
                        const zodiacGroups = {};
                        items.forEach(it => {
                            const z = it.zodiac;
                            const num = parseInt(it.numbers || it.number || it.value || '');
                            if (z && num && !isNaN(num)) {
                                if (!zodiacGroups[z]) zodiacGroups[z] = [];
                                if (!zodiacGroups[z].includes(num)) zodiacGroups[z].push(num);
                            }
                        });
                        // æŒ‰itemsä¸­é¦–æ¬¡å‡ºç°çš„é¡ºåºæ’åˆ—ç”Ÿè‚–
                        const zodiacOrder = [];
                        items.forEach(it => {
                            if (it.zodiac && !zodiacOrder.includes(it.zodiac)) {
                                zodiacOrder.push(it.zodiac);
                            }
                        });
                        const parts = zodiacOrder.map(z => {
                            const nums = zodiacGroups[z] || [];
                            // å°†Zä»£å·è½¬æ¢ä¸ºç”Ÿè‚–åç§°ï¼ˆå¦‚Z9â†’çŒ´ï¼‰
                            const zName = Z_TO_NAME[z] || z;
                            return zName + nums.map(n => String(n).padStart(2,'0')).join(',');
                        });
                        numbersStr = `ï¼ˆ${fbHighlightWinNum(parts.join(','), fbTema)}ï¼‰`;
                    }
                }
                
                // ğŸ†• v3.8.4 æ ¼å¼ï¼šâœ“/âœ— ç±»å‹(èµ”ç‡å€): åŸæ–‡ï¼ˆå·ç åˆ—è¡¨ï¼‰é‡‘é¢å…ƒ*æ³¨æ•°=æ€»é¢å…ƒ  ç›ˆäºï¼ˆåˆ é™¤"å„"å­—ï¼‰
                // ğŸ†• v3.11.31 æ··åˆä¸‹æ³¨æ—¶æ·»åŠ [é¦™]/[æ¾³]å‰ç¼€
                const itemLt = items[0]?.lt || 'mc';
                const ltPrefix = window.currentCalcIsMixed ? 
                    (itemLt === 'hk' ? '<span style="color:#ff6b6b;font-weight:bold;">[é¦™]</span> ' : '<span style="color:#4ecdc4;font-weight:bold;">[æ¾³]</span> ') 
                    : '';
                
                html += `
                <div class="fb-line" data-index="${firstIndex}" style="
                    display:flex;
                    align-items:center;
                    padding:8px 0;
                    border-bottom:${lineIdx < lines.length - 1 ? '1px dashed rgba(255,255,255,0.1)' : 'none'};
                    border-left:3px solid ${hasWin ? '#4caf50' : 'transparent'};
                    padding-left:${hasWin ? '8px' : '0'};
                    margin-left:${hasWin ? '-8px' : '0'};
                ">
                    <div style="flex:1;font-size:12px;line-height:1.5;">
                        ${ltPrefix}${statusIcon}
                        <span style="color:#64b5f6;margin-left:4px;">${typeName}(${typeOdds}å€):</span>
                        <span style="color:#fbbf24;font-weight:bold;margin-left:4px;">${displayOriginalLine}</span>
                        ${numbersStr ? `<span style="color:#888;font-size:11px;">${numbersStr}</span>` : ''}
                        <span style="color:#aaa;margin-left:6px;">${unitAmount}å…ƒ*${betCount}æ³¨=</span>
                        <span style="color:#fff;">${totalAmount}å…ƒ</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:13px;font-weight:bold;color:${lineProfit >= 0 ? '#4caf50' : '#f44336'};">${lineProfit >= 0 ? '+' : ''}${lineProfit}</span>
                        <span id="fb-err-btn-${firstIndex}" onclick="toggleErrorPanel(${firstIndex})" style="cursor:pointer;font-size:14px;opacity:0.5;">âŒ</span>
                    </div>
                </div>
                
                <!-- ğŸ†• v3.4 éšè—çš„é”™è¯¯é¢æ¿ - æ ¹æ®ç©æ³•ç±»å‹åŠ¨æ€æ˜¾ç¤ºé€‰é¡¹ -->
                <div id="fb-err-panel-${firstIndex}" data-type="${typeName}" data-code="${items[0]?.code || 'T01'}" style="display:none;background:rgba(244,67,54,0.1);padding:8px;margin:4px 0 8px 0;border-radius:6px;border:1px solid rgba(244,67,54,0.2);">
                    <div style="font-size:10px;color:#f44336;margin-bottom:6px;font-weight:bold;">âš ï¸ æ ‡è®°é”™è¯¯ç±»å‹ <span style="color:#888;font-weight:normal;">(${typeName})</span></div>
                    <!-- ğŸ†• v3.4 æ ¹æ®ç±»å‹åŠ¨æ€æ˜¾ç¤ºæŒ‰é’® -->
                    <div id="fb-err-btns-${firstIndex}" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
                        ${generateErrorButtons(firstIndex, typeName, items[0]?.code)}
                    </div>
                    <!-- åŠ¨æ€æç¤ºåŒºåŸŸ -->
                    <div id="fb-hint-${firstIndex}" style="display:none;font-size:10px;color:#ffc107;margin-bottom:4px;padding:4px 6px;background:rgba(255,193,7,0.1);border-radius:3px;"></div>
                    <!-- ğŸ†• v3.4 è§„åˆ™è¯´æ˜åŒºåŸŸ -->
                    <div id="fb-rule-${firstIndex}" style="display:none;font-size:10px;color:#888;margin-bottom:4px;padding:4px 6px;background:rgba(0,0,0,0.2);border-radius:3px;"></div>
                    <!-- ç»Ÿä¸€è¾“å…¥åŒºåŸŸ -->
                    <div id="fb-input-wrapper-${firstIndex}" style="display:none;margin-bottom:6px;">
                        <!-- ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                        <div id="fb-type-select-${firstIndex}" style="display:none;">
                            <select onchange="setCorrection(${firstIndex}, this.value)" style="width:100%;padding:6px;background:#2a2a3e;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:4px;font-size:11px;">
                                <option value="">é€‰æ‹©æ­£ç¡®ç±»å‹</option>
                                ${PLAY_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                            </select>
                        </div>
                        <!-- ğŸ†• v3.4 å­ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆæ ¹æ®å½“å‰ç±»å‹åŠ¨æ€ç”Ÿæˆï¼‰ -->
                        <div id="fb-subtype-select-${firstIndex}" style="display:none;">
                            <select id="fb-subtype-dropdown-${firstIndex}" onchange="setSubtypeCorrection(${firstIndex}, this.value)" style="width:100%;padding:6px;background:#2a2a3e;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:4px;font-size:11px;">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </select>
                        </div>
                        <!-- ğŸ†• v3.4 ä¸­å¥–åˆ¤æ–­é€‰æ‹© -->
                        <div id="fb-win-select-${firstIndex}" style="display:none;">
                            <select onchange="setWinCorrection(${firstIndex}, this.value)" style="width:100%;padding:6px;background:#2a2a3e;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:4px;font-size:11px;">
                                <option value="">é€‰æ‹©æ­£ç¡®ç»“æœ</option>
                                <option value="should_win">åº”è¯¥å‘½ä¸­ï¼ˆç³»ç»Ÿè¯¯åˆ¤æœªä¸­ï¼‰</option>
                                <option value="should_not_win">ä¸åº”å‘½ä¸­ï¼ˆç³»ç»Ÿè¯¯åˆ¤ä¸­å¥–ï¼‰</option>
                                <option value="wrong_amount">å‘½ä¸­ä½†é‡‘é¢é”™è¯¯</option>
                            </select>
                        </div>
                        <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
                        <input type="text" id="fb-correction-${firstIndex}" style="display:none;width:100%;padding:6px;background:#2a2a3e;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:4px;font-size:11px;box-sizing:border-box;" oninput="setCorrection(${firstIndex}, this.value)">
                    </div>
                    <input type="text" id="fb-note-${firstIndex}" placeholder="å…¶ä»–å¤‡æ³¨è¯´æ˜ï¼ˆé€‰å¡«ï¼‰" oninput="setItemNote(${firstIndex}, this.value)" style="width:100%;padding:6px;background:rgba(0,0,0,0.2);color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:4px;font-size:10px;box-sizing:border-box;">
                </div>
                `;
            });
            
            html += `
                </div>
            </div>
            `;
        });
        
        listEl.innerHTML = html;
    }
    
    // åˆ‡æ¢é”™è¯¯è¯Šæ–­é¢æ¿
    function toggleErrorPanel(index) {
        const panel = document.getElementById(`fb-err-panel-${index}`);
        const btn = document.getElementById(`fb-err-btn-${index}`);
        const line = document.querySelector(`.fb-line[data-index="${index}"]`);
        const item = feedbackData.items[index];
        
        if (!panel) return;
        
        if (panel.style.display === 'none') {
            // å±•å¼€é¢æ¿
            panel.style.display = 'block';
            if (btn) btn.style.opacity = '1';
            if (line) line.style.background = 'rgba(244,67,54,0.1)';
            if (item) item.hasError = true;
        } else {
            // æ”¶èµ·é¢æ¿ - é‡ç½®çŠ¶æ€
            panel.style.display = 'none';
            if (btn) btn.style.opacity = '0.5';
            if (line) line.style.background = 'transparent';
            if (item) {
                item.hasError = false;
                item.errorType = '';
                item.correction = '';
                item.errorBlame = '';
            }
            
            // é‡ç½®æ‰€æœ‰æ ‡ç­¾æ ·å¼
            document.querySelectorAll(`.fb-err-tag[data-idx="${index}"]`).forEach(tag => {
                tag.style.background = 'rgba(255,255,255,0.1)';
                tag.style.color = '#ccc';
                tag.style.borderColor = 'rgba(255,255,255,0.15)';
            });
            
            // éšè—å­é¢æ¿ v3.2
            const hintEl = document.getElementById(`fb-hint-${index}`);
            const inputWrapper = document.getElementById(`fb-input-wrapper-${index}`);
            const typeSelect = document.getElementById(`fb-type-select-${index}`);
            const correctionInput = document.getElementById(`fb-correction-${index}`);
            if (hintEl) hintEl.style.display = 'none';
            if (inputWrapper) inputWrapper.style.display = 'none';
            if (typeSelect) typeSelect.style.display = 'none';
            if (correctionInput) { correctionInput.style.display = 'none'; correctionInput.value = ''; }
        }
        
        updateErrorCount();
    }
    
    // ğŸ†• v3.4 é€‰æ‹©é”™è¯¯ç±»å‹ - æ ¹æ®ç©æ³•ç±»å‹åŠ¨æ€æ˜¾ç¤ºé€‰é¡¹
    function selectErrorType(index, errType, btnEl) {
        const item = feedbackData.items[index];
        const panel = document.getElementById(`fb-err-panel-${index}`);
        const currentType = panel?.dataset?.type || item.type;
        const currentCode = panel?.dataset?.code || item.code || 'T01';
        
        // ğŸ†• v3.11.17 ä¿å­˜å½“å‰ï¼ˆæ—§ï¼‰é”™è¯¯ç±»å‹çš„ä¿®æ­£å€¼å’Œå¤‡æ³¨
        const oldErrType = item.errorType;
        const oldCorrectionInput = document.getElementById(`fb-correction-${index}`);
        const oldNoteInput = document.getElementById(`fb-note-${index}`);
        
        if (oldErrType && oldCorrectionInput) {
            item.correctionsByType = item.correctionsByType || {};
            item.correctionsByType[oldErrType] = oldCorrectionInput.value || '';
        }
        if (oldErrType && oldNoteInput) {
            item.notesByType = item.notesByType || {};
            item.notesByType[oldErrType] = oldNoteInput.value || '';
        }
        
        item.errorType = errType;
        
        // ğŸ†• v3.4 æ›´æ–°å½’å› æ˜ å°„
        const blameMap = {
            'type': 'regex_service',      // ç±»å‹è¯†åˆ« â†’ æ­£åˆ™æœåŠ¡
            'amount': 'regex_service',    // é‡‘é¢æå– â†’ æ­£åˆ™æœåŠ¡
            'num': 'regex_service',       // å·ç æå– â†’ æ­£åˆ™æœåŠ¡
            'subtype': 'regex_service',   // å­ç±»å‹è¯†åˆ« â†’ æ­£åˆ™æœåŠ¡
            'count': 'calc_service',      // æ³¨æ•°å±•å¼€ â†’ è®¡ç®—æœåŠ¡
            'win': 'calc_service'         // å‘½ä¸­åˆ¤æ–­ â†’ è®¡ç®—æœåŠ¡
        };
        item.errorBlame = blameMap[errType] || 'unknown';
        
        // ğŸ†• v3.4 ä¿å­˜æ›´å®Œæ•´çš„ç³»ç»Ÿå½“å‰å€¼
        item.systemValue = {
            type: item.type,
            code: item.code,
            subType: item.subType,
            zodiac: item.zodiac,
            numbers: item.numbers || item.number,
            amount: item.amount,
            count: 1,
            isWin: item.isWin,
            winAmount: item.winAmount,
            odds: item.odds
        };
        
        // æ›´æ–°æ ‡ç­¾æ ·å¼
        document.querySelectorAll(`.fb-err-tag[data-idx="${index}"]`).forEach(tag => {
            const isSelected = tag.dataset.err === errType;
            tag.style.background = isSelected ? 'rgba(244,67,54,0.3)' : 'rgba(255,255,255,0.1)';
            tag.style.color = isSelected ? '#f44336' : '#ccc';
            tag.style.borderColor = isSelected ? '#f44336' : 'rgba(255,255,255,0.2)';
        });
        
        // è·å–å…ƒç´ 
        const hintEl = document.getElementById(`fb-hint-${index}`);
        const ruleEl = document.getElementById(`fb-rule-${index}`);
        const inputWrapper = document.getElementById(`fb-input-wrapper-${index}`);
        const typeSelect = document.getElementById(`fb-type-select-${index}`);
        const subtypeSelect = document.getElementById(`fb-subtype-select-${index}`);
        const winSelect = document.getElementById(`fb-win-select-${index}`);
        const correctionInput = document.getElementById(`fb-correction-${index}`);
        
        // éšè—æ‰€æœ‰è¾“å…¥åŒºåŸŸï¼ˆä¸æ¸…ç©ºå€¼ï¼Œåé¢ä¼šæ ¹æ®é”™è¯¯ç±»å‹æ¢å¤ï¼‰
        if (typeSelect) typeSelect.style.display = 'none';
        if (subtypeSelect) subtypeSelect.style.display = 'none';
        if (winSelect) winSelect.style.display = 'none';
        if (correctionInput) correctionInput.style.display = 'none';
        if (ruleEl) ruleEl.style.display = 'none';
        
        // ğŸ†• v3.4 æ ¹æ®ç©æ³•ç±»å‹è·å–é…ç½®
        const typeConfig = PLAY_TYPE_CONFIG[currentCode] || {};
        const winRuleText = typeof typeConfig.winRule === 'string' 
            ? typeConfig.winRule 
            : (typeConfig.winRule?.[item.subType] || typeConfig.winRule?.[currentType] || '');
        
        // ğŸ†• v3.4 æ ¹æ®é”™è¯¯ç±»å‹å’Œç©æ³•ç±»å‹ç”Ÿæˆæç¤º
        let hint = '';
        let showRule = false;
        
        switch(errType) {
            case 'type':
                hint = `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentType}</b>ï¼Œæ­£ç¡®ç±»å‹æ˜¯ï¼Ÿ`;
                if (typeSelect) typeSelect.style.display = 'block';
                break;
                
            case 'amount':
                hint = `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${item.amount}å…ƒ/æ³¨</b>ï¼Œæ­£ç¡®é‡‘é¢æ˜¯ï¼Ÿ`;
                if (correctionInput) {
                    correctionInput.style.display = 'block';
                    correctionInput.placeholder = 'è¾“å…¥æ­£ç¡®é‡‘é¢ï¼ˆæ•°å­—ï¼‰';
                }
                break;
                
            case 'num':
                hint = `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${item.numbers || item.number || 'æ— '}</b>ï¼Œæ­£ç¡®å·ç æ˜¯ï¼Ÿ`;
                if (correctionInput) {
                    correctionInput.style.display = 'block';
                    correctionInput.placeholder = 'è¾“å…¥æ­£ç¡®å·ç ï¼ˆå¦‚: 35,47ï¼‰';
                }
                break;
                
            case 'subtype':
                // ğŸ†• v3.4 æ ¹æ®ç©æ³•ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å­ç±»å‹é€‰é¡¹
                hint = generateSubtypeHint(currentType, currentCode, item);
                if (subtypeSelect) {
                    populateSubtypeDropdown(index, currentType, currentCode);
                    subtypeSelect.style.display = 'block';
                }
                showRule = true;
                break;
                
            case 'count':
                hint = `ğŸ’¡ å½“å‰è®¡ç®—: <b>1æ³¨</b>ï¼Œæ­£ç¡®æ³¨æ•°æ˜¯ï¼Ÿ`;
                if (correctionInput) {
                    correctionInput.style.display = 'block';
                    correctionInput.placeholder = 'è¾“å…¥æ­£ç¡®æ³¨æ•°ï¼ˆæ•°å­—ï¼‰';
                }
                break;
                
            case 'win':
                // ğŸ†• v3.4 å‘½ä¸­åˆ¤æ–­ä½¿ç”¨ä¸‹æ‹‰é€‰æ‹©
                hint = `ğŸ’¡ å½“å‰åˆ¤æ–­: <b>${item.isWin ? 'å‘½ä¸­ +' + item.winAmount + 'å…ƒ' : 'æœªå‘½ä¸­'}</b>`;
                if (winSelect) winSelect.style.display = 'block';
                showRule = true;
                break;
        }
        
        // æ˜¾ç¤ºæç¤º
        if (hintEl) {
            hintEl.innerHTML = hint;
            hintEl.style.display = 'block';
        }
        
        // ğŸ†• v3.4 æ˜¾ç¤ºå‘½ä¸­è§„åˆ™è¯´æ˜ï¼ˆæ›´é€šä¿—æ˜“æ‡‚çš„æ–‡å­—ï¼‰
        if (showRule && ruleEl && winRuleText) {
            ruleEl.innerHTML = `ğŸ“‹ åˆ¤æ–­è§„åˆ™: ${winRuleText}`;
            ruleEl.style.display = 'block';
        }
        
        // ğŸ†• v3.11.17 æ¢å¤æ–°é”™è¯¯ç±»å‹ä¹‹å‰ä¿å­˜çš„ä¿®æ­£å€¼å’Œå¤‡æ³¨
        item.correctionsByType = item.correctionsByType || {};
        item.notesByType = item.notesByType || {};
        
        const savedCorrection = item.correctionsByType[errType] || '';
        const savedNote = item.notesByType[errType] || '';
        
        // æ¢å¤ä¿®æ­£å€¼è¾“å…¥æ¡†
        const correctionEl = document.getElementById(`fb-correction-${index}`);
        if (correctionEl) {
            correctionEl.value = savedCorrection;
        }
        
        // æ¢å¤å¤‡æ³¨è¾“å…¥æ¡†
        const noteEl = document.getElementById(`fb-note-${index}`);
        if (noteEl) {
            noteEl.value = savedNote;
        }
        
        // åŒæ­¥åˆ° item å¯¹è±¡
        item.correction = savedCorrection;
        item.note = savedNote;
        
        if (inputWrapper) inputWrapper.style.display = 'block';
    }
    
    // ğŸ†• v3.4 æ ¹æ®ç©æ³•ç±»å‹ç”Ÿæˆå­ç±»å‹æç¤º
    function generateSubtypeHint(typeName, typeCode, item) {
        const config = PLAY_TYPE_CONFIG[typeCode];
        if (!config) return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${typeName}</b>ï¼Œæ­£ç¡®é€‰é¡¹æ˜¯ï¼Ÿ`;
        
        // æ ¹æ®ä¸åŒç±»å‹æ˜¾ç¤ºå½“å‰è¯†åˆ«çš„å­ç±»å‹
        let currentSubtype = item.subType || item.zodiac || typeName;
        
        if (['DXDS', 'XS', 'DS', 'ODD', 'EVEN'].includes(typeCode) || 
            ['å°æ•°', 'å¤§æ•°', 'å•æ•°', 'åŒæ•°', 'åˆå¤§', 'åˆå°', 'åˆå•', 'åˆåŒ'].includes(typeName)) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®çš„å¤§å°å•åŒæ˜¯ï¼Ÿ`;
        }
        
        if (['BS', 'C1', 'C2', 'C3'].includes(typeCode) || 
            ['çº¢æ³¢', 'è“æ³¢', 'ç»¿æ³¢', 'æ³¢è‰²'].includes(typeName)) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®çš„é¢œè‰²æ˜¯ï¼Ÿ`;
        }
        
        if (['BB'].includes(typeCode) || 
            ['çº¢å•', 'çº¢åŒ', 'çº¢å¤§', 'çº¢å°', 'è“å•', 'è“åŒ', 'è“å¤§', 'è“å°', 'ç»¿å•', 'ç»¿åŒ', 'ç»¿å¤§', 'ç»¿å°', 'åŠæ³¢'].includes(typeName)) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®çš„åŠæ³¢æ˜¯ï¼Ÿ`;
        }
        
        if (['PT1', 'TX', 'SX', 'ZX'].includes(typeCode) || 
            ['å¹³ç‰¹ä¸€è‚–', 'ç‰¹è‚–', 'ç”Ÿè‚–', 'æ­£è‚–'].includes(typeName)) {
            const zodiacName = item.zodiac ? Z_CODE_NAMES[item.zodiac] || item.zodiac : currentSubtype;
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${zodiacName}</b>ï¼Œæ­£ç¡®çš„ç”Ÿè‚–æ˜¯ï¼Ÿ`;
        }
        
        if (['ZH'].includes(typeCode) || ['æ€»å’Œ', 'æ€»å’Œå¤§', 'æ€»å’Œå°', 'æ€»å’Œå•', 'æ€»å’ŒåŒ'].includes(typeName)) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®çš„æ€»å’Œç±»å‹æ˜¯ï¼Ÿ`;
        }
        
        if (['JY'].includes(typeCode) || ['å®¶ç¦½é‡å…½', 'å®¶ç¦½', 'é‡å…½'].includes(typeName)) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®æ˜¯å®¶ç¦½è¿˜æ˜¯é‡å…½ï¼Ÿ`;
        }
        
        if (['TS'].includes(typeCode) || ['å¤´æ•°', '0å¤´', '1å¤´', '2å¤´', '3å¤´', '4å¤´'].includes(typeName)) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®çš„å¤´æ•°æ˜¯ï¼Ÿ`;
        }
        
        if (['WS', 'PTW'].includes(typeCode) || typeName.includes('å°¾')) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®çš„å°¾æ•°æ˜¯ï¼Ÿ`;
        }
        
        if (['WX'].includes(typeCode) || ['äº”è¡Œ', 'é‡‘', 'æœ¨', 'æ°´', 'ç«', 'åœŸ'].includes(typeName)) {
            return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®çš„äº”è¡Œæ˜¯ï¼Ÿ`;
        }
        
        return `ğŸ’¡ å½“å‰è¯†åˆ«: <b>${currentSubtype}</b>ï¼Œæ­£ç¡®é€‰é¡¹æ˜¯ï¼Ÿ`;
    }
    
    // ğŸ†• v3.4 å¡«å……å­ç±»å‹ä¸‹æ‹‰æ¡†
    function populateSubtypeDropdown(index, typeName, typeCode) {
        const dropdown = document.getElementById(`fb-subtype-dropdown-${index}`);
        if (!dropdown) return;
        
        let options = ['<option value="">é€‰æ‹©æ­£ç¡®é€‰é¡¹</option>'];
        
        // æ ¹æ®ç±»å‹ç¡®å®šå­ç±»å‹é€‰é¡¹
        if (['å¤§å°å•åŒ', 'å°æ•°', 'å¤§æ•°', 'å•æ•°', 'åŒæ•°', 'åˆå¤§', 'åˆå°', 'åˆå•', 'åˆåŒ'].includes(typeName) ||
            ['DXDS', 'XS', 'DS', 'ODD', 'EVEN'].includes(typeCode)) {
            options.push(...['å°æ•°', 'å¤§æ•°', 'å•æ•°', 'åŒæ•°', 'åˆå¤§', 'åˆå°', 'åˆå•', 'åˆåŒ'].map(t => 
                `<option value="${t}">${t}</option>`));
        }
        else if (['æ³¢è‰²', 'çº¢æ³¢', 'è“æ³¢', 'ç»¿æ³¢'].includes(typeName) || ['BS'].includes(typeCode)) {
            options.push(...['çº¢æ³¢', 'è“æ³¢', 'ç»¿æ³¢'].map(t => `<option value="${t}">${t}</option>`));
        }
        else if (['åŠæ³¢', 'çº¢å•', 'çº¢åŒ', 'çº¢å¤§', 'çº¢å°', 'è“å•', 'è“åŒ', 'è“å¤§', 'è“å°', 'ç»¿å•', 'ç»¿åŒ', 'ç»¿å¤§', 'ç»¿å°'].includes(typeName) ||
                 ['BB'].includes(typeCode)) {
            options.push(...['çº¢å•', 'çº¢åŒ', 'çº¢å¤§', 'çº¢å°', 'è“å•', 'è“åŒ', 'è“å¤§', 'è“å°', 'ç»¿å•', 'ç»¿åŒ', 'ç»¿å¤§', 'ç»¿å°'].map(t => 
                `<option value="${t}">${t}</option>`));
        }
        else if (['å¹³ç‰¹ä¸€è‚–', 'ç‰¹è‚–', 'ç”Ÿè‚–', 'æ­£è‚–'].includes(typeName) || 
                 ['PT1', 'TX', 'SX', 'ZX'].includes(typeCode)) {
            options.push(...['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'].map(t => 
                `<option value="${t}">${t}</option>`));
        }
        else if (['æ€»å’Œ', 'æ€»å’Œå¤§', 'æ€»å’Œå°', 'æ€»å’Œå•', 'æ€»å’ŒåŒ'].includes(typeName) || ['ZH'].includes(typeCode)) {
            options.push(...['æ€»å’Œå¤§', 'æ€»å’Œå°', 'æ€»å’Œå•', 'æ€»å’ŒåŒ'].map(t => `<option value="${t}">${t}</option>`));
        }
        else if (['å®¶ç¦½é‡å…½', 'å®¶ç¦½', 'é‡å…½'].includes(typeName) || ['JY'].includes(typeCode)) {
            options.push(...['å®¶ç¦½', 'é‡å…½'].map(t => `<option value="${t}">${t}</option>`));
        }
        else if (['å¤´æ•°', '0å¤´', '1å¤´', '2å¤´', '3å¤´', '4å¤´'].includes(typeName) || ['TS'].includes(typeCode)) {
            options.push(...['0å¤´', '1å¤´', '2å¤´', '3å¤´', '4å¤´'].map(t => `<option value="${t}">${t}</option>`));
        }
        else if (typeName.includes('å°¾') || ['WS', 'PTW'].includes(typeCode)) {
            options.push(...['0å°¾', '1å°¾', '2å°¾', '3å°¾', '4å°¾', '5å°¾', '6å°¾', '7å°¾', '8å°¾', '9å°¾'].map(t => 
                `<option value="${t}">${t}</option>`));
        }
        else if (['äº”è¡Œ', 'é‡‘', 'æœ¨', 'æ°´', 'ç«', 'åœŸ'].includes(typeName) || ['WX'].includes(typeCode)) {
            options.push(...['é‡‘', 'æœ¨', 'æ°´', 'ç«', 'åœŸ'].map(t => `<option value="${t}">${t}</option>`));
        }
        else {
            // é»˜è®¤ä½¿ç”¨é€šç”¨é€‰é¡¹
            options.push(...PLAY_TYPES.map(t => `<option value="${t}">${t}</option>`));
        }
        
        dropdown.innerHTML = options.join('');
    }
    
    // ğŸ†• v3.4 è®¾ç½®å­ç±»å‹ä¿®æ­£
    function setSubtypeCorrection(index, value) {
        const item = feedbackData.items[index];
        item.correction = value;
        item.subtypeCorrection = value;
    }
    
    // ğŸ†• v3.4 è®¾ç½®å‘½ä¸­åˆ¤æ–­ä¿®æ­£
    function setWinCorrection(index, value) {
        const item = feedbackData.items[index];
        item.correction = value;
        item.winCorrection = value;
    }
    
    // è®¾ç½®æ­£ç¡®ç±»å‹
    function setCorrectType(index, value) {
        feedbackData.items[index].correction = value;
    }
    
    // è®¾ç½®ä¿®æ­£å†…å®¹
    function setCorrection(index, value) {
        feedbackData.items[index].correction = value;
    }
    
    // è®¾ç½®å¤‡æ³¨
    function setItemNote(index, value) {
        feedbackData.items[index].note = value;
    }
    
    // æ›´æ–°é”™è¯¯è®¡æ•°
    function updateErrorCount() {
        const count = feedbackData.items.filter(item => item.hasError).length;
        feedbackData.errorCount = count;
        document.getElementById('fb-error-count').textContent = count;
        
        // æ ¹æ®æ˜¯å¦æœ‰é”™è¯¯æ›´æ–°æŒ‰é’®çŠ¶æ€
        const btn = document.getElementById('fb-submit-btn');
        if (count > 0) {
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            } else {
            btn.style.opacity = '0.5';
            btn.style.cursor = 'default';
        }
    }
    
    // å…¼å®¹æ—§å‡½æ•°
    function hideFeedbackModal() {
        showPage('page-main');
    }
    
    function toggleItemFeedback(index, type) {
        // å…¼å®¹æ—§è°ƒç”¨
    }
    
    function updateItemCardStyle(index) {
        // å…¼å®¹æ—§ä»£ç 
        const item = feedbackData.items[index];
        const card = document.querySelector(`.fb-card[data-index="${index}"]`);
        if (!card) return;
        
        if (item?.hasError) {
            card.style.borderLeftColor = '#f44336';
            card.style.background = 'rgba(244,67,54,0.1)';
        } else {
            card.style.borderLeftColor = '#666';
            card.style.background = 'rgba(255,255,255,0.05)';
        }
    }
    
    // å…¼å®¹æ—§å‡½æ•°ï¼ˆä¿ç•™ï¼‰
    function toggleCalcFeedback(type) {}
    function updateCalcButtonStyles() {}
    function renderCalcResult() {}
    function feedbackQuickAll(action) {}
    function updateFeedbackStats() {}
    function updateFeedbackDetail() {}
    
    // æ”¶é›†å®Œæ•´è°ƒè¯•ä¿¡æ¯ï¼ˆä¸­æ–‡å­—æ®µåï¼Œæ–¹ä¾¿æŸ¥çœ‹ï¼‰
    function collectDebugInfo() {
        // è·å–å¼€å¥–ä¿¡æ¯
        const currentType = appState.currentLotteryType || 'xam';
        const typeNames = { xam: 'æ–°æ¾³', hk: 'é¦™æ¸¯', am: 'æ¾³é—¨' };
        const lotteryNums = appState.lotteryNumbers || [];
        const tema = lotteryNums[6];
        
        // æ ¼å¼åŒ–ä¸‹æ³¨åˆ—è¡¨ï¼ˆä¸­æ–‡ï¼‰
        const betsFormatted = (parsedBets || []).map((b, i) => ({
            åºå·: i + 1,
            ç±»å‹: b.type,
            å·ç : b.number || b.value || '',
            é‡‘é¢: b.amount + 'å…ƒ'
        }));
        
        // æ ¼å¼åŒ–è®¡ç®—ç»“æœï¼ˆä¸­æ–‡ï¼‰
        const resultsFormatted = (calcResults || []).map((r, i) => ({
            åºå·: i + 1,
            ç±»å‹: r.type,
            å·ç : r.number || r.value || '',
            ä¸‹æ³¨: r.amount + 'å…ƒ',
            æ˜¯å¦ä¸­å¥–: r.isWin ? 'âœ“ä¸­å¥–' : 'âœ—æœªä¸­',
            ä¸­å¥–é‡‘é¢: r.isWin ? r.winAmount + 'å…ƒ' : '0å…ƒ'
        }));
        
        // è®¡ç®—æ±‡æ€»æ•°æ®
        const totalBet = calcResults?.reduce((sum, r) => sum + r.amount, 0) || 0;
        const winCount = calcResults?.filter(r => r.isWin).length || 0;
        const winAmount = calcResults?.filter(r => r.isWin).reduce((sum, r) => sum + r.winAmount, 0) || 0;
        const profit = winAmount - totalBet;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“Š ç”Ÿæˆæ§åˆ¶å°é£æ ¼çš„æ˜“è¯»æ€»ç»“ï¼ˆæ–¹ä¾¿åœ¨Supabaseåå°å¿«é€ŸæŸ¥çœ‹ï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const userInput = document.getElementById('bet-input')?.value || '';
        const pingmaStr = lotteryNums.slice(0,6).map(n => String(n).padStart(2,'0')).join(' ') || 'æœªè®¾ç½®';
        const temaStr = tema ? String(tema).padStart(2,'0') : 'æœªè®¾ç½®';
        
        // æŒ‰ç±»å‹åˆ†ç»„ç»Ÿè®¡
        const betsByType = {};
        (parsedBets || []).forEach(b => {
            const key = b.type;
            if (!betsByType[key]) betsByType[key] = { nums: [], amount: b.amount, count: 0 };
            betsByType[key].nums.push(b.number || b.value || '');
            betsByType[key].count++;
        });
        
        // ç”Ÿæˆä¸‹æ³¨æ˜ç»†æ–‡æœ¬
        let betDetailText = '';
        for (const [type, data] of Object.entries(betsByType)) {
            const numsStr = data.nums.slice(0, 10).join(',') + (data.nums.length > 10 ? '...' : '');
            betDetailText += `   ğŸ“Œ ${type}: ${numsStr} å„${data.amount}å…ƒ (${data.count}æ³¨)\n`;
        }
        
        // ç”Ÿæˆä¸­å¥–æ˜ç»†æ–‡æœ¬
        const winBets = (calcResults || []).filter(r => r.isWin);
        let winDetailText = '';
        if (winBets.length > 0) {
            winBets.forEach(w => {
                winDetailText += `   ğŸ¯ ${w.type} ${w.number || w.value} â†’ ${w.amount}å…ƒÃ—${w.odds}å€=${w.winAmount}å…ƒ\n`;
            });
        } else {
            winDetailText = '   (æ— ä¸­å¥–)\n';
        }
        
        // ç»„è£…æ§åˆ¶å°é£æ ¼æ€»ç»“
        const summaryText = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ“Š åé¦ˆæ•°æ®å¿«é€Ÿæ€»ç»“                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“ ç”¨æˆ·è¾“å…¥:
â•‘    "${userInput.substring(0, 60)}${userInput.length > 60 ? '...' : ''}"
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ° å¼€å¥–ä¿¡æ¯:
â•‘    å½©ç§: ${typeNames[currentType] || currentType}  æœŸå·: ${appState.lotteryData[currentType]?.issue || 'æœªçŸ¥'}
â•‘    å¹³ç : ${pingmaStr}
â•‘    ç‰¹ç : ${temaStr}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ¤– AIå¤„ç†:
â•‘    å‘é€å†…å®¹: "${(debugInfo.aiInput || '').substring(0, 50)}${(debugInfo.aiInput || '').length > 50 ? '...' : ''}"
â•‘    é”™è¯¯ä¿¡æ¯: ${debugInfo.lastError || 'æ— '}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“‹ è¯†åˆ«ç»“æœ: å…±${parsedBets?.length || 0}æ³¨
${betDetailText}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ’° è®¡ç®—ç»“æœ:
â•‘    æ€»ä¸‹æ³¨: ${totalBet}å…ƒ
â•‘    ä¸­å¥–: ${winCount}æ³¨ / ${winAmount}å…ƒ
${winDetailText}â•‘    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â•‘    ${profit >= 0 ? 'ğŸ“ˆ ç›ˆåˆ©' : 'ğŸ“‰ äºæŸ'}: ${profit >= 0 ? '+' : ''}${profit}å…ƒ
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

        const info = {
            '1_ç”¨æˆ·åŸå§‹è¾“å…¥': userInput,
            
            '2_AIå¤„ç†': {
                'å‘é€ç»™AIçš„å†…å®¹': debugInfo.aiInput || '',
                'AIè¿”å›åŸæ–‡': debugInfo.aiOutput || '',
                'AIè§£æç»“æœ': debugInfo.aiParsed || null,
                'é”™è¯¯ä¿¡æ¯': debugInfo.lastError || 'æ— '
            },
            
            '3_å‰ç«¯è§£æç»“æœ': {
                'è¯†åˆ«æ³¨æ•°': (parsedBets?.length || 0) + 'æ³¨',
                'ä¸‹æ³¨æ˜ç»†': betsFormatted
            },
            
            '4_å¼€å¥–ä¿¡æ¯': {
                'å½©ç§': typeNames[currentType] || currentType,
                'æœŸå·': appState.lotteryData[currentType]?.issue || 'æœªçŸ¥',
                'å¹³ç ': lotteryNums.slice(0,6).join(',') || 'æœªè®¾ç½®',
                'ç‰¹ç ': tema || 'æœªè®¾ç½®'
            },
            
            '5_èµ”ç‡è®¾ç½®': JSON.parse(localStorage.getItem('lhc_odds') || '{}'),
            
            '6_è®¡ç®—ç»“æœ': {
                'æ€»ä¸‹æ³¨': totalBet + 'å…ƒ',
                'ä¸­å¥–æ³¨æ•°': winCount + 'æ³¨',
                'ä¸­å¥–é‡‘é¢': winAmount + 'å…ƒ',
                'ç›ˆäº': (profit >= 0 ? '+' : '') + profit + 'å…ƒ',
                'è®¡ç®—æ˜ç»†': resultsFormatted
            },
            
            '7_å¿«é€Ÿæ€»ç»“': summaryText
        };
        
        return info;
    }
    
    // æäº¤åé¦ˆåˆ° Supabase
    // æ—§ç‰ˆæäº¤å‡½æ•°ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
    async function submitFeedback() {
        // è°ƒç”¨æ–°ç‰ˆæäº¤å‡½æ•°
        await submitFeedbackNew();
    }
    
    // ç²¾å‡†çº é”™ç‰ˆ - æäº¤åé¦ˆå‡½æ•°
    async function submitFeedbackNew() {
        // åªæäº¤æ ‡è®°ä¸ºé”™è¯¯çš„æ¡ç›®
        const errorItems = feedbackData.items.filter(item => item.hasError);
        
        if (errorItems.length === 0) {
            showAutoCloseToast('âš ï¸ è¯·ç‚¹å‡» âŒ æ ‡è®°è‡³å°‘ä¸€ä¸ªé”™è¯¯æ¡ç›®', 2000);
            return;
        }
        
        // è·å–å¼€å¥–ä¿¡æ¯
        const currentType = appState.currentLotteryType || 'xam';
        const typeNames = { xam: 'æ–°æ¾³', hk: 'é¦™æ¸¯', am: 'æ¾³é—¨' };
        const lotteryNums = appState.lotteryNumbers || [];
        const tema = lotteryNums[6];
        
        // è®¡ç®—æ±‡æ€»
        const totalBet = calcResults?.reduce((sum, r) => sum + r.amount, 0) || 0;
        const winAmount = calcResults?.filter(r => r.isWin).reduce((sum, r) => sum + r.winAmount, 0) || 0;
        const profit = winAmount - totalBet;
        
        // æ„å»ºç²¾å‡†çº é”™æ•°æ®åŒ…
        const submitData = {
            version: APP_VERSION,
            feedback_version: '2.0_precise',
            timestamp: new Date().toISOString(),
            
            // å¼€å¥–ä¿¡æ¯
            lottery: {
                type: typeNames[currentType] || currentType,
                issue: appState.lotteryData[currentType]?.issue || 'æœªçŸ¥',
                numbers: lotteryNums,
                tema: tema
            },
            
            // ç”¨æˆ·åŸå§‹è¾“å…¥
            user_input: document.getElementById('bet-input')?.value || '',
            
            // æ±‡æ€»æ•°æ®
            summary: {
                total_items: feedbackData.items.length,
                error_count: errorItems.length,
                total_bet: totalBet,
                profit: profit
            },
            
            // ğŸ†• v3.4 é”™è¯¯æ¡ç›®ï¼ˆæ ¸å¿ƒæ•°æ®ï¼‰- æ ¹æ®ç©æ³•ç±»å‹æ”¶é›†å®Œæ•´èƒŒæ™¯ä¿¡æ¯
            error_reports: errorItems.map(item => {
                // è·å–ç©æ³•ç±»å‹é…ç½®
                const typeCode = item.code || getTypeCode(item.type) || 'T01';
                const typeConfig = PLAY_TYPE_CONFIG[typeCode] || {};
                
                return {
                    // 1ï¸âƒ£ æ ‡è®°çš„è®°å½•ä¿¡æ¯
                    item_index: item.index,
                    item_raw: item.originalLine || item.original || '',
                    item_group_id: item.groupId,
                    item_line_id: item.lineId,
                    
                    // 2ï¸âƒ£ ç³»ç»Ÿè¯†åˆ«/è®¡ç®—ç»“æœï¼ˆğŸ†• v3.4 æ›´å®Œæ•´ï¼‰
                    system: {
                        type: item.type,
                        type_code: typeCode,
                        sub_type: item.subType || null,
                        zodiac: item.zodiac || null,
                        zodiac_name: item.zodiac ? (Z_CODE_NAMES[item.zodiac] || item.zodiac) : null,
                        numbers: item.numbers || item.number || null,
                        amount: item.amount,
                        count: 1,
                        is_win: item.isWin,
                        win_amount: item.winAmount,
                        odds: item.odds
                    },
                    
                    // ğŸ†• v3.4 ç©æ³•é…ç½®ä¿¡æ¯ï¼ˆä¾¿äºAIç†è§£è§„åˆ™ï¼‰
                    type_config: {
                        name: typeConfig.name || item.type,
                        has_subtypes: !!typeConfig.subTypes,
                        subtypes: typeConfig.subTypes || null,
                        win_rule: typeof typeConfig.winRule === 'string' 
                            ? typeConfig.winRule 
                            : (typeConfig.winRule?.[item.subType] || typeConfig.winRule?.[item.type] || null),
                        need_fields: typeConfig.needFields || [],
                        default_odds: typeConfig.defaultOdds || null
                    },
                    
                    // 3ï¸âƒ£ é”™è¯¯ç±»å‹ï¼ˆğŸ†• v3.4 å¢åŠ subtypeï¼‰
                    // type=ç±»å‹é”™, amount=é‡‘é¢é”™, num=å·ç é”™, subtype=å­ç±»å‹é”™, count=æ³¨æ•°é”™, win=å‘½ä¸­é”™
                    error_type: item.errorType,
                    
                    // 4ï¸âƒ£ é”™è¯¯å½’å› ï¼ˆå®šä½ä¿®æ”¹å“ªä¸ªæ–‡ä»¶ï¼‰
                    // regex_service=æ­£åˆ™æœåŠ¡, calc_service=è®¡ç®—æœåŠ¡
                    error_blame: item.errorBlame,
                    
                    // 5ï¸âƒ£ ç”¨æˆ·ä¿®æ­£å€¼ï¼ˆğŸ†• v3.4 åŒºåˆ†ä¸åŒç±»å‹çš„ä¿®æ­£ï¼‰
                    user_correction: item.correction,
                    subtype_correction: item.subtypeCorrection || null,
                    win_correction: item.winCorrection || null,
                    
                    // 6ï¸âƒ£ å¤‡æ³¨
                    note: item.note || ''
                };
            }),
            
            // AIè°ƒè¯•ä¿¡æ¯
            ai_debug: {
                input_sent: debugInfo.aiInput || '',
                output_raw: debugInfo.aiOutput || '',
                parsed_result: debugInfo.aiParsed || null,
                last_error: debugInfo.lastError || ''
            }
        };
        
        console.log('ğŸ“¤ ç²¾å‡†çº é”™æ•°æ®åŒ…:', submitData);
        
        try {
            showAutoCloseToast('ğŸ“¤ æ­£åœ¨æäº¤é”™è¯¯æŠ¥å‘Š...', 3000);
            
            // è·å–æ ¼å¼è®¾ç½®ä¸­çš„AIä¿¡æ¯
            const settings = getFormatSettings();
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // æ„å»ºã€å®Œæ•´è°ƒè¯•é“¾æ¡ã€‘æ•°æ® v3.1 - ä¾¿äºç²¾å‡†å®šä½é—®é¢˜ç¯èŠ‚
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const dbData = {
                version: APP_VERSION,
                app_version: APP_VERSION,
                backend_version: debugInfo.backendVersion || '',  // ğŸ†• v3.2.1 åç«¯ç‰ˆæœ¬
                
                // ğŸ“Œ ç¬¬1æ­¥ï¼šç”¨æˆ·åŸå§‹è¾“å…¥
                raw_input: document.getElementById('bet-input')?.value || '',
                
                // ğŸ“Œ ç¬¬2æ­¥ï¼šå‰ç«¯è„±æ•è½¬æ¢ï¼ˆæš—å·ï¼‰
                sanitized_input: debugInfo.sanitizedInput || debugInfo.aiInput || '',
                
                // ğŸ“Œ ç¬¬3æ­¥ï¼šåç«¯è¯†åˆ«
                backend_method: debugInfo.modelUsed === 'regex' ? 'regex' : 'ai',
                
                // ğŸ†• v3.1 æ­£åˆ™è¯†åˆ«ç»“æœï¼ˆå…³é”®ï¼åŒ…å« code, zodiac, nums, amtï¼‰
                regex_items: JSON.stringify(debugInfo.extractItems || []),
                
                // AIè¯†åˆ«ç»“æœï¼ˆå½“ backend_method æ˜¯ ai æ—¶ï¼‰
                ai_provider: settings.aiProvider || 'unknown',
                ai_model: debugInfo.modelUsed || '',
                ai_raw_response: (debugInfo.aiOutput || '').substring(0, 3000),
                ai_parsed_result: JSON.stringify(debugInfo.aiParsed || null),
                ai_latency_ms: debugInfo.latencyMs || 0,
                
                // ğŸ“Œ ç¬¬4æ­¥ï¼šåç«¯è®¡ç®—ï¼ˆğŸ†• v3.1 æ–°å¢å…³é”®å­—æ®µï¼‰
                calc_input_count: debugInfo.calcInputCount || 0,     // è¯†åˆ«æ¡æ•°
                calc_output_count: debugInfo.calcOutputCount || 0,   // å±•å¼€åæ¡æ•°ï¼ˆå…³é”®ï¼ï¼‰
                calc_items: JSON.stringify((debugInfo.calcItems || []).slice(0, 100)),  // è®¡ç®—åæ¯æ¡è¯¦æƒ…
                calc_s1: debugInfo.calcS1 || 0,   // æ€»æŠ•å…¥
                calc_s2: debugInfo.calcS2 || 0,   // å‘½ä¸­æ•°
                calc_s3: debugInfo.calcS3 || 0,   // å‘½ä¸­é‡‘é¢
                calc_s4: debugInfo.calcS4 || 0,   // ç»“ç®—
                calc_latency_ms: debugInfo.latencyMs || 0,
                // ğŸ†• v3.11.22 å¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼ˆç²¾å‡†å®šä½é—®é¢˜ï¼‰
                skip_regex_reason: debugInfo.skipRegexReason || null,         // è·³è¿‡æ­£åˆ™çš„åŸå› 
                ai_items_count: debugInfo.aiItemsCount || 0,                  // AIè¯†åˆ«çš„åŸå§‹è®°å½•æ•°ï¼ˆé¢„å¤„ç†å‰ï¼‰
                preprocess_log: JSON.stringify(debugInfo.preprocessLog || []), // é¢„å¤„ç†æ—¥å¿—
                
                // ğŸ“Œ ç¬¬5æ­¥ï¼šå‰ç«¯æ˜¾ç¤º
                display_items: JSON.stringify((calcResults || []).slice(0, 50).map(r => ({
                    type: r.type,
                    zodiac: r.zodiac,
                    numbers: r.numbers,
                    amount: r.amount,
                    isWin: r.isWin,
                    winAmount: r.winAmount
                }))),
                
                // æ—§å­—æ®µä¿ç•™å…¼å®¹
                restored_result: JSON.stringify((parsedBets || []).slice(0, 50)),
                calc_bets: JSON.stringify((parsedBets || []).map(b => ({
                    type: b.type,
                    number: b.number || b.value,
                    amount: b.amount
                })).slice(0, 50)),
                calc_results: JSON.stringify((calcResults || []).map(r => ({
                    type: r.type,
                    number: r.number || r.value,
                    amount: r.amount,
                    isWin: r.isWin,
                    winAmount: r.winAmount,
                    odds: r.odds
                })).slice(0, 50)),
                
                // ğŸ“Œ ç¬¬6æ­¥ï¼šå¼€å¥–ä¿¡æ¯
                lottery_type: submitData.lottery.type,
                lottery_issue: submitData.lottery.issue,
                lottery_numbers: JSON.stringify(submitData.lottery.numbers),
                lottery_tema: submitData.lottery.tema,
                
                // ğŸ“Œ ç¬¬7æ­¥ï¼šæœ€ç»ˆç»“æœæ±‡æ€»
                total_bets: submitData.summary.total_items,
                total_amount: submitData.summary.total_bet,
                win_count: (calcResults || []).filter(r => r.isWin).length,
                win_amount: (calcResults || []).filter(r => r.isWin).reduce((s, r) => s + r.winAmount, 0),
                profit: submitData.summary.profit,
                
                // ğŸ“Œ ç¬¬8æ­¥ï¼šç”¨æˆ·åé¦ˆçš„é”™è¯¯ v3.4
                // error_stage: é”™è¯¯å½’å› (regex_service/calc_service)
                error_stage: errorItems[0]?.errorBlame || 'unknown',
                // ğŸ†• v3.4 error_detail: æ›´è¯¦ç»†çš„é”™è¯¯æè¿°
                error_detail: errorItems.map(e => {
                    let detail = `${e.errorType}`;
                    if (e.correction) detail += `:${e.correction}`;
                    if (e.subtypeCorrection) detail += ` [å­ç±»å‹â†’${e.subtypeCorrection}]`;
                    if (e.winCorrection) detail += ` [å‘½ä¸­â†’${e.winCorrection}]`;
                    if (e.note) detail += ` (${e.note})`;
                    return detail;
                }).filter(n => n).join('; '),
                // expected_result: ç”¨æˆ·å¡«å†™çš„ä¿®æ­£å€¼
                expected_result: errorItems[0]?.correction || errorItems[0]?.subtypeCorrection || '',
                // error_items: å®Œæ•´çš„é”™è¯¯æŠ¥å‘ŠJSONï¼ˆğŸ†• v3.4 åŒ…å«ç©æ³•é…ç½®ï¼‰
                error_items: JSON.stringify(submitData.error_reports),
                // ğŸ†• v3.4 error_summary: æ›´æ¸…æ™°çš„å¿«é€Ÿæ‘˜è¦
                error_summary: errorItems.map(e => {
                    const typeCode = e.code || getTypeCode(e.type) || '';
                    const typeConfig = PLAY_TYPE_CONFIG[typeCode] || {};
                    return `[${e.type}/${typeCode}:${e.errorType}â†’${e.errorBlame}]${e.originalLine?.substring(0, 20) || ''}`;
                }).join(' | '),
                // ğŸ†• v3.4 ç©æ³•ç±»å‹æ±‡æ€»ï¼ˆä¾¿äºå¿«é€Ÿäº†è§£æ¶‰åŠçš„ç©æ³•ï¼‰
                play_types_involved: [...new Set(errorItems.map(e => e.type))].join(','),
                // ğŸ†• v3.4 é”™è¯¯ç±»å‹æ±‡æ€»
                error_types_involved: [...new Set(errorItems.map(e => e.errorType))].join(',')
            };
            
            console.log('ğŸ“¤ å®Œæ•´è°ƒè¯•é“¾æ¡æ•°æ®:', dbData);
            
            const response = await fetch(`${SUPABASE_URL}/rest/v1/feedback`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(dbData)
            });
            
            if (response.ok) {
                showAutoCloseToast('âœ… åé¦ˆæäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„è¯„ä»·', 3000);
                setTimeout(() => {
                    showPage('page-main');
                }, 1000);
            } else {
                const errorText = await response.text();
                console.error('åé¦ˆæäº¤å¤±è´¥:', errorText);
                showAutoCloseToast('âŒ æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 3000);
            }
        } catch (e) {
            console.error('åé¦ˆæäº¤é”™è¯¯:', e);
            showAutoCloseToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 3000);
        }
    }
    
    // åˆå§‹åŒ–
    init();
    </script>
</body>
</html>
